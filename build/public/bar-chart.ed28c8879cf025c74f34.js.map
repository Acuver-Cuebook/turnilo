{"version":3,"sources":["webpack:///./src/client/utils/dataset/selectors/selectors.ts","webpack:///./src/client/visualizations/line-chart/utils/splits.ts","webpack:///./src/client/components/bubble-title/bubble-title.tsx","webpack:///./src/client/utils/linear-scale/linear-scale.ts","webpack:///./src/client/components/series-bubble-content/series-bubble-content.tsx","webpack:///./src/client/components/modal-bubble/modal-bubble.tsx","webpack:///./src/client/components/highlight-modal/highlight-modal.tsx","webpack:///./src/client/components/segment-bubble/segment-bubble.tsx","webpack:///./src/client/components/measure-bubble-content/measure-bubble-content.tsx","webpack:///./src/client/components/grid-lines/grid-lines.tsx","webpack:///./src/client/utils/highlight-clause/highlight-clause.ts","webpack:///./src/client/visualizations/line-chart/utils/is-valid-clause.ts","webpack:///./src/client/components/color-swabs/color-entry.tsx","webpack:///./src/client/components/vis-measure-label/vis-measure-label.tsx","webpack:///./src/client/components/vertical-axis/vertical-axis.tsx","webpack:///./src/client/components/color-swabs/color-swabs.tsx","webpack:///./src/client/utils/extent/extent.ts","webpack:///./src/client/components/timeseries-visualization-controls/split-menu.tsx","webpack:///./src/client/components/timeseries-visualization-controls/visualization-controls.tsx","webpack:///./src/client/components/grid-border/grid-border.tsx","webpack:///./src/client/components/highlighter/highlighter.tsx","webpack:///./node_modules/@babel/runtime/helpers/esm/toPropertyKey.js","webpack:///./node_modules/@babel/runtime/helpers/esm/toPrimitive.js","webpack:///./src/client/visualizations/bar-chart/improved-bar-chart/utils/bar-chart-model.ts","webpack:///./src/client/visualizations/bar-chart/improved-bar-chart/hover-tooltip/tooltip-content.tsx","webpack:///./src/client/visualizations/bar-chart/improved-bar-chart/interactions/interaction.ts","webpack:///./src/client/visualizations/bar-chart/improved-bar-chart/hover-tooltip/hover-tooltip.tsx","webpack:///./src/client/visualizations/bar-chart/improved-bar-chart/foreground/highlight-modal.tsx","webpack:///./src/client/visualizations/bar-chart/improved-bar-chart/foreground/highlight-overlay.tsx","webpack:///./src/client/visualizations/bar-chart/improved-bar-chart/bar/padding.ts","webpack:///./src/client/visualizations/bar-chart/improved-bar-chart/foreground/foreground.tsx","webpack:///./src/client/visualizations/bar-chart/improved-bar-chart/utils/layout.ts","webpack:///./src/client/visualizations/bar-chart/improved-bar-chart/utils/calculate-segment-stage.ts","webpack:///./src/client/visualizations/bar-chart/improved-bar-chart/utils/y-extent.ts","webpack:///./src/client/visualizations/bar-chart/improved-bar-chart/bar/single-bar.tsx","webpack:///./src/client/visualizations/bar-chart/improved-bar-chart/bar/single-time-shift-bar.tsx","webpack:///./src/client/visualizations/bar-chart/improved-bar-chart/utils/stack-layout.ts","webpack:///./src/client/visualizations/bar-chart/improved-bar-chart/bar/stacked-bar.tsx","webpack:///./src/client/visualizations/bar-chart/improved-bar-chart/bar/stacked-time-shift-bar.tsx","webpack:///./src/client/visualizations/bar-chart/improved-bar-chart/y-axis/single-y-axis.tsx","webpack:///./src/client/visualizations/bar-chart/improved-bar-chart/bars/background.tsx","webpack:///./src/client/visualizations/bar-chart/improved-bar-chart/bars/bars.tsx","webpack:///./src/client/visualizations/bar-chart/improved-bar-chart/bars/bars-container.tsx","webpack:///./src/client/visualizations/bar-chart/improved-bar-chart/legend/Legend.tsx","webpack:///./src/client/visualizations/bar-chart/improved-bar-chart/bar-charts/bar-charts.tsx","webpack:///./src/client/visualizations/bar-chart/improved-bar-chart/interactions/interaction-controller.tsx","webpack:///./src/client/visualizations/bar-chart/improved-bar-chart/spacer/spacer.tsx","webpack:///./src/client/visualizations/bar-chart/improved-bar-chart/utils/stack-dataset.ts","webpack:///./src/client/utils/dataset/split/map-split-datums.ts","webpack:///./src/client/visualizations/bar-chart/improved-bar-chart/utils/transpose-dataset.ts","webpack:///./src/client/visualizations/bar-chart/improved-bar-chart/utils/x-scale.ts","webpack:///./src/client/visualizations/bar-chart/improved-bar-chart/x-axis/x-axis.tsx","webpack:///./src/client/visualizations/bar-chart/improved-bar-chart/y-axis/y-axis.tsx","webpack:///./src/client/visualizations/bar-chart/improved-bar-chart/bar-chart.tsx","webpack:///./src/client/visualizations/bar-chart/improved-bar-chart/utils/x-domain.ts","webpack:///./src/client/components/bucket-marks/bucket-marks.tsx","webpack:///./src/client/visualizations/bar-chart/bar-coordinates.ts","webpack:///./src/client/visualizations/bar-chart/old-bar-chart/old-bar-chart.tsx","webpack:///./src/client/visualizations/bar-chart/bar-chart.tsx"],"names":["selectMainDatum","dataset","data","selectSplitDataset","datum","SPLIT","selectDatums","selectSplitDatums","compose","selectFirstSplitDataset","selectFirstSplitDatums","dimensionForSplit","essence","split","findDimensionByName","dataCube","dimensions","reference","getContinuousSplit","splits","last","getContinuousDimension","getContinuousReference","getNominalSplit","count","first","hasNominalSplit","getNominalDimension","BubbleTitle","title","minWidth","clamp","length","className","style","pickTicks","scale","ticksCount","ticks","filter","n","getScale","height","min","max","isNaN","d3","domain","Math","nice","range","SeriesBubbleContent","props","series","showPrevious","Fragment","formatValue","currentValue","selectValue","previousValue","SeriesDerivation","PREVIOUS","formatter","lowerIsBetter","measure","current","previous","ModalBubble","el","modalRef","e","target","isInside","onClose","this","children","left","top","mouseDown","onMouseDown","classNames","ref","setModalRef","direction","React","Component","HighlightModal","acceptHighlight","dropHighlight","type","onClick","STRINGS","select","cancel","SegmentBubble","content","SegmentBubbleContent","MeasureBubbleContent","GridLines","orientation","stage","transform","getTransform","map","tick","value","roundToHalfPx","coordinates","x1","x2","width","y1","y2","lineCoordinates","key","String","toFilterClause","TimeRange","isTimeRange","dateRange","DateRange","values","List","of","FixedTimeFilterClause","PlywoodNumberRange","isNumberRange","numberRange","NumberRange","NumberFilterClause","Error","toPlywoodRange","clause","isValidClause","Range","fromJS","createColorEntry","color","name","hasComparison","delta","VisMeasureLabel","CURRENT","renderPrevious","VerticalAxis","tickSize","inputTicks","topLineExtend","hideZero","lines","y","labelX","labels","x","dy","ColorSwabs","colorSwabs","colorEntries","swabStyle","background","seriesSelectors","get","d","readNumber","datumsExtent","datums","selectors","reduce","acc","selector","extent","TimeSeriesContinuousSplitMenu","saveSplit","containerStage","dimension","openOn","useState","bucket","granularityToString","granularity","setGranularity","isValid","validateSplit","onSave","newSplit","createSplit","granularityChange","TimeSeriesCategorySplitMenu","sortOptions","DimensionSortOn","seriesSortOns","toArray","useSettingsContext","customization","visualizationColors","limitOptions","useMemo","colorSplitLimits","sort","setSort","limit","setLimit","selected","SortOn","fromSort","options","onChange","selectedLimit","limits","includeNone","onLimitSelect","TimeSeriesSplitMenu","equals","TimeSeriesSplitTile","splitMenuComponent","TimeSeriesSplitTilesRow","splitTileComponent","TimeSeriesVisualizationControls","splitTilesRow","BottomBorder","tickLength","RightBorder","Highlighter","bottom","right","whiteoutLeftStyle","frameStyle","whiteoutRightStyle","_toPropertyKey","arg","input","hint","prim","Symbol","toPrimitive","undefined","res","call","TypeError","Number","ModelVariantId","isStacked","model","variant","STACKED","create","commons","continuousSplit","timezone","getConcreteSeries","readCommons","BASE","nominalSplit","nominalDimension","colors","i","colorIndex","set","OrderedMap","createColorMap","InteractionKind","Content","entries","entrySeq","find","HoverTooltip","rect","interaction","xScale","yScale","xValue","calculate","bandwidth","createHover","kind","HOVER","equalInteractions","a","b","safeEquals","HighlightOverlay","includePrevious","getYValue","Foreground","container","getBoundingClientRect","HIGHLIGHT","isHighlight","isHover","MARGINS","calculateLayout","visualisationStage","domainLength","seriesCount","segmentStage","bodyStage","domainSize","availableHeight","heightFromEvenDivision","floor","Stage","fromSize","calculateSegmentStage","within","scroller","bodyHeight","bodyWidth","segment","yExtent","SingleBar","maxHeight","xPos","yPos","fill","main","SingleTimeShiftBar","xStart","rangeBand","barWidth","yCurrent","yPrevious","yCurrentStart","yPreviousStart","currentFill","previousFill","alphaMain","selectBase","period","stackBaseKey","plywoodKey","stackBy","y0","stacked","baseKey","cons","maxKey","changeData","StackedBar","StackedTimeShiftBar","yPreviousBase","yPreviousPos","previousHeight","previousColor","darker","opacity","toString","yCurrentBase","yCurrentPos","currentHeight","currentColor","SingleYAxis","viewBox","getViewBox","Background","gridStage","Bar","rest","Bars","index","BarsContainer","createRef","scrollLeft","totals","chartStage","getWidthHeight","LegendValues","Legend","getTitle","BarCharts","seriesList","hasInteraction","reactKey","InteractionController","hover","scrollTop","setState","part","highlight","getValueFromEvent","isRange","getSeriesFromEvent","findDatumByValue","oldHover","state","saveHighlight","layout","invert","seriesHeight","clauses","createHighlight","onScroll","saveScroll","onMouseLeave","resetHover","onMouseMove","saveHover","handleClick","Spacer","reverse","slice","reverseSplitDatums","fn","mapSplitDatums","stackDataset","reversedDatums","threadConditionally","stack","constructDatum","continuousRef","splitData","Dataset","transposeDataset","flatten","coll","currentDatum","idx","findIndex","continuousAttr","splitDatum","createInnerDatum","replaceAt","newDatum","mergeDatums","aRange","bRange","compare","rangeComparator","formatDomainValue","start","toISOString","XAxis","isContinuousSplit","_","textAnchor","TICK_HEIGHT","formatShortSegment","YAxis","axisStage","BarChart","transposedDataset","barChartLayout","stringifiedDomain","ordinalScale","rangeRound","quantizedScale","createXScale","leftGutter","bottomLeftCorner","bottomRightCorner","body","rightGutter","bottomGutter","BucketMarks","stageWidth","addLine","push","BarCoordinates","parameters","barOffset","stepWidth","hitboxMin","hitboxMax","getFilterFromDatum","dataPath","getSplit","SplitType","boolean","BooleanFilterClause","Set","number","time","string","StringFilterClause","action","StringFilterAction","IN","BAR_CHART_MANIFEST","initState","hoverInfo","calculateMousePosition","selectionInfo","path","chartIndex","rowHighlight","currentSeries","definition","hasHighlightOn","scrollerYPosition","scrollerXPosition","scrollerComponent","getSingleChartStage","chartHeight","getOuterChartHeight","size","getPrimaryXScale","chartCoordinates","getBarsCoordinates","findBarCoordinatesForX","findPathForIndices","indices","mySplitDataset","currentData","forEach","currentPath","isXWithin","hasChildren","yAxisStage","flatData","splitLength","leafData","extentY","getYExtent","yMin","yMax","getBarDimensions","xTicks","roundToPx","measures","VIS_H_PADDING","xHeight","CHART_TOP_PADDING","xAxisStage","oneChartHeight","leftOffset","topOffset","segmentLabel","getBubbleLeftOffset","middleX","getBubbleTopOffset","canShowBubble","segmentValue","measureContent","renderMeasureLabel","hasAnySelectionGoingOn","splitIndex","context","bars","bar","segmentValueStr","subPath","concat","bubble","subCoordinates","subData","subRender","renderBars","bubbleInfo","isHovered","renderHoverBubble","isSelected","faded","isFaded","renderSelectionBubble","renderSelectionHighlight","abs","SELECTION_PAD","canBucketByDefault","lastIndex","ascending","SortDirection","leftThing","rightThing","coordinate","getAxisStages","getYScale","yTicks","yGridLines","changeY","yAxis","topY","viewPortHeight","measureLabel","hasValidYExtent","chart","getYAxisStuff","isChartVisible","renderedChart","coordinatesCache","dimensionKind","firstSplitDataSet","originalDataset","dimensionName","firstBucket","end","j","filledData","segmentStart","m","attributes","valueOf","padDataset","s","flattened","order","nestingName","maxNumberOfLeaves","maxima","level","firstSplit","getXValues","usedWidth","padLeft","xRangeBand","overallWidth","numPrimarySteps","minStepWidth","maxAvailableWidth","getSubCoordinates","getX","scaleY","h","subStage","subxScale","yAxes","yAxesStage","changeHeight","selectionHighlight","scrollerLayout","xAxis","overlay","measureCharts","renderXAxis","renderChart","renderSelectionContainer","getScrollerLayout","renderRightGutter","onScrollerScroll","SettingsContext","newVersionSupports","or","Predicates","areExactSplitKinds","BarChartVisualization","chartComponent","ImprovedBarChart"],"mappings":"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","file":"bar-chart.ed28c8879cf025c74f34.js","sourcesContent":["/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Dataset, Datum } from \"plywood\";\nimport { compose } from \"../../../../common/utils/functional/functional\";\nimport { SPLIT } from \"../../../config/constants\";\n\nexport const selectMainDatum = (dataset: Dataset): Datum =>\n  dataset.data[0];\n\nexport const selectSplitDataset = (datum: Datum): Dataset =>\n  datum[SPLIT] as Dataset;\n\nexport const selectDatums = (dataset: Dataset): Datum[] =>\n  dataset.data;\n\nexport const selectSplitDatums: (datum: Datum) => Datum[] =\n  compose(selectSplitDataset, selectDatums);\n\nexport const selectFirstSplitDataset: (dataset: Dataset) => Dataset =\n  compose(selectMainDatum, selectSplitDataset);\n\nexport const selectFirstSplitDatums: (dataset: Dataset) => Datum[] =\n  compose(selectFirstSplitDataset, selectDatums);\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Dimension } from \"../../../../common/models/dimension/dimension\";\nimport { findDimensionByName } from \"../../../../common/models/dimension/dimensions\";\nimport { Essence } from \"../../../../common/models/essence/essence\";\nimport { Split } from \"../../../../common/models/split/split\";\n\nfunction dimensionForSplit(essence: Essence, split: Split): Dimension {\n   return findDimensionByName(essence.dataCube.dimensions, split.reference);\n}\n\nexport function getContinuousSplit({ splits: { splits } }: Essence): Split {\n   return splits.last();\n}\n\nexport function getContinuousDimension(essence: Essence): Dimension {\n   const split = getContinuousSplit(essence);\n   return dimensionForSplit(essence, split);\n}\n\nexport function getContinuousReference(essence: Essence): string {\n   return getContinuousSplit(essence).reference;\n}\n\nexport function getNominalSplit({ splits: { splits } }: Essence): Split | null {\n   return splits.count() === 1 ? null : splits.first();\n}\n\nexport function hasNominalSplit(essence: Essence): boolean {\n   return getNominalSplit(essence) !== null;\n}\n\nexport function getNominalDimension(essence: Essence): Dimension | null {\n   const split = getNominalSplit(essence);\n   return split && dimensionForSplit(essence, split);\n}\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { clamp } from \"../../utils/dom/dom\";\n\nconst PER_LETTER_PIXELS = 8;\nconst MIN_TITLE_WIDTH = 80;\nconst MAX_TITLE_WIDTH = 300;\n\ninterface BubbleTitleProps {\n  title: string;\n}\n\nexport const BubbleTitle: React.FunctionComponent<BubbleTitleProps> = ({ title }) => {\n  const minWidth = clamp(title.length * PER_LETTER_PIXELS, MIN_TITLE_WIDTH, MAX_TITLE_WIDTH);\n  return <div className=\"title\" style={{ minWidth }}>{title}</div>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as d3 from \"d3\";\n\nexport type LinearScale = d3.ScaleLinear<number, number>;\n\nexport const TICKS_COUNT = 5;\n\nexport function pickTicks(scale: LinearScale, ticksCount = TICKS_COUNT): number[] {\n  return scale.ticks(ticksCount).filter(n => n !== 0);\n}\n\nexport default function getScale([min, max]: number[], height: number): LinearScale | null {\n  if (isNaN(min) || isNaN(max)) {\n    return null;\n  }\n\n  return d3.scaleLinear()\n    .domain([Math.min(min, 0), Math.max(max, 0)])\n    .nice(TICKS_COUNT)\n    .range([height, 0]);\n}\n","/*\n * Copyright 2017-2020 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Datum } from \"plywood\";\nimport React from \"react\";\nimport { ConcreteSeries, SeriesDerivation } from \"../../../common/models/series/concrete-series\";\nimport { MeasureBubbleContent } from \"../measure-bubble-content/measure-bubble-content\";\n\ninterface SeriesBubbleContentProps {\n  series: ConcreteSeries;\n  datum: Datum;\n  showPrevious: boolean;\n}\n\nexport const SeriesBubbleContent: React.FunctionComponent<SeriesBubbleContentProps> = props => {\n  const { series, datum, showPrevious } = props;\n  if (!showPrevious) {\n    return <React.Fragment>\n      {series.formatValue(datum)}\n    </React.Fragment>;\n  }\n  const currentValue = series.selectValue(datum);\n  const previousValue = series.selectValue(datum, SeriesDerivation.PREVIOUS);\n  const formatter = series.formatter();\n  return <MeasureBubbleContent\n    lowerIsBetter={series.measure.lowerIsBetter}\n    formatter={formatter}\n    current={currentValue}\n    previous={previousValue}\n  />;\n};\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { classNames, isInside } from \"../../utils/dom/dom\";\nimport { BodyPortal } from \"../body-portal/body-portal\";\nimport { GlobalEventListener } from \"../global-event-listener/global-event-listener\";\nimport { Shpitz } from \"../shpitz/shpitz\";\nimport \"./modal-bubble.scss\";\n\ninterface ModalProps {\n  left: number;\n  top: number;\n  onClose: Fn;\n  className?: string;\n}\n\nexport class ModalBubble extends React.Component<ModalProps, {}> {\n\n  modalRef: HTMLDivElement;\n\n  setModalRef = (el: HTMLDivElement) => {\n    this.modalRef = el;\n  };\n\n  onMouseDown = (e: MouseEvent) => {\n    const target = e.target as Element;\n    if (isInside(target, this.modalRef)) return;\n    this.props.onClose();\n  };\n\n  render() {\n    const { className, children, left, top } = this.props;\n    return <React.Fragment>\n      <GlobalEventListener mouseDown={this.onMouseDown} />\n      <BodyPortal left={left} top={top}>\n        <div className={classNames(\"modal-bubble\", className)} ref={this.setModalRef}>\n          {children}\n          <Shpitz direction=\"up\" />\n        </div>\n      </BodyPortal>\n    </React.Fragment>;\n  }\n}\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { STRINGS } from \"../../config/constants\";\nimport { BubbleTitle } from \"../bubble-title/bubble-title\";\nimport { Button } from \"../button/button\";\nimport { ModalBubble } from \"../modal-bubble/modal-bubble\";\nimport \"./highlight-modal.scss\";\n\ninterface HighlightModalProps {\n  title: string;\n  left: number;\n  top: number;\n  dropHighlight: Fn;\n  acceptHighlight: Fn;\n}\n\nexport const HighlightModal: React.FunctionComponent<HighlightModalProps> = ({ title, children, left, top, acceptHighlight, dropHighlight }) =>\n  <ModalBubble className=\"highlight-modal\" left={left} top={top} onClose={dropHighlight}>\n    <BubbleTitle title={title} />\n    <div className=\"value\">{children}</div>\n    <div className=\"actions\">\n      <Button type=\"primary\" className=\"accept mini\" onClick={acceptHighlight} title={STRINGS.select} />\n      <Button type=\"secondary\" className=\"drop mini\" onClick={dropHighlight} title={STRINGS.cancel} />\n    </div>\n  </ModalBubble>;\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { ReactNode } from \"react\";\nimport { BodyPortal } from \"../body-portal/body-portal\";\nimport { BubbleTitle } from \"../bubble-title/bubble-title\";\nimport { Shpitz } from \"../shpitz/shpitz\";\nimport \"./segment-bubble.scss\";\n\nconst OFFSET_V = -10;\n\nexport interface SegmentBubbleProps extends SegmentBubbleContentProps {\n  left: number;\n  top: number;\n}\n\nexport const SegmentBubble: React.FunctionComponent<SegmentBubbleProps> = (props: SegmentBubbleProps) => {\n  const { left, top, title, content } = props;\n  return <BodyPortal left={left} top={top + OFFSET_V}>\n    <div className=\"segment-bubble\">\n      <SegmentBubbleContent title={title} content={content} />\n      <Shpitz direction=\"up\" />\n    </div>\n  </BodyPortal>;\n};\n\nexport interface SegmentBubbleContentProps {\n  title: string;\n  content?: ReactNode;\n}\n\nexport const SegmentBubbleContent: React.FunctionComponent<SegmentBubbleContentProps> = ({ title, content }: SegmentBubbleContentProps) => (\n  <div className=\"segment-bubble-text\">\n    <BubbleTitle title={title} />\n    {content ? <div className=\"content\">{content}</div> : null}\n  </div>\n);\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { Delta } from \"../delta/delta\";\nimport \"./measure-bubble-content.scss\";\n\nexport interface MeasureBubbleContentProps {\n  current: number;\n  previous: number;\n  formatter: Unary<number, string>;\n  lowerIsBetter?: boolean;\n}\n\nexport const MeasureBubbleContent: React.FunctionComponent<MeasureBubbleContentProps> = ({ lowerIsBetter, formatter, current, previous }) => {\n  const currentValue = formatter(current);\n  const previousValue = formatter(previous);\n  return <React.Fragment>\n    <strong className=\"current-value\">{currentValue}</strong>\n    <span className=\"previous-value\">{previousValue}</span>\n    <Delta formatter={formatter} currentValue={current} previousValue={previous} lowerIsBetter={lowerIsBetter} />\n  </React.Fragment>;\n};\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { classNames, roundToHalfPx } from \"../../utils/dom/dom\";\nimport \"./grid-lines.scss\";\n\nexport interface GridLinesProps {\n  orientation: \"horizontal\" | \"vertical\";\n  stage: Stage;\n  ticks: unknown[];\n  scale: Unary<unknown, number>;\n}\n\ninterface Coordinates {\n  x1: number;\n  x2: number;\n  y1: number;\n  y2: number;\n}\n\nfunction lineCoordinates(orientation: \"horizontal\" | \"vertical\", value: number, stage: Stage): Coordinates {\n  switch (orientation) {\n    case \"horizontal\":\n      return { x1: 0, x2: stage.width, y1: value, y2: value };\n    case \"vertical\":\n      return { x1: value, x2: value, y1: 0, y2: stage.height };\n  }\n}\n\nexport const GridLines: React.FunctionComponent<GridLinesProps> = props => {\n  const { orientation, stage, ticks, scale } = props;\n\n  return <g className={classNames(\"grid-lines\", orientation)} transform={stage.getTransform()}>\n    {ticks.map((tick: unknown) => {\n      const value = roundToHalfPx(scale(tick));\n      const coordinates = lineCoordinates(orientation, value, stage);\n      return <line key={String(tick)} {...coordinates} />;\n    })}\n  </g>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { List } from \"immutable\";\nimport { NumberRange as PlywoodNumberRange, Range, TimeRange } from \"plywood\";\nimport { DateRange } from \"../../../common/models/date-range/date-range\";\nimport { FilterClause, FixedTimeFilterClause, NumberFilterClause, NumberRange } from \"../../../common/models/filter-clause/filter-clause\";\nimport { ContinuousRange } from \"../../visualizations/line-chart/utils/continuous-types\";\nimport { isValidClause } from \"../../visualizations/line-chart/utils/is-valid-clause\";\n\nexport function toFilterClause(range: ContinuousRange, reference: string): FilterClause {\n  if (TimeRange.isTimeRange(range)) {\n    const dateRange = new DateRange(range);\n    const values = List.of(dateRange);\n    return new FixedTimeFilterClause({ reference, values });\n  }\n  if (PlywoodNumberRange.isNumberRange(range)) {\n    const numberRange = new NumberRange(range);\n    const values = List.of(numberRange);\n    return new NumberFilterClause({ reference, values });\n  }\n  throw new Error(`Expected Number or Time range, got: ${range}`);\n}\n\nexport function toPlywoodRange(clause: FilterClause): ContinuousRange {\n  if (!isValidClause(clause)) {\n    throw new Error(`Expected Number or FixedTime Filter Clause. Got ${clause}`);\n  }\n  const value = clause.values.first();\n  return Range.fromJS(value) as ContinuousRange;\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { FilterClause, FixedTimeFilterClause, NumberFilterClause } from \"../../../../common/models/filter-clause/filter-clause\";\n\nexport function isValidClause(clause: FilterClause): clause is FixedTimeFilterClause | NumberFilterClause {\n  return (clause instanceof FixedTimeFilterClause) || (clause instanceof NumberFilterClause);\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Datum } from \"plywood\";\nimport React from \"react\";\nimport { ConcreteSeries, SeriesDerivation } from \"../../../common/models/series/concrete-series\";\nimport { Delta } from \"../delta/delta\";\n\nexport interface ColorEntry {\n  color: string;\n  name: string;\n  value: string;\n  previous?: string;\n  delta?: JSX.Element;\n}\n\ninterface Parameters {\n  color: string;\n  name: string;\n  series: ConcreteSeries;\n  datum: Datum;\n  hasComparison: boolean;\n}\n\nexport function createColorEntry({ color, name, series, datum, hasComparison }: Parameters): ColorEntry {\n  const current = {\n    color,\n    name,\n    value: series.formatValue(datum)\n  };\n\n  if (!hasComparison) return current;\n\n  return {\n    ...current,\n    previous: series.formatValue(datum, SeriesDerivation.PREVIOUS),\n    delta: <Delta\n      currentValue={series.selectValue(datum)}\n      previousValue={series.selectValue(datum, SeriesDerivation.PREVIOUS)}\n      lowerIsBetter={series.measure.lowerIsBetter}\n      formatter={series.formatter()} />\n  };\n}\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Datum } from \"plywood\";\nimport React from \"react\";\nimport { ConcreteSeries, SeriesDerivation } from \"../../../common/models/series/concrete-series\";\nimport { Delta } from \"../delta/delta\";\nimport \"./vis-measure-label.scss\";\n\nexport interface VisMeasureLabelProps {\n  series: ConcreteSeries;\n  datum: Datum;\n  showPrevious: boolean;\n}\n\nfunction renderPrevious(datum: Datum, series: ConcreteSeries): JSX.Element {\n  const current = series.selectValue(datum, SeriesDerivation.CURRENT);\n  const previous = series.selectValue(datum, SeriesDerivation.PREVIOUS);\n  const formatter = series.formatter();\n  return <React.Fragment>\n    <span className=\"measure-previous-value\">\n      {formatter(previous)}\n      </span>\n    <Delta\n      formatter={formatter}\n      lowerIsBetter={series.measure.lowerIsBetter}\n      currentValue={current}\n      previousValue={previous} />\n  </React.Fragment>;\n}\n\nexport const VisMeasureLabel: React.FunctionComponent<VisMeasureLabelProps> = ({ series, datum, showPrevious }) => {\n  return <div className=\"vis-measure-label\">\n    <span className=\"measure-title\">{series.title()}</span>\n    <span className=\"colon\">: </span>\n    <span className=\"measure-value\">{series.formatValue(datum)}</span>\n    {showPrevious && renderPrevious(datum, series)}\n  </div>;\n};\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { roundToHalfPx } from \"../../utils/dom/dom\";\nimport \"./vertical-axis.scss\";\n\nconst TEXT_OFFSET = 2;\n\nexport interface VerticalAxisProps {\n  stage: Stage;\n  ticks: number[];\n  tickSize: number;\n  scale: any;\n  formatter: Unary<number, string>;\n  topLineExtend?: number;\n  hideZero?: boolean;\n}\n\nexport const VerticalAxis: React.FunctionComponent<VerticalAxisProps> = ({ formatter, stage, tickSize, ticks: inputTicks, scale, topLineExtend = 0, hideZero }) => {\n  const ticks = hideZero ? inputTicks.filter((tick: number) => tick !== 0) : inputTicks;\n\n  const lines = ticks.map((tick: any) => {\n    const y = roundToHalfPx(scale(tick));\n    return <line className=\"tick\" key={String(tick)} x1={0} y1={y} x2={tickSize} y2={y} />;\n  });\n\n  const labelX = tickSize + TEXT_OFFSET;\n  const dy = \"0.31em\";\n\n  const labels = ticks.map((tick: any) => {\n    const y = scale(tick);\n    return <text className=\"tick\" key={String(tick)} x={labelX} y={y} dy={dy}>{formatter(tick)}</text>;\n  });\n\n  return <g className=\"vertical-axis\" transform={stage.getTransform()}>\n    <line className=\"border\" x1={0.5} y1={-topLineExtend} x2={0.5} y2={stage.height} />\n    {lines}\n    {labels}\n  </g>;\n};\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { ColorEntry } from \"./color-entry\";\nimport \"./color-swabs.scss\";\n\ninterface ColorSwabsProps {\n  colorEntries: ColorEntry[];\n}\n\nexport const ColorSwabs: React.FunctionComponent<ColorSwabsProps> = ({ colorEntries }) => {\n  const colorSwabs = colorEntries.map(({ color, name, value, previous, delta }: ColorEntry) => {\n    const swabStyle = { background: color };\n    return <tr key={name}>\n      <td>\n        <div className=\"color-swab\" style={swabStyle} />\n      </td>\n      <td className=\"color-name\">{name}</td>\n      <td className=\"color-value\">{value}</td>\n      {previous && <td className=\"color-previous\">{previous}</td>}\n      {delta && <td className=\"color-delta\">{delta}</td>}\n    </tr>;\n  });\n\n  return <table className=\"color-swabs\">\n    <tbody>{colorSwabs}</tbody>\n  </table>;\n};\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport * as d3 from \"d3\";\nimport { Datum } from \"plywood\";\nimport { ConcreteSeries, SeriesDerivation } from \"../../../common/models/series/concrete-series\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { readNumber } from \"../../../common/utils/general/general\";\n\nexport type Selector = Unary<Datum, number>;\nexport type Extent = [number, number];\n\nexport function seriesSelectors(series: ConcreteSeries, hasComparison: boolean): Selector[] {\n  const get = (d: Datum) => readNumber(series.selectValue(d));\n  if (!hasComparison) return [get];\n  return [\n    get,\n    (d: Datum) => readNumber(series.selectValue(d, SeriesDerivation.PREVIOUS))\n  ];\n}\n\nexport function datumsExtent(datums: Datum[], selectors: Selector[]): Extent {\n  return selectors.reduce((acc, selector) => {\n    const extent =  d3.extent(datums, selector);\n    return d3.extent([...extent, ...acc]);\n  }, [0, 0]) as Extent;\n}\n","/*\n * Copyright 2017-2022 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React, { useMemo, useState } from \"react\";\nimport { colorSplitLimits } from \"../../../common/models/colors/colors\";\nimport { granularityToString } from \"../../../common/models/granularity/granularity\";\nimport { DimensionSortOn, SortOn } from \"../../../common/models/sort-on/sort-on\";\nimport { useSettingsContext } from \"../../views/cube-view/settings-context\";\nimport { getContinuousSplit } from \"../../visualizations/line-chart/utils/splits\";\nimport { GranularityPicker } from \"../split-menu/granularity-picker\";\nimport { LimitDropdown } from \"../split-menu/limit-dropdown\";\nimport { SortDropdown } from \"../split-menu/sort-dropdown\";\nimport { SplitMenuProps } from \"../split-menu/split-menu\";\nimport { createSplit, SplitMenuBase, validateSplit } from \"../split-menu/split-menu-base\";\n\nconst TimeSeriesContinuousSplitMenu: React.FunctionComponent<SplitMenuProps> = props => {\n  const { saveSplit, containerStage, split, dimension, onClose, openOn } = props;\n  const [granularity, setGranularity] = useState(() => split.bucket && granularityToString(split.bucket));\n\n  const onSave = () => {\n    const newSplit = createSplit({\n      dimension,\n      split,\n      granularity\n    });\n    saveSplit(split, newSplit);\n  };\n\n  const isValid = validateSplit({ split, dimension, granularity });\n\n  return <SplitMenuBase\n    openOn={openOn}\n    containerStage={containerStage}\n    onClose={onClose}\n    onSave={onSave}\n    dimension={dimension}\n    isValid={isValid}>\n    <GranularityPicker\n      granularity={granularity}\n      dimension={dimension}\n      granularityChange={setGranularity}/>\n  </SplitMenuBase>;\n};\n\nconst TimeSeriesCategorySplitMenu: React.FunctionComponent<SplitMenuProps> = props => {\n  const { openOn, containerStage, onClose, dimension, saveSplit, split, essence } = props;\n\n  const sortOptions = [\n    new DimensionSortOn(dimension),\n    ...essence.seriesSortOns(true).toArray()\n  ];\n\n  const { customization: { visualizationColors: { series } } } = useSettingsContext();\n  const limitOptions = useMemo(() => colorSplitLimits(series.length), [series.length]);\n\n  const [sort, setSort] = useState(split.sort);\n  const [limit, setLimit] = useState(split.limit);\n\n  const isValid = validateSplit({ split, dimension, limit, sort });\n\n  const onSave = () => {\n    const newSplit = createSplit({\n      dimension,\n      split,\n      limit,\n      sort\n    });\n    saveSplit(split, newSplit);\n  };\n\n  return <SplitMenuBase\n    openOn={openOn}\n    containerStage={containerStage}\n    onClose={onClose}\n    onSave={onSave}\n    dimension={dimension}\n    isValid={isValid}>\n    <SortDropdown\n      direction={sort.direction}\n      selected={SortOn.fromSort(sort, essence)}\n      options={sortOptions}\n      onChange={setSort}/>\n    <LimitDropdown\n      selectedLimit={limit}\n      limits={limitOptions}\n      includeNone={false}\n      onLimitSelect={setLimit}/>\n  </SplitMenuBase>;\n};\n\nexport const TimeSeriesSplitMenu: React.FunctionComponent<SplitMenuProps> = props => {\n  const { essence, split } = props;\n\n  const isContinuousSplit = split.equals(getContinuousSplit(essence));\n\n  if (isContinuousSplit) {\n    return <TimeSeriesContinuousSplitMenu {...props} />;\n  } else {\n    return <TimeSeriesCategorySplitMenu {...props} />;\n  }\n};\n","/*\n * Copyright 2017-2022 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { VisualizationControls, VisualizationControlsBaseProps } from \"../../views/cube-view/center-panel/center-panel\";\nimport { SplitTile, SplitTileBaseProps } from \"../split-tile/split-tile\";\nimport { SplitTilesRow, SplitTilesRowBaseProps } from \"../split-tile/split-tiles-row\";\nimport { TimeSeriesSplitMenu } from \"./split-menu\";\n\nconst TimeSeriesSplitTile: React.FunctionComponent<SplitTileBaseProps> = props =>\n  <SplitTile splitMenuComponent={TimeSeriesSplitMenu} {...props} />;\n\nconst TimeSeriesSplitTilesRow: React.FunctionComponent<SplitTilesRowBaseProps> = props =>\n  <SplitTilesRow {...props} splitTileComponent={TimeSeriesSplitTile}/>;\n\nexport const TimeSeriesVisualizationControls: React.FunctionComponent<VisualizationControlsBaseProps> = props =>\n  <VisualizationControls {...props} splitTilesRow={TimeSeriesSplitTilesRow}/>;\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { roundToHalfPx } from \"../../utils/dom/dom\";\nimport \"./grid-border.scss\";\n\ninterface BottomBorderProps {\n  stage: Stage;\n  tickLength: number;\n}\n\nexport const BottomBorder: React.FunctionComponent<BottomBorderProps> = ({ stage, tickLength }) => {\n  return <line\n    className=\"grid-border grid-bottom-border\"\n    transform={stage.getTransform()}\n    x1={0}\n    x2={stage.width + tickLength}\n    y1={roundToHalfPx(stage.height - 1)}\n    y2={roundToHalfPx(stage.height - 1)}\n  />;\n};\n\ninterface RightBorderProps {\n stage: Stage;\n}\n\nexport const RightBorder: React.FunctionComponent<RightBorderProps> = ({ stage }) => {\n  return <line\n    className=\"grid-border grid-right-border\"\n    transform={stage.getTransform()}\n    x1={roundToHalfPx(stage.width - 1)}\n    x2={roundToHalfPx(stage.width - 1)}\n    y1={0}\n    y2={stage.height} />;\n};\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport \"./highlighter.scss\";\n\nexport interface HighlighterProps {\n  left: number;\n  right: number;\n  top?: number;\n  bottom?: number;\n}\n\nexport function Highlighter(props: HighlighterProps) {\n  const { left, bottom = 0, right, top = 0 } = props;\n\n  const whiteoutLeftStyle = {\n    width: Math.max(left, 0)\n  };\n\n  const frameStyle = {\n    left,\n    top,\n    bottom,\n    width: Math.max(right - left, 0)\n  };\n\n  const whiteoutRightStyle = {\n    left: right\n  };\n\n  return <div className=\"highlighter\">\n    <div className=\"whiteout left\" style={whiteoutLeftStyle} />\n    <div className=\"frame\" style={frameStyle} />\n    <div className=\"whiteout right\" style={whiteoutRightStyle} />\n  </div>;\n}\n","import _typeof from \"./typeof.js\";\nimport toPrimitive from \"./toPrimitive.js\";\nexport default function _toPropertyKey(arg) {\n  var key = toPrimitive(arg, \"string\");\n  return _typeof(key) === \"symbol\" ? key : String(key);\n}","import _typeof from \"./typeof.js\";\nexport default function _toPrimitive(input, hint) {\n  if (_typeof(input) !== \"object\" || input === null) return input;\n  var prim = input[Symbol.toPrimitive];\n\n  if (prim !== undefined) {\n    var res = prim.call(input, hint || \"default\");\n    if (_typeof(res) !== \"object\") return res;\n    throw new TypeError(\"@@toPrimitive must return a primitive value.\");\n  }\n\n  return (hint === \"string\" ? String : Number)(input);\n}","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Timezone } from \"chronoshift\";\nimport { List, OrderedMap } from \"immutable\";\nimport { Dataset, Datum } from \"plywood\";\nimport { VisualizationColors } from \"../../../../../common/models/colors/colors\";\nimport { ClientCustomization } from \"../../../../../common/models/customization/customization\";\nimport { Dimension } from \"../../../../../common/models/dimension/dimension\";\nimport { Essence } from \"../../../../../common/models/essence/essence\";\nimport { ConcreteSeries } from \"../../../../../common/models/series/concrete-series\";\nimport { Split } from \"../../../../../common/models/split/split\";\nimport { Omit } from \"../../../../../common/utils/functional/functional\";\nimport { selectFirstSplitDatums } from \"../../../../utils/dataset/selectors/selectors\";\nimport { getContinuousSplit, getNominalDimension, getNominalSplit, hasNominalSplit } from \"../../../line-chart/utils/splits\";\n\nenum ModelVariantId { BASE, STACKED }\n\ninterface BarChartModelCommons {\n  variant: ModelVariantId;\n  continuousSplit: Split;\n  timezone: Timezone;\n  hasComparison: boolean;\n  series: List<ConcreteSeries>;\n}\n\nexport interface BaseBarChartModel extends BarChartModelCommons {\n  variant: ModelVariantId.BASE;\n}\n\ntype Color = string;\n\ntype ColorMap = OrderedMap<string, Color>;\n\nexport interface StackedBarChartModel extends BarChartModelCommons {\n  variant: ModelVariantId.STACKED;\n  colors: ColorMap;\n  nominalSplit: Split;\n  nominalDimension: Dimension;\n}\n\nexport type BarChartModel = BaseBarChartModel | StackedBarChartModel;\n\nexport function isStacked(model: BarChartModel): model is StackedBarChartModel {\n  return model.variant === ModelVariantId.STACKED;\n}\n\nfunction readCommons(essence: Essence): Omit<BarChartModelCommons, \"variant\"> {\n  const continuousSplit = getContinuousSplit(essence);\n  const hasComparison = essence.hasComparison();\n  const timezone = essence.timezone;\n  const series = essence.getConcreteSeries();\n  return {\n    continuousSplit,\n    hasComparison,\n    timezone,\n    series\n  };\n}\n\nfunction createColorMap(nominalSplit: Split, dataset: Dataset, colors: VisualizationColors): ColorMap {\n  const datums = selectFirstSplitDatums(dataset);\n  return datums.reduce<ColorMap>((map: ColorMap, datum: Datum, i: number) => {\n    const key = String(nominalSplit.selectValue(datum));\n    const colorIndex = i % colors.series.length;\n    const color = colors.series[colorIndex];\n    return map.set(key, color);\n  }, OrderedMap<string, Color>());\n}\n\nexport function create(essence: Essence, dataset: Dataset, customization: ClientCustomization): BarChartModel {\n  const { visualizationColors } = customization;\n  const commons = readCommons(essence);\n  if (!hasNominalSplit(essence)) {\n    return {\n      ...commons,\n      variant: ModelVariantId.BASE\n    };\n  }\n  const nominalSplit = getNominalSplit(essence);\n  const nominalDimension = getNominalDimension(essence);\n  const colors = createColorMap(nominalSplit, dataset, visualizationColors);\n  return {\n    ...commons,\n    variant: ModelVariantId.STACKED,\n    nominalSplit,\n    nominalDimension,\n    colors\n  };\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Datum } from \"plywood\";\nimport React from \"react\";\nimport { ConcreteSeries } from \"../../../../../common/models/series/concrete-series\";\nimport { createColorEntry } from \"../../../../components/color-swabs/color-entry\";\nimport { ColorSwabs } from \"../../../../components/color-swabs/color-swabs\";\nimport { SeriesBubbleContent } from \"../../../../components/series-bubble-content/series-bubble-content\";\nimport { selectSplitDatums } from \"../../../../utils/dataset/selectors/selectors\";\nimport { BarChartModel, isStacked, StackedBarChartModel } from \"../utils/bar-chart-model\";\n\ninterface ContentProps {\n  model: BarChartModel;\n  datum: Datum;\n  series: ConcreteSeries;\n}\n\nfunction colorEntries(datum: Datum, series: ConcreteSeries, model: StackedBarChartModel) {\n  const { nominalSplit, colors, hasComparison } = model;\n  const datums = selectSplitDatums(datum);\n  const colorEntries = colors.entrySeq().toArray();\n  return colorEntries.map(([name, color]) => {\n    const datum = datums.find(d => String(nominalSplit.selectValue(d)) === name);\n\n    if (!datum) {\n      return { color, name, value: \"-\" };\n    }\n\n    return createColorEntry({ color, name, hasComparison, datum, series });\n  });\n}\n\nexport const Content: React.FunctionComponent<ContentProps> = props => {\n  const { model, series, datum } = props;\n  if (isStacked(model)) {\n    const entries = colorEntries(datum, series, model);\n    return <ColorSwabs colorEntries={entries} />;\n  }\n  return <SeriesBubbleContent series={series} datum={datum} showPrevious={model.hasComparison}/>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Datum } from \"plywood\";\nimport { safeEquals } from \"../../../../../common/utils/immutable-utils/immutable-utils\";\n\nenum InteractionKind { HOVER, HIGHLIGHT }\n\ninterface InteractionBase {\n  kind: InteractionKind;\n  datum: Datum;\n  key: string;\n}\n\nexport interface Hover extends InteractionBase {\n  kind: InteractionKind.HOVER;\n}\n\nexport const createHover = (key: string, datum: Datum): Hover => ({\n  kind: InteractionKind.HOVER,\n  datum,\n  key\n});\n\nexport const isHover = (interaction?: Interaction): interaction is Hover => interaction && interaction.kind === InteractionKind.HOVER;\n\nexport interface Highlight extends InteractionBase {\n  kind: InteractionKind.HIGHLIGHT;\n}\n\nexport const createHighlight = (key: string, datum: Datum): Highlight => ({\n  kind: InteractionKind.HIGHLIGHT,\n  datum,\n  key\n});\n\nexport const isHighlight = (interaction?: Interaction): interaction is Highlight => interaction && interaction.kind === InteractionKind.HIGHLIGHT;\n\nexport type Interaction = Hover | Highlight;\n\nexport function equalInteractions(a: Interaction, b: Interaction): boolean {\n  return a.kind === b.kind\n    && a.key === b.key\n    && safeEquals(a.datum, b.datum);\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { ConcreteSeries } from \"../../../../../common/models/series/concrete-series\";\nimport { SegmentBubble } from \"../../../../components/segment-bubble/segment-bubble\";\nimport { LinearScale } from \"../../../../utils/linear-scale/linear-scale\";\nimport { Hover } from \"../interactions/interaction\";\nimport { BarChartModel } from \"../utils/bar-chart-model\";\nimport { DomainValue } from \"../utils/x-domain\";\nimport { XScale } from \"../utils/x-scale\";\nimport { Content } from \"./tooltip-content\";\n\ninterface HoverTooltipProps {\n  interaction: Hover;\n  xScale: XScale;\n  yScale: LinearScale;\n  series: ConcreteSeries;\n  model: BarChartModel;\n  rect: ClientRect | DOMRect;\n}\n\nexport const HoverTooltip: React.FunctionComponent<HoverTooltipProps> = props => {\n  const {\n    model,\n    rect: { left, top },\n    interaction: { datum },\n    series,\n    xScale,\n    yScale\n  } = props;\n  const { continuousSplit, timezone } = model;\n  const y = yScale(series.selectValue(datum));\n  const xValue = continuousSplit.selectValue<DomainValue>(datum);\n  const x = xScale.calculate(xValue) + (xScale.bandwidth() / 2);\n  return <SegmentBubble\n    top={top + y}\n    left={left + x}\n    title={continuousSplit.formatValue(datum, timezone)}\n    content={<Content model={model} datum={datum} series={series}/>} />;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { ConcreteSeries } from \"../../../../../common/models/series/concrete-series\";\nimport { Nullary } from \"../../../../../common/utils/functional/functional\";\nimport { HighlightModal as BaseHighlightModal } from \"../../../../components/highlight-modal/highlight-modal\";\nimport { LinearScale } from \"../../../../utils/linear-scale/linear-scale\";\nimport { Highlight } from \"../interactions/interaction\";\nimport { BarChartModel } from \"../utils/bar-chart-model\";\nimport { DomainValue } from \"../utils/x-domain\";\nimport { XScale } from \"../utils/x-scale\";\n\ninterface HighlightModalProps {\n  interaction: Highlight;\n  dropHighlight: Nullary<void>;\n  acceptHighlight: Nullary<void>;\n  xScale: XScale;\n  yScale: LinearScale;\n  series: ConcreteSeries;\n  model: BarChartModel;\n  rect: ClientRect | DOMRect;\n}\n\nexport const HighlightModal: React.FunctionComponent<HighlightModalProps> = props => {\n  const {\n    model: { timezone, continuousSplit },\n    rect: { left, top },\n    interaction: { datum },\n    dropHighlight,\n    acceptHighlight,\n    yScale,\n    series,\n    xScale } = props;\n  const xValue = continuousSplit.selectValue<DomainValue>(datum);\n  const x = xScale.calculate(xValue) + (xScale.bandwidth() / 2);\n  const yValue = series.selectValue(datum);\n  const y = yScale(yValue);\n  return <BaseHighlightModal\n    title={continuousSplit.formatValue(datum, timezone)}\n    left={left + x}\n    top={top + y}\n    dropHighlight={dropHighlight}\n    acceptHighlight={acceptHighlight} />;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Datum } from \"plywood\";\nimport React from \"react\";\nimport { ConcreteSeries, SeriesDerivation } from \"../../../../../common/models/series/concrete-series\";\nimport { Stage } from \"../../../../../common/models/stage/stage\";\nimport { Highlighter } from \"../../../../components/highlighter/highlighter\";\nimport { LinearScale } from \"../../../../utils/linear-scale/linear-scale\";\nimport { TOP_PADDING } from \"../bar/padding\";\nimport { Highlight } from \"../interactions/interaction\";\nimport { BarChartModel } from \"../utils/bar-chart-model\";\nimport { DomainValue } from \"../utils/x-domain\";\nimport { XScale } from \"../utils/x-scale\";\n\ninterface HighlightOverlayProps {\n  interaction: Highlight;\n  xScale: XScale;\n  yScale: LinearScale;\n  series: ConcreteSeries;\n  stage: Stage;\n  model: BarChartModel;\n}\n\nfunction getYValue(datum: Datum, series: ConcreteSeries, includePrevious: boolean): number {\n  if (!includePrevious) {\n    return series.selectValue(datum);\n  }\n  return Math.max(series.selectValue(datum), series.selectValue(datum, SeriesDerivation.PREVIOUS));\n}\n\nexport const HighlightOverlay: React.FunctionComponent<HighlightOverlayProps> = props => {\n  const { stage, yScale, series, xScale, model: { hasComparison, continuousSplit }, interaction: { datum } } = props;\n  const xValue = continuousSplit.selectValue<DomainValue>(datum);\n  const left = xScale.calculate(xValue);\n  const right = left + xScale.bandwidth();\n  const yValue = getYValue(datum, series, hasComparison);\n  const top = yScale(yValue) + stage.y - TOP_PADDING;\n  return <Highlighter left={left} right={right} top={top} />;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nexport const SIDE_PADDING = 5;\nexport const TOP_PADDING = 5;\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { ConcreteSeries } from \"../../../../../common/models/series/concrete-series\";\nimport { Stage } from \"../../../../../common/models/stage/stage\";\nimport { Nullary } from \"../../../../../common/utils/functional/functional\";\nimport { LinearScale } from \"../../../../utils/linear-scale/linear-scale\";\nimport { HoverTooltip } from \"../hover-tooltip/hover-tooltip\";\nimport { Interaction, isHighlight, isHover } from \"../interactions/interaction\";\nimport { BarChartModel } from \"../utils/bar-chart-model\";\nimport { XScale } from \"../utils/x-scale\";\nimport { HighlightModal } from \"./highlight-modal\";\nimport { HighlightOverlay } from \"./highlight-overlay\";\n\ninterface ForegroundProps {\n  interaction: Interaction;\n  container: React.RefObject<HTMLDivElement>;\n  dropHighlight: Nullary<void>;\n  acceptHighlight: Nullary<void>;\n  xScale: XScale;\n  yScale: LinearScale;\n  series: ConcreteSeries;\n  model: BarChartModel;\n  stage: Stage;\n}\n\nexport const Foreground: React.FunctionComponent<ForegroundProps> = props => {\n  const { stage, dropHighlight, acceptHighlight, container, model, series, xScale, yScale, interaction } = props;\n  const rect = container.current.getBoundingClientRect();\n  return <React.Fragment>\n    {isHighlight(interaction) && <React.Fragment>\n      <HighlightModal\n        interaction={interaction}\n        dropHighlight={dropHighlight}\n        acceptHighlight={acceptHighlight}\n        xScale={xScale}\n        yScale={yScale}\n        model={model}\n        series={series}\n        rect={rect} />\n      <HighlightOverlay\n        interaction={interaction}\n        stage={stage}\n        xScale={xScale}\n        yScale={yScale}\n        series={series}\n        model={model} />\n    </React.Fragment>}\n    {isHover(interaction) && <HoverTooltip\n      rect={rect}\n      interaction={interaction}\n      xScale={xScale}\n      yScale={yScale}\n      series={series}\n      model={model} />}\n  </React.Fragment>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Stage } from \"../../../../../common/models/stage/stage\";\nimport { ScrollerLayout } from \"../../../../components/scroller/scroller\";\nimport { calculateSegmentStage } from \"./calculate-segment-stage\";\n\nconst Y_AXIS_WIDTH = 60;\nconst X_AXIS_HEIGHT = 40;\nconst LEFT_PADDING = 5;\nconst MARGINS: Margins = {\n  left: LEFT_PADDING,\n  right: Y_AXIS_WIDTH,\n  bottom: X_AXIS_HEIGHT\n};\n\ninterface Margins {\n  left: number;\n  right: number;\n  bottom: number;\n}\n\nexport interface BarChartLayout {\n  scroller: ScrollerLayout;\n  segment: Stage;\n}\n\nexport function calculateLayout(visualisationStage: Stage, domainLength: number, seriesCount: number): BarChartLayout {\n  const bodyStage = visualisationStage.within(MARGINS);\n  const segmentStage = calculateSegmentStage(bodyStage, domainLength, seriesCount);\n  const innerBodyHeight = segmentStage.height * seriesCount;\n  return {\n    scroller: {\n      bodyHeight: innerBodyHeight,\n      bodyWidth: segmentStage.width,\n      top: 0,\n      left: MARGINS.left,\n      right: MARGINS.right,\n      bottom: MARGINS.bottom\n    },\n    segment: segmentStage\n  };\n}\n\nconst TOP_MARGIN = 30;\nconst BOTTOM_MARGIN = 0;\n\nexport function calculateChartStage(segmentStage: Stage): Stage {\n  return segmentStage.within({ top: TOP_MARGIN, bottom: BOTTOM_MARGIN });\n}\n\nexport function calculateYAxisStage(segmentStage: Stage): Stage {\n  return Stage.fromJS({\n    x: 0,\n    y: TOP_MARGIN,\n    width: Y_AXIS_WIDTH,\n    height: segmentStage.height - TOP_MARGIN - BOTTOM_MARGIN\n  });\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Stage } from \"../../../../../common/models/stage/stage\";\n\nconst BAR_MIN_WIDTH = 30;\nconst MIN_CHART_HEIGHT = 200;\n\nexport function calculateSegmentStage(bodyStage: Stage, domainSize: number, seriesCount: number): Stage {\n  const width = Math.max(bodyStage.width, domainSize * BAR_MIN_WIDTH);\n  const availableHeight = bodyStage.height;\n  const heightFromEvenDivision = Math.floor(availableHeight / seriesCount);\n  const height = Math.max(MIN_CHART_HEIGHT, heightFromEvenDivision);\n  return Stage.fromSize(width, height);\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Datum } from \"plywood\";\nimport { ConcreteSeries } from \"../../../../../common/models/series/concrete-series\";\nimport { datumsExtent, Extent, seriesSelectors } from \"../../../../utils/extent/extent\";\n\nexport function yExtent(datums: Datum[], series: ConcreteSeries, hasComparison: boolean): Extent {\n  return datumsExtent(datums, seriesSelectors(series, hasComparison));\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Datum } from \"plywood\";\nimport React from \"react\";\nimport { ConcreteSeries } from \"../../../../../common/models/series/concrete-series\";\nimport { LinearScale } from \"../../../../utils/linear-scale/linear-scale\";\nimport { useSettingsContext } from \"../../../../views/cube-view/settings-context\";\nimport { BaseBarChartModel } from \"../utils/bar-chart-model\";\nimport { DomainValue } from \"../utils/x-domain\";\nimport { XScale } from \"../utils/x-scale\";\nimport { SIDE_PADDING } from \"./padding\";\n\ninterface SingleBarProps {\n  datum: Datum;\n  yScale: LinearScale;\n  xScale: XScale;\n  series: ConcreteSeries;\n  model: BaseBarChartModel;\n}\n\nexport const SingleBar: React.FunctionComponent<SingleBarProps> = props => {\n  const { customization: { visualizationColors } } = useSettingsContext();\n  const { datum, xScale, yScale, model: { continuousSplit }, series } = props;\n  const [maxHeight] = yScale.range();\n  const x = continuousSplit.selectValue<DomainValue>(datum);\n  const xPos = xScale.calculate(x) + SIDE_PADDING;\n  const width = xScale.bandwidth() - (2 * SIDE_PADDING);\n  const y = series.selectValue(datum);\n  const yPos = yScale(y);\n  const height = maxHeight - yPos;\n  const fill = visualizationColors.main;\n\n  return <rect\n    className=\"bar-chart-bar\"\n    x={xPos}\n    y={yPos}\n    fill={fill}\n    width={width}\n    height={height} />;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Datum } from \"plywood\";\nimport React from \"react\";\nimport { alphaMain } from \"../../../../../common/models/colors/colors\";\nimport { ConcreteSeries, SeriesDerivation } from \"../../../../../common/models/series/concrete-series\";\nimport { LinearScale } from \"../../../../utils/linear-scale/linear-scale\";\nimport { useSettingsContext } from \"../../../../views/cube-view/settings-context\";\nimport { BaseBarChartModel } from \"../utils/bar-chart-model\";\nimport { DomainValue } from \"../utils/x-domain\";\nimport { XScale } from \"../utils/x-scale\";\nimport { SIDE_PADDING } from \"./padding\";\n\ninterface SingleTimeShiftBar {\n  datum: Datum;\n  yScale: LinearScale;\n  xScale: XScale;\n  series: ConcreteSeries;\n  model: BaseBarChartModel;\n}\n\nexport const SingleTimeShiftBar: React.FunctionComponent<SingleTimeShiftBar> = props => {\n  const { customization: { visualizationColors } } = useSettingsContext();\n  const { datum, xScale, yScale, model: { continuousSplit }, series } = props;\n  const [maxHeight] = yScale.range();\n  const x = continuousSplit.selectValue<DomainValue>(datum);\n  const xStart = xScale.calculate(x);\n  const rangeBand = xScale.bandwidth();\n  const fullWidth = rangeBand - 2 * SIDE_PADDING;\n  const barWidth = fullWidth * 2 / 3;\n\n  const yCurrent = series.selectValue(datum);\n  const yPrevious = series.selectValue(datum, SeriesDerivation.PREVIOUS);\n  const yCurrentStart = yScale(yCurrent);\n  const yPreviousStart = yScale(yPrevious);\n\n  const currentFill = visualizationColors.main;\n  const previousFill = alphaMain(visualizationColors);\n\n  return <React.Fragment>\n    <rect\n      className=\"bar-chart-bar-previous\"\n      x={xStart + rangeBand - SIDE_PADDING - barWidth}\n      y={yPreviousStart}\n      fill={previousFill}\n      width={barWidth}\n      height={maxHeight - yPreviousStart} />\n    <rect\n      className=\"bar-chart-bar\"\n      x={xStart + SIDE_PADDING}\n      y={yCurrentStart}\n      fill={currentFill}\n      width={barWidth}\n      height={maxHeight - yCurrentStart} />\n  </React.Fragment>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Datum } from \"plywood\";\nimport { ConcreteSeries, SeriesDerivation } from \"../../../../../common/models/series/concrete-series\";\nimport { cons, threadConditionally } from \"../../../../../common/utils/functional/functional\";\nimport { SPLIT } from \"../../../../config/constants\";\nimport { selectSplitDataset, selectSplitDatums } from \"../../../../utils/dataset/selectors/selectors\";\n\nexport function selectBase(datum: Datum, series: ConcreteSeries, period = SeriesDerivation.CURRENT): number {\n  return datum[stackBaseKey(series, period)] as number;\n}\n\nfunction stackBaseKey(series: ConcreteSeries, period = SeriesDerivation.CURRENT): string {\n  return `__stack_base_${series.plywoodKey(period)}`;\n}\n\nfunction stackBy(series: ConcreteSeries, period = SeriesDerivation.CURRENT) {\n  return (datum: Datum): Datum => {\n    const values = selectSplitDatums(datum);\n    const { y0, stacked } = values.reduce(({ y0, stacked }, value) => {\n      const y = series.selectValue(value, period);\n      const baseKey = stackBaseKey(series, period);\n\n      return {\n        y0: y + y0,\n        stacked: cons(stacked, { ...value, [baseKey]: y0 })\n      };\n\n    }, { y0: 0, stacked: [] });\n\n    const maxKey = series.plywoodKey(period);\n    return {\n      ...datum,\n      [maxKey]: y0,\n      [SPLIT]: selectSplitDataset(datum).changeData(stacked)\n    };\n  };\n}\n\nexport function stack(datums: Datum[], series: ConcreteSeries, includePrevious: boolean): Datum[] {\n  return datums.map(datum =>\n    threadConditionally(datum,\n      stackBy(series),\n      includePrevious && stackBy(series, SeriesDerivation.PREVIOUS)));\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Datum } from \"plywood\";\nimport React from \"react\";\nimport { ConcreteSeries } from \"../../../../../common/models/series/concrete-series\";\nimport { selectSplitDatums } from \"../../../../utils/dataset/selectors/selectors\";\nimport { LinearScale } from \"../../../../utils/linear-scale/linear-scale\";\nimport { StackedBarChartModel } from \"../utils/bar-chart-model\";\nimport { selectBase } from \"../utils/stack-layout\";\nimport { DomainValue } from \"../utils/x-domain\";\nimport { XScale } from \"../utils/x-scale\";\nimport { SIDE_PADDING } from \"./padding\";\n\ninterface StackedBarProps {\n  model: StackedBarChartModel;\n  datum: Datum;\n  yScale: LinearScale;\n  xScale: XScale;\n  series: ConcreteSeries;\n}\n\nexport const StackedBar: React.FunctionComponent<StackedBarProps> = props => {\n  const { datum, xScale, yScale, series, model: { colors, continuousSplit, nominalSplit } } = props;\n  const datums = selectSplitDatums(datum);\n\n  const x = continuousSplit.selectValue<DomainValue>(datum);\n  const xPos = xScale.calculate(x) + SIDE_PADDING;\n  const width = xScale.bandwidth() - (2 * SIDE_PADDING);\n  const color = (d: Datum) => colors.get(String(nominalSplit.selectValue(d)));\n  return <React.Fragment>\n    {datums.map(datum => {\n      const key = String(nominalSplit.selectValue(datum));\n      const y = series.selectValue(datum);\n      const y0 = selectBase(datum, series);\n      const yPos = yScale(y + y0);\n      const height = yScale(y0) - yScale(y + y0);\n\n      return <rect\n        className=\"bar-chart-bar-segment\"\n        key={String(key)}\n        x={xPos}\n        y={yPos}\n        width={width}\n        height={height}\n        fill={color(datum)}\n      />;\n    })}\n  </React.Fragment>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as d3 from \"d3\";\nimport { Datum } from \"plywood\";\nimport React from \"react\";\nimport { ConcreteSeries, SeriesDerivation } from \"../../../../../common/models/series/concrete-series\";\nimport { selectSplitDatums } from \"../../../../utils/dataset/selectors/selectors\";\nimport { LinearScale } from \"../../../../utils/linear-scale/linear-scale\";\nimport { StackedBarChartModel } from \"../utils/bar-chart-model\";\nimport { selectBase } from \"../utils/stack-layout\";\nimport { DomainValue } from \"../utils/x-domain\";\nimport { XScale } from \"../utils/x-scale\";\nimport { SIDE_PADDING } from \"./padding\";\n\ninterface StackedTimeShiftBarProps {\n  model: StackedBarChartModel;\n  datum: Datum;\n  yScale: LinearScale;\n  xScale: XScale;\n  series: ConcreteSeries;\n}\n\nexport const StackedTimeShiftBar: React.FunctionComponent<StackedTimeShiftBarProps> = props => {\n  const { datum, xScale, yScale, series, model: { nominalSplit, continuousSplit, colors } } = props;\n  const datums = selectSplitDatums(datum);\n\n  const x = continuousSplit.selectValue<DomainValue>(datum);\n\n  const xStart = xScale.calculate(x);\n  const rangeBand = xScale.bandwidth();\n  const fullWidth = rangeBand - 2 * SIDE_PADDING;\n  const barWidth = fullWidth * 2 / 3;\n  const color = (d: Datum) => colors.get(String(nominalSplit.selectValue(d)));\n  return <React.Fragment>\n    {datums.map(datum => {\n      const key = `${nominalSplit.selectValue(datum)}--previous`;\n      const yPrevious = series.selectValue(datum, SeriesDerivation.PREVIOUS);\n      const yPreviousBase = selectBase(datum, series, SeriesDerivation.PREVIOUS);\n      const yPreviousPos = yScale(yPrevious + yPreviousBase);\n      const previousHeight = yScale(yPreviousBase) - yScale(yPrevious + yPreviousBase);\n\n      const previousColor = d3.rgb(color(datum)).darker(0.8);\n\n      return <rect\n          className=\"bar-chart-bar-segment\"\n          key={String(key)}\n          x={xStart + rangeBand - SIDE_PADDING - barWidth}\n          y={yPreviousPos}\n          width={barWidth}\n          height={previousHeight}\n          opacity={0.8}\n          fill={previousColor.toString()}\n        />;\n    })}\n    {datums.map(datum => {\n      const key = `${nominalSplit.selectValue(datum)}--current`;\n      const yCurrent = series.selectValue(datum);\n      const yCurrentBase = selectBase(datum, series);\n      const yCurrentPos = yScale(yCurrent + yCurrentBase);\n      const currentHeight = yScale(yCurrentBase) - yScale(yCurrent + yCurrentBase);\n      const currentColor = color(datum);\n\n      return <rect\n        className=\"bar-chart-bar-previous-segment\"\n        key={key}\n        x={xStart + SIDE_PADDING}\n        y={yCurrentPos}\n        width={barWidth}\n        height={currentHeight}\n        fill={currentColor}\n      />;\n    })}\n  </React.Fragment>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { ConcreteSeries } from \"../../../../../common/models/series/concrete-series\";\nimport { Stage } from \"../../../../../common/models/stage/stage\";\nimport { VerticalAxis } from \"../../../../components/vertical-axis/vertical-axis\";\nimport { LinearScale, pickTicks } from \"../../../../utils/linear-scale/linear-scale\";\n\nexport const TICK_LENGTH = 10;\n\ninterface SingleYAxisProps {\n  series: ConcreteSeries;\n  scale: LinearScale;\n  stage: Stage;\n}\n\nexport const SingleYAxis: React.FunctionComponent<SingleYAxisProps> = props => {\n  const { scale, series, stage } = props;\n  return <div>\n    <svg viewBox={stage.getViewBox()}>\n      <g transform=\"translate(-1, 0)\">\n        <VerticalAxis\n          stage={stage}\n          ticks={pickTicks(scale)}\n          tickSize={TICK_LENGTH}\n          scale={scale}\n          formatter={series.formatter()} />\n      </g>\n    </svg>\n  </div>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Stage } from \"../../../../../common/models/stage/stage\";\nimport { BottomBorder, RightBorder } from \"../../../../components/grid-border/grid-border\";\nimport { GridLines } from \"../../../../components/grid-lines/grid-lines\";\nimport { LinearScale, pickTicks } from \"../../../../utils/linear-scale/linear-scale\";\nimport { TICK_LENGTH } from \"../y-axis/single-y-axis\";\n\ninterface BackgroundProps {\n  gridStage: Stage;\n  yScale: LinearScale;\n}\n\nexport const Background: React.FunctionComponent<BackgroundProps> = props => {\n  const { gridStage, yScale } = props;\n  const ticks = pickTicks(yScale);\n  return <React.Fragment>\n    <GridLines\n      orientation=\"horizontal\"\n      scale={yScale}\n      ticks={ticks}\n      stage={gridStage}\n    />\n    <BottomBorder stage={gridStage} tickLength={TICK_LENGTH} />\n    <RightBorder stage={gridStage}/>\n\n  </React.Fragment>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Datum } from \"plywood\";\nimport React from \"react\";\nimport { ConcreteSeries } from \"../../../../../common/models/series/concrete-series\";\nimport { Stage } from \"../../../../../common/models/stage/stage\";\nimport getScale, { LinearScale } from \"../../../../utils/linear-scale/linear-scale\";\nimport { SingleBar } from \"../bar/single-bar\";\nimport { SingleTimeShiftBar } from \"../bar/single-time-shift-bar\";\nimport { StackedBar } from \"../bar/stacked-bar\";\nimport { StackedTimeShiftBar } from \"../bar/stacked-time-shift-bar\";\nimport { BarChartModel, isStacked } from \"../utils/bar-chart-model\";\nimport { XScale } from \"../utils/x-scale\";\nimport { yExtent } from \"../utils/y-extent\";\nimport { Background } from \"./background\";\n\ninterface BarProps {\n  model: BarChartModel;\n  datum: Datum;\n  yScale: LinearScale;\n  xScale: XScale;\n  series: ConcreteSeries;\n}\n\nconst Bar: React.FunctionComponent<BarProps> = props => {\n  const { model, ...rest } = props;\n  const showPrevious = model.hasComparison;\n  if (isStacked(model)) {\n    return showPrevious\n      ? <StackedTimeShiftBar {...rest} model={model} />\n      : <StackedBar {...rest} model={model} />;\n  }\n  return showPrevious\n    ? <SingleTimeShiftBar {...rest} model={model} />\n    : <SingleBar {...rest} model={model} />;\n};\n\ninterface BarsProps {\n  model: BarChartModel;\n  stage: Stage;\n  xScale: XScale;\n  series: ConcreteSeries;\n  datums: Datum[];\n}\n\nexport const Bars: React.FunctionComponent<BarsProps> = props => {\n  const { model, stage, xScale, series, datums } = props;\n  const extent = yExtent(datums, series, model.hasComparison);\n  const yScale = getScale(extent, stage.height);\n  if (!yScale) return null;\n  return <React.Fragment>\n    <svg viewBox={stage.getViewBox()}>\n      <Background gridStage={stage} yScale={yScale} />\n      <g transform={stage.getTransform()}>\n        {datums.map((datum: Datum, index: number) => <Bar\n          key={index}\n          datum={datum}\n          model={model}\n          yScale={yScale}\n          xScale={xScale}\n          series={series}\n        />)}\n      </g>\n    </svg>\n  </React.Fragment>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Datum } from \"plywood\";\nimport React from \"react\";\nimport { ConcreteSeries } from \"../../../../../common/models/series/concrete-series\";\nimport { Stage } from \"../../../../../common/models/stage/stage\";\nimport { Nullary } from \"../../../../../common/utils/functional/functional\";\nimport { VisMeasureLabel } from \"../../../../components/vis-measure-label/vis-measure-label\";\nimport getScale from \"../../../../utils/linear-scale/linear-scale\";\nimport { Foreground } from \"../foreground/foreground\";\nimport { Interaction } from \"../interactions/interaction\";\nimport { BarChartModel } from \"../utils/bar-chart-model\";\nimport { calculateChartStage } from \"../utils/layout\";\nimport { XScale } from \"../utils/x-scale\";\nimport { yExtent } from \"../utils/y-extent\";\nimport { Bars } from \"./bars\";\nimport \"./bars.scss\";\n\ninterface BarsContainerProps {\n  dropHighlight: Nullary<void>;\n  acceptHighlight: Nullary<void>;\n  interaction?: Interaction;\n  series: ConcreteSeries;\n  model: BarChartModel;\n  datums: Datum[];\n  totals: Datum;\n  xScale: XScale;\n  stage: Stage;\n  scrollLeft: number;\n}\n\nconst TOTAL_LABEL_OFFSET = 10;\n\nexport class BarsContainer extends React.Component<BarsContainerProps> {\n\n  private container = React.createRef<HTMLDivElement>();\n\n  render() {\n    const { dropHighlight, acceptHighlight, interaction, model, stage, scrollLeft, series, totals, datums, xScale } = this.props;\n    const hasComparison = model.hasComparison;\n    const chartStage = calculateChartStage(stage);\n    const extent = yExtent(datums, series, hasComparison);\n    const yScale = getScale(extent, chartStage.height);\n\n    return <React.Fragment>\n      <div\n        ref={this.container}\n        className=\"bar-chart-bars\"\n        style={stage.getWidthHeight()}>\n        <div className=\"bar-chart-total\" style={{ left: scrollLeft + TOTAL_LABEL_OFFSET }}>\n          <VisMeasureLabel\n            series={series}\n            datum={totals}\n            showPrevious={hasComparison} />\n        </div>\n        <Bars\n          model={model}\n          stage={chartStage}\n          xScale={xScale}\n          series={series}\n          datums={datums} />\n        {interaction && <Foreground\n          interaction={interaction}\n          container={this.container}\n          stage={chartStage}\n          dropHighlight={dropHighlight}\n          acceptHighlight={acceptHighlight}\n          model={model}\n          xScale={xScale}\n          series={series}\n          yScale={yScale} />}\n      </div>\n    </React.Fragment>;\n  }\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { StackedBarChartModel } from \"../utils/bar-chart-model\";\nimport \"./legend.scss\";\n\ninterface LegendProps {\n  model: StackedBarChartModel;\n}\n\ninterface LegendValuesProps {\n  colors: StackedBarChartModel[\"colors\"];\n}\n\nconst LegendValues: React.FunctionComponent<LegendValuesProps> = ({ colors }) => {\n  return <div className=\"legend-values\">\n    <table className=\"legend-values-table\">\n      <tbody>\n      {colors.entrySeq().toArray().map(([segment, color]) => {\n        const style = { background: color };\n        return <tr key={segment} className=\"legend-value\">\n          <td className=\"legend-value-color-cell\">\n            <div className=\"legend-value-color\" style={style} />\n          </td>\n          <td className=\"legend-value-label\">\n            <span className=\"legend-value-name\">{segment}</span>\n          </td>\n        </tr>;\n      })}\n      </tbody>\n    </table>\n  </div>;\n};\n\nexport const Legend: React.FunctionComponent<LegendProps> = props => {\n  const { model: { nominalSplit, nominalDimension, colors } } = props;\n  const title = nominalSplit.getTitle(nominalDimension);\n\n  return <div className=\"bar-chart-legend\">\n    <div className=\"legend-header\">\n      {title}\n    </div>\n    <LegendValues colors={colors} />\n  </div>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Datum } from \"plywood\";\nimport React from \"react\";\nimport { Stage } from \"../../../../../common/models/stage/stage\";\nimport { Nullary } from \"../../../../../common/utils/functional/functional\";\nimport { LegendSpot } from \"../../../../components/pinboard-panel/pinboard-panel\";\nimport { BarsContainer } from \"../bars/bars-container\";\nimport { Interaction } from \"../interactions/interaction\";\nimport { Legend } from \"../legend/Legend\";\nimport { BarChartModel, isStacked } from \"../utils/bar-chart-model\";\nimport { XScale } from \"../utils/x-scale\";\n\ninterface BarChartsProps {\n  interaction: Interaction;\n  dropHighlight: Nullary<void>;\n  acceptHighlight: Nullary<void>;\n  stage: Stage;\n  scrollLeft: number;\n  model: BarChartModel;\n  datums: Datum[];\n  totals: Datum;\n  xScale: XScale;\n}\n\nexport const BarCharts: React.FunctionComponent<BarChartsProps> = props => {\n  const { dropHighlight, acceptHighlight, interaction, model, datums, xScale, scrollLeft, stage, totals } = props;\n  const seriesList = model.series.toArray();\n  return <React.Fragment>\n    {isStacked(model) && <LegendSpot>\n      <Legend model={model}/>\n    </LegendSpot>}\n    {seriesList.map(series => {\n      const hasInteraction = !!interaction && interaction.key === series.plywoodKey();\n      return <BarsContainer\n        key={series.reactKey()}\n        stage={stage}\n        scrollLeft={scrollLeft}\n        interaction={hasInteraction && interaction}\n        series={series}\n        xScale={xScale}\n        datums={datums}\n        totals={totals}\n        model={model}\n        acceptHighlight={acceptHighlight}\n        dropHighlight={dropHighlight} />;\n    })}\n  </React.Fragment>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { List } from \"immutable\";\nimport { Datum, Range, TimeRange } from \"plywood\";\nimport React from \"react\";\nimport { DateRange } from \"../../../../../common/models/date-range/date-range\";\nimport { FilterClause, FixedTimeFilterClause } from \"../../../../../common/models/filter-clause/filter-clause\";\nimport { ConcreteSeries } from \"../../../../../common/models/series/concrete-series\";\nimport { Binary, Unary } from \"../../../../../common/utils/functional/functional\";\nimport { safeEquals } from \"../../../../../common/utils/immutable-utils/immutable-utils\";\nimport { ScrollerPart } from \"../../../../components/scroller/scroller\";\nimport { toPlywoodRange } from \"../../../../utils/highlight-clause/highlight-clause\";\nimport { Highlight } from \"../../../highlight-controller/highlight\";\nimport { BarChartModel } from \"../utils/bar-chart-model\";\nimport { BarChartLayout } from \"../utils/layout\";\nimport { DomainValue } from \"../utils/x-domain\";\nimport { XScale } from \"../utils/x-scale\";\nimport { createHighlight, createHover, equalInteractions, Hover, Interaction } from \"./interaction\";\n\ninterface InteractionProps {\n  onClick?: (x: number, y: number, part: ScrollerPart) => void;\n  onMouseMove?: (x: number, y: number, part: ScrollerPart) => void;\n  onMouseLeave?: () => void;\n  onScroll?: (scrollTop: number, scrollLeft: number) => void;\n  scrollLeft: number;\n  scrollTop: number;\n  interaction: Interaction | null;\n}\n\ninterface InteractionControllerProps {\n  xScale: XScale;\n  model: BarChartModel;\n  datums: Datum[];\n  layout: BarChartLayout;\n  children: Unary<InteractionProps, React.ReactNode>;\n  highlight?: Highlight;\n  saveHighlight: Binary<List<FilterClause>, string, void>;\n}\n\ninterface InteractionControllerState {\n  hover?: Hover;\n  scrollLeft: number;\n  scrollTop: number;\n}\n\nexport class InteractionController extends React.Component<InteractionControllerProps, InteractionControllerState> {\n\n  state: InteractionControllerState = { hover: null, scrollLeft: 0, scrollTop: 0 };\n\n  saveScroll = (scrollTop: number, scrollLeft: number) => {\n    this.setState({\n      hover: null,\n      scrollLeft,\n      scrollTop\n    });\n  };\n\n  saveHover = (x: number, y: number, part: ScrollerPart) => {\n    const { highlight } = this.props;\n    if (highlight) return;\n    const value = this.getValueFromEvent(x, part);\n    if (!Range.isRange(value)) return;\n    const series = this.getSeriesFromEvent(y, part);\n    if (series === null) return;\n    const datum = this.findDatumByValue(value);\n    const hover = createHover(series.plywoodKey(), datum);\n    const { hover: oldHover } = this.state;\n    if (oldHover && equalInteractions(oldHover, hover)) return;\n    this.setState({ hover });\n  };\n\n  resetHover = () => {\n    const { hover } = this.state;\n    if (hover) {\n      this.setState({ hover: null });\n    }\n  };\n\n  handleClick = (x: number, y: number, part: ScrollerPart) => {\n    const value = this.getValueFromEvent(x, part);\n    if (!TimeRange.isTimeRange(value)) return;\n    this.setState({ hover: null });\n    const series = this.getSeriesFromEvent(y, part);\n    if (series === null) return;\n    const { saveHighlight, model } = this.props;\n    const { reference } = model.continuousSplit;\n    const values = List.of(new DateRange(value));\n    const clause = new FixedTimeFilterClause({ reference, values });\n    saveHighlight(List.of(clause), series.plywoodKey());\n  };\n\n  getValueFromEvent(x: number, part: ScrollerPart): DomainValue | null {\n    if (part !== \"body\") return null;\n    const { layout, xScale } = this.props;\n    return xScale.invert(x - layout.scroller.left);\n  }\n\n  findDatumByValue(value: DomainValue): Datum | null {\n    const { model: { continuousSplit }, datums } = this.props;\n    return datums.find(datum => safeEquals(value, continuousSplit.selectValue(datum)));\n  }\n\n  getSeriesFromEvent(y: number, part: ScrollerPart): ConcreteSeries | null {\n    if (part !== \"body\") return null;\n    const { layout: { segment: { height: seriesHeight } }, model: { series } } = this.props;\n    const index = Math.floor(y / seriesHeight);\n    return series.get(index) || null;\n  }\n\n  interaction(): Interaction | null {\n    const { highlight } = this.props;\n    if (highlight) {\n      const value = toPlywoodRange(highlight.clauses.first());\n      const datum = this.findDatumByValue(value);\n      return createHighlight(highlight.key, datum);\n    }\n    return this.state.hover;\n  }\n\n  render() {\n    const { children } = this.props;\n    const { scrollLeft, scrollTop } = this.state;\n    return children({\n      interaction: this.interaction(),\n      scrollLeft,\n      scrollTop,\n      onScroll: this.saveScroll,\n      onMouseLeave: this.resetHover,\n      onMouseMove: this.saveHover,\n      onClick: this.handleClick\n    });\n  }\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport \"./spacer.scss\";\n\nexport const Spacer: React.FunctionComponent<{}> = props => {\n return <div className=\"spacer\" />;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Datum } from \"plywood\";\nimport { ConcreteSeries } from \"../../../../../common/models/series/concrete-series\";\nimport { mapSplitDatums } from \"../../../../utils/dataset/split/map-split-datums\";\nimport { StackedBarChartModel } from \"./bar-chart-model\";\nimport { stack } from \"./stack-layout\";\n\nconst reverse = (datums: Datum[]): Datum[] => datums.slice().reverse();\n\nconst reverseSplitDatums = (datum: Datum) => mapSplitDatums(datum, reverse);\n\nexport function stackDataset(dataset: Datum[], { series, hasComparison }: StackedBarChartModel): Datum[] {\n  const seriesList = series.toArray();\n  const reversedDatums = dataset.map(reverseSplitDatums);\n  return seriesList.reduce((datums: Datum[], series: ConcreteSeries) =>\n    stack(datums, series, hasComparison), reversedDatums);\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { Datum } from \"plywood\";\nimport { Unary } from \"../../../../common/utils/functional/functional\";\nimport { SPLIT } from \"../../../config/constants\";\nimport { selectSplitDataset, selectSplitDatums } from \"../selectors/selectors\";\n\nexport function mapSplitDatums(datum: Datum, fn: Unary<Datum[], Datum[]>): Datum {\n  const datums = selectSplitDatums(datum);\n  return {\n    ...datum,\n    [SPLIT]: selectSplitDataset(datum).changeData(fn(datums))\n  };\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Dataset, Datum, NumberRange, TimeRange } from \"plywood\";\nimport { Split } from \"../../../../../common/models/split/split\";\nimport { Binary, cons, replaceAt, Unary } from \"../../../../../common/utils/functional/functional\";\nimport { SPLIT } from \"../../../../config/constants\";\nimport { selectFirstSplitDatums, selectSplitDatums } from \"../../../../utils/dataset/selectors/selectors\";\nimport { BarChartModel, isStacked } from \"./bar-chart-model\";\n\nfunction rangeComparator(continuousSplit: Split): Binary<Datum, Datum, number> {\n  return (a: Datum, b: Datum) => {\n    const aRange = continuousSplit.selectValue<TimeRange | NumberRange>(a);\n    const bRange = continuousSplit.selectValue<TimeRange | NumberRange>(b);\n    /*\n      NOTE: Conflict of variance:\n      `aRange` has type `TimeRange | NumberRange` and as a result\n      argument of `aRange.compare` has type `TimeRange & NumberRange`.\n      Such type is impossible, thus error\n    */\n    return aRange.compare(bRange as TimeRange & NumberRange);\n  };\n}\n\nfunction equalBy(split: Split, datum: Datum): Unary<Datum, boolean> {\n  const value = split.selectValue(datum);\n  return (d: Datum) => {\n    const range = split.selectValue(d);\n    if (TimeRange.isTimeRange(value) && TimeRange.isTimeRange(range)) {\n      return value.equals(range);\n    }\n    if (NumberRange.isNumberRange(value) && NumberRange.isNumberRange(range)) {\n      return value.equals(range);\n    }\n    return false;\n  };\n}\n\nfunction constructDatum(continuousRef: string, range: TimeRange, splitData: Datum[]): Datum {\n  return {\n    [continuousRef]: range,\n    [SPLIT]: new Dataset({ data: splitData })\n  };\n}\n\nfunction createInnerDatum(continuousRef: string, datum: Datum): Datum {\n  const { [continuousRef]: continuousAttr, ...splitDatum } = datum;\n  return constructDatum(continuousRef, continuousAttr as TimeRange, [splitDatum]);\n}\n\nfunction mergeDatums(continuousRef: string, datum: Datum, newDatum: Datum): Datum {\n  const splitData = selectSplitDatums(datum);\n  const { [continuousRef]: continuousAttr, ...splitDatum } = newDatum;\n  return constructDatum(continuousRef, continuousAttr as TimeRange, [...splitData, splitDatum]);\n}\n\nexport function transposeDataset(dataset: Dataset, model: BarChartModel): Datum[] {\n  if (!isStacked(model)) return selectFirstSplitDatums(dataset);\n\n  const { continuousSplit } = model;\n  const { data } = dataset.flatten();\n\n  const result = data.reduce((coll: Datum[], currentDatum: Datum) => {\n    const idx = coll.findIndex(equalBy(continuousSplit, currentDatum));\n    const notFound = idx === -1;\n\n    if (notFound) {\n      return cons(coll, createInnerDatum(continuousSplit.reference, currentDatum));\n    }\n\n    return replaceAt(coll, idx, mergeDatums(continuousSplit.reference, coll[idx], currentDatum));\n  }, []);\n\n  return result.sort(rangeComparator(continuousSplit));\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as d3 from \"d3\";\nimport { NumberRange, TimeRange } from \"plywood\";\nimport { DomainValue, XDomain } from \"./x-domain\";\n\nexport interface XScale {\n  calculate(x: DomainValue): number;\n  invert(x: number): DomainValue;\n  domain(): XDomain;\n  bandwidth(): number;\n}\n\nexport function createXScale(domain: XDomain, width: number): XScale {\n  const range: [number, number] = [0, width];\n  const stringifiedDomain = domain.map(formatDomainValue);\n  const ordinalScale = d3.scaleBand()\n    .domain(stringifiedDomain)\n    .rangeRound(range);\n\n  const quantizedScale = d3.scaleQuantize<DomainValue>()\n    .domain(range)\n    .range(domain);\n\n  return {\n    calculate: (value: DomainValue) => ordinalScale(formatDomainValue(value)),\n    domain: () => domain,\n    invert: (x: number) => quantizedScale(x),\n    bandwidth: () => ordinalScale.bandwidth()\n  };\n}\n\nfunction formatDomainValue(value: DomainValue): string {\n  if (TimeRange.isTimeRange(value)) {\n    const { start } = value;\n    return start.toISOString();\n  }\n  if (NumberRange.isNumberRange(value)) {\n    const { start } = value;\n    return start.toString(10);\n  }\n  return String(value);\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { isContinuousSplit } from \"../../../../../common/models/split/split\";\nimport { Stage } from \"../../../../../common/models/stage/stage\";\nimport { formatShortSegment } from \"../../../../../common/utils/formatter/formatter\";\nimport { roundToHalfPx } from \"../../../../utils/dom/dom\";\nimport { BarChartModel } from \"../utils/bar-chart-model\";\nimport { DomainValue, XDomain } from \"../utils/x-domain\";\nimport { XScale } from \"../utils/x-scale\";\nimport \"./x-axis.scss\";\n\ninterface XAxisProps {\n  model: BarChartModel;\n  stage: Stage;\n  scale: XScale;\n}\n\nconst TICK_HEIGHT = 10;\nconst TICK_TEXT_OFFSET = 12;\n\nfunction calculateTicks(domain: XDomain, { continuousSplit }: BarChartModel): DomainValue[] {\n  if (isContinuousSplit(continuousSplit)) {\n    return domain.filter((_, idx) => idx % 8 === 0);\n  }\n  return domain;\n}\n\nexport const XAxis: React.FunctionComponent<XAxisProps> = props => {\n  const { model, stage, scale } = props;\n  const ticks = calculateTicks(scale.domain(), model);\n  return <svg width={stage.width} height={stage.height}>\n    <g className=\"bar-chart-x-axis\">\n      {ticks.map((value, index) => {\n        const x = roundToHalfPx(scale.calculate(value));\n        const textAnchor = index === 0 ? \"start\" : \"middle\";\n        return <g key={String(value)} transform={`translate(${x}, 0)`}>\n          <line x1={0} x2={0} y1={0} y2={TICK_HEIGHT} />\n          <text y={TICK_HEIGHT + TICK_TEXT_OFFSET} style={{ textAnchor }}>\n            {formatShortSegment(value, model.timezone)}\n          </text>\n        </g>;\n      })}\n    </g>\n  </svg>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Datum } from \"plywood\";\nimport React from \"react\";\nimport { Stage } from \"../../../../../common/models/stage/stage\";\nimport getScale from \"../../../../utils/linear-scale/linear-scale\";\nimport { BarChartModel } from \"../utils/bar-chart-model\";\nimport { calculateYAxisStage } from \"../utils/layout\";\nimport { yExtent } from \"../utils/y-extent\";\nimport { SingleYAxis } from \"./single-y-axis\";\n\ninterface YAxisProps {\n  stage: Stage;\n  datums: Datum[];\n  model: BarChartModel;\n}\n\nexport const YAxis: React.FunctionComponent<YAxisProps> = props => {\n  const { model, stage, datums } = props;\n  const axisStage = calculateYAxisStage(stage);\n  const seriesList = model.series.toArray();\n  return <React.Fragment>\n    {seriesList.map(series => {\n      const extent = yExtent(datums, series, model.hasComparison);\n      const scale = getScale(extent, axisStage.height);\n      return <div\n        style={stage.getWidthHeight()}\n        key={series.reactKey()}>\n        {scale && <SingleYAxis\n          series={series}\n          scale={scale}\n          stage={axisStage} />}\n      </div>;\n    })}\n  </React.Fragment>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { ChartProps } from \"../../../../common/models/chart-props/chart-props\";\nimport { Stage } from \"../../../../common/models/stage/stage\";\nimport { MessageCard } from \"../../../components/message-card/message-card\";\nimport { Scroller } from \"../../../components/scroller/scroller\";\nimport { SPLIT } from \"../../../config/constants\";\nimport { selectMainDatum } from \"../../../utils/dataset/selectors/selectors\";\nimport { useSettingsContext } from \"../../../views/cube-view/settings-context\";\nimport { BarCharts } from \"./bar-charts/bar-charts\";\nimport { InteractionController } from \"./interactions/interaction-controller\";\nimport { Spacer } from \"./spacer/spacer\";\nimport { create, isStacked } from \"./utils/bar-chart-model\";\nimport { calculateLayout } from \"./utils/layout\";\nimport { stackDataset } from \"./utils/stack-dataset\";\nimport { transposeDataset } from \"./utils/transpose-dataset\";\nimport { getXDomain } from \"./utils/x-domain\";\nimport { createXScale } from \"./utils/x-scale\";\nimport { XAxis } from \"./x-axis/x-axis\";\nimport { YAxis } from \"./y-axis/y-axis\";\n\nexport const BarChart: React.FunctionComponent<ChartProps> = props => {\n  const { customization } = useSettingsContext();\n  const { data: dataset, essence, stage, highlight, acceptHighlight, dropHighlight, saveHighlight } = props;\n  const model = create(essence, dataset, customization);\n\n  const transposedDataset = transposeDataset(dataset, model);\n  if (transposedDataset.length === 0) {\n    return <MessageCard title=\"No data found. Try different filters.\"/>;\n  }\n\n  const { [SPLIT]: split, ...totals } = selectMainDatum(dataset);\n  const data = isStacked(model) ? stackDataset(transposedDataset, model) : transposedDataset;\n  const seriesCount = model.series.count();\n  const domain = getXDomain(data, model);\n  const barChartLayout = calculateLayout(stage, domain.length, seriesCount);\n  const { scroller, segment } = barChartLayout;\n  const xScale = createXScale(domain, segment.width);\n\n  return <InteractionController\n    xScale={xScale}\n    model={model}\n    datums={data}\n    layout={barChartLayout}\n    saveHighlight={saveHighlight}\n    highlight={highlight}>\n    {({\n        onClick,\n        onScroll,\n        onMouseLeave,\n        onMouseMove,\n        interaction,\n        scrollLeft\n      }) => <Scroller\n      layout={scroller}\n      onMouseLeave={onMouseLeave}\n      onClick={onClick}\n      onScroll={onScroll}\n      onMouseMove={onMouseMove}\n      leftGutter={<Spacer />}\n      bottomLeftCorner={<Spacer />}\n      bottomRightCorner={<Spacer />}\n      body={<BarCharts\n        interaction={interaction}\n        datums={data}\n        totals={totals}\n        stage={segment}\n        scrollLeft={scrollLeft}\n        model={model}\n        xScale={xScale}\n        acceptHighlight={acceptHighlight}\n        dropHighlight={dropHighlight} />}\n      rightGutter={<YAxis\n        model={model}\n        datums={data}\n        stage={Stage.fromSize(scroller.right, segment.height)} />}\n      bottomGutter={<XAxis\n        model={model}\n        scale={xScale}\n        stage={Stage.fromSize(segment.width, scroller.bottom)}\n      />} />}\n  </InteractionController>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Datum, NumberRange, TimeRange } from \"plywood\";\nimport { BarChartModel } from \"./bar-chart-model\";\n\nexport type DomainValue = boolean | number | string | Date | NumberRange | TimeRange;\n\nexport type XDomain = DomainValue[];\n\nexport function getXDomain(datums: Datum[], { continuousSplit }: BarChartModel): XDomain {\n  return datums.map(datum => continuousSplit.selectValue<DomainValue>(datum));\n}\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as d3 from \"d3\";\nimport { PlywoodValue } from \"plywood\";\nimport React from \"react\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { roundToHalfPx } from \"../../utils/dom/dom\";\nimport \"./bucket-marks.scss\";\n\nconst TICK_HEIGHT = 5;\n\nexport interface BucketMarksProps {\n  stage: Stage;\n  ticks: PlywoodValue[];\n  scale: d3.ScaleBand<PlywoodValue>;\n}\n\nexport interface BucketMarksState {\n}\n\nexport class BucketMarks extends React.Component<BucketMarksProps, BucketMarksState> {\n\n  render() {\n    const { stage, ticks, scale } = this.props;\n    const stageWidth = stage.width;\n\n    const lines: JSX.Element[] = [];\n\n    function addLine(x: number, key: string) {\n      if (stageWidth < x) return;\n      lines.push(<line key={key} x1={x} y1={0} x2={x} y2={TICK_HEIGHT} />);\n    }\n\n    for (const tick of ticks) {\n      const x = roundToHalfPx(scale(tick));\n      addLine(x, \"_\" + tick);\n    }\n    if (ticks.length) {\n      const x = roundToHalfPx(scale(ticks[ticks.length - 1]) + scale.bandwidth());\n      addLine(x, \"last\");\n    }\n\n    return <g className=\"bucket-marks\" transform={stage.getTransform()}>\n      {lines}\n    </g>;\n  }\n}\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nexport interface BarCoordinatesValue {\n  x: number;\n  y: number;\n  height: number;\n  width: number;\n\n  barOffset: number;\n  barWidth: number;\n  stepWidth: number;\n  children: BarCoordinates[];\n}\n\nexport class BarCoordinates {\n  public x: number;\n  public y: number;\n  public height: number;\n  public width: number;\n\n  public barOffset: number;\n  public barWidth: number;\n  public stepWidth: number;\n  public children: BarCoordinates[];\n\n  private hitboxMin: number;\n  private hitboxMax: number;\n\n  constructor(parameters: BarCoordinatesValue) {\n    this.x = parameters.x;\n    this.y = parameters.y;\n    this.height = parameters.height;\n    this.width = parameters.width;\n\n    this.barOffset = parameters.barOffset;\n    this.barWidth = parameters.barWidth;\n    this.stepWidth = parameters.stepWidth;\n    this.children = parameters.children;\n\n    this.hitboxMin = this.x - this.barOffset;\n    this.hitboxMax = this.x + this.barWidth + this.barOffset * 2;\n  }\n\n  isXWithin(x: number): boolean {\n    return x >= this.hitboxMin && x <= this.hitboxMax;\n  }\n\n  hasChildren(): boolean {\n    return this.children.length > 0;\n  }\n\n  get middleX(): number {\n    return this.x + this.barWidth * .5 + this.barOffset;\n  }\n}\n","/*\n * Copyright 2017-2022 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as d3 from \"d3\";\nimport { List, Set } from \"immutable\";\nimport { Dataset, Datum, NumberRange, PlywoodRange, PseudoDatum, Range } from \"plywood\";\nimport React from \"react\";\nimport { ChartProps } from \"../../../../common/models/chart-props/chart-props\";\nimport { DateRange } from \"../../../../common/models/date-range/date-range\";\nimport { canBucketByDefault, Dimension } from \"../../../../common/models/dimension/dimension\";\nimport { findDimensionByName } from \"../../../../common/models/dimension/dimensions\";\nimport {\n  BooleanFilterClause,\n  FilterClause,\n  FixedTimeFilterClause,\n  NumberFilterClause,\n  StringFilterAction,\n  StringFilterClause\n} from \"../../../../common/models/filter-clause/filter-clause\";\nimport { Measure } from \"../../../../common/models/measure/measure\";\nimport { ConcreteSeries, SeriesDerivation } from \"../../../../common/models/series/concrete-series\";\nimport { Series } from \"../../../../common/models/series/series\";\nimport { SortDirection } from \"../../../../common/models/sort/sort\";\nimport { SplitType } from \"../../../../common/models/split/split\";\nimport { Splits } from \"../../../../common/models/splits/splits\";\nimport { Stage } from \"../../../../common/models/stage/stage\";\nimport { formatValue } from \"../../../../common/utils/formatter/formatter\";\nimport { BAR_CHART_MANIFEST } from \"../../../../common/visualization-manifests/bar-chart/bar-chart\";\nimport { BucketMarks } from \"../../../components/bucket-marks/bucket-marks\";\nimport { GridLines } from \"../../../components/grid-lines/grid-lines\";\nimport { HighlightModal } from \"../../../components/highlight-modal/highlight-modal\";\nimport { MeasureBubbleContent } from \"../../../components/measure-bubble-content/measure-bubble-content\";\nimport { Scroller, ScrollerLayout } from \"../../../components/scroller/scroller\";\nimport { SegmentBubble } from \"../../../components/segment-bubble/segment-bubble\";\nimport { VerticalAxis } from \"../../../components/vertical-axis/vertical-axis\";\nimport { VisMeasureLabel } from \"../../../components/vis-measure-label/vis-measure-label\";\nimport { SPLIT, VIS_H_PADDING } from \"../../../config/constants\";\nimport { classNames, roundToPx } from \"../../../utils/dom/dom\";\nimport { SettingsContext, SettingsContextValue } from \"../../../views/cube-view/settings-context\";\nimport { hasHighlightOn } from \"../../highlight-controller/highlight-controller\";\nimport { BarCoordinates } from \"../bar-coordinates\";\n\nconst X_AXIS_HEIGHT = 84;\nconst Y_AXIS_WIDTH = 60;\nconst CHART_TOP_PADDING = 10;\nconst CHART_BOTTOM_PADDING = 0;\nconst MIN_CHART_HEIGHT = 200;\nconst MAX_STEP_WIDTH = 140; // Note that the step is bar + empty space around it. The width of the rectangle is step * BAR_PROPORTION\nconst MIN_STEP_WIDTH = 20;\nconst BAR_PROPORTION = 0.8;\nconst BARS_MIN_PAD_LEFT = 30;\nconst BARS_MIN_PAD_RIGHT = 6;\nconst HOVER_BUBBLE_V_OFFSET = 8;\nconst SELECTION_PAD = 4;\n\nfunction getFilterFromDatum(splits: Splits, dataPath: Datum[]): List<FilterClause> {\n  return List(dataPath.map((datum, i) => {\n    const { type, reference } = splits.getSplit(i);\n    const segment: any = datum[reference];\n\n    switch (type) {\n      case SplitType.boolean:\n        return new BooleanFilterClause({ reference, values: Set.of(segment) });\n      case SplitType.number:\n        return new NumberFilterClause({ reference, values: List.of(segment) });\n      case SplitType.time:\n        return new FixedTimeFilterClause({ reference, values: List.of(new DateRange(segment)) });\n      case SplitType.string:\n        return new StringFilterClause({ reference, action: StringFilterAction.IN, values: Set.of(segment) });\n    }\n  }));\n}\n\nfunction padDataset(originalDataset: Dataset, dimension: Dimension, measures: Measure[]): Dataset {\n  const data = (originalDataset.data[0][SPLIT] as Dataset).data;\n  const dimensionName = dimension.name;\n\n  const firstBucket: PlywoodRange = data[0][dimensionName] as PlywoodRange;\n  if (!firstBucket) return originalDataset;\n  const start = Number(firstBucket.start);\n  const end = Number(firstBucket.end);\n\n  const size = end - start;\n\n  let i = start;\n  let j = 0;\n\n  const filledData: Datum[] = [];\n  data.forEach(d => {\n    const segmentValue = d[dimensionName];\n    const segmentStart = (segmentValue as PlywoodRange).start;\n    while (i < segmentStart) {\n      filledData[j] = {};\n      filledData[j][dimensionName] = NumberRange.fromJS({\n        start: i,\n        end: i + size\n      });\n      measures.forEach(m => {\n        filledData[j][m.name] = 0; // todo: what if effective zero is not 0?\n      });\n\n      if (d[SPLIT]) {\n        filledData[j][SPLIT] = new Dataset({\n          data: [],\n          attributes: []\n        });\n      }\n\n      j++;\n      i += size;\n    }\n    filledData[j] = d;\n    i += size;\n    j++;\n  });\n\n  const value = originalDataset.valueOf();\n  (value.data[0][SPLIT] as Dataset).data = filledData;\n  return new Dataset(value);\n}\n\nexport interface BubbleInfo {\n  series: ConcreteSeries;\n  chartIndex: number;\n  path: Datum[];\n  coordinates: BarCoordinates;\n  splitIndex?: number;\n  segmentLabel?: string;\n}\n\nexport interface BarChartState {\n  hoverInfo?: BubbleInfo;\n  selectionInfo?: BubbleInfo;\n  scrollerYPosition?: number;\n  scrollerXPosition?: number;\n  scrollTop: number;\n  scrollLeft: number;\n\n  // Precalculated stuff\n  flatData?: PseudoDatum[];\n  maxNumberOfLeaves?: number[];\n}\n\nexport class BarChart extends React.Component<ChartProps, BarChartState> {\n  static contextType = SettingsContext;\n  protected className = BAR_CHART_MANIFEST.name;\n\n  private coordinatesCache: BarCoordinates[][] = [];\n  private scroller = React.createRef<Scroller>();\n\n  state: BarChartState = this.initState();\n\n  context: SettingsContextValue;\n\n  componentDidUpdate() {\n    const { scrollerYPosition, scrollerXPosition } = this.state;\n\n    const scrollerComponent = this.scroller.current;\n    if (!scrollerComponent) return;\n\n    const rect = scrollerComponent.scroller.current.getBoundingClientRect();\n\n    if (scrollerYPosition !== rect.top || scrollerXPosition !== rect.left) {\n      this.setState({ scrollerYPosition: rect.top, scrollerXPosition: rect.left });\n    }\n  }\n\n  calculateMousePosition(x: number, y: number): BubbleInfo {\n    const { essence } = this.props;\n\n    const series = essence.getConcreteSeries();\n    const chartStage = this.getSingleChartStage();\n    const chartHeight = this.getOuterChartHeight(chartStage);\n\n    if (y >= chartHeight * series.size) return null; // on x axis\n    if (x >= chartStage.width) return null; // on y axis\n\n    const xScale = this.getPrimaryXScale();\n    const chartIndex = Math.floor(y / chartHeight);\n\n    const chartCoordinates = this.getBarsCoordinates(chartIndex, xScale);\n\n    const { path, coordinates } = this.findBarCoordinatesForX(x, chartCoordinates, []);\n\n    return {\n      path: this.findPathForIndices(path),\n      series: series.get(chartIndex),\n      chartIndex,\n      coordinates\n    };\n  }\n\n  findPathForIndices(indices: number[]): Datum[] {\n    const { data } = this.props;\n    const mySplitDataset = data.data[0][SPLIT] as Dataset;\n\n    const path: Datum[] = [];\n    let currentData: Dataset = mySplitDataset;\n    indices.forEach(i => {\n      const datum = currentData.data[i];\n      path.push(datum);\n      currentData = (datum[SPLIT] as Dataset);\n    });\n\n    return path;\n  }\n\n  findBarCoordinatesForX(x: number, coordinates: BarCoordinates[], currentPath: number[]): { path: number[], coordinates: BarCoordinates } {\n    for (let i = 0; i < coordinates.length; i++) {\n      if (coordinates[i].isXWithin(x)) {\n        currentPath.push(i);\n        if (coordinates[i].hasChildren()) {\n          return this.findBarCoordinatesForX(x, coordinates[i].children, currentPath);\n        } else {\n          return { path: currentPath, coordinates: coordinates[i] };\n        }\n      }\n    }\n\n    return { path: [], coordinates: null };\n  }\n\n  onScrollerScroll = (scrollTop: number, scrollLeft: number) => {\n    this.setState({\n      hoverInfo: null,\n      scrollLeft,\n      scrollTop\n    });\n  };\n\n  onMouseMove = (x: number, y: number) => {\n    this.setState({ hoverInfo: this.calculateMousePosition(x, y) });\n  };\n\n  onMouseLeave = () => {\n    this.setState({ hoverInfo: null });\n  };\n\n  onClick = (x: number, y: number) => {\n    const { essence, highlight, dropHighlight, saveHighlight } = this.props;\n\n    const selectionInfo = this.calculateMousePosition(x, y);\n\n    if (!selectionInfo) return;\n\n    if (!selectionInfo.coordinates) {\n      dropHighlight();\n      this.setState({ selectionInfo: null });\n      return;\n    }\n\n    const { path, chartIndex } = selectionInfo;\n\n    const { splits } = essence;\n    const series = essence.getConcreteSeries();\n\n    const rowHighlight = getFilterFromDatum(splits, path);\n\n    const currentSeries = series.get(chartIndex).definition;\n    if (hasHighlightOn(highlight, currentSeries.key())) {\n      if (rowHighlight.equals(highlight.clauses)) {\n        dropHighlight();\n        this.setState({ selectionInfo: null });\n        return;\n      }\n    }\n\n    this.setState({ selectionInfo });\n    saveHighlight(rowHighlight, series.get(chartIndex).definition.key());\n  };\n\n  getYExtent(data: Datum[], series: ConcreteSeries): number[] {\n    const getY = (d: Datum) => series.selectValue(d);\n    return d3.extent(data, getY);\n  }\n\n  getYScale(series: ConcreteSeries, yAxisStage: Stage): d3.ScaleLinear<number, number> {\n    const { essence } = this.props;\n    const { flatData } = this.state;\n\n    const splitLength = essence.splits.length();\n    const leafData = flatData.filter((d: Datum) => d[\"__nest\"] === splitLength - 1);\n\n    const extentY = this.getYExtent(leafData, series);\n\n    return d3.scaleLinear()\n      .domain([Math.min(extentY[0] * 1.1, 0), Math.max(extentY[1] * 1.1, 0)])\n      .range([yAxisStage.height, yAxisStage.y]);\n  }\n\n  hasValidYExtent(series: ConcreteSeries, data: Datum[]): boolean {\n    const [yMin, yMax] = this.getYExtent(data, series);\n    return !isNaN(yMin) && !isNaN(yMax);\n  }\n\n  getSingleChartStage(): Stage {\n    const xScale = this.getPrimaryXScale();\n    const { essence, stage } = this.props;\n\n    const { stepWidth } = this.getBarDimensions(xScale.bandwidth());\n    const xTicks = xScale.domain();\n    const width = xTicks.length > 0 ? roundToPx(xScale(xTicks[xTicks.length - 1])) + stepWidth : 0;\n\n    const measures = essence.getConcreteSeries();\n    const availableHeight = stage.height - X_AXIS_HEIGHT;\n    const height = Math.max(MIN_CHART_HEIGHT, Math.floor(availableHeight / measures.size));\n\n    return new Stage({\n      x: 0,\n      y: CHART_TOP_PADDING,\n      width: Math.max(width, stage.width - Y_AXIS_WIDTH - VIS_H_PADDING * 2),\n      height: height - CHART_TOP_PADDING - CHART_BOTTOM_PADDING\n    });\n  }\n\n  getOuterChartHeight(chartStage: Stage): number {\n    return chartStage.height + CHART_TOP_PADDING + CHART_BOTTOM_PADDING;\n  }\n\n  getAxisStages(chartStage: Stage): { xAxisStage: Stage, yAxisStage: Stage } {\n    const { essence, stage } = this.props;\n\n    const xHeight = Math.max(\n      stage.height - (CHART_TOP_PADDING + CHART_BOTTOM_PADDING + chartStage.height) * essence.getConcreteSeries().size,\n      X_AXIS_HEIGHT\n    );\n\n    return {\n      xAxisStage: new Stage({ x: chartStage.x, y: 0, height: xHeight, width: chartStage.width }),\n      yAxisStage: new Stage({ x: 0, y: chartStage.y, height: chartStage.height, width: Y_AXIS_WIDTH + VIS_H_PADDING })\n    };\n  }\n\n  getScrollerLayout(chartStage: Stage, xAxisStage: Stage, yAxisStage: Stage): ScrollerLayout {\n    const { essence } = this.props;\n    const measures = essence.getConcreteSeries().toArray();\n\n    const oneChartHeight = this.getOuterChartHeight(chartStage);\n\n    return {\n      // Inner dimensions\n      bodyWidth: chartStage.width,\n      bodyHeight: oneChartHeight * measures.length - CHART_BOTTOM_PADDING,\n\n      // Gutters\n      top: 0,\n      right: yAxisStage.width,\n      bottom: xAxisStage.height,\n      left: 0\n    };\n  }\n\n  getBubbleTopOffset(y: number, chartIndex: number, chartStage: Stage): number {\n    const { scrollTop, scrollerYPosition } = this.state;\n    const oneChartHeight = this.getOuterChartHeight(chartStage);\n    const chartsAboveMe = oneChartHeight * chartIndex;\n\n    return chartsAboveMe - scrollTop + scrollerYPosition + y - HOVER_BUBBLE_V_OFFSET + CHART_TOP_PADDING;\n  }\n\n  getBubbleLeftOffset(x: number): number {\n    const { scrollLeft, scrollerXPosition } = this.state;\n\n    return scrollerXPosition + x - scrollLeft;\n  }\n\n  canShowBubble(leftOffset: number, topOffset: number): boolean {\n    const { stage } = this.props;\n    const { scrollerYPosition, scrollerXPosition } = this.state;\n\n    if (topOffset <= 0) return false;\n    if (topOffset > scrollerYPosition + stage.height - X_AXIS_HEIGHT) return false;\n    if (leftOffset <= 0) return false;\n    if (leftOffset > scrollerXPosition + stage.width - Y_AXIS_WIDTH) return false;\n\n    return true;\n  }\n\n  renderSelectionBubble(hoverInfo: BubbleInfo): JSX.Element {\n    const { dropHighlight, acceptHighlight } = this.props;\n    const { series, path, chartIndex, segmentLabel, coordinates } = hoverInfo;\n    const chartStage = this.getSingleChartStage();\n    const leftOffset = this.getBubbleLeftOffset(coordinates.middleX);\n    const topOffset = this.getBubbleTopOffset(coordinates.y, chartIndex, chartStage);\n    if (!this.canShowBubble(leftOffset, topOffset)) return null;\n\n    const segmentValue = series.formatValue(path[path.length - 1]);\n    return <HighlightModal\n      left={leftOffset}\n      top={topOffset}\n      dropHighlight={dropHighlight}\n      acceptHighlight={acceptHighlight}\n      title={segmentLabel}>\n      {segmentValue}\n    </HighlightModal>;\n  }\n\n  renderHoverBubble(hoverInfo: BubbleInfo): JSX.Element {\n    const chartStage = this.getSingleChartStage();\n    const { series, path, chartIndex, segmentLabel, coordinates } = hoverInfo;\n\n    const leftOffset = this.getBubbleLeftOffset(coordinates.middleX);\n    const topOffset = this.getBubbleTopOffset(coordinates.y, chartIndex, chartStage);\n\n    if (!this.canShowBubble(leftOffset, topOffset)) return null;\n\n    const measureContent = this.renderMeasureLabel(path[path.length - 1], series);\n    return <SegmentBubble\n      top={topOffset}\n      left={leftOffset}\n      title={segmentLabel}\n      content={measureContent}\n    />;\n  }\n\n  private renderMeasureLabel(datum: Datum, series: ConcreteSeries): JSX.Element | string {\n    if (!this.props.essence.hasComparison()) {\n      return series.formatValue(datum);\n    }\n    const currentValue = series.selectValue(datum);\n    const previousValue = series.selectValue(datum, SeriesDerivation.PREVIOUS);\n    const formatter = series.formatter();\n    return <MeasureBubbleContent\n      lowerIsBetter={series.measure.lowerIsBetter}\n      formatter={formatter}\n      current={currentValue}\n      previous={previousValue}\n    />;\n  }\n\n  isSelected(path: Datum[], series: Series): boolean {\n    const { essence, highlight } = this.props;\n    const { splits } = essence;\n    return hasHighlightOn(highlight, series.key()) && highlight.clauses.equals(getFilterFromDatum(splits, path));\n  }\n\n  isFaded(): boolean {\n    return this.props.highlight !== null;\n  }\n\n  hasAnySelectionGoingOn(): boolean {\n    return this.props.highlight !== null;\n  }\n\n  isHovered(path: Datum[], series: ConcreteSeries): boolean {\n    const { essence } = this.props;\n    const { hoverInfo } = this.state;\n    const { splits } = essence;\n\n    if (this.hasAnySelectionGoingOn()) return false;\n    if (!hoverInfo) return false;\n    if (!hoverInfo.series.equals(series)) return false;\n\n    const filter = (path: Datum[]) => getFilterFromDatum(splits, path);\n\n    return filter(hoverInfo.path).equals(filter(path));\n  }\n\n  renderBars(\n    data: Datum[],\n    series: ConcreteSeries,\n    chartIndex: number,\n    chartStage: Stage,\n    xAxisStage: Stage,\n    coordinates: BarCoordinates[],\n    splitIndex = 0,\n    path: Datum[] = []\n  ): { bars: JSX.Element[], highlight: JSX.Element } {\n    const { essence } = this.props;\n    const { timezone } = essence;\n    const { customization: { visualizationColors } } = this.context;\n\n    const bars: JSX.Element[] = [];\n    let highlight: JSX.Element;\n\n    const dimension = findDimensionByName(essence.dataCube.dimensions, essence.splits.splits.get(splitIndex).reference);\n    const splitLength = essence.splits.length();\n\n    data.forEach((d, i) => {\n      const segmentValue = d[dimension.name];\n      const segmentValueStr = formatValue(segmentValue, timezone);\n      const subPath = path.concat(d);\n\n      let bar: any;\n      let bubble: JSX.Element = null;\n      const subCoordinates = coordinates[i];\n      const { x, y, height, barWidth, barOffset } = coordinates[i];\n\n      if (splitIndex < splitLength - 1) {\n        const subData: Datum[] = (d[SPLIT] as Dataset).data;\n        const subRender = this.renderBars(subData, series, chartIndex, chartStage, xAxisStage, subCoordinates.children, splitIndex + 1, subPath);\n\n        bar = subRender.bars;\n        if (!highlight && subRender.highlight) highlight = subRender.highlight;\n\n      } else {\n\n        const bubbleInfo: BubbleInfo = {\n          series,\n          chartIndex,\n          path: subPath,\n          coordinates: subCoordinates,\n          segmentLabel: segmentValueStr,\n          splitIndex\n        };\n\n        const isHovered = this.isHovered(subPath, series);\n        if (isHovered) {\n          bubble = this.renderHoverBubble(bubbleInfo);\n        }\n\n        const selected = this.isSelected(subPath, series.definition);\n        const faded = this.isFaded();\n        if (selected) {\n          bubble = this.renderSelectionBubble(bubbleInfo);\n          if (bubble) highlight = this.renderSelectionHighlight(chartStage, subCoordinates, chartIndex);\n        }\n\n        bar = <g\n          className={classNames(\"bar\", { \"selected\": selected, \"not-selected\": (!selected && faded), isHovered })}\n          key={String(segmentValue)}\n          transform={`translate(${roundToPx(x)}, 0)`}\n        >\n          <rect\n            className=\"background\"\n            width={roundToPx(barWidth)}\n            height={roundToPx(Math.abs(height))}\n            fill={visualizationColors.main}\n            x={barOffset}\n            y={roundToPx(y)}\n          />\n          {bubble}\n        </g>;\n\n      }\n\n      bars.push(bar);\n    });\n\n    return { bars, highlight };\n  }\n\n  renderSelectionHighlight(chartStage: Stage, coordinates: BarCoordinates, chartIndex: number): JSX.Element {\n    const { scrollLeft, scrollTop } = this.state;\n    const chartHeight = this.getOuterChartHeight(chartStage);\n    const { barWidth, height, barOffset, y, x } = coordinates;\n\n    const leftOffset = roundToPx(x) + barOffset - SELECTION_PAD + chartStage.x - scrollLeft;\n    const topOffset = roundToPx(y) - SELECTION_PAD + chartStage.y - scrollTop + chartHeight * chartIndex;\n\n    const style: React.CSSProperties = {\n      left: leftOffset,\n      top: topOffset,\n      width: roundToPx(barWidth + SELECTION_PAD * 2),\n      height: roundToPx(Math.abs(height) + SELECTION_PAD * 2)\n    };\n\n    return <div className=\"selection-highlight\" style={style}/>;\n  }\n\n  renderXAxis(data: Datum[], coordinates: BarCoordinates[], xAxisStage: Stage): JSX.Element {\n    const { essence } = this.props;\n    const xScale = this.getPrimaryXScale();\n    const xTicks = xScale.domain();\n\n    const split = essence.splits.splits.first();\n    const dimension = findDimensionByName(essence.dataCube.dimensions, split.reference);\n\n    const labels: JSX.Element[] = [];\n    if (canBucketByDefault(dimension)) {\n      const lastIndex = data.length - 1;\n      const ascending = split.sort.direction === SortDirection.ascending;\n      const leftThing = ascending ? \"start\" : \"end\";\n      const rightThing = ascending ? \"end\" : \"start\";\n      data.forEach((d, i) => {\n        const segmentValue = d[dimension.name];\n        let segmentValueStr = String(Range.isRange(segmentValue) ? (segmentValue as any)[leftThing] : \"\");\n        const coordinate = coordinates[i];\n\n        labels.push(<div\n          className=\"slanty-label continuous\"\n          key={i}\n          style={{ right: xAxisStage.width - coordinate.x }}\n        >{segmentValueStr}</div>);\n\n        if (i === lastIndex) {\n          segmentValueStr = String(Range.isRange(segmentValue) ? (segmentValue as any)[rightThing] : \"\");\n          labels.push(<div\n            className=\"slanty-label continuous\"\n            key=\"last-one\"\n            style={{ right: xAxisStage.width - (coordinate.x + coordinate.stepWidth) }}\n          >{segmentValueStr}</div>);\n        }\n      });\n    } else {\n      data.forEach((d, i) => {\n        const segmentValueStr = String(d[dimension.name]);\n        const coordinate = coordinates[i];\n\n        labels.push(<div\n          className=\"slanty-label categorical\"\n          key={segmentValueStr}\n          style={{ right: xAxisStage.width - (coordinate.x + coordinate.stepWidth / 2) }}\n        >{segmentValueStr}</div>);\n      });\n    }\n\n    return <div className=\"x-axis\" style={{ width: xAxisStage.width }}>\n      <svg style={xAxisStage.getWidthHeight()} viewBox={xAxisStage.getViewBox()}>\n        <BucketMarks stage={xAxisStage} ticks={xTicks} scale={xScale}/>\n      </svg>\n      {labels}\n    </div>;\n  }\n\n  getYAxisStuff(dataset: Dataset, series: ConcreteSeries, chartStage: Stage, chartIndex: number): {\n    yGridLines: JSX.Element, yAxis: JSX.Element, yScale: d3.ScaleLinear<number, number>\n  } {\n    const { yAxisStage } = this.getAxisStages(chartStage);\n\n    const yScale = this.getYScale(series, yAxisStage);\n    const yTicks = yScale.ticks(5);\n\n    const yGridLines: JSX.Element = <GridLines\n      orientation=\"horizontal\"\n      scale={yScale}\n      ticks={yTicks}\n      stage={chartStage}\n    />;\n\n    const axisStage = yAxisStage.changeY(yAxisStage.y + (chartStage.height + CHART_TOP_PADDING + CHART_BOTTOM_PADDING) * chartIndex);\n\n    const yAxis: JSX.Element = <VerticalAxis\n      formatter={series.formatter()}\n      key={series.reactKey()}\n      stage={axisStage}\n      ticks={yTicks}\n      tickSize={5}\n      scale={yScale}\n      hideZero={true}\n    />;\n\n    return { yGridLines, yAxis, yScale };\n  }\n\n  isChartVisible(chartIndex: number, xAxisStage: Stage): boolean {\n    const { stage } = this.props;\n    const { scrollTop } = this.state;\n\n    const chartStage = this.getSingleChartStage();\n    const chartHeight = this.getOuterChartHeight(chartStage);\n\n    const topY = chartIndex * chartHeight;\n    const viewPortHeight = stage.height - xAxisStage.height;\n    const hiddenAtBottom = topY - scrollTop >= viewPortHeight;\n\n    const bottomY = topY + chartHeight;\n    const hiddenAtTop = bottomY < scrollTop;\n\n    return !hiddenAtTop && !hiddenAtBottom;\n  }\n\n  renderChart(\n    dataset: Dataset,\n    coordinates: BarCoordinates[],\n    series: ConcreteSeries,\n    chartIndex: number,\n    chartStage: Stage\n  ): { yAxis: JSX.Element, chart: JSX.Element, highlight: JSX.Element } {\n    const { essence } = this.props;\n    const mySplitDataset = dataset.data[0][SPLIT] as Dataset;\n\n    const measureLabel = <VisMeasureLabel\n      series={series}\n      datum={dataset.data[0]}\n      showPrevious={essence.hasComparison()}/>;\n\n    // Invalid data, early return\n    if (!this.hasValidYExtent(series, mySplitDataset.data)) {\n      return {\n        chart: <div className=\"measure-bar-chart\" key={series.reactKey()} style={{ width: chartStage.width }}>\n          <svg style={chartStage.getWidthHeight(0, CHART_BOTTOM_PADDING)}\n               viewBox={chartStage.getViewBox(0, CHART_BOTTOM_PADDING)}/>\n          {measureLabel}\n        </div>,\n        yAxis: null,\n        highlight: null\n      };\n    }\n\n    const { xAxisStage } = this.getAxisStages(chartStage);\n\n    const { yAxis, yGridLines } = this.getYAxisStuff(mySplitDataset, series, chartStage, chartIndex);\n\n    let bars: JSX.Element[];\n    let highlight: JSX.Element;\n    if (this.isChartVisible(chartIndex, xAxisStage)) {\n      const renderedChart = this.renderBars(mySplitDataset.data, series, chartIndex, chartStage, xAxisStage, coordinates);\n      bars = renderedChart.bars;\n      highlight = renderedChart.highlight;\n    }\n\n    const chart = <div className=\"measure-bar-chart\" key={series.reactKey()} style={{ width: chartStage.width }}>\n      <svg style={chartStage.getWidthHeight(0, CHART_BOTTOM_PADDING)}\n           viewBox={chartStage.getViewBox(0, CHART_BOTTOM_PADDING)}>\n        {yGridLines}\n        <g className=\"bars\" transform={chartStage.getTransform()}>{bars}</g>\n      </svg>\n      {measureLabel}\n    </div>;\n\n    return { chart, yAxis, highlight };\n  }\n\n  private initState(): BarChartState {\n    const { essence, data } = this.props;\n    const { splits } = essence;\n    this.coordinatesCache = [];\n    if (!splits.length()) return {} as BarChartState;\n    const split = splits.splits.first();\n    const dimension = findDimensionByName(essence.dataCube.dimensions, split.reference);\n    const dimensionKind = dimension.kind;\n    const series = essence.getConcreteSeries().toArray();\n    // TODO: very suspicious\n    const paddedDataset = dimensionKind === \"number\" ? padDataset(data, dimension, series.map(s => s.measure)) : data;\n    const firstSplitDataSet = paddedDataset.data[0][SPLIT] as Dataset;\n    const flattened = firstSplitDataSet.flatten({\n      order: \"preorder\",\n      nestingName: \"__nest\"\n    });\n\n    const maxNumberOfLeaves = splits.splits.map(() => 0).toArray(); // initializing maxima to 0\n    this.maxNumberOfLeaves(firstSplitDataSet.data, maxNumberOfLeaves, 0);\n    const flatData = flattened.data;\n    return {\n      hoverInfo: null,\n      maxNumberOfLeaves,\n      flatData,\n      scrollTop: 0,\n      scrollLeft: 0\n    };\n  }\n\n  maxNumberOfLeaves(data: Datum[], maxima: number[], level: number) {\n    maxima[level] = Math.max(maxima[level], data.length);\n\n    if (data[0] && data[0][SPLIT] !== undefined) {\n      const n = data.length;\n      for (let i = 0; i < n; i++) {\n        this.maxNumberOfLeaves((data[i][SPLIT] as Dataset).data, maxima, level + 1);\n      }\n    }\n  }\n\n  getPrimaryXScale(): d3.ScaleBand<string> {\n    const { data } = this.props;\n    const { maxNumberOfLeaves } = this.state;\n    const dataset = (data.data[0][SPLIT] as Dataset).data;\n\n    const { essence } = this.props;\n    const { splits, dataCube } = essence;\n    const firstSplit = splits.splits.first();\n    const dimension = findDimensionByName(dataCube.dimensions, firstSplit.reference);\n\n    const getX = (d: Datum) => d[dimension.name] as string;\n\n    const { usedWidth, padLeft } = this.getXValues(maxNumberOfLeaves);\n\n    return d3.scaleBand()\n      .domain(dataset.map(getX))\n      .range([padLeft, padLeft + usedWidth]);\n  }\n\n  getBarDimensions(xRangeBand: number): { stepWidth: number, barWidth: number, barOffset: number } {\n    if (isNaN(xRangeBand)) xRangeBand = 0;\n    const stepWidth = xRangeBand;\n    const barWidth = Math.max(stepWidth * BAR_PROPORTION, 0);\n    const barOffset = (stepWidth - barWidth) / 2;\n\n    return { stepWidth, barWidth, barOffset };\n  }\n\n  getXValues(maxNumberOfLeaves: number[]): { padLeft: number, usedWidth: number } {\n    const { essence, stage } = this.props;\n    const overallWidth = stage.width - VIS_H_PADDING * 2 - Y_AXIS_WIDTH;\n\n    const numPrimarySteps = maxNumberOfLeaves[0];\n    const minStepWidth = MIN_STEP_WIDTH * maxNumberOfLeaves.slice(1).reduce(((a, b) => a * b), 1);\n\n    const maxAvailableWidth = overallWidth - BARS_MIN_PAD_LEFT - BARS_MIN_PAD_RIGHT;\n\n    let stepWidth: number;\n    if (minStepWidth * numPrimarySteps < maxAvailableWidth) {\n      stepWidth = Math.max(Math.min(maxAvailableWidth / numPrimarySteps, MAX_STEP_WIDTH * essence.splits.length()), MIN_STEP_WIDTH);\n    } else {\n      stepWidth = minStepWidth;\n    }\n\n    const usedWidth = stepWidth * maxNumberOfLeaves[0];\n    const padLeft = Math.max(BARS_MIN_PAD_LEFT, (overallWidth - usedWidth) / 2);\n\n    return { padLeft, usedWidth };\n  }\n\n  getBarsCoordinates(chartIndex: number, xScale: d3.ScaleBand<string>): BarCoordinates[] {\n    if (!!this.coordinatesCache[chartIndex]) {\n      return this.coordinatesCache[chartIndex];\n    }\n\n    const { data } = this.props;\n    const dataset = data.data[0][SPLIT] as Dataset;\n\n    const { essence } = this.props;\n    const { splits, dataCube } = essence;\n\n    const series = essence.getConcreteSeries().get(chartIndex);\n    const firstSplit = splits.splits.first();\n    const dimension = findDimensionByName(dataCube.dimensions, firstSplit.reference);\n\n    const chartStage = this.getSingleChartStage();\n    const yScale = this.getYScale(series, this.getAxisStages(chartStage).yAxisStage);\n\n    this.coordinatesCache[chartIndex] = this.getSubCoordinates(\n      dataset.data,\n      series,\n      chartStage,\n      (d: Datum) => d[dimension.name] as string,\n      xScale,\n      yScale\n    );\n\n    return this.coordinatesCache[chartIndex];\n  }\n\n  getSubCoordinates(\n    data: Datum[],\n    series: ConcreteSeries,\n    chartStage: Stage,\n    getX: (d: Datum, i: number) => string,\n    xScale: d3.ScaleBand<string>,\n    scaleY: d3.ScaleLinear<number, number>,\n    splitIndex = 1\n  ): BarCoordinates[] {\n    const { essence } = this.props;\n    const { maxNumberOfLeaves } = this.state;\n\n    const { stepWidth, barWidth, barOffset } = this.getBarDimensions(xScale.bandwidth());\n\n    const coordinates: BarCoordinates[] = data.map((d, i) => {\n      const x = xScale(getX(d, i));\n      const y = scaleY(series.selectValue(d));\n      const h = scaleY(0) - y;\n      const children: BarCoordinates[] = [];\n      const coordinate = new BarCoordinates({\n        x,\n        y: h >= 0 ? y : scaleY(0),\n        width: roundToPx(barWidth),\n        height: roundToPx(Math.abs(h)),\n        stepWidth,\n        barWidth,\n        barOffset,\n        children\n      });\n\n      if (splitIndex < essence.splits.length()) {\n        const subStage: Stage = new Stage({ x, y: chartStage.y, width: barWidth, height: chartStage.height });\n        const subGetX: any = (d: Datum, i: number) => String(i);\n        const subData: Datum[] = (d[SPLIT] as Dataset).data;\n        const subxScale = d3.scaleBand()\n          .domain(d3.range(0, maxNumberOfLeaves[splitIndex]).map(String))\n          .range([x + barOffset, x + subStage.width]);\n\n        coordinate.children = this.getSubCoordinates(subData, series, subStage, subGetX, subxScale, scaleY, splitIndex + 1);\n      }\n\n      return coordinate;\n    });\n\n    return coordinates;\n  }\n\n  renderRightGutter(seriesCount: number, yAxisStage: Stage, yAxes: JSX.Element[]): JSX.Element {\n    const yAxesStage = yAxisStage.changeHeight((yAxisStage.height + CHART_TOP_PADDING + CHART_BOTTOM_PADDING) * seriesCount);\n\n    return <svg style={yAxesStage.getWidthHeight()} viewBox={yAxesStage.getViewBox()}>\n      {yAxes}\n    </svg>;\n  }\n\n  renderSelectionContainer(selectionHighlight: JSX.Element, chartIndex: number, chartStage: Stage): JSX.Element {\n    return <div className=\"selection-highlight-container\">\n      {selectionHighlight}\n    </div>;\n  }\n\n  render() {\n    const { data, essence, stage } = this.props;\n    const { splits } = essence;\n\n    let scrollerLayout: ScrollerLayout;\n    const measureCharts: JSX.Element[] = [];\n    let xAxis: JSX.Element;\n    let rightGutter: JSX.Element;\n    let overlay: JSX.Element;\n\n    if (splits.length()) {\n      const xScale = this.getPrimaryXScale();\n      const yAxes: JSX.Element[] = [];\n      const series = essence.getConcreteSeries();\n\n      const chartStage = this.getSingleChartStage();\n      const { xAxisStage, yAxisStage } = this.getAxisStages(chartStage);\n      xAxis = this.renderXAxis((data.data[0][SPLIT] as Dataset).data, this.getBarsCoordinates(0, xScale), xAxisStage);\n\n      series.forEach((series, chartIndex) => {\n        const coordinates = this.getBarsCoordinates(chartIndex, xScale);\n        const { yAxis, chart, highlight } = this.renderChart(data, coordinates, series, chartIndex, chartStage);\n\n        measureCharts.push(chart);\n        yAxes.push(yAxis);\n        if (highlight) {\n          overlay = this.renderSelectionContainer(highlight, chartIndex, chartStage);\n        }\n      });\n\n      scrollerLayout = this.getScrollerLayout(chartStage, xAxisStage, yAxisStage);\n      rightGutter = this.renderRightGutter(series.count(), chartStage, yAxes);\n    }\n\n    return <div className=\"measure-bar-charts\" style={{ height: stage.height }}>\n      <Scroller\n        layout={scrollerLayout}\n        ref={this.scroller}\n\n        bottomGutter={xAxis}\n        rightGutter={rightGutter}\n\n        body={measureCharts}\n        overlay={overlay}\n\n        onClick={this.onClick}\n        onMouseMove={this.onMouseMove}\n        onMouseLeave={this.onMouseLeave}\n        onScroll={this.onScrollerScroll}\n      />\n    </div>;\n  }\n}\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { or } from \"../../../common/utils/functional/functional\";\nimport { Predicates } from \"../../../common/utils/rules/predicates\";\nimport {\n  TimeSeriesVisualizationControls\n} from \"../../components/timeseries-visualization-controls/visualization-controls\";\nimport {\n  ChartPanel,\n  DefaultVisualizationControls,\n  VisualizationProps\n} from \"../../views/cube-view/center-panel/center-panel\";\nimport \"./bar-chart.scss\";\nimport { BarChart as ImprovedBarChart } from \"./improved-bar-chart/bar-chart\";\nimport { BarChart } from \"./old-bar-chart/old-bar-chart\";\n\nconst newVersionSupports = or(\n  Predicates.areExactSplitKinds(\"time\"),\n  Predicates.areExactSplitKinds(\"*\", \"time\"),\n  Predicates.areExactSplitKinds(\"number\"),\n  Predicates.areExactSplitKinds(\"*\", \"number\")\n);\n\nexport default function BarChartVisualization(props: VisualizationProps) {\n  if (newVersionSupports(props.essence)) {\n    return <React.Fragment>\n      <TimeSeriesVisualizationControls {...props} />\n      <ChartPanel {...props} chartComponent={ImprovedBarChart} />\n    </React.Fragment>;\n  }\n  return <React.Fragment>\n    <DefaultVisualizationControls {...props} />\n    <ChartPanel {...props} chartComponent={BarChart}/>\n  </React.Fragment>;\n}\n"],"sourceRoot":""}