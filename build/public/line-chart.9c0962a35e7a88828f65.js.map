{"version":3,"sources":["webpack:///./src/client/utils/dataset/selectors/selectors.ts","webpack:///./src/client/visualizations/line-chart/utils/splits.ts","webpack:///./src/client/components/bubble-title/bubble-title.tsx","webpack:///./src/client/utils/linear-scale/linear-scale.ts","webpack:///./src/client/components/series-bubble-content/series-bubble-content.tsx","webpack:///./src/client/components/modal-bubble/modal-bubble.tsx","webpack:///./src/client/components/highlight-modal/highlight-modal.tsx","webpack:///./src/client/components/segment-bubble/segment-bubble.tsx","webpack:///./src/client/components/measure-bubble-content/measure-bubble-content.tsx","webpack:///./src/client/components/grid-lines/grid-lines.tsx","webpack:///./src/client/utils/highlight-clause/highlight-clause.ts","webpack:///./src/client/visualizations/line-chart/utils/is-valid-clause.ts","webpack:///./src/client/components/color-swabs/color-entry.tsx","webpack:///./src/client/components/vis-measure-label/vis-measure-label.tsx","webpack:///./src/client/components/vertical-axis/vertical-axis.tsx","webpack:///./src/client/components/color-swabs/color-swabs.tsx","webpack:///./src/client/utils/extent/extent.ts","webpack:///./src/client/components/tooltip-within-stage/calculate-position.ts","webpack:///./src/client/components/tooltip-within-stage/tooltip-within-stage.tsx","webpack:///./src/client/components/timeseries-visualization-controls/split-menu.tsx","webpack:///./src/client/components/timeseries-visualization-controls/visualization-controls.tsx","webpack:///./src/client/components/grid-border/grid-border.tsx","webpack:///./src/client/components/highlighter/highlighter.tsx","webpack:///./src/client/visualizations/line-chart/legend/legend.tsx","webpack:///./src/client/visualizations/line-chart/legend/split-legend.tsx","webpack:///./src/client/visualizations/line-chart/charts/calculate-chart-stage.ts","webpack:///./src/client/visualizations/line-chart/interactions/interaction.ts","webpack:///./src/client/utils/mouse-event-offset/mouse-event-offset.ts","webpack:///./src/client/visualizations/line-chart/base-chart/background/background.tsx","webpack:///./src/client/visualizations/line-chart/base-chart/foreground/highlight-modal.tsx","webpack:///./src/client/visualizations/line-chart/base-chart/foreground/hover-tooltip.tsx","webpack:///./src/client/visualizations/line-chart/interactions/continuous-range.ts","webpack:///./src/client/visualizations/line-chart/base-chart/foreground/selection-overlay.tsx","webpack:///./src/client/visualizations/line-chart/base-chart/foreground/foreground.tsx","webpack:///./src/client/visualizations/line-chart/base-chart/foreground/hover-guide.tsx","webpack:///./src/client/visualizations/line-chart/base-chart/base-chart.tsx","webpack:///./src/client/visualizations/line-chart/chart-line/prepare-data-points.ts","webpack:///./src/client/visualizations/line-chart/chart-line/chart-line.tsx","webpack:///./src/client/visualizations/line-chart/chart-line/series-chart-line.tsx","webpack:///./src/client/visualizations/line-chart/chart-line/colored-series-chart-line.tsx","webpack:///./src/client/visualizations/line-chart/chart-line/singleton-series-chart-line.tsx","webpack:///./src/client/visualizations/line-chart/charts/charts-per-series/series-hover-content.tsx","webpack:///./src/client/visualizations/line-chart/charts/charts-per-series/series-chart.tsx","webpack:///./src/client/visualizations/line-chart/utils/extent.ts","webpack:///./src/client/visualizations/line-chart/charts/charts-per-series/charts-per-series.tsx","webpack:///./src/client/visualizations/line-chart/legend/series-legend.tsx","webpack:///./src/client/visualizations/line-chart/charts/charts-per-split/label.tsx","webpack:///./src/client/visualizations/line-chart/charts/charts-per-split/split-hover-content.tsx","webpack:///./src/client/visualizations/line-chart/charts/charts-per-split/split-chart.tsx","webpack:///./src/client/visualizations/line-chart/charts/charts-per-split/charts-per-split.tsx","webpack:///./src/client/visualizations/line-chart/charts/charts-per-split/nominal-value-key.ts","webpack:///./src/client/visualizations/line-chart/charts/charts.tsx","webpack:///./src/client/visualizations/line-chart/interactions/find-closest-datum.ts","webpack:///./src/client/visualizations/line-chart/interactions/snap-range-to-grid.ts","webpack:///./src/client/visualizations/line-chart/interactions/interaction-controller.tsx","webpack:///./src/client/visualizations/line-chart/utils/pick-x-axis-ticks.ts","webpack:///./src/client/visualizations/line-chart/utils/x-scale.ts","webpack:///./src/common/utils/plywood/range.ts","webpack:///./src/client/visualizations/line-chart/x-axis/x-axis.tsx","webpack:///./src/client/visualizations/line-chart/line-chart.tsx"],"names":["selectMainDatum","dataset","data","selectSplitDataset","datum","SPLIT","selectDatums","selectSplitDatums","compose","selectFirstSplitDataset","selectFirstSplitDatums","dimensionForSplit","essence","split","findDimensionByName","dataCube","dimensions","reference","getContinuousSplit","splits","last","getContinuousDimension","getContinuousReference","getNominalSplit","count","first","hasNominalSplit","getNominalDimension","BubbleTitle","title","minWidth","clamp","length","className","style","pickTicks","scale","ticksCount","ticks","filter","n","getScale","min","max","height","isNaN","d3","domain","Math","nice","range","SeriesBubbleContent","props","series","showPrevious","Fragment","formatValue","currentValue","selectValue","previousValue","SeriesDerivation","PREVIOUS","formatter","lowerIsBetter","measure","current","previous","ModalBubble","React","Component","el","this","modalRef","e","target","isInside","onClose","render","children","left","top","mouseDown","onMouseDown","classNames","ref","setModalRef","direction","HighlightModal","acceptHighlight","dropHighlight","type","onClick","STRINGS","select","cancel","SegmentBubble","content","SegmentBubbleContent","MeasureBubbleContent","GridLines","orientation","stage","transform","getTransform","map","tick","value","roundToHalfPx","coordinates","x1","x2","width","y1","y2","lineCoordinates","key","String","toFilterClause","TimeRange","isTimeRange","dateRange","DateRange","values","List","of","FixedTimeFilterClause","PlywoodNumberRange","isNumberRange","numberRange","NumberRange","NumberFilterClause","Error","toPlywoodRange","clause","isValidClause","Range","fromJS","createColorEntry","color","name","hasComparison","delta","VisMeasureLabel","CURRENT","renderPrevious","VerticalAxis","tickSize","inputTicks","topLineExtend","hideZero","lines","y","labelX","labels","x","dy","ColorSwabs","colorEntries","colorSwabs","swabStyle","background","seriesSelectors","get","d","readNumber","datumsExtent","datums","selectors","reduce","acc","selector","extent","calculatePosition","rect","initialTop","initialLeft","margin","stageBottom","stageRight","bottom","right","TooltipWithinStage","createRef","componentDidMount","setState","self","getBoundingClientRect","state","TimeSeriesContinuousSplitMenu","saveSplit","containerStage","dimension","openOn","granularity","setGranularity","useState","bucket","granularityToString","isValid","validateSplit","onSave","newSplit","createSplit","granularityChange","TimeSeriesCategorySplitMenu","sortOptions","DimensionSortOn","seriesSortOns","toArray","customization","visualizationColors","useSettingsContext","limitOptions","useMemo","colorSplitLimits","sort","setSort","limit","setLimit","selected","SortOn","fromSort","options","onChange","selectedLimit","limits","includeNone","onLimitSelect","TimeSeriesSplitMenu","equals","TimeSeriesSplitTile","splitMenuComponent","TimeSeriesSplitTilesRow","splitTileComponent","TimeSeriesVisualizationControls","splitTilesRow","BottomBorder","tickLength","RightBorder","Highlighter","whiteoutLeftStyle","frameStyle","whiteoutRightStyle","LegendValues","i","Legend","SplitLegend","legendSplit","legendDimension","getTitle","calculateChartStage","chartsCount","VIS_H_PADDING","maxHeightFromRatio","heightFromStageDivision","boundedChartHeight","floor","Stage","InteractionKind","mouseEventOffset","event","currentTarget","cx","clientX","cy","clientY","element","window","isHover","interaction","kind","HOVER","createDragging","start","end","DRAGGING","isDragging","isHighlight","HIGHLIGHT","Background","gridStage","axisStage","xScale","yScale","xTicks","timezone","midpoint","HoverTooltip","constructRange","a","b","shiftByOne","orderValues","Date","second","shift","SelectionOverlay","getHighlightRange","getLeftTopWidthHeight","Foreground","container","visualisationStage","hoverContent","HoverGuide","hover","offsetX","BaseChart","interactions","yDomain","chartStage","chartId","label","mouseLeave","dragStart","handleHover","xRange","lineStage","within","hasInteraction","getWidthHeight","viewBox","getViewBox","onMouseMove","onMouseLeave","areDetached","valueOf","nextMidpoint","rangeWidth","previousMidpoint","prepareDataPoints","getX","getY","flatMap","index","maybeY","concatTruthy","currentIndex","shouldInsertPreviousPoint","next","shouldInsertNextPoint","ChartLine","mainColor","main","dashed","showArea","area","y0","line","points","scaledPoints","hasMultiplePoints","hasSinglePoint","stroke","strokeDasharray","undefined","fill","alphaMain","r","SeriesChartLine","reactKey","ColoredSeriesChartLine","SingletonSeriesChartLine","nominalSplit","continuousRef","hoverDatum","dimensionName","findDatumByAttribute","findSplitDatumByAttribute","SeriesHoverContent","entries","continuousDimension","measureLabel","SeriesChart","continuousSplitDataset","continuousSplit","getters","splitDataset","extentAcrossSplits","splitKey","plywoodKey","ChartsPerSeries","concreteSeries","getConcreteSeries","SeriesLegend","Label","nominalDimension","splitValue","formatSegment","ColoredSeries","SplitHoverContent","SplitChart","selectDatum","splitDatum","s","extentAcrossSeries","firstSeries","defaultFormatter","ChartsPerSplit","hasMultipleSeries","getNthDatum","getChartsSelectors","nominalValueKey","Charts","groupSeries","visualizationSettings","findClosest","scaleX","closestDatum","minDist","Infinity","continuousSegmentValue","isRange","mid","dist","abs","distPx","roundTo","v","round","InteractionController","scrollTop","offset","hoverRange","findRangeUnderOffset","findValueUnderOffset","calculateOffset","saveHighlight","duration","bucketSize","startFloored","endFloored","snapRangeToGrid","scrollEvent","chartsContainerRef","invert","flatten","findClosestDatum","highlight","clauses","createHighlight","hocProps","handleDragStart","mouseUp","stopDragging","mouseMove","dragging","scroll","scrollCharts","pickXAxisTicks","materialize","generateDateTicks","getBestBucketUnitForRange","generateNumberTicks","getFilterRange","timekeeper","continuousFilterClause","getEffectiveFilter","clauseForReference","filterRange","maxTime","continuousBucket","Duration","filterRangeEnd","filterRangeEndFloored","filterRangeEndCeiled","includeMaxTimeBucket","getMaxTime","safeRangeSum","extend","calculateXRange","datasetRange","getDatasetXRange","union","floatFormat","XAxis","fromSize","format","scaleTicksFormatter","date","getMoment","labelFormatter","TICK_HEIGHT","textAnchor","LineChartVisualization","chartComponent","LineChart","LINE_CHART_MANIFEST","domainRange","createContinuousScale","maxHeight","chartsRef","changeHeight"],"mappings":"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","file":"line-chart.9c0962a35e7a88828f65.js","sourcesContent":["/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Dataset, Datum } from \"plywood\";\nimport { compose } from \"../../../../common/utils/functional/functional\";\nimport { SPLIT } from \"../../../config/constants\";\n\nexport const selectMainDatum = (dataset: Dataset): Datum =>\n  dataset.data[0];\n\nexport const selectSplitDataset = (datum: Datum): Dataset =>\n  datum[SPLIT] as Dataset;\n\nexport const selectDatums = (dataset: Dataset): Datum[] =>\n  dataset.data;\n\nexport const selectSplitDatums: (datum: Datum) => Datum[] =\n  compose(selectSplitDataset, selectDatums);\n\nexport const selectFirstSplitDataset: (dataset: Dataset) => Dataset =\n  compose(selectMainDatum, selectSplitDataset);\n\nexport const selectFirstSplitDatums: (dataset: Dataset) => Datum[] =\n  compose(selectFirstSplitDataset, selectDatums);\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Dimension } from \"../../../../common/models/dimension/dimension\";\nimport { findDimensionByName } from \"../../../../common/models/dimension/dimensions\";\nimport { Essence } from \"../../../../common/models/essence/essence\";\nimport { Split } from \"../../../../common/models/split/split\";\n\nfunction dimensionForSplit(essence: Essence, split: Split): Dimension {\n   return findDimensionByName(essence.dataCube.dimensions, split.reference);\n}\n\nexport function getContinuousSplit({ splits: { splits } }: Essence): Split {\n   return splits.last();\n}\n\nexport function getContinuousDimension(essence: Essence): Dimension {\n   const split = getContinuousSplit(essence);\n   return dimensionForSplit(essence, split);\n}\n\nexport function getContinuousReference(essence: Essence): string {\n   return getContinuousSplit(essence).reference;\n}\n\nexport function getNominalSplit({ splits: { splits } }: Essence): Split | null {\n   return splits.count() === 1 ? null : splits.first();\n}\n\nexport function hasNominalSplit(essence: Essence): boolean {\n   return getNominalSplit(essence) !== null;\n}\n\nexport function getNominalDimension(essence: Essence): Dimension | null {\n   const split = getNominalSplit(essence);\n   return split && dimensionForSplit(essence, split);\n}\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { clamp } from \"../../utils/dom/dom\";\n\nconst PER_LETTER_PIXELS = 8;\nconst MIN_TITLE_WIDTH = 80;\nconst MAX_TITLE_WIDTH = 300;\n\ninterface BubbleTitleProps {\n  title: string;\n}\n\nexport const BubbleTitle: React.FunctionComponent<BubbleTitleProps> = ({ title }) => {\n  const minWidth = clamp(title.length * PER_LETTER_PIXELS, MIN_TITLE_WIDTH, MAX_TITLE_WIDTH);\n  return <div className=\"title\" style={{ minWidth }}>{title}</div>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as d3 from \"d3\";\n\nexport type LinearScale = d3.ScaleLinear<number, number>;\n\nexport const TICKS_COUNT = 5;\n\nexport function pickTicks(scale: LinearScale, ticksCount = TICKS_COUNT): number[] {\n  return scale.ticks(ticksCount).filter(n => n !== 0);\n}\n\nexport default function getScale([min, max]: number[], height: number): LinearScale | null {\n  if (isNaN(min) || isNaN(max)) {\n    return null;\n  }\n\n  return d3.scaleLinear()\n    .domain([Math.min(min, 0), Math.max(max, 0)])\n    .nice(TICKS_COUNT)\n    .range([height, 0]);\n}\n","/*\n * Copyright 2017-2020 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Datum } from \"plywood\";\nimport React from \"react\";\nimport { ConcreteSeries, SeriesDerivation } from \"../../../common/models/series/concrete-series\";\nimport { MeasureBubbleContent } from \"../measure-bubble-content/measure-bubble-content\";\n\ninterface SeriesBubbleContentProps {\n  series: ConcreteSeries;\n  datum: Datum;\n  showPrevious: boolean;\n}\n\nexport const SeriesBubbleContent: React.FunctionComponent<SeriesBubbleContentProps> = props => {\n  const { series, datum, showPrevious } = props;\n  if (!showPrevious) {\n    return <React.Fragment>\n      {series.formatValue(datum)}\n    </React.Fragment>;\n  }\n  const currentValue = series.selectValue(datum);\n  const previousValue = series.selectValue(datum, SeriesDerivation.PREVIOUS);\n  const formatter = series.formatter();\n  return <MeasureBubbleContent\n    lowerIsBetter={series.measure.lowerIsBetter}\n    formatter={formatter}\n    current={currentValue}\n    previous={previousValue}\n  />;\n};\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { classNames, isInside } from \"../../utils/dom/dom\";\nimport { BodyPortal } from \"../body-portal/body-portal\";\nimport { GlobalEventListener } from \"../global-event-listener/global-event-listener\";\nimport { Shpitz } from \"../shpitz/shpitz\";\nimport \"./modal-bubble.scss\";\n\ninterface ModalProps {\n  left: number;\n  top: number;\n  onClose: Fn;\n  className?: string;\n}\n\nexport class ModalBubble extends React.Component<ModalProps, {}> {\n\n  modalRef: HTMLDivElement;\n\n  setModalRef = (el: HTMLDivElement) => {\n    this.modalRef = el;\n  };\n\n  onMouseDown = (e: MouseEvent) => {\n    const target = e.target as Element;\n    if (isInside(target, this.modalRef)) return;\n    this.props.onClose();\n  };\n\n  render() {\n    const { className, children, left, top } = this.props;\n    return <React.Fragment>\n      <GlobalEventListener mouseDown={this.onMouseDown} />\n      <BodyPortal left={left} top={top}>\n        <div className={classNames(\"modal-bubble\", className)} ref={this.setModalRef}>\n          {children}\n          <Shpitz direction=\"up\" />\n        </div>\n      </BodyPortal>\n    </React.Fragment>;\n  }\n}\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { STRINGS } from \"../../config/constants\";\nimport { BubbleTitle } from \"../bubble-title/bubble-title\";\nimport { Button } from \"../button/button\";\nimport { ModalBubble } from \"../modal-bubble/modal-bubble\";\nimport \"./highlight-modal.scss\";\n\ninterface HighlightModalProps {\n  title: string;\n  left: number;\n  top: number;\n  dropHighlight: Fn;\n  acceptHighlight: Fn;\n}\n\nexport const HighlightModal: React.FunctionComponent<HighlightModalProps> = ({ title, children, left, top, acceptHighlight, dropHighlight }) =>\n  <ModalBubble className=\"highlight-modal\" left={left} top={top} onClose={dropHighlight}>\n    <BubbleTitle title={title} />\n    <div className=\"value\">{children}</div>\n    <div className=\"actions\">\n      <Button type=\"primary\" className=\"accept mini\" onClick={acceptHighlight} title={STRINGS.select} />\n      <Button type=\"secondary\" className=\"drop mini\" onClick={dropHighlight} title={STRINGS.cancel} />\n    </div>\n  </ModalBubble>;\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { ReactNode } from \"react\";\nimport { BodyPortal } from \"../body-portal/body-portal\";\nimport { BubbleTitle } from \"../bubble-title/bubble-title\";\nimport { Shpitz } from \"../shpitz/shpitz\";\nimport \"./segment-bubble.scss\";\n\nconst OFFSET_V = -10;\n\nexport interface SegmentBubbleProps extends SegmentBubbleContentProps {\n  left: number;\n  top: number;\n}\n\nexport const SegmentBubble: React.FunctionComponent<SegmentBubbleProps> = (props: SegmentBubbleProps) => {\n  const { left, top, title, content } = props;\n  return <BodyPortal left={left} top={top + OFFSET_V}>\n    <div className=\"segment-bubble\">\n      <SegmentBubbleContent title={title} content={content} />\n      <Shpitz direction=\"up\" />\n    </div>\n  </BodyPortal>;\n};\n\nexport interface SegmentBubbleContentProps {\n  title: string;\n  content?: ReactNode;\n}\n\nexport const SegmentBubbleContent: React.FunctionComponent<SegmentBubbleContentProps> = ({ title, content }: SegmentBubbleContentProps) => (\n  <div className=\"segment-bubble-text\">\n    <BubbleTitle title={title} />\n    {content ? <div className=\"content\">{content}</div> : null}\n  </div>\n);\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { Delta } from \"../delta/delta\";\nimport \"./measure-bubble-content.scss\";\n\nexport interface MeasureBubbleContentProps {\n  current: number;\n  previous: number;\n  formatter: Unary<number, string>;\n  lowerIsBetter?: boolean;\n}\n\nexport const MeasureBubbleContent: React.FunctionComponent<MeasureBubbleContentProps> = ({ lowerIsBetter, formatter, current, previous }) => {\n  const currentValue = formatter(current);\n  const previousValue = formatter(previous);\n  return <React.Fragment>\n    <strong className=\"current-value\">{currentValue}</strong>\n    <span className=\"previous-value\">{previousValue}</span>\n    <Delta formatter={formatter} currentValue={current} previousValue={previous} lowerIsBetter={lowerIsBetter} />\n  </React.Fragment>;\n};\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { classNames, roundToHalfPx } from \"../../utils/dom/dom\";\nimport \"./grid-lines.scss\";\n\nexport interface GridLinesProps {\n  orientation: \"horizontal\" | \"vertical\";\n  stage: Stage;\n  ticks: unknown[];\n  scale: Unary<unknown, number>;\n}\n\ninterface Coordinates {\n  x1: number;\n  x2: number;\n  y1: number;\n  y2: number;\n}\n\nfunction lineCoordinates(orientation: \"horizontal\" | \"vertical\", value: number, stage: Stage): Coordinates {\n  switch (orientation) {\n    case \"horizontal\":\n      return { x1: 0, x2: stage.width, y1: value, y2: value };\n    case \"vertical\":\n      return { x1: value, x2: value, y1: 0, y2: stage.height };\n  }\n}\n\nexport const GridLines: React.FunctionComponent<GridLinesProps> = props => {\n  const { orientation, stage, ticks, scale } = props;\n\n  return <g className={classNames(\"grid-lines\", orientation)} transform={stage.getTransform()}>\n    {ticks.map((tick: unknown) => {\n      const value = roundToHalfPx(scale(tick));\n      const coordinates = lineCoordinates(orientation, value, stage);\n      return <line key={String(tick)} {...coordinates} />;\n    })}\n  </g>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { List } from \"immutable\";\nimport { NumberRange as PlywoodNumberRange, Range, TimeRange } from \"plywood\";\nimport { DateRange } from \"../../../common/models/date-range/date-range\";\nimport { FilterClause, FixedTimeFilterClause, NumberFilterClause, NumberRange } from \"../../../common/models/filter-clause/filter-clause\";\nimport { ContinuousRange } from \"../../visualizations/line-chart/utils/continuous-types\";\nimport { isValidClause } from \"../../visualizations/line-chart/utils/is-valid-clause\";\n\nexport function toFilterClause(range: ContinuousRange, reference: string): FilterClause {\n  if (TimeRange.isTimeRange(range)) {\n    const dateRange = new DateRange(range);\n    const values = List.of(dateRange);\n    return new FixedTimeFilterClause({ reference, values });\n  }\n  if (PlywoodNumberRange.isNumberRange(range)) {\n    const numberRange = new NumberRange(range);\n    const values = List.of(numberRange);\n    return new NumberFilterClause({ reference, values });\n  }\n  throw new Error(`Expected Number or Time range, got: ${range}`);\n}\n\nexport function toPlywoodRange(clause: FilterClause): ContinuousRange {\n  if (!isValidClause(clause)) {\n    throw new Error(`Expected Number or FixedTime Filter Clause. Got ${clause}`);\n  }\n  const value = clause.values.first();\n  return Range.fromJS(value) as ContinuousRange;\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { FilterClause, FixedTimeFilterClause, NumberFilterClause } from \"../../../../common/models/filter-clause/filter-clause\";\n\nexport function isValidClause(clause: FilterClause): clause is FixedTimeFilterClause | NumberFilterClause {\n  return (clause instanceof FixedTimeFilterClause) || (clause instanceof NumberFilterClause);\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Datum } from \"plywood\";\nimport React from \"react\";\nimport { ConcreteSeries, SeriesDerivation } from \"../../../common/models/series/concrete-series\";\nimport { Delta } from \"../delta/delta\";\n\nexport interface ColorEntry {\n  color: string;\n  name: string;\n  value: string;\n  previous?: string;\n  delta?: JSX.Element;\n}\n\ninterface Parameters {\n  color: string;\n  name: string;\n  series: ConcreteSeries;\n  datum: Datum;\n  hasComparison: boolean;\n}\n\nexport function createColorEntry({ color, name, series, datum, hasComparison }: Parameters): ColorEntry {\n  const current = {\n    color,\n    name,\n    value: series.formatValue(datum)\n  };\n\n  if (!hasComparison) return current;\n\n  return {\n    ...current,\n    previous: series.formatValue(datum, SeriesDerivation.PREVIOUS),\n    delta: <Delta\n      currentValue={series.selectValue(datum)}\n      previousValue={series.selectValue(datum, SeriesDerivation.PREVIOUS)}\n      lowerIsBetter={series.measure.lowerIsBetter}\n      formatter={series.formatter()} />\n  };\n}\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Datum } from \"plywood\";\nimport React from \"react\";\nimport { ConcreteSeries, SeriesDerivation } from \"../../../common/models/series/concrete-series\";\nimport { Delta } from \"../delta/delta\";\nimport \"./vis-measure-label.scss\";\n\nexport interface VisMeasureLabelProps {\n  series: ConcreteSeries;\n  datum: Datum;\n  showPrevious: boolean;\n}\n\nfunction renderPrevious(datum: Datum, series: ConcreteSeries): JSX.Element {\n  const current = series.selectValue(datum, SeriesDerivation.CURRENT);\n  const previous = series.selectValue(datum, SeriesDerivation.PREVIOUS);\n  const formatter = series.formatter();\n  return <React.Fragment>\n    <span className=\"measure-previous-value\">\n      {formatter(previous)}\n      </span>\n    <Delta\n      formatter={formatter}\n      lowerIsBetter={series.measure.lowerIsBetter}\n      currentValue={current}\n      previousValue={previous} />\n  </React.Fragment>;\n}\n\nexport const VisMeasureLabel: React.FunctionComponent<VisMeasureLabelProps> = ({ series, datum, showPrevious }) => {\n  return <div className=\"vis-measure-label\">\n    <span className=\"measure-title\">{series.title()}</span>\n    <span className=\"colon\">: </span>\n    <span className=\"measure-value\">{series.formatValue(datum)}</span>\n    {showPrevious && renderPrevious(datum, series)}\n  </div>;\n};\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { roundToHalfPx } from \"../../utils/dom/dom\";\nimport \"./vertical-axis.scss\";\n\nconst TEXT_OFFSET = 2;\n\nexport interface VerticalAxisProps {\n  stage: Stage;\n  ticks: number[];\n  tickSize: number;\n  scale: any;\n  formatter: Unary<number, string>;\n  topLineExtend?: number;\n  hideZero?: boolean;\n}\n\nexport const VerticalAxis: React.FunctionComponent<VerticalAxisProps> = ({ formatter, stage, tickSize, ticks: inputTicks, scale, topLineExtend = 0, hideZero }) => {\n  const ticks = hideZero ? inputTicks.filter((tick: number) => tick !== 0) : inputTicks;\n\n  const lines = ticks.map((tick: any) => {\n    const y = roundToHalfPx(scale(tick));\n    return <line className=\"tick\" key={String(tick)} x1={0} y1={y} x2={tickSize} y2={y} />;\n  });\n\n  const labelX = tickSize + TEXT_OFFSET;\n  const dy = \"0.31em\";\n\n  const labels = ticks.map((tick: any) => {\n    const y = scale(tick);\n    return <text className=\"tick\" key={String(tick)} x={labelX} y={y} dy={dy}>{formatter(tick)}</text>;\n  });\n\n  return <g className=\"vertical-axis\" transform={stage.getTransform()}>\n    <line className=\"border\" x1={0.5} y1={-topLineExtend} x2={0.5} y2={stage.height} />\n    {lines}\n    {labels}\n  </g>;\n};\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { ColorEntry } from \"./color-entry\";\nimport \"./color-swabs.scss\";\n\ninterface ColorSwabsProps {\n  colorEntries: ColorEntry[];\n}\n\nexport const ColorSwabs: React.FunctionComponent<ColorSwabsProps> = ({ colorEntries }) => {\n  const colorSwabs = colorEntries.map(({ color, name, value, previous, delta }: ColorEntry) => {\n    const swabStyle = { background: color };\n    return <tr key={name}>\n      <td>\n        <div className=\"color-swab\" style={swabStyle} />\n      </td>\n      <td className=\"color-name\">{name}</td>\n      <td className=\"color-value\">{value}</td>\n      {previous && <td className=\"color-previous\">{previous}</td>}\n      {delta && <td className=\"color-delta\">{delta}</td>}\n    </tr>;\n  });\n\n  return <table className=\"color-swabs\">\n    <tbody>{colorSwabs}</tbody>\n  </table>;\n};\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport * as d3 from \"d3\";\nimport { Datum } from \"plywood\";\nimport { ConcreteSeries, SeriesDerivation } from \"../../../common/models/series/concrete-series\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { readNumber } from \"../../../common/utils/general/general\";\n\nexport type Selector = Unary<Datum, number>;\nexport type Extent = [number, number];\n\nexport function seriesSelectors(series: ConcreteSeries, hasComparison: boolean): Selector[] {\n  const get = (d: Datum) => readNumber(series.selectValue(d));\n  if (!hasComparison) return [get];\n  return [\n    get,\n    (d: Datum) => readNumber(series.selectValue(d, SeriesDerivation.PREVIOUS))\n  ];\n}\n\nexport function datumsExtent(datums: Datum[], selectors: Selector[]): Extent {\n  return selectors.reduce((acc, selector) => {\n    const extent =  d3.extent(datums, selector);\n    return d3.extent([...extent, ...acc]);\n  }, [0, 0]) as Extent;\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { TooltipWithinStageProps } from \"./tooltip-within-stage\";\n\nexport type Rect = ClientRect | DOMRect;\n\nexport type Position = Pick<React.CSSProperties, \"left\" | \"top\">;\n\nexport function calculatePosition(props: TooltipWithinStageProps, rect?: Rect): Position {\n  const { top: initialTop, left: initialLeft, stage, margin = 10 } = props;\n  if (!rect) {\n    const top = initialTop + margin;\n    const left = initialLeft + margin;\n    return { top, left };\n  }\n\n  const stageBottom = stage.y + stage.height;\n  const stageRight = stage.x + stage.width;\n\n  const top = rect.bottom > stageBottom\n    ? initialTop - margin - rect.height\n    : rect.top < stage.y\n      ? initialTop + rect.height\n      : initialTop + margin;\n\n  const left = rect.right > stageRight\n    ? initialLeft - margin - rect.width\n    : rect.left < stage.x\n      ? initialLeft + rect.width\n      : initialLeft + margin;\n\n  return { top, left };\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { calculatePosition, Rect } from \"./calculate-position\";\nimport \"./tooltip-within-stage.scss\";\n\nexport interface TooltipWithinStageProps {\n  stage: Stage;\n  top: number;\n  left: number;\n  margin?: number;\n}\n\ninterface TooltipWithinStageState {\n  rect?: Rect;\n}\n\nexport class TooltipWithinStage extends React.Component<TooltipWithinStageProps, TooltipWithinStageState> {\n\n  private self = React.createRef<HTMLDivElement>();\n\n  state: TooltipWithinStageState = {};\n\n  componentDidMount() {\n    this.setState({\n      rect: this.self.current.getBoundingClientRect()\n    });\n  }\n\n  render() {\n    const { children } = this.props;\n    return <div\n      className=\"tooltip-within-stage\"\n      style={calculatePosition(this.props, this.state.rect)}\n      ref={this.self}>\n      {children}\n    </div>;\n  }\n}\n","/*\n * Copyright 2017-2022 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React, { useMemo, useState } from \"react\";\nimport { colorSplitLimits } from \"../../../common/models/colors/colors\";\nimport { granularityToString } from \"../../../common/models/granularity/granularity\";\nimport { DimensionSortOn, SortOn } from \"../../../common/models/sort-on/sort-on\";\nimport { useSettingsContext } from \"../../views/cube-view/settings-context\";\nimport { getContinuousSplit } from \"../../visualizations/line-chart/utils/splits\";\nimport { GranularityPicker } from \"../split-menu/granularity-picker\";\nimport { LimitDropdown } from \"../split-menu/limit-dropdown\";\nimport { SortDropdown } from \"../split-menu/sort-dropdown\";\nimport { SplitMenuProps } from \"../split-menu/split-menu\";\nimport { createSplit, SplitMenuBase, validateSplit } from \"../split-menu/split-menu-base\";\n\nconst TimeSeriesContinuousSplitMenu: React.FunctionComponent<SplitMenuProps> = props => {\n  const { saveSplit, containerStage, split, dimension, onClose, openOn } = props;\n  const [granularity, setGranularity] = useState(() => split.bucket && granularityToString(split.bucket));\n\n  const onSave = () => {\n    const newSplit = createSplit({\n      dimension,\n      split,\n      granularity\n    });\n    saveSplit(split, newSplit);\n  };\n\n  const isValid = validateSplit({ split, dimension, granularity });\n\n  return <SplitMenuBase\n    openOn={openOn}\n    containerStage={containerStage}\n    onClose={onClose}\n    onSave={onSave}\n    dimension={dimension}\n    isValid={isValid}>\n    <GranularityPicker\n      granularity={granularity}\n      dimension={dimension}\n      granularityChange={setGranularity}/>\n  </SplitMenuBase>;\n};\n\nconst TimeSeriesCategorySplitMenu: React.FunctionComponent<SplitMenuProps> = props => {\n  const { openOn, containerStage, onClose, dimension, saveSplit, split, essence } = props;\n\n  const sortOptions = [\n    new DimensionSortOn(dimension),\n    ...essence.seriesSortOns(true).toArray()\n  ];\n\n  const { customization: { visualizationColors: { series } } } = useSettingsContext();\n  const limitOptions = useMemo(() => colorSplitLimits(series.length), [series.length]);\n\n  const [sort, setSort] = useState(split.sort);\n  const [limit, setLimit] = useState(split.limit);\n\n  const isValid = validateSplit({ split, dimension, limit, sort });\n\n  const onSave = () => {\n    const newSplit = createSplit({\n      dimension,\n      split,\n      limit,\n      sort\n    });\n    saveSplit(split, newSplit);\n  };\n\n  return <SplitMenuBase\n    openOn={openOn}\n    containerStage={containerStage}\n    onClose={onClose}\n    onSave={onSave}\n    dimension={dimension}\n    isValid={isValid}>\n    <SortDropdown\n      direction={sort.direction}\n      selected={SortOn.fromSort(sort, essence)}\n      options={sortOptions}\n      onChange={setSort}/>\n    <LimitDropdown\n      selectedLimit={limit}\n      limits={limitOptions}\n      includeNone={false}\n      onLimitSelect={setLimit}/>\n  </SplitMenuBase>;\n};\n\nexport const TimeSeriesSplitMenu: React.FunctionComponent<SplitMenuProps> = props => {\n  const { essence, split } = props;\n\n  const isContinuousSplit = split.equals(getContinuousSplit(essence));\n\n  if (isContinuousSplit) {\n    return <TimeSeriesContinuousSplitMenu {...props} />;\n  } else {\n    return <TimeSeriesCategorySplitMenu {...props} />;\n  }\n};\n","/*\n * Copyright 2017-2022 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { VisualizationControls, VisualizationControlsBaseProps } from \"../../views/cube-view/center-panel/center-panel\";\nimport { SplitTile, SplitTileBaseProps } from \"../split-tile/split-tile\";\nimport { SplitTilesRow, SplitTilesRowBaseProps } from \"../split-tile/split-tiles-row\";\nimport { TimeSeriesSplitMenu } from \"./split-menu\";\n\nconst TimeSeriesSplitTile: React.FunctionComponent<SplitTileBaseProps> = props =>\n  <SplitTile splitMenuComponent={TimeSeriesSplitMenu} {...props} />;\n\nconst TimeSeriesSplitTilesRow: React.FunctionComponent<SplitTilesRowBaseProps> = props =>\n  <SplitTilesRow {...props} splitTileComponent={TimeSeriesSplitTile}/>;\n\nexport const TimeSeriesVisualizationControls: React.FunctionComponent<VisualizationControlsBaseProps> = props =>\n  <VisualizationControls {...props} splitTilesRow={TimeSeriesSplitTilesRow}/>;\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { roundToHalfPx } from \"../../utils/dom/dom\";\nimport \"./grid-border.scss\";\n\ninterface BottomBorderProps {\n  stage: Stage;\n  tickLength: number;\n}\n\nexport const BottomBorder: React.FunctionComponent<BottomBorderProps> = ({ stage, tickLength }) => {\n  return <line\n    className=\"grid-border grid-bottom-border\"\n    transform={stage.getTransform()}\n    x1={0}\n    x2={stage.width + tickLength}\n    y1={roundToHalfPx(stage.height - 1)}\n    y2={roundToHalfPx(stage.height - 1)}\n  />;\n};\n\ninterface RightBorderProps {\n stage: Stage;\n}\n\nexport const RightBorder: React.FunctionComponent<RightBorderProps> = ({ stage }) => {\n  return <line\n    className=\"grid-border grid-right-border\"\n    transform={stage.getTransform()}\n    x1={roundToHalfPx(stage.width - 1)}\n    x2={roundToHalfPx(stage.width - 1)}\n    y1={0}\n    y2={stage.height} />;\n};\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport \"./highlighter.scss\";\n\nexport interface HighlighterProps {\n  left: number;\n  right: number;\n  top?: number;\n  bottom?: number;\n}\n\nexport function Highlighter(props: HighlighterProps) {\n  const { left, bottom = 0, right, top = 0 } = props;\n\n  const whiteoutLeftStyle = {\n    width: Math.max(left, 0)\n  };\n\n  const frameStyle = {\n    left,\n    top,\n    bottom,\n    width: Math.max(right - left, 0)\n  };\n\n  const whiteoutRightStyle = {\n    left: right\n  };\n\n  return <div className=\"highlighter\">\n    <div className=\"whiteout left\" style={whiteoutLeftStyle} />\n    <div className=\"frame\" style={frameStyle} />\n    <div className=\"whiteout right\" style={whiteoutRightStyle} />\n  </div>;\n}\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { useSettingsContext } from \"../../../views/cube-view/settings-context\";\nimport \"./legend.scss\";\n\nexport interface LegendProps {\n  values: string[];\n  title: string;\n}\n\ninterface LegendValuesProps {\n  values: string[];\n}\n\nconst LegendValues: React.FunctionComponent<LegendValuesProps> = props => {\n  const { customization: { visualizationColors } } = useSettingsContext();\n  const { values } = props;\n  return <div className=\"legend-values\">\n    <table className=\"legend-values-table\">\n      <tbody>\n      {values.map((value, i) => {\n        const style = { background: visualizationColors.series[i] };\n        return <tr key={value} className=\"legend-value\">\n          <td className=\"legend-value-color-cell\">\n            <div className=\"legend-value-color\" style={style} />\n          </td>\n          <td className=\"legend-value-label\">\n            <span className=\"legend-value-name\">{value}</span>\n          </td>\n        </tr>;\n      })}\n      </tbody>\n    </table>\n  </div>;\n};\n\nexport const Legend: React.FunctionComponent<LegendProps> = props => {\n  const { values, title } = props;\n\n  return <div className=\"line-chart-legend\">\n    <div className=\"legend-header\">\n      {title}\n    </div>\n    <LegendValues values={values} />\n  </div>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Dataset } from \"plywood\";\nimport React from \"react\";\nimport { findDimensionByName } from \"../../../../common/models/dimension/dimensions\";\nimport { Essence } from \"../../../../common/models/essence/essence\";\nimport { selectFirstSplitDatums } from \"../../../utils/dataset/selectors/selectors\";\nimport { Legend } from \"./legend\";\n\ninterface SplitLegendProps {\n  dataset: Dataset;\n  essence: Essence;\n}\n\nexport const SplitLegend: React.FunctionComponent<SplitLegendProps> = props => {\n  const { essence, dataset } = props;\n  const legendSplit = essence.splits.splits.first();\n\n  const legendDimension = findDimensionByName(essence.dataCube.dimensions, legendSplit.reference);\n  const title = legendSplit.getTitle(legendDimension);\n\n  const nestedDataset = selectFirstSplitDatums(dataset);\n  const values = nestedDataset.map(datum => String(legendSplit.selectValue(datum)));\n\n  return <Legend\n    values={values}\n    title={title}/>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Stage } from \"../../../../common/models/stage/stage\";\nimport { VIS_H_PADDING } from \"../../../config/constants\";\n\nconst X_AXIS_HEIGHT = 30;\nconst MIN_CHART_HEIGHT = 200;\nconst MAX_ASPECT_RATIO = 1; // width / height\n\nexport function calculateChartStage(stage: Stage, chartsCount: number): Stage {\n  const width = stage.width - VIS_H_PADDING * 2;\n  const maxHeightFromRatio = width / MAX_ASPECT_RATIO;\n  const heightFromStageDivision = (stage.height - X_AXIS_HEIGHT) / chartsCount;\n  const boundedChartHeight = Math.floor(Math.min(\n    maxHeightFromRatio,\n    heightFromStageDivision\n  ));\n  const height = Math.max(MIN_CHART_HEIGHT, boundedChartHeight);\n\n  return new Stage({\n    x: VIS_H_PADDING,\n    y: 0,\n    width,\n    height\n  });\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { FilterClause } from \"../../../../common/models/filter-clause/filter-clause\";\nimport { Highlight as VizHighlight } from \"../../highlight-controller/highlight\";\nimport { ContinuousRange, ContinuousValue } from \"../utils/continuous-types\";\n\nenum InteractionKind { HOVER, DRAGGING, HIGHLIGHT }\n\ninterface InteractionBase {\n  kind: InteractionKind;\n  key: string;\n}\n\nexport interface Hover extends InteractionBase {\n  kind: InteractionKind.HOVER;\n  range: ContinuousRange;\n}\n\nexport const createHover = (key: string, range: ContinuousRange): Hover => ({\n  kind: InteractionKind.HOVER,\n  range,\n  key\n});\n\nexport const isHover = (interaction?: Interaction): interaction is Hover => interaction && interaction.kind === InteractionKind.HOVER;\n\nexport interface Dragging extends InteractionBase {\n  kind: InteractionKind.DRAGGING;\n  start: ContinuousValue;\n  end: ContinuousValue;\n}\n\nexport const createDragging = (key: string, start: ContinuousValue, end: ContinuousValue): Dragging => ({\n  kind: InteractionKind.DRAGGING,\n  start,\n  end,\n  key\n});\n\nexport const isDragging = (interaction?: Interaction): interaction is Dragging => interaction && interaction.kind === InteractionKind.DRAGGING;\n\nexport interface Highlight extends InteractionBase {\n  kind: InteractionKind.HIGHLIGHT;\n  clause: FilterClause;\n}\n\nexport const createHighlight = (highlight: VizHighlight): Highlight => ({\n  kind: InteractionKind.HIGHLIGHT,\n  clause: highlight.clauses.first(),\n  key: highlight.key\n});\n\nexport const isHighlight = (interaction?: Interaction): interaction is Highlight => interaction && interaction.kind === InteractionKind.HIGHLIGHT;\n\nexport type MouseInteraction = Hover | Dragging;\n\nexport type Interaction = Hover | Dragging | Highlight;\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\n\nfunction getBoundingClientOffset(element: HTMLElement | Window): { left: number, top: number } {\n  if (element === window) {\n    return { top: 0, left: 0 };\n  }\n  // typescript doesn't know that window is only value inhabiting Window type and can't narrow type here\n  return (element as HTMLElement).getBoundingClientRect();\n}\n\nexport function mouseEventOffset(event: React.MouseEvent<HTMLElement> | MouseEvent): [number, number] {\n  const target = event.currentTarget as HTMLElement;\n  const cx = event.clientX || 0;\n  const cy = event.clientY || 0;\n  const { left, top } = getBoundingClientOffset(target);\n  return [cx - left, cy - top];\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Stage } from \"../../../../../common/models/stage/stage\";\nimport { Unary } from \"../../../../../common/utils/functional/functional\";\nimport { BottomBorder } from \"../../../../components/grid-border/grid-border\";\nimport { GridLines } from \"../../../../components/grid-lines/grid-lines\";\nimport { VerticalAxis } from \"../../../../components/vertical-axis/vertical-axis\";\nimport { LinearScale, pickTicks } from \"../../../../utils/linear-scale/linear-scale\";\nimport { ContinuousScale } from \"../../utils/continuous-types\";\nimport { ContinuousTicks } from \"../../utils/pick-x-axis-ticks\";\n\nexport const TICK_WIDTH = 5;\n\ninterface BackgroundProps {\n  gridStage: Stage;\n  axisStage: Stage;\n  xScale: ContinuousScale;\n  xTicks: ContinuousTicks;\n  yScale: LinearScale;\n  formatter: Unary<number, string>;\n}\n\nexport const Background: React.FunctionComponent<BackgroundProps> = props => {\n  const { formatter, gridStage, axisStage, xScale, yScale, xTicks } = props;\n\n  return <React.Fragment>\n    <GridLines\n      orientation=\"horizontal\"\n      scale={yScale}\n      ticks={pickTicks(yScale)}\n      stage={gridStage}\n    />\n    {/* TODO: omit last xTick if it's equal to last data point so we don't overplot with yAxis */}\n    <GridLines\n      orientation=\"vertical\"\n      scale={xScale}\n      ticks={xTicks}\n      stage={gridStage}\n    />\n    <VerticalAxis\n      tickSize={TICK_WIDTH}\n      stage={axisStage}\n      formatter={formatter}\n      ticks={pickTicks(yScale)}\n      scale={yScale}\n    />\n    <BottomBorder stage={gridStage} tickLength={TICK_WIDTH} />\n  </React.Fragment>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Timezone } from \"chronoshift\";\nimport React from \"react\";\nimport { formatValue } from \"../../../../../common/utils/formatter/formatter\";\nimport { Nullary } from \"../../../../../common/utils/functional/functional\";\nimport { HighlightModal as BaseHighlightModal } from \"../../../../components/highlight-modal/highlight-modal\";\nimport { toPlywoodRange } from \"../../../../utils/highlight-clause/highlight-clause\";\nimport { Highlight } from \"../../interactions/interaction\";\nimport { ContinuousScale } from \"../../utils/continuous-types\";\n\ninterface HighlightModalProps {\n  interaction: Highlight;\n  dropHighlight: Nullary<void>;\n  acceptHighlight: Nullary<void>;\n  timezone: Timezone;\n  xScale: ContinuousScale;\n  rect: ClientRect | DOMRect;\n}\n\nexport const HighlightModal: React.FunctionComponent<HighlightModalProps> = props => {\n  const { rect: { left, top }, interaction, timezone, dropHighlight, acceptHighlight, xScale } = props;\n  const range = toPlywoodRange(interaction.clause);\n  const x = xScale(range.midpoint());\n  return <BaseHighlightModal\n    title={formatValue(range, timezone)}\n    left={left + x}\n    top={top + 80}\n    dropHighlight={dropHighlight}\n    acceptHighlight={acceptHighlight} />;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Timezone } from \"chronoshift\";\nimport React from \"react\";\nimport { ReactNode } from \"react\";\nimport { Stage } from \"../../../../../common/models/stage/stage\";\nimport { formatValue } from \"../../../../../common/utils/formatter/formatter\";\nimport { SegmentBubbleContent } from \"../../../../components/segment-bubble/segment-bubble\";\nimport { TooltipWithinStage } from \"../../../../components/tooltip-within-stage/tooltip-within-stage\";\nimport { Hover } from \"../../interactions/interaction\";\nimport { ContinuousScale } from \"../../utils/continuous-types\";\n\ninterface HoverTooltipProps {\n  interaction: Hover;\n  xScale: ContinuousScale;\n  timezone: Timezone;\n  content: ReactNode;\n  stage: Stage;\n}\n\nexport const HoverTooltip: React.FunctionComponent<HoverTooltipProps> = props => {\n  const { content, interaction, xScale, timezone, stage } = props;\n  const { range } = interaction;\n  const x = xScale(range.midpoint());\n\n  return <TooltipWithinStage key={x} top={60} left={x} stage={stage}>\n    <SegmentBubbleContent\n      title={formatValue(range, timezone)}\n      content={content} />\n  </TooltipWithinStage>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { second, Timezone } from \"chronoshift\";\nimport { Range } from \"plywood\";\nimport { ContinuousDomain, ContinuousRange, ContinuousValue } from \"../utils/continuous-types\";\n\nfunction orderValues(a: ContinuousValue, b: ContinuousValue, timezone: Timezone): ContinuousDomain {\n  if (a > b) return [b, a];\n  if (b > a) return [a, b];\n  return [a, shiftByOne(a, timezone)];\n}\n\nexport function constructRange(a: ContinuousValue, b: ContinuousValue, timezone: Timezone): ContinuousRange {\n  const [start, end] = orderValues(a, b, timezone);\n  return Range.fromJS({ start, end }) as ContinuousRange;\n}\n\nexport function shiftByOne(value: ContinuousValue, timezone: Timezone): ContinuousValue {\n  return value instanceof Date ? second.shift(value, timezone, 1) : value + 1;\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Timezone } from \"chronoshift\";\nimport { Range } from \"plywood\";\nimport React from \"react\";\nimport { Stage } from \"../../../../../common/models/stage/stage\";\nimport { Highlighter } from \"../../../../components/highlighter/highlighter\";\nimport { constructRange } from \"../../interactions/continuous-range\";\nimport { Interaction, isDragging, isHighlight } from \"../../interactions/interaction\";\nimport { ContinuousRange, ContinuousScale } from \"../../utils/continuous-types\";\nimport { isValidClause } from \"../../utils/is-valid-clause\";\n\ninterface SelectionOverlayProps {\n  interaction: Interaction;\n  stage: Stage;\n  xScale: ContinuousScale;\n  timezone: Timezone;\n}\n\nfunction getHighlightRange(interaction: Interaction, timezone: Timezone): ContinuousRange | null {\n  if (isDragging(interaction)) {\n    return constructRange(interaction.start, interaction.end, timezone);\n  }\n  if (isHighlight(interaction)) {\n    const { clause } = interaction;\n    if (!isValidClause(clause)) {\n      throw new Error(`Expected FixedTime or Number Filter clause. Got: ${clause}`);\n    }\n    return Range.fromJS(clause.values.first()) as ContinuousRange;\n  }\n  return null;\n}\n\nexport const SelectionOverlay: React.FunctionComponent<SelectionOverlayProps> = props => {\n  const { stage, timezone, interaction, xScale } = props;\n  const range = getHighlightRange(interaction, timezone);\n  if (!range) return null;\n\n  const left = xScale(range.start);\n  const right = xScale(range.end);\n\n  return <div style={stage.getLeftTopWidthHeight()}>\n    <Highlighter left={left} right={right}/>\n  </div>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Timezone } from \"chronoshift\";\nimport React from \"react\";\nimport { ReactNode } from \"react\";\nimport { Stage } from \"../../../../../common/models/stage/stage\";\nimport { Nullary } from \"../../../../../common/utils/functional/functional\";\nimport { Interaction, isHighlight, isHover } from \"../../interactions/interaction\";\nimport { ContinuousScale } from \"../../utils/continuous-types\";\nimport { HighlightModal } from \"./highlight-modal\";\nimport { HoverTooltip } from \"./hover-tooltip\";\nimport { SelectionOverlay } from \"./selection-overlay\";\n\ninterface ForegroundProps {\n  interaction: Interaction;\n  stage: Stage;\n  visualisationStage: Stage;\n  container: React.RefObject<HTMLDivElement>;\n  dropHighlight: Nullary<void>;\n  acceptHighlight: Nullary<void>;\n  hoverContent?: ReactNode;\n  xScale: ContinuousScale;\n  timezone: Timezone;\n}\n\nexport const Foreground: React.FunctionComponent<ForegroundProps> = props => {\n  const { stage, interaction, container, xScale, timezone, visualisationStage, hoverContent, dropHighlight, acceptHighlight } = props;\n\n  return <React.Fragment>\n    <SelectionOverlay\n      stage={stage}\n      interaction={interaction}\n      timezone={timezone}\n      xScale={xScale} />\n    {isHover(interaction) && <HoverTooltip\n      stage={visualisationStage}\n      interaction={interaction}\n      xScale={xScale}\n      content={hoverContent}\n      timezone={timezone} />}\n    {isHighlight(interaction) && <HighlightModal\n      rect={container.current.getBoundingClientRect()}\n      interaction={interaction}\n      xScale={xScale}\n      timezone={timezone}\n      dropHighlight={dropHighlight}\n      acceptHighlight={acceptHighlight} />}\n  </React.Fragment>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as d3 from \"d3\";\nimport React from \"react\";\nimport { Stage } from \"../../../../../common/models/stage/stage\";\nimport { Hover } from \"../../interactions/interaction\";\nimport { ContinuousScale } from \"../../utils/continuous-types\";\n\ninterface HoverGuideProps {\n  hover: Hover;\n  stage: Stage;\n  yScale: d3.ScaleLinear<number, number>;\n  xScale: ContinuousScale;\n}\n\nexport const HoverGuide: React.FunctionComponent<HoverGuideProps> = props => {\n  const { stage, hover: { range }, yScale, xScale } = props;\n  const midpoint = range.midpoint();\n  const x = xScale(midpoint);\n  const [y2, y1] = yScale.range();\n  return <line\n    transform={stage.getTransform()}\n    x1={x}\n    x2={x}\n    y1={0}\n    y2={stage.height}\n    className=\"hover-guide\" />;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Timezone } from \"chronoshift\";\nimport React from \"react\";\nimport { ReactNode } from \"react\";\nimport { Stage } from \"../../../../common/models/stage/stage\";\nimport { Unary } from \"../../../../common/utils/functional/functional\";\nimport getScale from \"../../../utils/linear-scale/linear-scale\";\nimport { mouseEventOffset } from \"../../../utils/mouse-event-offset/mouse-event-offset\";\nimport { Scale } from \"../chart-line/chart-line\";\nimport { isHover } from \"../interactions/interaction\";\nimport { InteractionsProps } from \"../interactions/interaction-controller\";\nimport { ContinuousScale } from \"../utils/continuous-types\";\nimport { ContinuousTicks } from \"../utils/pick-x-axis-ticks\";\nimport { Background } from \"./background/background\";\nimport \"./base-chart.scss\";\nimport { Foreground } from \"./foreground/foreground\";\nimport { HoverGuide } from \"./foreground/hover-guide\";\n\ninterface ChartLinesProps {\n  yScale: Scale;\n  lineStage: Stage;\n}\n\nclass BaseChartProps {\n  chartId: string;\n  children: Unary<ChartLinesProps, ReactNode>;\n  label: ReactNode;\n  hoverContent?: ReactNode;\n  xScale: ContinuousScale;\n  timezone: Timezone;\n  xTicks: ContinuousTicks;\n  chartStage: Stage;\n  visualisationStage: Stage;\n  formatter: Unary<number, string>;\n  yDomain: [number, number];\n  interactions: InteractionsProps;\n}\n\nconst TEXT_SPACER = 36;\n\nconst offsetX = (e: React.MouseEvent<HTMLElement> | MouseEvent) => mouseEventOffset(e)[0];\n\nexport class BaseChart extends React.Component<BaseChartProps> {\n\n  private container = React.createRef<HTMLDivElement>();\n\n  render() {\n    const { hoverContent, interactions, timezone, yDomain, visualisationStage, chartStage, chartId, children, label, formatter, xScale, xTicks } = this.props;\n    const { interaction, dropHighlight, acceptHighlight, mouseLeave, dragStart, handleHover } = interactions;\n\n    const [, xRange] = xScale.range();\n    const lineStage = chartStage.within({ top: TEXT_SPACER, right: chartStage.width - xRange });\n    const axisStage = chartStage.within({ top: TEXT_SPACER, left: xRange });\n\n    const yScale = getScale(yDomain, lineStage.height);\n    const hasInteraction = interaction && interaction.key === chartId;\n\n    return <React.Fragment>\n      <div className=\"line-base-chart\" ref={this.container} style={chartStage.getWidthHeight()}>\n        <svg className=\"chart-stage\" viewBox={chartStage.getViewBox()}>\n          <Background\n            axisStage={axisStage}\n            formatter={formatter}\n            gridStage={lineStage}\n            xScale={xScale}\n            xTicks={xTicks}\n            yScale={yScale} />\n          {children({ yScale, lineStage })}\n          {hasInteraction && isHover(interaction) && <HoverGuide\n            hover={interaction}\n            stage={lineStage}\n            yScale={yScale}\n            xScale={xScale} />}\n        </svg>\n        <div style={lineStage.getWidthHeight()}\n             className=\"event-region\"\n             onMouseDown={e => dragStart(chartId, offsetX(e))}\n             onMouseMove={e => handleHover(chartId, offsetX(e))}\n             onMouseLeave={mouseLeave}\n        />\n        {label}\n        {hasInteraction && <Foreground\n          container={this.container}\n          stage={lineStage}\n          visualisationStage={visualisationStage}\n          interaction={interaction}\n          hoverContent={hoverContent}\n          dropHighlight={dropHighlight}\n          acceptHighlight={acceptHighlight}\n          xScale={xScale}\n          timezone={timezone} />}\n      </div>\n    </React.Fragment>;\n  }\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Datum, PlywoodRange } from \"plywood\";\nimport { concatTruthy, flatMap, Unary } from \"../../../../common/utils/functional/functional\";\nimport { ContinuousRange } from \"../utils/continuous-types\";\n\ntype DataPoint = [number, number];\n\nfunction areDetached(a: PlywoodRange | null, b: PlywoodRange | null): boolean {\n  return a && b && a.end.valueOf() !== b.start.valueOf();\n}\n\nfunction nextMidpoint(range: ContinuousRange): number {\n  const rangeWidth = range.end.valueOf() - range.start.valueOf();\n  return range.midpoint().valueOf() + rangeWidth;\n}\n\nfunction previousMidpoint(range: ContinuousRange): number {\n  const rangeWidth = range.end.valueOf() - range.start.valueOf();\n  return range.midpoint().valueOf() - rangeWidth;\n}\n\nfunction shouldInsertPreviousPoint(dataset: Datum[], currentIndex: number, getX: Unary<Datum, ContinuousRange>): boolean {\n  const previous = dataset[currentIndex - 1];\n  if (!previous) return false;\n  const current = dataset[currentIndex];\n  return areDetached(getX(previous), getX(current));\n}\n\nfunction shouldInsertNextPoint(dataset: Datum[], currentIndex: number, getX: Unary<Datum, ContinuousRange>): boolean {\n  const next = dataset[currentIndex + 1];\n  if (!next) return false;\n  const current = dataset[currentIndex];\n  return areDetached(getX(current), getX(next));\n}\n\nexport function prepareDataPoints(dataset: Datum[], getX: Unary<Datum, ContinuousRange>, getY: Unary<Datum, number>): DataPoint[] {\n  return flatMap(dataset, (datum, index) => {\n    const range = getX(datum);\n    const x = range.midpoint().valueOf();\n    const maybeY = getY(datum);\n    const y = isNaN(maybeY) ? 0 : maybeY;\n\n    return concatTruthy<DataPoint>(\n      shouldInsertPreviousPoint(dataset, index, getX) && [previousMidpoint(range), 0],\n      [x, y],\n      shouldInsertNextPoint(dataset, index, getX) && [nextMidpoint(range), 0]\n    );\n  });\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as d3 from \"d3\";\nimport { Datum } from \"plywood\";\nimport React from \"react\";\nimport { alphaMain } from \"../../../../common/models/colors/colors\";\nimport { Stage } from \"../../../../common/models/stage/stage\";\nimport { Unary } from \"../../../../common/utils/functional/functional\";\nimport { useSettingsContext } from \"../../../views/cube-view/settings-context\";\nimport { ContinuousRange, ContinuousScale } from \"../utils/continuous-types\";\nimport \"./chart-line.scss\";\nimport { prepareDataPoints } from \"./prepare-data-points\";\n\nexport type Scale = d3.ScaleLinear<number, number>;\n\nexport interface ChartLineProps {\n  xScale: ContinuousScale;\n  yScale: Scale;\n  getX: Unary<Datum, ContinuousRange>;\n  getY: Unary<Datum, number>;\n  color?: string;\n  showArea: boolean;\n  dashed: boolean;\n  dataset: Datum[];\n  stage: Stage;\n}\n\nexport const ChartLine: React.FunctionComponent<ChartLineProps> = props => {\n  const { customization: { visualizationColors } } = useSettingsContext();\n  const mainColor = visualizationColors.main;\n  const { color = mainColor, dashed, getX, getY, dataset, showArea, stage, xScale, yScale } = props;\n\n  const area = d3.area().y0(yScale(0));\n  const line = d3.line();\n\n  const points = prepareDataPoints(dataset, getX, getY);\n  const scaledPoints = points.map(([x, y]) => [xScale(x), yScale(y)] as [number, number]);\n  const hasMultiplePoints = points.length > 1;\n  const hasSinglePoint = points.length === 1;\n\n  return <g className=\"chart-line\" transform={stage.getTransform()}>\n    {hasMultiplePoints && <path\n      className=\"line\"\n      d={line(scaledPoints)}\n      stroke={color}\n      strokeDasharray={dashed ? \"4 2\" : undefined}/>}\n    {hasMultiplePoints && showArea && <path\n      className=\"area\"\n      fill={alphaMain(visualizationColors)}\n      d={area(scaledPoints)}/>}\n    {hasSinglePoint && <circle\n      className=\"singleton\"\n      cx={scaledPoints[0][0]}\n      cy={scaledPoints[0][1]}\n      r=\"2\"\n      style={{ fill: color }}\n    />}\n  </g>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Datum } from \"plywood\";\nimport React from \"react\";\nimport { Essence } from \"../../../../common/models/essence/essence\";\nimport { ConcreteSeries, SeriesDerivation } from \"../../../../common/models/series/concrete-series\";\nimport { Unary } from \"../../../../common/utils/functional/functional\";\nimport { readNumber } from \"../../../../common/utils/general/general\";\nimport { ChartLine, ChartLineProps } from \"./chart-line\";\n\ninterface OwnProps {\n  essence: Essence;\n  series: ConcreteSeries;\n}\n\nexport type SeriesChartLineProps = Pick<ChartLineProps, \"showArea\" | \"getX\" | \"xScale\" | \"yScale\" | \"dataset\" | \"color\" | \"stage\"> & OwnProps;\n\nexport const SeriesChartLine: React.FunctionComponent<SeriesChartLineProps> = props => {\n  const { showArea, essence, series, getX, stage, dataset, xScale, yScale, color } = props;\n\n  const getY: Unary<Datum, number> = (d: Datum) => readNumber(series.selectValue(d));\n  const getYP: Unary<Datum, number> = (d: Datum) => readNumber(series.selectValue(d, SeriesDerivation.PREVIOUS));\n  const hasComparison = essence.hasComparison();\n  return <React.Fragment key={series.reactKey()}>\n    <ChartLine\n      key=\"current\"\n      xScale={xScale}\n      yScale={yScale}\n      getX={getX}\n      getY={getY}\n      showArea={showArea}\n      color={color}\n      dashed={false}\n      dataset={dataset}\n      stage={stage} />\n    {hasComparison && <ChartLine\n      key=\"previous\"\n      xScale={xScale}\n      yScale={yScale}\n      getX={getX}\n      getY={getYP}\n      showArea={showArea}\n      color={color}\n      dashed={true}\n      dataset={dataset}\n      stage={stage} />}\n  </React.Fragment>;\n\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Omit } from \"../../../../common/utils/functional/functional\";\nimport { SeriesChartLine, SeriesChartLineProps } from \"./series-chart-line\";\n\ntype ColoredSeriesChartLine = Omit<SeriesChartLineProps, \"color\"  | \"showArea\"> & { color: string };\n\nexport const ColoredSeriesChartLine: React.FunctionComponent<ColoredSeriesChartLine> = props => {\n  return <SeriesChartLine {...props} showArea={false}/>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Omit } from \"../../../../common/utils/functional/functional\";\nimport { SeriesChartLine, SeriesChartLineProps } from \"./series-chart-line\";\n\ntype SingletonSeriesChartLineProps = Omit<SeriesChartLineProps, \"color\" | \"showArea\">;\n\nexport const SingletonSeriesChartLine: React.FunctionComponent<SingletonSeriesChartLineProps> = props => {\n  return <SeriesChartLine {...props} showArea={true} />;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Dataset, Datum, PlywoodRange } from \"plywood\";\nimport React from \"react\";\nimport { ReactNode } from \"react\";\nimport { VisualizationColors } from \"../../../../../common/models/colors/colors\";\nimport { Essence } from \"../../../../../common/models/essence/essence\";\nimport { ConcreteSeries } from \"../../../../../common/models/series/concrete-series\";\nimport { ColorEntry, createColorEntry } from \"../../../../components/color-swabs/color-entry\";\nimport { ColorSwabs } from \"../../../../components/color-swabs/color-swabs\";\nimport { SeriesBubbleContent } from \"../../../../components/series-bubble-content/series-bubble-content\";\nimport { selectSplitDataset } from \"../../../../utils/dataset/selectors/selectors\";\nimport { useSettingsContext } from \"../../../../views/cube-view/settings-context\";\nimport { getContinuousDimension, getContinuousReference, getNominalSplit, hasNominalSplit } from \"../../utils/splits\";\n\nfunction findSplitDatumByAttribute(d: Datum, dimensionName: string, range: PlywoodRange): Datum {\n  const dataset = selectSplitDataset(d);\n  return dataset != null ? dataset.findDatumByAttribute(dimensionName, range) : null;\n}\n\nfunction measureLabel(dataset: Dataset, range: PlywoodRange, series: ConcreteSeries, essence: Essence): ReactNode {\n  const continuousDimension = getContinuousDimension(essence);\n  const datum = dataset.findDatumByAttribute(continuousDimension.name, range);\n  if (!datum) return null;\n\n  return <SeriesBubbleContent series={series} datum={datum} showPrevious={essence.hasComparison()}/>;\n}\n\nfunction colorEntries(dataset: Dataset, range: PlywoodRange, series: ConcreteSeries, essence: Essence, visualizationColors: VisualizationColors): ColorEntry[] {\n  const { data } = dataset;\n  const nominalSplit = getNominalSplit(essence);\n  const continuousRef = getContinuousReference(essence);\n  const hasComparison = essence.hasComparison();\n  return data.map((datum, i) => {\n    const name = String(nominalSplit.selectValue(datum));\n    const color = visualizationColors.series[i];\n    const hoverDatum = findSplitDatumByAttribute(datum, continuousRef, range);\n\n    if (!hoverDatum) {\n      return {\n        color,\n        name,\n        value: \"-\"\n      };\n    }\n\n    return createColorEntry({\n      color,\n      name,\n      series,\n      datum: hoverDatum,\n      hasComparison\n    });\n  });\n}\n\ninterface SeriesHoverContentProps {\n  essence: Essence;\n  dataset: Dataset;\n  range: PlywoodRange;\n  series: ConcreteSeries;\n}\n\nexport const SeriesHoverContent: React.FunctionComponent<SeriesHoverContentProps> = props => {\n  const { customization: { visualizationColors } } = useSettingsContext();\n  const { essence, range, series, dataset } = props;\n  if (hasNominalSplit(essence)) {\n    const entries = colorEntries(dataset, range, series, essence, visualizationColors);\n    return <ColorSwabs colorEntries={entries} />;\n  }\n  return <React.Fragment>\n    {measureLabel(dataset, range, series, essence)}\n  </React.Fragment>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Dataset, Datum, NumberRange, TimeRange } from \"plywood\";\nimport React from \"react\";\nimport { Essence } from \"../../../../../common/models/essence/essence\";\nimport { ConcreteSeries } from \"../../../../../common/models/series/concrete-series\";\nimport { Stage } from \"../../../../../common/models/stage/stage\";\nimport { VisMeasureLabel } from \"../../../../components/vis-measure-label/vis-measure-label\";\nimport { selectFirstSplitDataset, selectMainDatum, selectSplitDatums } from \"../../../../utils/dataset/selectors/selectors\";\nimport { useSettingsContext } from \"../../../../views/cube-view/settings-context\";\nimport { BaseChart } from \"../../base-chart/base-chart\";\nimport { ColoredSeriesChartLine } from \"../../chart-line/colored-series-chart-line\";\nimport { SingletonSeriesChartLine } from \"../../chart-line/singleton-series-chart-line\";\nimport { isHover } from \"../../interactions/interaction\";\nimport { InteractionsProps } from \"../../interactions/interaction-controller\";\nimport { ContinuousScale } from \"../../utils/continuous-types\";\nimport { extentAcrossSplits } from \"../../utils/extent\";\nimport { ContinuousTicks } from \"../../utils/pick-x-axis-ticks\";\nimport { getContinuousSplit, getNominalSplit, hasNominalSplit } from \"../../utils/splits\";\nimport { SeriesHoverContent } from \"./series-hover-content\";\n\ninterface SeriesChartProps {\n  chartId: string;\n  interactions: InteractionsProps;\n  essence: Essence;\n  dataset: Dataset;\n  series: ConcreteSeries;\n  xScale: ContinuousScale;\n  xTicks: ContinuousTicks;\n  chartStage: Stage;\n  visualisationStage: Stage;\n}\n\nexport const SeriesChart: React.FunctionComponent<SeriesChartProps> = props => {\n  const { customization: { visualizationColors } } = useSettingsContext();\n  const { chartId, interactions, visualisationStage, chartStage, essence, series, xScale, xTicks, dataset } = props;\n  const hasComparison = essence.hasComparison();\n  const continuousSplitDataset = selectFirstSplitDataset(dataset);\n  const { interaction } = interactions;\n\n  const hoverContent = isHover(interaction) && <SeriesHoverContent\n    essence={essence}\n    dataset={continuousSplitDataset}\n    range={interaction.range}\n    series={series}/>;\n\n  const label = <VisMeasureLabel\n    series={series}\n    datum={selectMainDatum(dataset)}\n    showPrevious={hasComparison} />;\n\n  const continuousSplit = getContinuousSplit(essence);\n  const getX = (d: Datum) => continuousSplit.selectValue<TimeRange | NumberRange>(d);\n\n  const domain = extentAcrossSplits(continuousSplitDataset, essence, series);\n\n  if (hasNominalSplit(essence)) {\n    const nominalSplit = getNominalSplit(essence);\n    return <BaseChart\n      visualisationStage={visualisationStage}\n      chartId={chartId}\n      interactions={interactions}\n      hoverContent={hoverContent}\n      timezone={essence.timezone}\n      label={label}\n      xScale={xScale}\n      xTicks={xTicks}\n      chartStage={chartStage}\n      formatter={series.formatter()}\n      yDomain={domain}>\n      {({ yScale, lineStage }) => <React.Fragment>\n        {continuousSplitDataset.data.map((datum, index) => {\n          const splitKey = nominalSplit.selectValue(datum);\n          const color = visualizationColors.series[index];\n          return <ColoredSeriesChartLine\n            key={String(splitKey)}\n            xScale={xScale}\n            yScale={yScale}\n            getX={getX}\n            color={color}\n            dataset={selectSplitDatums(datum)}\n            stage={lineStage}\n            essence={essence}\n            series={series} />;\n        })}\n      </React.Fragment>}\n    </BaseChart>;\n  }\n  return <BaseChart\n    chartId={series.plywoodKey()}\n    visualisationStage={visualisationStage}\n    interactions={interactions}\n    hoverContent={hoverContent}\n    timezone={essence.timezone}\n    label={label}\n    chartStage={chartStage}\n    yDomain={domain}\n    formatter={series.formatter()}\n    xScale={xScale}\n    xTicks={xTicks}>\n    {({ yScale, lineStage }) => <SingletonSeriesChartLine\n      xScale={xScale}\n      yScale={yScale}\n      getX={getX}\n      dataset={continuousSplitDataset.data}\n      stage={lineStage}\n      essence={essence}\n      series={series} />}\n  </BaseChart>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as d3 from \"d3\";\nimport { Dataset } from \"plywood\";\nimport { Essence } from \"../../../../common/models/essence/essence\";\nimport { ConcreteSeries } from \"../../../../common/models/series/concrete-series\";\nimport { flatMap } from \"../../../../common/utils/functional/functional\";\nimport { selectSplitDataset } from \"../../../utils/dataset/selectors/selectors\";\nimport { datumsExtent, Extent, seriesSelectors } from \"../../../utils/extent/extent\";\nimport { hasNominalSplit } from \"./splits\";\n\nexport function extentAcrossSeries(dataset: Dataset, essence: Essence): Extent {\n  const hasComparison = essence.hasComparison();\n  const series = essence.getConcreteSeries().toArray();\n  const getters = flatMap(series, s => seriesSelectors(s, hasComparison));\n  return datumsExtent(dataset.data, getters);\n}\n\nexport function extentAcrossSplits(dataset: Dataset, essence: Essence, series: ConcreteSeries): Extent {\n  const getters = seriesSelectors(series, essence.hasComparison());\n  if (hasNominalSplit(essence)) {\n    return dataset.data.reduce((acc, datum) => {\n      const splitDataset = selectSplitDataset(datum);\n      if (!splitDataset) return acc;\n      const extent = datumsExtent(splitDataset.data, getters);\n      return d3.extent([...acc, ...extent]);\n    }, [0, 0]) as Extent;\n  }\n\n  return datumsExtent(dataset.data, getters);\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Dataset } from \"plywood\";\nimport React from \"react\";\nimport { Essence } from \"../../../../../common/models/essence/essence\";\nimport { Stage } from \"../../../../../common/models/stage/stage\";\nimport { LegendSpot } from \"../../../../components/pinboard-panel/pinboard-panel\";\nimport { InteractionsProps } from \"../../interactions/interaction-controller\";\nimport { SplitLegend } from \"../../legend/split-legend\";\nimport { ContinuousScale } from \"../../utils/continuous-types\";\nimport { ContinuousTicks } from \"../../utils/pick-x-axis-ticks\";\nimport { hasNominalSplit } from \"../../utils/splits\";\nimport { calculateChartStage } from \"../calculate-chart-stage\";\nimport { SeriesChart } from \"./series-chart\";\n\ninterface ChartsPerSeriesProps {\n  interactions: InteractionsProps;\n  essence: Essence;\n  dataset: Dataset;\n  xScale: ContinuousScale;\n  xTicks: ContinuousTicks;\n  stage: Stage;\n}\n\nexport const ChartsPerSeries: React.FunctionComponent<ChartsPerSeriesProps> = props => {\n  const { interactions, xScale, xTicks, essence, dataset, stage } = props;\n\n  const concreteSeries = essence.getConcreteSeries().toArray();\n  const chartStage = calculateChartStage(stage, essence.series.count());\n\n  return <React.Fragment>\n    {hasNominalSplit(essence) && <LegendSpot>\n      <SplitLegend dataset={dataset} essence={essence}/>\n    </LegendSpot>}\n    {concreteSeries.map(series => {\n      const key = series.reactKey();\n      return <SeriesChart\n          interactions={interactions}\n          key={key}\n          chartId={key}\n          dataset={dataset}\n          essence={essence}\n          series={series}\n          chartStage={chartStage}\n          visualisationStage={stage}\n          xScale={xScale}\n          xTicks={xTicks} />;\n      }\n    )}\n  </React.Fragment>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Essence } from \"../../../../common/models/essence/essence\";\nimport { Legend } from \"./legend\";\n\ninterface SeriesLegend {\n  essence: Essence;\n}\n\nexport const SeriesLegend: React.FunctionComponent<SeriesLegend> = props => {\n  const { essence } = props;\n  const series = essence.getConcreteSeries().toArray();\n  const values = series.map(series => series.title());\n  return <Legend values={values} title=\"Series\" />;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Datum } from \"plywood\";\nimport React from \"react\";\nimport { Essence } from \"../../../../../common/models/essence/essence\";\nimport { formatSegment } from \"../../../../../common/utils/formatter/formatter\";\nimport { getNominalDimension, getNominalSplit, hasNominalSplit } from \"../../utils/splits\";\nimport \"./label.scss\";\n\ninterface LabelProps {\n  essence: Essence;\n  datum: Datum;\n}\n\nexport const Label: React.FunctionComponent<LabelProps> = props => {\n  const { essence, datum } = props;\n  if (hasNominalSplit(essence)) {\n    const nominalSplit = getNominalSplit(essence);\n    const nominalDimension = getNominalDimension(essence);\n    const splitValue = nominalSplit.selectValue(datum);\n    return <div className=\"split-chart-label\">\n    <span className=\"split-chart-dimension-title\">\n      {nominalDimension.title}\n    </span>\n      <span className=\"split-chart-value\">\n      : {formatSegment(splitValue, essence.timezone)}\n    </span>\n    </div>;\n  }\n  return null;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Dataset, Datum } from \"plywood\";\nimport React from \"react\";\nimport { Essence } from \"../../../../../common/models/essence/essence\";\nimport { ConcreteSeries } from \"../../../../../common/models/series/concrete-series\";\nimport { createColorEntry } from \"../../../../components/color-swabs/color-entry\";\nimport { ColorSwabs } from \"../../../../components/color-swabs/color-swabs\";\nimport { SeriesBubbleContent } from \"../../../../components/series-bubble-content/series-bubble-content\";\nimport { useSettingsContext } from \"../../../../views/cube-view/settings-context\";\nimport { Hover } from \"../../interactions/interaction\";\nimport { getContinuousReference } from \"../../utils/splits\";\n\ninterface SplitHoverContentProps {\n  interaction: Hover;\n  essence: Essence;\n  dataset: Dataset;\n}\n\ninterface ColoredSeriesProps {\n  series: ConcreteSeries[];\n  datum: Datum;\n  hasComparison: boolean;\n}\n\nconst ColoredSeries: React.FunctionComponent<ColoredSeriesProps> = props => {\n  const { customization: { visualizationColors } } = useSettingsContext();\n  const { datum, hasComparison, series } = props;\n  const colorEntries = series.map((series, index) => {\n    const color = visualizationColors.series[index];\n    const name = series.title();\n    return createColorEntry({ color, name, hasComparison, datum, series });\n  });\n  return <ColorSwabs colorEntries={colorEntries} />;\n};\n\nexport const SplitHoverContent: React.FunctionComponent<SplitHoverContentProps> = props => {\n  const { essence, dataset, interaction: { range } } = props;\n  const series = essence.getConcreteSeries().toArray();\n  const hasComparison = essence.hasComparison();\n  const reference = getContinuousReference(essence);\n  const datum = dataset.findDatumByAttribute(reference, range) || {};\n  if (series.length === 1) {\n    return <SeriesBubbleContent series={series[0]} datum={datum} showPrevious={hasComparison}/>;\n  }\n  return <ColoredSeries  datum={datum} series={series} hasComparison={hasComparison}/>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Dataset, Datum, NumberRange, TimeRange } from \"plywood\";\nimport React from \"react\";\nimport { Essence } from \"../../../../../common/models/essence/essence\";\nimport { defaultFormatter } from \"../../../../../common/models/series/series-format\";\nimport { Stage } from \"../../../../../common/models/stage/stage\";\nimport { Unary } from \"../../../../../common/utils/functional/functional\";\nimport { selectSplitDataset } from \"../../../../utils/dataset/selectors/selectors\";\nimport { useSettingsContext } from \"../../../../views/cube-view/settings-context\";\nimport { BaseChart } from \"../../base-chart/base-chart\";\nimport { ColoredSeriesChartLine } from \"../../chart-line/colored-series-chart-line\";\nimport { SingletonSeriesChartLine } from \"../../chart-line/singleton-series-chart-line\";\nimport { isHover } from \"../../interactions/interaction\";\nimport { InteractionsProps } from \"../../interactions/interaction-controller\";\nimport { ContinuousScale } from \"../../utils/continuous-types\";\nimport { extentAcrossSeries } from \"../../utils/extent\";\nimport { ContinuousTicks } from \"../../utils/pick-x-axis-ticks\";\nimport { getContinuousSplit } from \"../../utils/splits\";\nimport { Label } from \"./label\";\nimport { SplitHoverContent } from \"./split-hover-content\";\n\ninterface SplitChartProps {\n  interactions: InteractionsProps;\n  chartId: string;\n  essence: Essence;\n  dataset: Dataset;\n  selectDatum: Unary<Dataset, Datum>;\n  xScale: ContinuousScale;\n  xTicks: ContinuousTicks;\n  chartStage: Stage;\n  visualisationStage: Stage;\n}\n\nexport const SplitChart: React.FunctionComponent<SplitChartProps> = props => {\n  const { customization: { visualizationColors } } = useSettingsContext();\n  const {\n    chartId,\n    interactions,\n    visualisationStage,\n    chartStage,\n    essence,\n    xScale,\n    xTicks,\n    selectDatum,\n    dataset\n  } = props;\n  const { interaction } = interactions;\n  const splitDatum = selectDatum(dataset);\n  const splitDataset = selectSplitDataset(splitDatum);\n\n  const series = essence.getConcreteSeries();\n\n  const label = <Label essence={essence} datum={splitDatum}/>;\n  const hoverContent = isHover(interaction) && <SplitHoverContent\n    interaction={interaction}\n    essence={essence}\n    dataset={splitDataset}/>;\n\n  const continuousSplit = getContinuousSplit(essence);\n  const getX = (d: Datum) => continuousSplit.selectValue<TimeRange | NumberRange>(d);\n  const domain = extentAcrossSeries(splitDataset, essence);\n\n  if (series.count() === 1) {\n    const firstSeries = series.first();\n    return <BaseChart\n      chartId={chartId}\n      interactions={interactions}\n      hoverContent={hoverContent}\n      timezone={essence.timezone}\n      label={label}\n      xScale={xScale}\n      xTicks={xTicks}\n      chartStage={chartStage}\n      formatter={firstSeries.formatter()}\n      yDomain={domain} visualisationStage={visualisationStage}>\n      {({ yScale, lineStage }) => {\n        return <SingletonSeriesChartLine\n          xScale={xScale}\n          yScale={yScale}\n          getX={getX}\n          dataset={splitDataset.data}\n          stage={lineStage}\n          essence={essence}\n          series={firstSeries}/>;\n      }}\n    </BaseChart>;\n  }\n\n  return <BaseChart\n    chartId={chartId}\n    visualisationStage={visualisationStage}\n    timezone={essence.timezone}\n    hoverContent={hoverContent}\n    interactions={interactions}\n    label={label}\n    xScale={xScale}\n    xTicks={xTicks}\n    chartStage={chartStage}\n    formatter={defaultFormatter}\n    yDomain={domain}>\n    {({ yScale, lineStage }) => <React.Fragment>\n      {series.toArray().map((series, index) => {\n        const color = visualizationColors.series[index];\n        return <ColoredSeriesChartLine\n          key={series.plywoodKey()}\n          xScale={xScale}\n          yScale={yScale}\n          getX={getX}\n          dataset={splitDataset.data}\n          stage={lineStage}\n          essence={essence}\n          series={series}\n          color={color}/>;\n      })}\n    </React.Fragment>}\n  </BaseChart>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Dataset, Datum } from \"plywood\";\nimport React from \"react\";\nimport { Essence } from \"../../../../../common/models/essence/essence\";\nimport { Stage } from \"../../../../../common/models/stage/stage\";\nimport { compose, Unary } from \"../../../../../common/utils/functional/functional\";\nimport { LegendSpot } from \"../../../../components/pinboard-panel/pinboard-panel\";\nimport { selectFirstSplitDatums, selectMainDatum, selectSplitDatums } from \"../../../../utils/dataset/selectors/selectors\";\nimport { InteractionsProps } from \"../../interactions/interaction-controller\";\nimport { SeriesLegend } from \"../../legend/series-legend\";\nimport { ContinuousScale } from \"../../utils/continuous-types\";\nimport { ContinuousTicks } from \"../../utils/pick-x-axis-ticks\";\nimport { hasNominalSplit } from \"../../utils/splits\";\nimport { calculateChartStage } from \"../calculate-chart-stage\";\nimport { nominalValueKey } from \"./nominal-value-key\";\nimport { SplitChart } from \"./split-chart\";\n\ninterface ChartsPerSplit {\n  interactions: InteractionsProps;\n  essence: Essence;\n  dataset: Dataset;\n  xScale: ContinuousScale;\n  xTicks: ContinuousTicks;\n  stage: Stage;\n}\n\nfunction getChartsSelectors(essence: Essence, dataset: Dataset): Array<Unary<Dataset, Datum>> {\n  if (!hasNominalSplit(essence)) {\n    return [selectMainDatum];\n  }\n\n  const splitDatums = selectFirstSplitDatums(dataset);\n  return splitDatums.map((datum, index) => {\n    const getNthDatum = compose(selectSplitDatums, datums => datums[index]);\n    return compose<Dataset, Datum, Datum>(selectMainDatum, getNthDatum);\n  });\n}\n\nexport const ChartsPerSplit: React.FunctionComponent<ChartsPerSplit> = props => {\n  const { interactions, xScale, xTicks, essence, dataset, stage } = props;\n\n  const hasMultipleSeries = essence.series.count() > 1;\n  const selectors = getChartsSelectors(essence, dataset);\n  const chartStage = calculateChartStage(stage, selectors.length);\n  return <React.Fragment>\n    {hasMultipleSeries && <LegendSpot>\n      <SeriesLegend essence={essence} />\n    </LegendSpot>}\n    {selectors.map(selector => {\n      const key = nominalValueKey(selector(dataset), essence);\n      return <SplitChart\n        key={key}\n        chartId={key}\n        interactions={interactions}\n        essence={essence}\n        dataset={dataset}\n        selectDatum={selector}\n        xScale={xScale}\n        xTicks={xTicks}\n        visualisationStage={stage}\n        chartStage={chartStage} />;\n    })}\n  </React.Fragment>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Datum } from \"plywood\";\nimport { Essence } from \"../../../../../common/models/essence/essence\";\nimport { formatSegment } from \"../../../../../common/utils/formatter/formatter\";\nimport { getNominalSplit, hasNominalSplit } from \"../../utils/splits\";\n\nexport function nominalValueKey(datum: Datum, essence: Essence): string {\n  if (!hasNominalSplit(essence)) return \"no-nominal-split\";\n  const nominalSplit = getNominalSplit(essence);\n  const splitValue = nominalSplit.selectValue(datum);\n  return formatSegment(splitValue, essence.timezone);\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Dataset } from \"plywood\";\nimport React from \"react\";\nimport { Essence } from \"../../../../common/models/essence/essence\";\nimport { Stage } from \"../../../../common/models/stage/stage\";\nimport { ImmutableRecord } from \"../../../../common/utils/immutable-utils/immutable-utils\";\nimport { LineChartSettings } from \"../../../../common/visualization-manifests/line-chart/settings\";\nimport { InteractionsProps } from \"../interactions/interaction-controller\";\nimport { ContinuousScale } from \"../utils/continuous-types\";\nimport { ContinuousTicks } from \"../utils/pick-x-axis-ticks\";\nimport { ChartsPerSeries } from \"./charts-per-series/charts-per-series\";\nimport { ChartsPerSplit } from \"./charts-per-split/charts-per-split\";\n\ninterface ChartsProps {\n  interactions: InteractionsProps;\n  essence: Essence;\n  xScale: ContinuousScale;\n  xTicks: ContinuousTicks;\n  dataset: Dataset;\n  stage: Stage;\n}\n\nexport const Charts: React.FunctionComponent<ChartsProps> = props => {\n  const { essence } = props;\n  const { groupSeries } = essence.visualizationSettings as ImmutableRecord<LineChartSettings>;\n\n  return groupSeries\n    ? <ChartsPerSplit {...props} />\n    : <ChartsPerSeries {...props} />;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Dataset, Datum, NumberRange, Range, TimeRange } from \"plywood\";\nimport { Essence } from \"../../../../common/models/essence/essence\";\nimport { Split } from \"../../../../common/models/split/split\";\nimport { selectFirstSplitDataset, selectFirstSplitDatums } from \"../../../utils/dataset/selectors/selectors\";\nimport { ContinuousScale, ContinuousValue } from \"../utils/continuous-types\";\nimport { getContinuousSplit, hasNominalSplit } from \"../utils/splits\";\n\nconst MAX_HOVER_DIST = 50;\n\nfunction findClosest(data: Datum[], value: ContinuousValue, scaleX: ContinuousScale, continuousSplit: Split): Datum | null {\n  let closestDatum: Datum = null;\n  let minDist = Infinity;\n  for (const datum of data) {\n    const continuousSegmentValue = continuousSplit.selectValue<TimeRange | NumberRange>(datum);\n    if (!continuousSegmentValue || !Range.isRange(continuousSegmentValue)) continue; // !Range.isRange => temp solution for non-bucketed reaching here\n    const mid = continuousSegmentValue.midpoint();\n    const dist = Math.abs(mid.valueOf() - value.valueOf());\n    const distPx = Math.abs(scaleX(mid) - scaleX(value));\n    if ((!closestDatum || dist < minDist) && distPx < MAX_HOVER_DIST) { // Make sure it is not too far way\n      closestDatum = datum;\n      minDist = dist;\n    }\n  }\n  return closestDatum;\n}\n\nexport function findClosestDatum(value: ContinuousValue, essence: Essence, dataset: Dataset, xScale: ContinuousScale): Datum | null {\n  const continuousSplit = getContinuousSplit(essence);\n  if (hasNominalSplit(essence)) {\n    const flattened = selectFirstSplitDataset(dataset).flatten();\n    return findClosest(flattened.data, value, xScale, continuousSplit);\n  }\n  return findClosest(selectFirstSplitDatums(dataset), value, xScale, continuousSplit);\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { Duration } from \"chronoshift\";\nimport { NumberRange, PlywoodRange, TimeRange } from \"plywood\";\nimport { Essence } from \"../../../../common/models/essence/essence\";\nimport { ContinuousRange } from \"../utils/continuous-types\";\nimport { getContinuousSplit } from \"../utils/splits\";\n\nfunction roundTo(v: number, roundTo: number) {\n  return Math.round(Math.floor(v / roundTo)) * roundTo;\n}\n\nexport function snapRangeToGrid(range: PlywoodRange, essence: Essence): ContinuousRange {\n  // floors range to scale ranges\n  const continuousSplit = getContinuousSplit(essence);\n\n  if (TimeRange.isTimeRange(range)) {\n    const { timezone } = essence;\n    const duration = continuousSplit.bucket as Duration;\n    return TimeRange.fromJS({\n      start: duration.floor(range.start, timezone),\n      end: duration.shift(duration.floor(range.end, timezone), timezone, 1)\n    });\n  }\n  if (NumberRange.isNumberRange(range)) {\n    const bucketSize = continuousSplit.bucket as number;\n    const startFloored = roundTo((range as NumberRange).start, bucketSize);\n    let endFloored = roundTo((range as NumberRange).end, bucketSize);\n\n    if (endFloored - startFloored < bucketSize) {\n      endFloored += bucketSize;\n    }\n\n    return NumberRange.fromJS({\n      start: startFloored,\n      end: endFloored\n    });\n  }\n\n  return null;\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { List } from \"immutable\";\nimport { Dataset } from \"plywood\";\nimport React from \"react\";\nimport { ReactNode } from \"react\";\nimport { Essence } from \"../../../../common/models/essence/essence\";\nimport { FilterClause } from \"../../../../common/models/filter-clause/filter-clause\";\nimport { Binary, Nullary, Unary } from \"../../../../common/utils/functional/functional\";\nimport { GlobalEventListener } from \"../../../components/global-event-listener/global-event-listener\";\nimport { toFilterClause } from \"../../../utils/highlight-clause/highlight-clause\";\nimport { mouseEventOffset } from \"../../../utils/mouse-event-offset/mouse-event-offset\";\nimport { Highlight } from \"../../highlight-controller/highlight\";\nimport { ContinuousRange, ContinuousScale, ContinuousValue } from \"../utils/continuous-types\";\nimport { getContinuousReference } from \"../utils/splits\";\nimport { constructRange, shiftByOne } from \"./continuous-range\";\nimport { findClosestDatum } from \"./find-closest-datum\";\nimport { createDragging, createHighlight, createHover, Interaction, isDragging, isHighlight, isHover, MouseInteraction } from \"./interaction\";\nimport { snapRangeToGrid } from \"./snap-range-to-grid\";\n\ninterface InteractionControllerProps {\n  xScale: ContinuousScale;\n  essence: Essence;\n  dataset: Dataset;\n  children: Unary<InteractionsProps, ReactNode>;\n  highlight?: Highlight;\n  saveHighlight: Binary<List<FilterClause>, string, void>;\n  dropHighlight: Nullary<void>;\n  acceptHighlight: Nullary<void>;\n  chartsContainerRef: React.RefObject<HTMLDivElement>;\n}\n\ninterface InteractionsState {\n  interaction: MouseInteraction | null;\n  scrollTop: number;\n}\n\nexport interface InteractionsProps {\n  interaction: Interaction | null;\n  dropHighlight: Nullary<void>;\n  acceptHighlight: Nullary<void>;\n  dragStart: Binary<string, number, void>;\n  handleHover: Binary<string, number, void>;\n  mouseLeave: Nullary<void>;\n}\n\nexport class InteractionController extends React.Component<InteractionControllerProps, InteractionsState> {\n\n  state: InteractionsState = { interaction: null, scrollTop: 0 };\n\n  handleHover = (chartId: string, offset: number) => {\n    // calculate hover range and setState\n    const { interaction } = this.state;\n    if (isDragging(interaction) || isHighlight(interaction)) return;\n    const hoverRange = this.findRangeUnderOffset(offset);\n    if (hoverRange === null) {\n      this.setState({ interaction: null });\n      return;\n    }\n    /*\n      Plywood expects that `equals` argument in concrete Range types (NumberRange, TimeRange)\n      have exact type as object. Because we move union type into covariant position, typescript\n      would expect that `hoverRange` has type NumberRange & TimeRange which is impossible.\n      Plywood handles mismatched types correctly.\n     */\n    // @ts-ignore\n    if (isHover(interaction) && interaction.range.equals(hoverRange)) return;\n    this.setState({ interaction: createHover(chartId, hoverRange) });\n  };\n\n  onMouseLeave = () => {\n    const { interaction } = this.state;\n    if (!isHover(interaction)) return;\n    this.setState({ interaction: null });\n  };\n\n  handleDragStart = (chartId: string, offset: number) => {\n    const { essence: { timezone } } = this.props;\n    const start = this.findValueUnderOffset(offset);\n    const end = shiftByOne(start, timezone);\n    this.setState({ interaction: createDragging(chartId, start, end) });\n  };\n\n  private calculateOffset(e: MouseEvent): number | null {\n    const { chartsContainerRef } = this.props;\n    if (!chartsContainerRef.current) return null;\n    const [x] = mouseEventOffset(e);\n    const { left } = chartsContainerRef.current.getBoundingClientRect();\n    return x - left;\n  }\n\n  dragging = (e: MouseEvent) => {\n    const { interaction } = this.state;\n    if (!isDragging(interaction)) return;\n    const offset = this.calculateOffset(e);\n    if (offset === null) return;\n    const end = this.findValueUnderOffset(offset);\n    const { start, key } = interaction;\n    this.setState({ interaction: createDragging(key, start, end) });\n  };\n\n  stopDragging = (e: MouseEvent) => {\n    const { interaction } = this.state;\n    if (!isDragging(interaction)) return;\n    const offset = this.calculateOffset(e);\n    if (offset === null) return;\n    this.setState({ interaction: null });\n    const { essence, saveHighlight } = this.props;\n    const { start, key } = interaction;\n    const end = this.findValueUnderOffset(offset);\n    const range = snapRangeToGrid(constructRange(start, end, essence.timezone), essence);\n    saveHighlight(List.of(toFilterClause(range, getContinuousReference(essence))), key);\n  };\n\n  private findValueUnderOffset(offset: number): ContinuousValue {\n    const { xScale } = this.props;\n    return xScale.invert(offset);\n  }\n\n  private findRangeUnderOffset(offset: number): ContinuousRange | null {\n    const value = this.findValueUnderOffset(offset);\n    const { essence, xScale, dataset } = this.props;\n    const closestDatum = findClosestDatum(value, essence, dataset, xScale);\n    const range = closestDatum && closestDatum[getContinuousReference(essence)];\n    return range as ContinuousRange;\n  }\n\n  scrollCharts = (scrollEvent: MouseEvent) => {\n    const { scrollTop } = scrollEvent.target as Element;\n\n    this.setState({\n      interaction: null,\n      scrollTop\n    });\n  };\n\n  interaction(): Interaction | null {\n    const { highlight } = this.props;\n    if (highlight) return createHighlight(highlight);\n    return this.state.interaction;\n  }\n\n  render() {\n    const interaction = this.interaction();\n    const { children, acceptHighlight, dropHighlight } = this.props;\n    const hocProps: InteractionsProps = {\n      interaction,\n      acceptHighlight,\n      dropHighlight,\n      dragStart: this.handleDragStart,\n      handleHover: this.handleHover,\n      mouseLeave: this.onMouseLeave\n    };\n    return <React.Fragment>\n      <GlobalEventListener\n        mouseUp={this.stopDragging}\n        mouseMove={this.dragging}\n        scroll={this.scrollCharts} />\n      {children(hocProps)}\n    </React.Fragment>;\n  }\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Duration, Timezone } from \"chronoshift\";\nimport { range } from \"d3\";\nimport { NumberRange, TimeRange } from \"plywood\";\nimport { getBestBucketUnitForRange } from \"../../../../common/models/granularity/granularity\";\nimport { ContinuousDomain } from \"./continuous-types\";\n\nexport type ContinuousTicks = Array<Date | number>;\n\nfunction generateDateTicks(bucket: Duration, start: Date, end: Date, timezone: Timezone): Date[] {\n  return bucket.materialize(start, end as Date, timezone);\n}\n\nfunction generateNumberTicks(bucket: number, start: number, end: number): number[] {\n  const sequence = range(start, end, bucket);\n  return [...sequence, end];\n}\n\nexport default function pickXAxisTicks([start, end]: ContinuousDomain, timezone: Timezone): ContinuousTicks {\n  if (start instanceof Date && end instanceof Date) {\n    const bucket = getBestBucketUnitForRange(TimeRange.fromJS({ start, end }), true) as Duration;\n    return generateDateTicks(bucket, start, end, timezone);\n  }\n  if (typeof start === \"number\" && typeof end === \"number\") {\n    const bucket = getBestBucketUnitForRange(NumberRange.fromJS({ start, end }), true) as number;\n    return generateNumberTicks(bucket, start, end);\n  }\n  throw new Error(`Expected domain to be continuous. Got [${start}, ${end}]`);\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Duration, Timezone } from \"chronoshift\";\nimport * as d3 from \"d3\";\nimport { Dataset, PlywoodRange, Range } from \"plywood\";\nimport { getMaxTime } from \"../../../../common/models/data-cube/data-cube\";\nimport { Essence } from \"../../../../common/models/essence/essence\";\nimport { ContinuousDimensionKind } from \"../../../../common/models/granularity/granularity\";\nimport { Split } from \"../../../../common/models/split/split\";\nimport { Timekeeper } from \"../../../../common/models/timekeeper/timekeeper\";\nimport { union } from \"../../../../common/utils/plywood/range\";\nimport { toPlywoodRange } from \"../../../utils/highlight-clause/highlight-clause\";\nimport { ContinuousRange, ContinuousScale } from \"./continuous-types\";\nimport { getContinuousDimension, getContinuousSplit } from \"./splits\";\n\n// This function is responsible for aligning d3 types with our domain types.\nexport function createContinuousScale(essence: Essence, domainRange: PlywoodRange, width: number): ContinuousScale {\n  const continuousDimension = getContinuousDimension(essence);\n  const kind = continuousDimension.kind as ContinuousDimensionKind;\n  const range = [0, width];\n  switch (kind) {\n    case \"number\": {\n      const domain = [domainRange.start, domainRange.end] as [number, number];\n      return (d3.scaleLinear().clamp(true) as unknown as ContinuousScale).domain(domain).range(range);\n    }\n    case \"time\": {\n      const domain = [domainRange.start, domainRange.end] as [Date, Date];\n      return (d3.scaleTime().clamp(true) as unknown as ContinuousScale).domain(domain).range(range);\n    }\n  }\n}\n\nfunction includeMaxTimeBucket(filterRange: PlywoodRange, maxTime: Date, continuousSplit: Split, timezone: Timezone) {\n  const continuousBucket = continuousSplit.bucket;\n  /*\n    Special treatment for realtime data:\n    Max time could be inside last bucket of time filter.\n   */\n  if (maxTime && continuousBucket instanceof Duration) {\n    const filterRangeEnd = filterRange.end as Date;\n    const filterRangeEndFloored = continuousBucket.floor(filterRangeEnd, timezone);\n    const filterRangeEndCeiled = continuousBucket.shift(filterRangeEndFloored, timezone);\n    if (filterRangeEndFloored < maxTime && maxTime < filterRangeEndCeiled) {\n      return Range.fromJS({ start: filterRange.start, end: filterRangeEndCeiled });\n    }\n  }\n  return filterRange;\n}\n\nfunction getFilterRange(essence: Essence, timekeeper: Timekeeper): PlywoodRange | null {\n  const continuousSplit = getContinuousSplit(essence);\n  const effectiveFilter = essence.getEffectiveFilter(timekeeper);\n  const continuousFilterClause = effectiveFilter.clauseForReference(continuousSplit.reference);\n  if (!continuousFilterClause) return null;\n  const filterRange = toPlywoodRange(continuousFilterClause);\n  const maxTime = getMaxTime(essence.dataCube, timekeeper);\n  return includeMaxTimeBucket(filterRange, maxTime, continuousSplit, essence.timezone);\n}\n\nfunction safeRangeSum(a: PlywoodRange | null, b: PlywoodRange | null): PlywoodRange | null {\n  return (a && b) ? a.extend(b) : (a || b);\n}\n\nfunction getDatasetXRange(dataset: Dataset, continuousSplit: Split): PlywoodRange | null {\n  const flatDataset = dataset.flatten();\n  return flatDataset\n    .data\n    .map(datum => continuousSplit.selectValue(datum) as PlywoodRange)\n    .reduce(safeRangeSum, null);\n}\n\nexport function calculateXRange(essence: Essence, timekeeper: Timekeeper, dataset: Dataset): ContinuousRange | null {\n  const continuousSplit = getContinuousSplit(essence);\n  const filterRange = getFilterRange(essence, timekeeper);\n  const datasetRange = getDatasetXRange(dataset, continuousSplit);\n  return union(filterRange, datasetRange) as ContinuousRange;\n}\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { PlywoodRange, Range } from \"plywood\";\n\nexport function union(first: PlywoodRange | null, second: PlywoodRange | null): PlywoodRange | null {\n  if (!Range.isRange(first) && !Range.isRange(second)) {\n    return null;\n  }\n  if (!Range.isRange(first)) {\n    return second;\n  }\n  if (!Range.isRange(second)) {\n    return first;\n  }\n  return first.union(second);\n}\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Timezone } from \"chronoshift\";\nimport * as d3 from \"d3\";\nimport React from \"react\";\nimport { Stage } from \"../../../../common/models/stage/stage\";\nimport { Unary } from \"../../../../common/utils/functional/functional\";\nimport { getMoment, scaleTicksFormatter } from \"../../../../common/utils/time/time\";\nimport { roundToHalfPx } from \"../../../utils/dom/dom\";\nimport { ContinuousScale } from \"../utils/continuous-types\";\nimport \"./x-axis.scss\";\n\nconst TICK_HEIGHT = 5;\nconst TEXT_OFFSET = 12;\nconst X_AXIS_HEIGHT = 30;\n\nexport interface XAxisProps {\n  width: number;\n  ticks: Array<Date | number>;\n  scale: ContinuousScale;\n  timezone: Timezone;\n}\n\nconst floatFormat = d3.format(\".1f\");\n\nfunction labelFormatter(scale: ContinuousScale, timezone: Timezone): Unary<Date | number, string> {\n  const [start] = scale.domain();\n  if (start instanceof Date) {\n    const formatter = scaleTicksFormatter(scale as any);\n    return (date: Date) => formatter(getMoment(date, timezone));\n  }\n  return (value: number) => String(floatFormat(value));\n}\n\nexport const XAxis: React.FunctionComponent<XAxisProps> = props => {\n  const { width, ticks, scale, timezone } = props;\n  const stage = Stage.fromSize(width, X_AXIS_HEIGHT);\n  const format = labelFormatter(scale, timezone);\n\n  const lines = ticks.map((tick: any) => {\n    const x = roundToHalfPx(scale(tick));\n    return <line key={String(tick)} x1={x} y1={0} x2={x} y2={TICK_HEIGHT} />;\n  });\n\n  const labelY = TICK_HEIGHT + TEXT_OFFSET;\n  const labels = ticks.map((tick: any, index: number) => {\n    const x = scale(tick);\n    return <text key={String(tick)} x={x} y={labelY} style={{ textAnchor: index === 0 ? \"start\" : \"middle\" }}>{format(tick)}</text>;\n  });\n\n  return <svg className=\"bottom-axis\" width={stage.width} height={stage.height}>\n    <g className=\"line-chart-axis\" transform={stage.getTransform()}>\n      {lines}\n      {labels}\n    </g>\n  </svg>;\n};\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { ChartProps } from \"../../../common/models/chart-props/chart-props\";\nimport { LINE_CHART_MANIFEST } from \"../../../common/visualization-manifests/line-chart/line-chart\";\nimport { MessageCard } from \"../../components/message-card/message-card\";\nimport { TimeSeriesVisualizationControls } from \"../../components/timeseries-visualization-controls/visualization-controls\";\nimport { ChartPanel, VisualizationProps } from \"../../views/cube-view/center-panel/center-panel\";\nimport { Charts } from \"./charts/charts\";\nimport { InteractionController } from \"./interactions/interaction-controller\";\nimport \"./line-chart.scss\";\nimport pickXAxisTicks from \"./utils/pick-x-axis-ticks\";\nimport { calculateXRange, createContinuousScale } from \"./utils/x-scale\";\nimport { XAxis } from \"./x-axis/x-axis\";\n\nconst Y_AXIS_WIDTH = 60;\nconst X_AXIS_HEIGHT = 30;\n\nexport default function LineChartVisualization(props: VisualizationProps) {\n  return <React.Fragment>\n    <TimeSeriesVisualizationControls {...props} />\n    <ChartPanel {...props} chartComponent={LineChart}/>\n  </React.Fragment>;\n}\n\nclass LineChart extends React.Component<ChartProps> {\n  protected className = LINE_CHART_MANIFEST.name;\n\n  private chartsRef = React.createRef<HTMLDivElement>();\n\n  render(): JSX.Element {\n    const { essence, data, timekeeper, stage, highlight, dropHighlight, acceptHighlight, saveHighlight } = this.props;\n\n    const range = calculateXRange(essence, timekeeper, data);\n    if (!range) {\n      return <MessageCard title=\"No data found. Try different filters.\"/>;\n    }\n    const scale = createContinuousScale(essence, range, stage.width - Y_AXIS_WIDTH);\n    const ticks = pickXAxisTicks(scale.domain(), essence.timezone);\n\n    const maxHeight = stage.height - X_AXIS_HEIGHT;\n\n    return <InteractionController\n      dataset={data}\n      xScale={scale}\n      chartsContainerRef={this.chartsRef}\n      essence={essence}\n      highlight={highlight}\n      dropHighlight={dropHighlight}\n      acceptHighlight={acceptHighlight}\n      saveHighlight={saveHighlight}>\n      {interactions => {\n        return <div className=\"line-chart-container\">\n          <div className=\"line-charts\" ref={this.chartsRef} style={{ maxHeight }}>\n            <Charts\n              interactions={interactions}\n              stage={stage.changeHeight(maxHeight)}\n              essence={essence}\n              xScale={scale}\n              xTicks={ticks}\n              dataset={data}/>\n          </div>\n          <XAxis\n            width={stage.width}\n            ticks={ticks}\n            scale={scale}\n            timezone={essence.timezone}/>\n        </div>;\n      }}\n    </InteractionController>;\n  }\n}\n"],"sourceRoot":""}