{"version":3,"sources":["webpack:///./src/client/components/delta/delta.tsx","webpack:///./src/client/components/drop-indicator/drop-indicator.tsx","webpack:///./src/client/components/filter-tile/add-filter.tsx","webpack:///./src/common/utils/array/array.ts","webpack:///./src/client/components/filter-menu/boolean-filter-menu/boolean-filter-menu.tsx","webpack:///./src/client/components/filter-options-dropdown/filter-options-dropdown.tsx","webpack:///./src/client/components/range-handle/range-handle.tsx","webpack:///./src/client/components/number-range-picker/number-range-picker.tsx","webpack:///./src/client/components/filter-menu/number-filter-menu/number-filter-menu.tsx","webpack:///./src/client/components/preview-string-filter-menu/preview-list.tsx","webpack:///./src/client/components/preview-string-filter-menu/preview-string-filter-menu.tsx","webpack:///./src/client/components/paste-form/paste-form.tsx","webpack:///./src/client/components/selectable-string-filter-menu/string-value.tsx","webpack:///./src/client/components/selectable-string-filter-menu/string-values-list.tsx","webpack:///./src/client/components/selectable-string-filter-menu/selectable-string-filter-menu.tsx","webpack:///./src/client/components/filter-menu/string-filter-menu/string-filter-menu.tsx","webpack:///./src/client/components/date-range-input/date-range-input.tsx","webpack:///./src/client/components/date-range-picker/calendar.ts","webpack:///./src/client/components/date-range-picker/date-range-picker.tsx","webpack:///./src/client/components/filter-menu/time-filter-menu/time-shift-selector.tsx","webpack:///./src/client/components/filter-menu/time-filter-menu/fixed-time-tab.tsx","webpack:///./src/client/components/filter-menu/time-filter-menu/preset-time-tab.tsx","webpack:///./src/client/components/filter-menu/time-filter-menu/time-filter-menu.tsx","webpack:///./src/client/components/filter-menu/filter-menu.tsx","webpack:///./src/client/components/filter-tile/filter-tile.tsx","webpack:///./src/client/components/filter-tile/partial-filter-tile.tsx","webpack:///./src/client/components/filter-tile/filter-tiles.tsx","webpack:///./src/client/components/filter-tile/filter-tiles-row.tsx","webpack:///./src/client/components/manual-fallback/manual-fallback.tsx","webpack:///./src/client/components/series-tile/add-series.tsx","webpack:///./src/client/components/series-menu/format-picker.tsx","webpack:///./src/client/components/series-menu/arithmetic-series-menu.tsx","webpack:///./src/client/components/series-menu/measure-series-menu.tsx","webpack:///./src/client/components/series-menu/percent-series-menu.tsx","webpack:///./src/client/components/series-menu/quantile-picker.tsx","webpack:///./src/client/components/series-menu/quantile-series-menu.tsx","webpack:///./src/client/components/series-menu/series-menu.tsx","webpack:///./src/client/components/series-tile/placeholder-series.tsx","webpack:///./src/client/components/series-tile/series-tile.tsx","webpack:///./src/client/components/series-tile/series-tiles.tsx","webpack:///./src/client/components/series-tile/series-tiles-row.tsx","webpack:///./src/client/visualization-settings/line-chart/line-chart-settings.tsx","webpack:///./src/client/visualization-settings/settings-component.ts","webpack:///./src/client/visualization-settings/table/table-settings.tsx","webpack:///./src/client/visualization-settings/scatterplot/scatterplot-settings.tsx","webpack:///./src/client/components/vis-selector/vis-selector-menu.tsx","webpack:///./src/client/components/vis-selector/vis-selector.tsx","webpack:///./src/client/visualizations/data-provider/data-provider.tsx","webpack:///./src/client/views/cube-view/center-panel/center-panel.tsx","webpack:///./src/client/components/with-ref/with-ref.tsx","webpack:///./src/client/components/input-with-presets/string-input-with-presets.tsx","webpack:///./src/client/components/split-menu/granularity-picker.tsx","webpack:///./src/client/components/split-menu/limit-dropdown.tsx","webpack:///./src/client/components/split-menu/sort-dropdown.tsx","webpack:///./src/client/components/split-menu/split-menu-base.tsx","webpack:///./src/client/components/split-tile/add-split.tsx","webpack:///./src/client/components/split-tile/split-tiles.tsx","webpack:///./src/client/components/split-tile/split-tiles-row.tsx","webpack:///./src/client/components/tile-overflow-container/tile-overflow-container.tsx","webpack:///./src/client/components/split-menu/split-menu.tsx","webpack:///./src/client/components/split-tile/split-tile.tsx","webpack:///./src/client/components/drag-indicator/fancy-drag-indicator.tsx","webpack:///./src/client/components/drag-indicator/drag-indicator.tsx","webpack:///./src/client/components/message-card/message-card.tsx","webpack:///./src/client/components/add-tile/add-tile.tsx","webpack:///./src/client/components/button-group/button-group.tsx","webpack:///./src/client/visualizations/highlight-controller/highlight.ts","webpack:///./src/client/visualizations/highlight-controller/highlight-controller.tsx","webpack:///./src/client/components/input-with-presets/input-with-presets.tsx"],"names":["deltaSignToClassName","deltaSign","lowerIsBetter","percentageFormatter","format","Delta","currentValue","previousValue","formatter","formattedDelta","isNil","delta","deltaRatio","Math","abs","formatDelta","className","deltaSignToSymbol","ratio","isFinite","DropIndicator","React","Component","render","svg","require","AddFilter","props","appendFilter","menuStage","essence","filter","dataCube","tiles","allDimensions","dimensions","dimension","getClauseForDimension","map","key","name","label","title","value","onSelect","containerStage","insert","array","index","element","slice","BooleanFilterMenu","this","initialValues","actionEnabled","saveClause","onClose","constructClause","selectedValues","state","newSelection","has","remove","add","setState","String","onClick","selectValue","selected","clause","Set","of","values","BooleanFilterClause","Error","componentDidMount","fetchData","booleanFilterQuery","context","loading","then","dataset","data","d","error","isEmpty","reference","newClause","oldClause","equals","openOn","direction","stage","Stage","fromSize","renderRow","type","STRINGS","ok","onOkClick","disabled","cancel","onCancelClick","ApiContext","FILTER_OPTIONS","include","FilterMode","INCLUDE","checkType","exclude","EXCLUDE","contains","CONTAINS","regex","REGEX","FilterOptionsDropdown","option","onSelectOption","filterTypes","indexOf","selectedOption","filterOptions","selectedItem","find","menuClassName","items","equal","a","b","keyItem","renderItem","renderFilterOption","renderSelectedItem","RangeHandle","anchor","event","onChange","leftBound","rightBound","newX","getXFromEvent","clamp","offset","positionLeft","preventDefault","window","addEventListener","onGlobalMouseUp","onGlobalMouseMove","removeEventListener","isAny","isBeyondMin","isBeyondMax","style","left","classNames","onMouseDown","addNubSize","subtractNubSize","getAdjustedStartHalf","start","NUB_SIZE","NumberRangePicker","constructor","super","createRef","absolutePosition","onRangeStartChange","leftOffset","relativePosition","relativePositionToValue","onRangeEndChange","min","max","step","timekeeper","numberFilterQuery","mounted","isTruthy","rect","picker","current","getBoundingClientRect","width","componentWillUnmount","position","range","toSignificantDigits","n","totalDigits","getNumberOfWholeDigits","getNumberOfDigitsToShow","valueToRelativePosition","onBarClick","positionStart","positionEnd","e","absoluteX","relativeX","updateStart","startNubPosition","endNubPosition","isAfterEnd","inBetween","updateEnd","distanceFromEnd","distanceFromStart","end","content","relativeStart","relativeEnd","adjustedRightBound","rangeBarSelected","absoluteRightBound","bind","inverted","ref","numberOrAnyToString","any","stringToNumberOrAny","startInput","parse","parseFloat","isNaN","getFilterOptions","NumberFilterMenu","enterKey","target","endInput","filterMode","UNSAFE_componentWillMount","NumberFilterClause","count","first","getModeForDimension","globalKeyDownListener","not","List","NumberRange","bounds","Boolean","menuSize","onSelectFilterOption","onRangeInputStartChange","onRangeInputEndChange","errorNotice","Row","highlight","text","filterValues","list","searchText","includes","escaped","replace","regexp","RegExp","test","predicate","PreviewList","regexErrorMessage","limit","length","filtered","Fragment","PreviewStringFilterMenu","StringFilterClause","action","StringFilterAction","IN","initialSearchText","stringFilterQuery","lastSearchText","loaded","catch","err","reportError","debounceWithPromise","queryFilter","SEARCH_WAIT","loadRows","sendQueryFilter","debouncedQueryFilter","message","checkRegex","componentDidUpdate","prevProps","prevState","MATCH","hasMore","isLoaded","keyDown","placeholder","focusOnMount","updateSearchText","isError","isLoading","focus","textArea","PasteForm","split","s","trim","saveValue","select","StringValue","checkboxStyle","onRowSelect","altKey","ctrlKey","metaKey","hasModKey","StringValuesList","promotedValues","rowValues","rows","promoted","matchingValues","searchTextLower","toLowerCase","filterRows","toggle","set","SelectableStringFilterMenu","pasteModeEnabled","initialSelection","withModKey","isValueSingleSelected","isFilterValid","_","constructSearchTextClause","ignoreCase","renderSelectMode","enablePasteMode","onValueClick","renderImportMode","selectValues","disablePasteMode","StringFilterMenu","initialFilterMode","dimensionKind","kind","concat","renderFilterControls","selectableProps","previewProps","DateRangeInput","dateString","timeString","normalizeISODate","validateISODate","changeDate","normalizeISOTime","validateISOTime","time","timezone","updateStateFromTime","UNSAFE_componentWillReceiveProps","nextProps","valueOf","formatISODate","formatISOTime","possibleDateString","possibleTimeString","possibleMoment","combineDateAndTimeIntoMoment","isValid","toDate","hide","dateValue","timeValue","dateChange","timeChange","calendarDays","startDay","locale","monthWeeks","weeks","firstDayOfMonth","getMoment","firstDayOfNextMonth","clone","week","currentPointer","startOf","isBefore","day","weekStart","push","monthToWeeks","firstWeek","lastWeek","middleWeeks","padFirstWeek","padLastWeek","lastDate","padCount","nextNDates","previousNDates","i","shift","DateRangePicker","activeMonthStartDate","month","floor","startTime","Date","hoverTimeRange","selectionSet","navigateToMonth","newDate","calculateHoverTimeRange","mouseEnteredDay","endTime","TimeRange","selectNewRange","startDate","endDate","onStartChange","onEndChange","selectDay","selection","isBackwardSelection","datesEqual","getIsSelectable","date","renderDays","monthStart","maxTime","dayBeforeEnd","nextMonthStart","daysInWeek","row","dayDate","column","isPast","isFuture","isBeyondMaxRange","isSelected","isSelectedEdgeStart","isSelectedEdgeEnd","onMouseEnter","getDayInMonth","renderCalendar","renderCalendarNav","goToPreviousMonth","formatYearMonth","goToNextMonth","days","cyclicShift","shortDays","onMouseLeave","onCalendarMouseLeave","timeShiftPreviewForRange","duration","Duration","fromJS","safeDurationFromJS","shiftedTimeRange","formatTimeRange","presets","identity","timeShiftDurations","normalizeDurationName","toJS","TimeShiftSelector","onShiftChange","selectedTimeShift","timeShiftPreview","timeShift","errorMessage","isValidTimeShift","invalidDurationFormat","timeShiftExamples","FixedTimeTab","timeFilter","getEffectiveFilter","clauseForReference","FixedTimeFilterClause","get","initialState","validate","clicker","constructFixedClause","changeComparisonShift","constructTimeShift","createDateRange","maybeEnd","DateRange","TimeShift","doesTimeShiftOverlap","currentRange","previousRange","intersects","validateOverlap","isTimeShiftValid","areDatesValid","overlappingPeriods","isFormValid","isFilterDifferent","newTimeShift","overlapError","getMaxTime","setTimeShift","PresetTimeTab","filterPeriod","filterDuration","filterClause","RelativeTimeFilterClause","period","constructRelativeClause","isValidDuration","timeShiftDuration","getCanonicalLength","isDurationValid","renderLatestPresets","latestPeriodDurations","latestPeriod","TimeFilterPeriod","LATEST","latest","undefined","setFilter","durationsExamples","renderButtonGroup","activePeriod","groupMembers","getTimeFilterPresets","getFilterRange","evaluateSelection","previewFilter","previewText","noFilter","isTimeAttribute","expression","CURRENT","previous","PREVIOUS","saveTimeFilter","tabTitle","tab","TimeFilterTab","RELATIVE","relative","fixed","TabSelector","selectedTab","onTabSelect","tabs","FIXED","TimeFilterMenu","isRelativeTab","tabProps","selectTab","FilterMenu","tileTitle","getFormattedClause","timeShiftLabel","FilterTile","open","removeClause","openFilterMenu","closeFilterMenu","dragStart","excluded","isTimeFilter","setRef","included","draggable","onDragStart","PartialFilterTile","closeItem","FilterTiles","maxItems","removeFilter","openedFilterMenu","partialFilter","removePartialFilter","overflowOpen","closeOverflowMenu","openOverflowMenu","clauses","toArray","updateClause","changeFilter","setClause","tilesWithPlaceholder","partialTile","newFilter","isInsert","insertByIndex","replaceByIndex","insertClause","getIndex","insertPartialTile","findDimensionByName","isTimeClause","getTimeDimension","visibleItems","el","idx","cloneElement","transformStyle","SECTION_WIDTH","overflowItems","anyOverflowItemOpen","some","isPartialFilterInOverflow","overflowOpened","filterItemOverflow","x","FilterTilesRow","openedClause","dataTransfer","effectAllowed","setDragData","DragManager","setDragFilter","setDragGhost","canDrop","dragPosition","calculateDragPosition","dragging","DraggedElementType","DIMENSION","dropDimension","draggingDimension","FILTER","dropFilter","draggingFilter","SPLIT","dropSplit","draggingSplit","addPartialFilter","DragPosition","insertAt","getMaxItems","MEASURE","SERIES","NONE","numItems","calculateFromOffset","CORE_ITEM_WIDTH","CORE_ITEM_GAP","tryingToReplaceTime","isReplace","targetClause","getTimeDimensionReference","onDragEnter","dragEnter","dragOver","dragLeave","drop","CubeContext","ManualFallback","onResolutionClick","resolution","adjustment","splits","series","changeSeriesList","changeSplits","VisStrategy","KeepAlways","visResolve","isManual","resolutionItems","resolutions","description","AddSeries","appendMeasureSeries","allMeasures","measures","measure","hasMeasure","printFormat","measureFormat","SeriesFormatType","DEFAULT","EXACT","exactFormat","PERCENT","percentFormat","CUSTOM","FormatPicker","formatChange","formatPresets","concatTruthy","measureDefaultFormat","DEFAULT_FORMAT","EXACT_FORMAT","PERCENT_FORMAT","customFormat","readFormat","href","seriesFormatter","OPERATIONS","id","ExpressionSeriesOperation","ADD","SUBTRACT","MULTIPLY","DIVIDE","renderOperation","op","renderMeasure","m","renderSelectedMeasure","ArithmeticSeriesMenu","initialSeries","seriesList","onSeriesChange","ArithmeticExpression","isSeriesValid","duplicate","removeSeries","getSeriesWithKey","operation","operand","findMeasureByName","byName","isApproximate","setIn","ExpressionConcreteSeries","expressionSeriesTitle","MeasureSeriesMenu","PERCENT_OF_PARENT","PERCENT_OF_TOTAL","PercentSeriesMenu","selectedOperations","getExpressionSeriesFor","PercentExpression","toSet","toString","QuantilePicker","parseCustomValue","formatCustomValue","percentiles","QuantileSeriesMenu","otherSeries","validateSeries","percentile","hasSeriesWithKey","SeriesMenu","saveSeries","isModified","isUnique","MeasureSeries","ExpressionSeries","QuantileSeries","PlaceholderSeriesTile","SeriesTile","item","updateSeries","openSeriesMenu","closeSeriesMenu","definition","newSeries","stopPropagation","SeriesTiles","openedSeriesMenu","removePlaceholderSeries","savePlaceholderSeries","partialSeries","getConcreteSeries","placeholderTile","insertPlaceholder","isDummySeriesInOverflow","seriesItemOverflow","SeriesTilesRow","openedSeries","oldSeries","replaceSeries","removePartialSeries","addSeries","setDragSeries","isDraggingSeries","rearrangeSeries","draggingSeries","dropNewSeries","fromMeasure","draggingMeasure","addPartialSeries","isMeasureSeries","isUniqueQuantile","hasSeries","Components","settings","groupSeries","update","collapseRows","collapse","showSummary","settingsComponent","visualization","VisSelectorMenu","initialVisualization","visualizationSettings","initialSettings","defaults","renderSettings","component","TableSettingsComponent","changeSettings","LineChartSettingsComponent","ScatterplotSettingsComponent","MANIFESTS","changeVisualization","save","close","visSelectorMenuStage","VisSelector","openMenu","currentTarget","selector","closeMenu","vis","renderMenu","active","DataProvider","query","wasUsedForLastQuery","callExecutor","loadData","lastQueryEssence","debouncedCallExecutor","shouldFetchData","visualisationNotResized","hadDataLoaded","essenceChanged","showSpinner","handleDatasetLoad","loadedDataset","setDataset","differentVisualizationDefinition","nextEssence","nextTimekeeper","differentDataCube","differentEffectiveFilter","differentTimeShift","differentSplits","differentSeries","differentSettings","differentBucketingTimezone","differentLastRefreshRequestTimestamp","newEssence","hasSplitOn","refreshRequestTimestamp","children","status","DatasetRequestStatus","LOADING","ERROR","LOADED","DownloadableDatasetContext","DefaultVisualizationControls","VisualizationControls","splitTilesRow","DefaultSplitTilesRow","SplitTilesRow","addFilter","customization","removeTile","ChartPanel","chartComponent","lastRefreshRequestTimestamp","isDraggedOver","ChartWrapper","onDragOver","onDragLeave","onDragExit","onDrop","ChartComponent","highlightProps","Consumer","visualizationQuery","WithRef","StringInputWithPresets","GranularityPicker","granularity","granularityChange","isContinuous","granularities","getGranularities","bucketedBy","g","formatGranularity","granularityToString","floorableDurationsExamples","validateGranularity","formatLimit","calculateLimits","limits","includeNone","LimitDropdown","onLimitSelect","selectedLimit","SortDropdown","options","sortBy","SortOn","getTitle","getKey","sortOn","toSort","newDirection","SortDirection","descending","ascending","validateSplit","splitAssembly","isGranularityValid","newSplit","createSplit","sort","bucket","coerceGranularity","Split","SplitMenuBase","onSave","AddSplit","appendSplit","findSplitForDimension","SplitTiles","splitTileComponent","SplitTile","removeSplit","updateSplit","openedSplit","splitTiles","toKey","visibleSplits","overflowSplits","anyOverflowTileOpen","splitOverflow","DefaultSplitTile","oldSplit","UnfairGame","FairGame","setDragSplit","insertSplit","replaceSplit","addSplit","fromDimension","SEGMENT_HEIGHT","TileOverflowContainerMenu","positionedItems","fixedSize","TileOverflowContainer","SplitMenu","saveSplit","seriesSortOns","DimensionSortOn","fromSort","saveGranularity","saveSort","saveLimit","splitMenuComponent","FancyDragIndicator","sectionWidth","ghostArrowLeft","dragGhostElement","DragIndicator","MessageCard","AddTile","addButton","menuOpenOn","setQuery","resetQuery","renderRows","selectTile","renderTable","filteredRows","mountAdd","ButtonGroup","renderMembers","button","Highlight","hasHighlightOn","HighlightController","mergeClauses","dropHighlight","acceptHighlight","saveHighlight","InputWithPresets","customValue","customPicked","isPresetPicked","presetButtons","pickPreset","customSelected","members","pickCustom","renderErrorMessage","invalid","customValueUpdate"],"mappings":"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","file":"default~bar-chart~grid~heatmap~line-chart~scatterplot~table~totals.9c0962a35e7a88828f65.js","sourcesContent":["/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { format } from \"d3\";\nimport React from \"react\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { isNil } from \"../../../common/utils/general/general\";\nimport \"./delta.scss\";\n\nexport type DeltaSign = -1 | 0 | 1;\n\nexport interface DeltaAttributes {\n  delta: number;\n  deltaRatio: number;\n  deltaSign: DeltaSign;\n}\n\nexport function formatDelta(currentValue: number, previousValue: number): DeltaAttributes {\n  if (isNil(currentValue) || isNil(previousValue)) {\n    return null;\n  }\n\n  const delta = currentValue - previousValue;\n  const deltaSign = delta ? delta < 0 ? -1 : 1 : 0;\n  const deltaRatio = Math.abs(delta / previousValue);\n\n  return { deltaSign, deltaRatio, delta };\n}\n\nfunction deltaSignToSymbol(deltaSign: DeltaSign): string {\n  switch (deltaSign) {\n    case -1:\n      return \"\";\n    case 0:\n      return \"\";\n    case 1:\n      return \"\";\n  }\n}\n\nfunction deltaSignToClassName(deltaSign: DeltaSign, lowerIsBetter = false): string {\n  switch (deltaSign) {\n    case -1:\n      return lowerIsBetter ? \"delta-positive\" : \"delta-negative\";\n    case 0:\n      return \"delta-neutral\";\n    case 1:\n      return lowerIsBetter ? \"delta-negative\" : \"delta-positive\";\n  }\n}\n\nconst percentageFormatter = format(\".1%\");\n\nfunction printDeltaRatio(ratio: number): string | null {\n  if (!isFinite(ratio)) return null;\n  return ` (${percentageFormatter(ratio)})`;\n}\n\nexport interface DeltaProps {\n  currentValue: number;\n  previousValue: number;\n  formatter: Unary<number, string>;\n  lowerIsBetter?: boolean;\n}\n\nexport const Delta: React.FunctionComponent<DeltaProps> = ({ lowerIsBetter, currentValue, previousValue, formatter }) => {\n  const formattedDelta = formatDelta(currentValue, previousValue);\n  if (formattedDelta === null) {\n    return <span className=\"delta-neutral\">-</span>;\n  }\n\n  const { delta, deltaRatio, deltaSign } = formattedDelta;\n  return <span className={deltaSignToClassName(deltaSign, lowerIsBetter)}>\n    {deltaSignToSymbol(deltaSign)}\n    {formatter(Math.abs(delta))}\n    {printDeltaRatio(deltaRatio)}\n  </span>;\n};\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { SvgIcon } from \"../svg-icon/svg-icon\";\nimport \"./drop-indicator.scss\";\n\nexport interface DropIndicatorProps {\n}\n\nexport interface DropIndicatorState {\n}\n\nexport class DropIndicator extends React.Component<DropIndicatorProps, DropIndicatorState> {\n\n  render() {\n    return <div className=\"drop-indicator\">\n      <div className=\"white-out\" />\n      <div className=\"action\">\n        <SvgIcon svg={require(\"../../icons/split-replace.svg\")} />\n      </div>\n    </div>;\n  }\n}\n","/*\n * Copyright 2017-2021 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Dimension } from \"../../../common/models/dimension/dimension\";\nimport { allDimensions } from \"../../../common/models/dimension/dimensions\";\nimport { Essence } from \"../../../common/models/essence/essence\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { AddTile } from \"../add-tile/add-tile\";\n\ninterface AddFilterProps {\n  appendFilter: Unary<Dimension, void>;\n  menuStage: Stage;\n  essence: Essence;\n}\n\nexport const AddFilter: React.FunctionComponent<AddFilterProps> = props => {\n  const { appendFilter, menuStage, essence: { filter, dataCube } } = props;\n  const tiles = allDimensions(dataCube.dimensions)\n    .filter(dimension => !filter.getClauseForDimension(dimension))\n    .map(dimension => {\n      return {\n        key: dimension.name,\n        label: dimension.title,\n        value: dimension\n      };\n    });\n\n  return <AddTile<Dimension>\n    tiles={tiles}\n    onSelect={appendFilter}\n    containerStage={menuStage} />;\n};\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nexport function insert<T>(array: T[], index: number, element: T): T[] {\n  return [...array.slice(0, index), element, ...array.slice(index)];\n}\n\nexport function shallowEqualArrays(a: unknown[], b: unknown[]): boolean {\n  if (a === b) return true;\n  if (!a || !b) return false;\n  if (b.length !== a.length) return false;\n\n  for (let i = 0; i < a.length; i++) {\n    if (a[i] !== b[i]) {\n      return false;\n    }\n  }\n\n  return true;\n}\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Set } from \"immutable\";\nimport { Dataset } from \"plywood\";\nimport React from \"react\";\nimport { Dimension } from \"../../../../common/models/dimension/dimension\";\nimport { Essence } from \"../../../../common/models/essence/essence\";\nimport { BooleanFilterClause, FilterClause } from \"../../../../common/models/filter-clause/filter-clause\";\nimport { Stage } from \"../../../../common/models/stage/stage\";\nimport { Unary } from \"../../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../../common/utils/general/general\";\nimport { STRINGS } from \"../../../config/constants\";\nimport { ApiContext, ApiContextValue } from \"../../../views/cube-view/api-context\";\nimport { BubbleMenu } from \"../../bubble-menu/bubble-menu\";\nimport { Button } from \"../../button/button\";\nimport { Checkbox } from \"../../checkbox/checkbox\";\nimport { Loader } from \"../../loader/loader\";\nimport { QueryError } from \"../../query-error/query-error\";\nimport \"./boolean-filter-menu.scss\";\n\ninterface BooleanFilterMenuProps {\n  dimension: Dimension;\n  saveClause: Unary<FilterClause, void>;\n  essence: Essence;\n  onClose: Fn;\n  containerStage?: Stage;\n  openOn: Element;\n}\n\nexport type Booleanish = string | boolean | null;\n\ninterface BooleanFilterMenuState {\n  loading?: boolean;\n  error?: Error;\n  values: Booleanish[];\n  selectedValues: Set<Booleanish>;\n}\n\nexport class BooleanFilterMenu extends React.Component<BooleanFilterMenuProps, BooleanFilterMenuState> {\n  static contextType = ApiContext;\n\n  context: ApiContextValue;\n\n  state = this.initialValues();\n\n  initialValues(): BooleanFilterMenuState {\n    const { essence: { filter }, dimension } = this.props;\n    const clause = filter.getClauseForDimension(dimension);\n    if (!clause) {\n      return { selectedValues: Set.of(), values: [] };\n    }\n    if (!(clause instanceof BooleanFilterClause)) {\n      throw new Error(`Expected boolean filter clause, got: ${clause}`);\n    }\n    return { selectedValues: clause.values, values: [] };\n  }\n\n  componentDidMount() {\n    this.fetchData();\n  }\n\n  fetchData() {\n    const { booleanFilterQuery } = this.context;\n    const { essence, dimension } = this.props;\n\n    this.setState({ loading: true });\n    booleanFilterQuery(essence, dimension)\n      .then(\n        (dataset: Dataset) => {\n          this.setState({\n            loading: false,\n            values: dataset.data.map(d => d[dimension.name] as Booleanish),\n            error: null\n          });\n        },\n        error => {\n          this.setState({\n            loading: false,\n            values: [],\n            error\n          });\n        }\n      );\n\n  }\n\n  constructClause(): BooleanFilterClause | null {\n    const { selectedValues } = this.state;\n    if (selectedValues.isEmpty()) return null;\n\n    const { dimension } = this.props;\n    return new BooleanFilterClause({\n      reference: dimension.name,\n      values: selectedValues\n    });\n  }\n\n  actionEnabled(): boolean {\n    const { essence: { filter }, dimension } = this.props;\n    const newClause = this.constructClause();\n    const oldClause = filter.getClauseForDimension(dimension);\n    return newClause && !newClause.equals(oldClause);\n  }\n\n  onOkClick = () => {\n    if (!this.actionEnabled()) return;\n    const { saveClause, onClose } = this.props;\n    saveClause(this.constructClause());\n    onClose();\n  };\n\n  onCancelClick = () => {\n    const { onClose } = this.props;\n    onClose();\n  };\n\n  selectValue = (value: Booleanish) => {\n    const { selectedValues } = this.state;\n    const newSelection = selectedValues.has(value) ? selectedValues.remove(value) : selectedValues.add(value);\n    this.setState({ selectedValues: newSelection });\n  };\n\n  renderRow = (value: Booleanish) => {\n    const { selectedValues } = this.state;\n    return <div\n      className=\"row\"\n      key={String(value)}\n      title={String(value)}\n      onClick={() => this.selectValue(value)}>\n      <div className=\"row-wrapper\">\n        <Checkbox selected={selectedValues.has(value)} />\n        <span className=\"label\">{String(value)}</span>\n      </div>\n    </div>;\n  };\n\n  render() {\n    const { onClose, containerStage, openOn } = this.props;\n    const { values, error, loading } = this.state;\n\n    return <BubbleMenu\n      className=\"boolean-filter-menu\"\n      direction=\"down\"\n      containerStage={containerStage}\n      stage={Stage.fromSize(250, 210)}\n      openOn={openOn}\n      onClose={onClose}>\n      <div className=\"menu-table\">\n        <div className=\"rows\">\n          {values.map(this.renderRow)}\n        </div>\n        {error && <QueryError error={error} />}\n        {loading && <Loader />}\n      </div>\n      <div className=\"ok-cancel-bar\">\n        <Button type=\"primary\" title={STRINGS.ok} onClick={this.onOkClick} disabled={!this.actionEnabled()} />\n        <Button type=\"secondary\" title={STRINGS.cancel} onClick={this.onCancelClick} />\n      </div>\n    </BubbleMenu>;\n  }\n}\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { FilterMode } from \"../../../common/models/filter/filter\";\nimport { STRINGS } from \"../../config/constants\";\nimport { CheckboxType } from \"../checkbox/checkbox\";\nimport { Dropdown } from \"../dropdown/dropdown\";\nimport { SvgIcon } from \"../svg-icon/svg-icon\";\nimport \"./filter-options-dropdown.scss\";\n\nexport interface FilterOption {\n  label: string;\n  value: FilterMode;\n  svg: string;\n  checkType?: CheckboxType;\n}\n\nconst FILTER_OPTIONS: FilterOption[] = [\n  {\n    label: STRINGS.include,\n    value: FilterMode.INCLUDE,\n    svg: require(\"../../icons/filter-include.svg\"),\n    checkType: \"check\"\n  },\n  {\n    label: STRINGS.exclude,\n    value: FilterMode.EXCLUDE,\n    svg: require(\"../../icons/filter-exclude.svg\"),\n    checkType: \"cross\"\n  },\n  {\n    label: STRINGS.contains,\n    value: FilterMode.CONTAINS,\n    svg: require(\"../../icons/filter-contains.svg\")\n  },\n  {\n    label: STRINGS.regex,\n    value: FilterMode.REGEX,\n    svg: require(\"../../icons/filter-regex.svg\")\n  }\n];\n\nexport interface FilterOptionsDropdownProps {\n  selectedOption: FilterMode;\n  onSelectOption: (o: FilterMode) => void;\n  filterOptions?: FilterOption[];\n}\n\nexport class FilterOptionsDropdown extends React.Component<FilterOptionsDropdownProps> {\n  static getFilterOptions(...filterTypes: string[]) {\n    return FILTER_OPTIONS.filter(option => filterTypes.indexOf(option.value) !== -1);\n  }\n\n  onSelectOption = (option: FilterOption) => {\n    this.props.onSelectOption(option.value);\n  };\n\n  renderFilterOption = (option: FilterOption) => {\n    return <span className=\"filter-option\">\n      <SvgIcon className=\"icon\" svg={option.svg} />\n      <span className=\"option-label\">{option.label}</span>\n    </span>;\n  };\n\n  render() {\n    const { selectedOption, filterOptions = FILTER_OPTIONS } = this.props;\n    const selectedItem = filterOptions.find(({ value }) => value === selectedOption) || filterOptions[0];\n\n    return <div className=\"filter-options-dropdown\">\n      <Dropdown<FilterOption>\n        menuClassName=\"filter-options\"\n        items={filterOptions}\n        selectedItem={selectedItem}\n        equal={(a, b) => a.value === b.value}\n        keyItem={d => d.value}\n        renderItem={this.renderFilterOption}\n        renderSelectedItem={d => <SvgIcon className=\"icon\" svg={d.svg} />}\n        onSelect={this.onSelectOption}\n      />\n    </div>;\n  }\n}\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { clamp, classNames, getXFromEvent } from \"../../utils/dom/dom\";\nimport \"./range-handle.scss\";\n\nexport interface RangeHandleProps {\n  positionLeft: number;\n  onChange: (x: number) => void;\n  offset: number;\n  isAny: boolean;\n  isBeyondMin?: boolean;\n  isBeyondMax?: boolean;\n  rightBound?: number;\n  leftBound?: number;\n}\n\nexport interface RangeHandleState {\n  anchor: number;\n}\n\nexport class RangeHandle extends React.Component<RangeHandleProps, RangeHandleState> {\n  public mounted: boolean;\n\n  state: RangeHandleState = {\n    anchor: null\n  };\n\n  onGlobalMouseMove = (event: MouseEvent) => {\n    const { onChange, leftBound, rightBound } = this.props;\n    const { anchor } = this.state;\n    const newX = getXFromEvent(event) - anchor;\n\n    onChange(clamp(newX, leftBound, rightBound));\n  };\n\n  onMouseDown = (event: React.MouseEvent<HTMLElement>) => {\n    const { offset, positionLeft } = this.props;\n\n    const x = getXFromEvent(event);\n    const anchor = x - offset - positionLeft;\n\n    this.setState({\n      anchor\n    });\n\n    event.preventDefault();\n    window.addEventListener(\"mouseup\", this.onGlobalMouseUp);\n    window.addEventListener(\"mousemove\", this.onGlobalMouseMove);\n  };\n\n  onGlobalMouseUp = () => {\n    window.removeEventListener(\"mouseup\", this.onGlobalMouseUp);\n    window.removeEventListener(\"mousemove\", this.onGlobalMouseMove);\n  };\n\n  render() {\n    const { positionLeft, isAny, isBeyondMin, isBeyondMax } = this.props;\n\n    const style = { left: positionLeft };\n\n    return <div\n      className={classNames(\"range-handle\", { \"empty\": isAny, \"beyond min\": isBeyondMin, \"beyond max\": isBeyondMax })}\n      style={style}\n      onMouseDown={this.onMouseDown}\n    />;\n  }\n}\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Dataset } from \"plywood\";\nimport React from \"react\";\nimport { Dimension } from \"../../../common/models/dimension/dimension\";\nimport { Essence } from \"../../../common/models/essence/essence\";\nimport { Timekeeper } from \"../../../common/models/timekeeper/timekeeper\";\nimport { getNumberOfWholeDigits, isTruthy, toSignificantDigits } from \"../../../common/utils/general/general\";\nimport { clamp, classNames, getXFromEvent } from \"../../utils/dom/dom\";\nimport { ApiContext, ApiContextValue } from \"../../views/cube-view/api-context\";\nimport { Loader } from \"../loader/loader\";\nimport { QueryError } from \"../query-error/query-error\";\nimport { RangeHandle } from \"../range-handle/range-handle\";\nimport \"./number-range-picker.scss\";\n\nexport const ANY_VALUE: any = null;\n\nconst NUB_SIZE = 16;\nconst GRANULARITY_IN_BAR = 300; // this is how many steps we want to represent in the slider bar\n\nfunction addNubSize(value: number) {\n  return value + NUB_SIZE;\n}\n\nfunction subtractNubSize(value: number) {\n  return value && value > NUB_SIZE ? value - NUB_SIZE : 0;\n}\n\nfunction getNumberOfDigitsToShow(n: number) {\n  const totalDigits = getNumberOfWholeDigits(n / GRANULARITY_IN_BAR);\n  return totalDigits > 3 ? Math.min(totalDigits, 4) : 3;\n}\n\n// offset the bar a little because a rectangle at the same position as a circle will peek through\nfunction getAdjustedStartHalf(start: number) {\n  return start + NUB_SIZE / 2;\n}\n\nexport interface NumberRangePickerProps {\n  start: number;\n  end: number;\n  essence: Essence;\n  timekeeper: Timekeeper;\n  dimension: Dimension;\n  onRangeStartChange: (n: number) => void;\n  onRangeEndChange: (n: number) => void;\n  exclude: boolean;\n}\n\nexport interface NumberRangePickerState {\n  leftOffset?: number;\n  rightBound?: number;\n  min?: number;\n  max?: number;\n  step?: number;\n  loading?: boolean;\n  error?: any;\n}\n\nexport class NumberRangePicker extends React.Component<NumberRangePickerProps, NumberRangePickerState> {\n  static contextType = ApiContext;\n\n  context: ApiContextValue;\n  public mounted: boolean;\n  private picker = React.createRef<HTMLDivElement>();\n\n  constructor(props: NumberRangePickerProps) {\n    super(props);\n    this.state = {\n      min: null,\n      max: null,\n      step: null,\n      loading: false,\n      error: null\n    };\n  }\n\n  fetchData(essence: Essence, timekeeper: Timekeeper, dimension: Dimension, rightBound: number): void {\n    const { numberFilterQuery } = this.context;\n    this.setState({\n      loading: true\n    });\n\n    numberFilterQuery(essence, dimension)\n      .then(\n        (dataset: Dataset) => {\n          if (!this.mounted) return;\n          const min = (dataset.data[0][\"Min\"] as number);\n          const max = (dataset.data[0][\"Max\"] as number);\n\n          const areBoundsFinite = isTruthy(max) && isTruthy(min) && isFinite(max) && isFinite(min);\n          const step = areBoundsFinite ? (max - min) / rightBound : 1;\n\n          this.setState({\n            min,\n            max,\n            loading: false,\n            step: step !== 0 && isFinite(step) ? step : 1\n          });\n        },\n        error => {\n          if (!this.mounted) return;\n          this.setState({\n            loading: false,\n            error\n          });\n        }\n      );\n  }\n\n  componentDidMount() {\n    this.mounted = true;\n    const node = this.picker.current;\n    const rect = node.getBoundingClientRect();\n    const { essence, timekeeper, dimension } = this.props;\n    const leftOffset = rect.left;\n    const rightBound = rect.width;\n\n    this.setState({ leftOffset, rightBound });\n    this.fetchData(essence, timekeeper, dimension, rightBound);\n\n  }\n\n  componentWillUnmount() {\n    this.mounted = false;\n  }\n\n  relativePositionToValue(position: number, type: \"start\" | \"end\") {\n    const { step, min, max, rightBound } = this.state;\n    if (position <= addNubSize(0) && type === \"start\") return ANY_VALUE;\n    if (position >= rightBound && type === \"end\") return ANY_VALUE;\n\n    const range = max - min !== 0 ? max - min : Math.abs(max);\n    return toSignificantDigits(position * step, getNumberOfDigitsToShow(range));\n  }\n\n  valueToRelativePosition(value: number) {\n    const { step } = this.state;\n    return value / step;\n  }\n\n  onBarClick(positionStart: number, positionEnd: number, e: MouseEvent) {\n    const { leftOffset } = this.state;\n\n    const clickPadding = 5;\n    const absoluteX = getXFromEvent(e);\n    const relativeX = absoluteX - leftOffset;\n    if (relativeX < NUB_SIZE / 2) return this.updateStart(leftOffset);\n\n    const startNubPosition = addNubSize(positionStart) + clickPadding;\n    const endNubPosition = subtractNubSize(positionEnd) + clickPadding;\n\n    const isBeforeStart = relativeX < positionStart;\n    const isAfterEnd = relativeX > positionEnd + NUB_SIZE;\n    const inBetween = (relativeX < positionEnd) && relativeX > startNubPosition;\n\n    if (isBeforeStart) {\n      this.updateStart(absoluteX - NUB_SIZE);\n    } else if (isAfterEnd) {\n      this.updateEnd(absoluteX);\n    } else if (inBetween) {\n\n      const distanceFromEnd = endNubPosition - relativeX;\n      const distanceFromStart = relativeX - startNubPosition;\n\n      if (distanceFromEnd < distanceFromStart) {\n        this.updateEnd(endNubPosition + leftOffset - distanceFromEnd);\n      } else {\n        this.updateStart(startNubPosition + leftOffset + distanceFromStart - NUB_SIZE);\n      }\n      return;\n    }\n  }\n\n  updateStart = (absolutePosition: number) => {\n    const { onRangeStartChange } = this.props;\n    const { leftOffset } = this.state;\n\n    const relativePosition = absolutePosition - leftOffset;\n    const newValue = this.relativePositionToValue(addNubSize(relativePosition), \"start\");\n    onRangeStartChange(newValue);\n  };\n\n  updateEnd = (absolutePosition: number) => {\n    const { onRangeEndChange } = this.props;\n    const { leftOffset } = this.state;\n\n    const relativePosition = absolutePosition - leftOffset;\n    const newValue = this.relativePositionToValue(relativePosition, \"end\");\n\n    onRangeEndChange(newValue);\n  };\n\n  render() {\n    const { start, end, exclude } = this.props;\n    const { min, max, loading, error, step, rightBound, leftOffset } = this.state;\n\n    let content: JSX.Element = null;\n\n    if (rightBound && step && isFinite(max) && isFinite(min)) {\n      const relativeStart = start === ANY_VALUE ? 0 : subtractNubSize(this.valueToRelativePosition(start));\n      const relativeEnd = end === ANY_VALUE ? rightBound : this.valueToRelativePosition(end);\n      const adjustedRightBound = subtractNubSize(rightBound);\n\n      const positionEnd = clamp(relativeEnd, addNubSize(relativeStart), adjustedRightBound);\n      const positionStart = start ? clamp(relativeStart, 0, subtractNubSize(positionEnd)) : 0;\n\n      const rangeBarSelected = { left: getAdjustedStartHalf(positionStart), width: positionEnd - positionStart };\n\n      const absoluteRightBound = leftOffset + rightBound;\n\n      content = <div className=\"range-slider\" onMouseDown={this.onBarClick.bind(this, positionStart, positionEnd)}>\n        <div className=\"range-bar full\" />\n        <div className=\"range-bar selected\" style={rangeBarSelected} />\n        <RangeHandle\n          positionLeft={positionStart}\n          onChange={this.updateStart}\n          isAny={start === ANY_VALUE}\n          isBeyondMin={start !== ANY_VALUE && start < min}\n          leftBound={leftOffset}\n          rightBound={leftOffset + subtractNubSize(positionEnd)}\n          offset={leftOffset}\n        />\n        <RangeHandle\n          positionLeft={positionEnd}\n          onChange={this.updateEnd}\n          isAny={end === ANY_VALUE}\n          isBeyondMax={end !== ANY_VALUE && max < end}\n          leftBound={leftOffset + addNubSize(positionStart)}\n          rightBound={absoluteRightBound}\n          offset={leftOffset}\n        />\n      </div>;\n    }\n\n    return <div className={classNames(\"number-range-picker\", { inverted: exclude })} ref={this.picker}>\n      {content}\n      {loading && <Loader />}\n      {error && <QueryError error={error} />}\n    </div>;\n  }\n}\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { List } from \"immutable\";\nimport React from \"react\";\nimport { Dimension } from \"../../../../common/models/dimension/dimension\";\nimport { Essence } from \"../../../../common/models/essence/essence\";\nimport { FilterClause, NumberFilterClause, NumberRange } from \"../../../../common/models/filter-clause/filter-clause\";\nimport { FilterMode } from \"../../../../common/models/filter/filter\";\nimport { Stage } from \"../../../../common/models/stage/stage\";\nimport { Timekeeper } from \"../../../../common/models/timekeeper/timekeeper\";\nimport { Unary } from \"../../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../../common/utils/general/general\";\nimport { STRINGS } from \"../../../config/constants\";\nimport { enterKey } from \"../../../utils/dom/dom\";\nimport { BubbleMenu } from \"../../bubble-menu/bubble-menu\";\nimport { Button } from \"../../button/button\";\nimport { FilterOption, FilterOptionsDropdown } from \"../../filter-options-dropdown/filter-options-dropdown\";\nimport { ANY_VALUE, NumberRangePicker } from \"../../number-range-picker/number-range-picker\";\nimport \"./number-filter-menu.scss\";\n\nfunction numberOrAnyToString(start: number): string {\n  if (start === ANY_VALUE) return STRINGS.any;\n  return \"\" + start;\n}\n\nfunction stringToNumberOrAny(startInput: string): number {\n  const parse = parseFloat(startInput);\n  return isNaN(parse) ? ANY_VALUE : parse;\n}\n\nconst MENU_WIDTH = 250;\nconst filterOptions: FilterOption[] = FilterOptionsDropdown.getFilterOptions(FilterMode.INCLUDE, FilterMode.EXCLUDE);\n\nexport interface NumberFilterMenuProps {\n  essence: Essence;\n  timekeeper: Timekeeper;\n  dimension: Dimension;\n  saveClause: Unary<FilterClause, void>;\n  onClose: Fn;\n  containerStage?: Stage;\n  openOn: Element;\n}\n\nexport interface NumberFilterMenuState {\n  leftOffset?: number;\n  rightBound?: number;\n  start?: number;\n  end?: number;\n  significantDigits?: number;\n  filterMode?: FilterMode;\n}\n\nexport class NumberFilterMenu extends React.Component<NumberFilterMenuProps, NumberFilterMenuState> {\n  state: NumberFilterMenuState = {\n    leftOffset: null,\n    rightBound: null,\n    start: ANY_VALUE,\n    end: ANY_VALUE\n  };\n\n  UNSAFE_componentWillMount() {\n    const { essence, dimension } = this.props;\n    const clause = essence.filter.getClauseForDimension(dimension);\n    if (!clause) return;\n    if (!(clause instanceof NumberFilterClause)) {\n      throw new Error(`Expected number filter. Got: ${clause}`);\n    }\n    const hasFilter = clause.values.count() !== 0;\n    if (hasFilter) {\n      const { start, end } = clause.values.first();\n\n      this.setState({\n        start,\n        end,\n        filterMode: essence.filter.getModeForDimension(dimension) || FilterMode.INCLUDE\n      });\n    }\n  }\n\n  componentDidMount() {\n    window.addEventListener(\"keydown\", this.globalKeyDownListener);\n  }\n\n  componentWillUnmount() {\n    window.removeEventListener(\"keydown\", this.globalKeyDownListener);\n  }\n\n  constructClause(): NumberFilterClause {\n    const { dimension } = this.props;\n    const { start, end, filterMode } = this.state;\n\n    if (isNaN(start) || isNaN(end)) return null;\n    if (start === null && end === null) return null;\n    if (start !== null && end !== null && start > end) return null;\n    return new NumberFilterClause({\n      reference: dimension.name,\n      not: filterMode === FilterMode.EXCLUDE,\n      values: List.of(new NumberRange({ start, end, bounds: start === end ? \"[]\" : \"[)\" }))\n    });\n  }\n\n  globalKeyDownListener = (e: KeyboardEvent) => {\n    if (enterKey(e)) {\n      this.onOkClick();\n    }\n  };\n\n  onOkClick = () => {\n    if (!this.actionEnabled()) return;\n    const { saveClause, onClose } = this.props;\n    saveClause(this.constructClause());\n    onClose();\n  };\n\n  onCancelClick = () => {\n    const { onClose } = this.props;\n    onClose();\n  };\n\n  onRangeInputStartChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const startInput = e.target.value;\n    this.setState({\n      start: stringToNumberOrAny(startInput)\n    });\n  };\n\n  onRangeInputEndChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const endInput = e.target.value;\n    this.setState({\n      end: stringToNumberOrAny(endInput)\n    });\n  };\n\n  onRangeStartChange = (start: number) => {\n    this.setState({ start });\n  };\n\n  onRangeEndChange = (end: number) => {\n    this.setState({ end });\n  };\n\n  onSelectFilterOption = (filterMode: FilterMode) => {\n    this.setState({ filterMode });\n  };\n\n  actionEnabled() {\n    const { essence: { filter }, dimension } = this.props;\n    const newClause = this.constructClause();\n    const oldClause = filter.getClauseForDimension(dimension);\n    return Boolean(newClause) && !newClause.equals(oldClause);\n  }\n\n  render() {\n    const { essence, timekeeper, dimension, onClose, containerStage, openOn } = this.props;\n    const { end, start, filterMode } = this.state;\n    const menuSize = Stage.fromSize(MENU_WIDTH, 410);\n\n    return <BubbleMenu\n      className=\"number-filter-menu\"\n      direction=\"down\"\n      containerStage={containerStage}\n      stage={menuSize}\n      openOn={openOn}\n      onClose={onClose}\n    >\n      <div className=\"side-by-side\">\n        <div className=\"group\">\n          <label className=\"input-top-label\">Type</label>\n          <FilterOptionsDropdown\n            selectedOption={filterMode}\n            onSelectOption={this.onSelectFilterOption}\n            filterOptions={filterOptions}\n          />\n        </div>\n        <div className=\"group\">\n          <label className=\"input-top-label\">Min</label>\n          <input value={numberOrAnyToString(start)} onChange={this.onRangeInputStartChange} />\n        </div>\n        <div className=\"group\">\n          <label className=\"input-top-label\">Max</label>\n          <input value={numberOrAnyToString(end)} onChange={this.onRangeInputEndChange} />\n        </div>\n      </div>\n\n      <NumberRangePicker\n        onRangeEndChange={this.onRangeEndChange}\n        onRangeStartChange={this.onRangeStartChange}\n        start={start}\n        end={end}\n        dimension={dimension}\n        essence={essence}\n        timekeeper={timekeeper}\n        exclude={filterMode === FilterMode.EXCLUDE}\n      />\n\n      <div className=\"ok-cancel-bar\">\n        <Button type=\"primary\" title={STRINGS.ok} onClick={this.onOkClick} disabled={!this.actionEnabled()} />\n        <Button type=\"secondary\" title={STRINGS.cancel} onClick={this.onCancelClick} />\n      </div>\n    </BubbleMenu>;\n  }\n}\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Dataset } from \"plywood\";\nimport React from \"react\";\nimport { Dimension } from \"../../../common/models/dimension/dimension\";\nimport { FilterMode } from \"../../../common/models/filter/filter\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { HighlightString } from \"../highlight-string/highlight-string\";\nimport \"./preview-list.scss\";\nimport { PreviewFilterMode } from \"./preview-string-filter-menu\";\n\ninterface PreviewListProps {\n  dimension: Dimension;\n  dataset: Dataset;\n  searchText: string;\n  regexErrorMessage: string;\n  limit: number;\n  filterMode: PreviewFilterMode;\n}\n\nconst errorNotice = (content: string) => <div className=\"error-notice\">{content}</div>;\n\ninterface RowProps {\n  content: string;\n  highlight: string;\n}\n\nconst Row: React.FunctionComponent<RowProps> = ({ content, highlight }) => <div className=\"row no-select\" title={content}>\n  <div className=\"row-wrapper\">\n    <HighlightString className=\"label\" text={content} highlight={highlight} />\n  </div>\n</div>;\n\nfunction predicate(filterMode: PreviewFilterMode, searchText: string): Unary<unknown, boolean> {\n  switch (filterMode) {\n    case FilterMode.CONTAINS:\n      return d => String(d).includes(searchText);\n    case FilterMode.REGEX:\n      const escaped = searchText.replace(/\\\\[^\\\\]]/g, \"\\\\\\\\\");\n      const regexp = new RegExp(escaped);\n      return d => regexp.test(String(d));\n  }\n}\n\nfunction filterValues<T>(list: T[], filterMode: PreviewFilterMode, searchText: string): T[] {\n  if (!searchText) return list;\n  return list.filter(predicate(filterMode, searchText));\n}\n\nexport const PreviewList: React.FunctionComponent<PreviewListProps> = props => {\n  const { regexErrorMessage, searchText, dataset, filterMode, dimension, limit } = props;\n\n  if (regexErrorMessage) return errorNotice(regexErrorMessage);\n\n  const data = dataset.data;\n  if (searchText && data.length === 0) return errorNotice(`No results for \"${searchText}\"`);\n\n  const list = data.slice(0, limit).map(d => d[dimension.name]);\n  const filtered = filterValues(list, filterMode, searchText);\n\n  return <React.Fragment>\n    {searchText && <div className=\"matching-values-message\">Matching Values</div>}\n    {filtered.map(value => <Row content={String(value)} highlight={searchText} key={String(value)} />)}\n  </React.Fragment>;\n};\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Set } from \"immutable\";\nimport { Dataset } from \"plywood\";\nimport React from \"react\";\nimport {\n  DatasetRequest,\n  error,\n  isError,\n  isLoaded,\n  isLoading,\n  loaded,\n  loading\n} from \"../../../common/models/dataset-request/dataset-request\";\nimport { Dimension } from \"../../../common/models/dimension/dimension\";\nimport { Essence } from \"../../../common/models/essence/essence\";\nimport {\n  FilterClause,\n  StringFilterAction,\n  StringFilterClause\n} from \"../../../common/models/filter-clause/filter-clause\";\nimport { FilterMode } from \"../../../common/models/filter/filter\";\nimport { debounceWithPromise, Unary } from \"../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { SEARCH_WAIT, STRINGS } from \"../../config/constants\";\nimport { classNames, enterKey } from \"../../utils/dom/dom\";\nimport { reportError } from \"../../utils/error-reporter/error-reporter\";\nimport { ApiContext, ApiContextValue } from \"../../views/cube-view/api-context\";\nimport { Button } from \"../button/button\";\nimport { ClearableInput } from \"../clearable-input/clearable-input\";\nimport { GlobalEventListener } from \"../global-event-listener/global-event-listener\";\nimport { Loader } from \"../loader/loader\";\nimport { QueryError } from \"../query-error/query-error\";\nimport { PreviewList } from \"./preview-list\";\nimport \"./preview-string-filter-menu.scss\";\n\nfunction checkRegex(text: string): string {\n  try {\n    new RegExp(text);\n  } catch (e) {\n    return e.message;\n  }\n  return null;\n}\n\nconst TOP_N = 100;\n\nexport type PreviewFilterMode = FilterMode.CONTAINS | FilterMode.REGEX;\n\nexport interface PreviewStringFilterMenuProps {\n  dimension: Dimension;\n  essence: Essence;\n  onClose: Fn;\n  filterMode: FilterMode.REGEX | FilterMode.CONTAINS;\n  saveClause: Unary<FilterClause, void>;\n}\n\nexport interface PreviewStringFilterMenuState {\n  searchText: string;\n  dataset: DatasetRequest;\n}\n\nexport class PreviewStringFilterMenu extends React.Component<PreviewStringFilterMenuProps, PreviewStringFilterMenuState> {\n  static contextType = ApiContext;\n\n  context: ApiContextValue;\n\n  private lastSearchText: string;\n\n  initialSearchText = (): string => {\n    const { essence, dimension } = this.props;\n    const clause = essence.filter.getClauseForDimension(dimension);\n    if (clause && clause instanceof StringFilterClause && clause.action !== StringFilterAction.IN) {\n      return clause.values.first();\n    }\n    return \"\";\n  };\n\n  state: PreviewStringFilterMenuState = { dataset: loading, searchText: this.initialSearchText() };\n\n  updateSearchText = (searchText: string) => this.setState({ searchText });\n\n  private loadRows() {\n    if (this.regexErrorMessage()) return;\n    this.setState({ dataset: loading });\n    this.sendQueryFilter()\n      .then(dataset => {\n        // TODO: encode it better\n        // null is here when we get out of order request, so we just ignore it\n        if (!dataset) return;\n        this.setState({ dataset });\n      });\n  }\n\n  private sendQueryFilter(): Promise<DatasetRequest> {\n    const { searchText } = this.state;\n    this.lastSearchText = searchText;\n    return this.debouncedQueryFilter(this.props.essence, this.constructClause());\n  }\n\n  private regexErrorMessage(): string {\n    const { filterMode } = this.props;\n    const { searchText } = this.state;\n    return filterMode === FilterMode.REGEX && searchText && checkRegex(searchText);\n  }\n\n  private queryFilter = (essence: Essence, clause: StringFilterClause): Promise<DatasetRequest> => {\n    const { stringFilterQuery } = this.context;\n    const { searchText } = this.state;\n\n    return stringFilterQuery(essence, clause)\n      .then((dataset: Dataset) => {\n        if (this.lastSearchText !== searchText) return null;\n        return loaded(dataset);\n      })\n      .catch(err => {\n          if (this.lastSearchText !== searchText) return null;\n          reportError(err);\n          return error(err);\n        }\n      );\n  };\n\n  private debouncedQueryFilter = debounceWithPromise(this.queryFilter, SEARCH_WAIT);\n\n  UNSAFE_componentWillMount() {\n    this.loadRows();\n  }\n\n  componentWillUnmount() {\n    this.debouncedQueryFilter.cancel();\n  }\n\n  componentDidUpdate(prevProps: PreviewStringFilterMenuProps, prevState: PreviewStringFilterMenuState): void {\n    if (this.state.searchText !== prevState.searchText) {\n      this.loadRows();\n    }\n  }\n\n  globalKeyDownListener = (e: KeyboardEvent) => {\n    if (enterKey(e)) {\n      this.onOkClick();\n    }\n  };\n\n  constructClause(): StringFilterClause {\n    const { dimension, filterMode } = this.props;\n    const { searchText } = this.state;\n    const { name: reference } = dimension;\n\n    switch (filterMode) {\n      case FilterMode.CONTAINS:\n        return new StringFilterClause({\n          reference,\n          values: Set.of(searchText),\n          action: StringFilterAction.CONTAINS\n        });\n      case FilterMode.REGEX:\n        return new StringFilterClause({\n          reference,\n          values: Set.of(searchText),\n          action: StringFilterAction.MATCH\n        });\n    }\n  }\n\n  onOkClick = () => {\n    if (!this.actionEnabled()) return;\n    const { saveClause, onClose } = this.props;\n    saveClause(this.constructClause());\n    onClose();\n  };\n\n  onCancelClick = () => {\n    this.props.onClose();\n  };\n\n  actionEnabled() {\n    const { essence: { filter }, dimension } = this.props;\n    if (this.regexErrorMessage()) return false;\n    const newClause = this.constructClause();\n    if (!newClause.values.first()) {\n      return false;\n    }\n    const oldClause = filter.getClauseForDimension(dimension);\n    return !newClause.equals(oldClause);\n  }\n\n  render() {\n    const { filterMode, dimension } = this.props;\n    const { dataset, searchText } = this.state;\n\n    const hasMore = isLoaded(dataset) && dataset.dataset.data.length > TOP_N;\n    return <React.Fragment>\n      <GlobalEventListener keyDown={this.globalKeyDownListener} />\n      <div className=\"search-box\">\n        <ClearableInput\n          placeholder=\"Search\"\n          focusOnMount={true}\n          value={searchText}\n          onChange={this.updateSearchText}\n        />\n      </div>\n      <div className=\"preview-string-filter-menu\">\n        <div className={classNames(\"menu-table\", hasMore ? \"has-more\" : \"no-more\")}>\n          <div className=\"rows\">\n            {isLoaded(dataset) && <PreviewList\n              dimension={dimension}\n              dataset={dataset.dataset}\n              searchText={searchText}\n              regexErrorMessage={this.regexErrorMessage()}\n              limit={TOP_N}\n              filterMode={filterMode} />}\n            {isError(dataset) ? <QueryError error={dataset.error} /> : null}\n            {isLoading(dataset) ? <Loader /> : null}\n          </div>\n        </div>\n        <div className=\"ok-cancel-bar\">\n          <Button type=\"primary\" title={STRINGS.ok} onClick={this.onOkClick} disabled={!this.actionEnabled()} />\n          <Button type=\"secondary\" title={STRINGS.cancel} onClick={this.onCancelClick} />\n        </div>\n      </div>\n    </React.Fragment>;\n  }\n}\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Set } from \"immutable\";\nimport React from \"react\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { Button } from \"../button/button\";\nimport \"./paste-form.scss\";\n\ninterface PasteFormProps {\n  onSelect: Unary<Set<string>, void>;\n  onClose: Fn;\n}\n\ninterface PasteFormState {\n  value: string;\n}\n\nfunction focus(textArea: HTMLTextAreaElement): void {\n  if (!textArea) return;\n  textArea.focus();\n}\n\nexport class PasteForm extends React.Component<PasteFormProps, PasteFormState> {\n\n  state: PasteFormState = { value: \"\" };\n\n  values = (): Set<string> => {\n    const { value } = this.state;\n    return Set(value\n      .split(\"\\n\")\n      .map(s => s.trim())\n      .filter(s => s.length > 0));\n  };\n\n  select = () => {\n    const { onClose, onSelect } = this.props;\n    const values = this.values();\n    if (values.isEmpty()) return;\n    onSelect(Set(values));\n    onClose();\n  };\n\n  cancel = () => this.props.onClose();\n\n  saveValue = ({ target: { value } }: React.ChangeEvent<HTMLTextAreaElement>) => this.setState({ value });\n\n  render() {\n    const { value } = this.state;\n    const disabled = this.values().isEmpty();\n    return <div>\n      <textarea ref={focus} className=\"paste-field\" value={value} onChange={this.saveValue} />\n      <div className=\"paste-actions\">\n        <Button type=\"primary\" title=\"Select\" disabled={disabled} onClick={this.select} />\n        <Button type=\"secondary\" title=\"Cancel\" onClick={this.cancel} />\n      </div>\n    </div>;\n  }\n}\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Binary } from \"../../../common/utils/functional/functional\";\nimport { classNames } from \"../../utils/dom/dom\";\nimport { Checkbox, CheckboxType } from \"../checkbox/checkbox\";\nimport { HighlightString } from \"../highlight-string/highlight-string\";\nimport \"./string-value.scss\";\n\ninterface StringValueProps {\n  value: unknown;\n  selected: boolean;\n  checkboxStyle: string;\n  highlight: string;\n  onRowSelect: Binary<unknown, boolean, void>;\n}\n\nconst hasModKey = (e: React.MouseEvent<unknown>) => e.altKey || e.ctrlKey || e.metaKey;\n\nexport const StringValue: React.FunctionComponent<StringValueProps> = props => {\n  const { value, selected, checkboxStyle, highlight, onRowSelect } = props;\n  const label = String(value);\n\n  return <div\n    className={classNames(\"string-value\", { selected })}\n    title={label}\n    onClick={e => onRowSelect(value, hasModKey(e))}\n  >\n    <div className=\"value-wrapper\">\n      <Checkbox type={checkboxStyle as CheckboxType} selected={selected} />\n      <HighlightString className=\"label\" text={label} highlight={highlight} />\n    </div>\n  </div>;\n};\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Set } from \"immutable\";\nimport { Dataset } from \"plywood\";\nimport React from \"react\";\nimport { Dimension } from \"../../../common/models/dimension/dimension\";\nimport { FilterMode } from \"../../../common/models/filter/filter\";\nimport { Binary } from \"../../../common/utils/functional/functional\";\nimport { StringValue } from \"./string-value\";\nimport \"./string-values-list.scss\";\n\nfunction filterRows(rows: unknown[], searchText: string): unknown[] {\n  if (!searchText) return rows;\n  const searchTextLower = searchText.toLowerCase();\n  return rows.filter(d => String(d).toLowerCase().indexOf(searchTextLower) !== -1);\n}\n\nfunction prependPromotedValues(rows: unknown[], promoted: Set<unknown>): unknown[] {\n  return [\n    ...promoted,\n    ...rows.filter(value => !promoted.contains(value))\n    ];\n}\n\ninterface RowsListProps {\n  dimension: Dimension;\n  dataset: Dataset;\n  searchText: string;\n  selectedValues: Set<unknown>;\n  promotedValues: Set<unknown>;\n  filterMode: FilterMode;\n  onRowSelect: Binary<unknown, boolean, void>;\n}\n\nexport const StringValuesList: React.FunctionComponent<RowsListProps> = props => {\n  const { onRowSelect, filterMode, dataset, dimension, searchText, promotedValues, selectedValues } = props;\n  const rowValues: unknown[] = dataset.data.map(d => d[dimension.name]);\n  const values = prependPromotedValues(rowValues, promotedValues);\n  const matchingValues = filterRows(values, searchText);\n  if (searchText && matchingValues.length === 0) {\n    return <div className=\"no-string-values\">{`No results for \"${searchText}\"`}</div>;\n  }\n  const checkboxStyle = filterMode === FilterMode.EXCLUDE ? \"cross\" : \"check\";\n  return <React.Fragment>\n    {matchingValues.map(value => (\n      <StringValue\n        key={String(value)}\n        value={value}\n        onRowSelect={onRowSelect}\n        selected={selectedValues && selectedValues.contains(value)}\n        checkboxStyle={checkboxStyle}\n        highlight={searchText} />))}\n  </React.Fragment>;\n};\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Set } from \"immutable\";\nimport { Dataset } from \"plywood\";\nimport React from \"react\";\nimport {\n  DatasetRequest,\n  error,\n  isError,\n  isLoaded,\n  isLoading,\n  loaded,\n  loading\n} from \"../../../common/models/dataset-request/dataset-request\";\nimport { Dimension } from \"../../../common/models/dimension/dimension\";\nimport { Essence } from \"../../../common/models/essence/essence\";\nimport {\n  FilterClause,\n  StringFilterAction,\n  StringFilterClause\n} from \"../../../common/models/filter-clause/filter-clause\";\nimport { FilterMode } from \"../../../common/models/filter/filter\";\nimport { Timekeeper } from \"../../../common/models/timekeeper/timekeeper\";\nimport { debounceWithPromise, Unary } from \"../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { SEARCH_WAIT, STRINGS } from \"../../config/constants\";\nimport { classNames, enterKey } from \"../../utils/dom/dom\";\nimport { reportError } from \"../../utils/error-reporter/error-reporter\";\nimport { ApiContext, ApiContextValue } from \"../../views/cube-view/api-context\";\nimport { Button } from \"../button/button\";\nimport { ClearableInput } from \"../clearable-input/clearable-input\";\nimport { GlobalEventListener } from \"../global-event-listener/global-event-listener\";\nimport { Loader } from \"../loader/loader\";\nimport { PasteForm } from \"../paste-form/paste-form\";\nimport { QueryError } from \"../query-error/query-error\";\nimport { SvgIcon } from \"../svg-icon/svg-icon\";\nimport \"./selectable-string-filter-menu.scss\";\nimport { StringValuesList } from \"./string-values-list\";\n\nconst TOP_N = 100;\n\nexport interface SelectableStringFilterMenuProps {\n  dimension: Dimension;\n  essence: Essence;\n  timekeeper: Timekeeper;\n  onClose: Fn;\n  filterMode?: FilterMode;\n  saveClause: Unary<FilterClause, void>;\n}\n\nexport interface SelectableStringFilterMenuState {\n  searchText: string;\n  dataset: DatasetRequest;\n  selectedValues: Set<string>;\n  pasteModeEnabled: boolean;\n}\n\nfunction toggle(set: Set<string>, value: string): Set<string> {\n  return set.has(value) ? set.remove(value) : set.add(value);\n}\n\nexport class SelectableStringFilterMenu extends React.Component<SelectableStringFilterMenuProps, SelectableStringFilterMenuState> {\n  static contextType = ApiContext;\n\n  context: ApiContextValue;\n  private lastSearchText: string;\n\n  state: SelectableStringFilterMenuState = {\n    pasteModeEnabled: false,\n    dataset: loading,\n    selectedValues: this.initialSelection(),\n    searchText: \"\"\n  };\n\n  private loadRows() {\n    this.setState({ dataset: loading });\n    this.sendQueryFilter()\n      .then(dataset => {\n        // TODO: encode it better\n        // null is here when we get out of order request, so we just ignore it\n        if (!dataset) return;\n        this.setState({ dataset });\n      })\n      .catch(_ => {\n        // Some weird internal error. All application logic errors are handled earlier\n        this.setState({ dataset: error(new Error(\"Unknown error\")) });\n      });\n  }\n\n  private sendQueryFilter(): Promise<DatasetRequest> {\n    const { searchText } = this.state;\n    this.lastSearchText = searchText;\n    return this.debouncedQueryFilter(this.props.essence, this.constructSearchTextClause());\n  }\n\n  private queryFilter = (essence: Essence, clause: StringFilterClause): Promise<DatasetRequest> => {\n    const { searchText } = this.state;\n    const { stringFilterQuery } = this.context;\n\n    return stringFilterQuery(essence, clause)\n      .then((dataset: Dataset) => {\n        if (this.lastSearchText !== searchText) return null;\n        return loaded(dataset);\n      })\n      .catch(err => {\n          if (this.lastSearchText !== searchText) return null;\n          reportError(err);\n          return error(err);\n        }\n      );\n  };\n\n  private debouncedQueryFilter = debounceWithPromise(this.queryFilter, SEARCH_WAIT);\n\n  UNSAFE_componentWillMount() {\n    this.loadRows();\n  }\n\n  private initialSelection(): Set<string> {\n    const { essence: { filter }, dimension } = this.props;\n    const clause = filter.getClauseForDimension(dimension);\n    if (!clause) return Set();\n    if (!(clause instanceof StringFilterClause)) {\n      throw new Error(`Expected string filter clause, got: ${clause}`);\n    }\n    return clause.action === StringFilterAction.IN ? clause.values : Set();\n  }\n\n  componentWillUnmount() {\n    this.debouncedQueryFilter.cancel();\n  }\n\n  componentDidUpdate(prevProps: SelectableStringFilterMenuProps, prevState: SelectableStringFilterMenuState) {\n    if (this.state.searchText !== prevState.searchText) {\n      this.loadRows();\n    }\n  }\n\n  globalKeyDownListener = (e: KeyboardEvent) => {\n    if (!this.state.pasteModeEnabled && enterKey(e)) {\n      this.onOkClick();\n    }\n  };\n\n  updateSearchText = (searchText: string) => this.setState({ searchText });\n\n  constructClause(): StringFilterClause {\n    const { dimension, filterMode } = this.props;\n    const { selectedValues } = this.state;\n    const { name } = dimension;\n    if (selectedValues.isEmpty()) return null;\n\n    return new StringFilterClause({\n      action: StringFilterAction.IN,\n      reference: name,\n      values: selectedValues,\n      not: filterMode === FilterMode.EXCLUDE\n    });\n  }\n\n  constructSearchTextClause(): StringFilterClause {\n    const { dimension } = this.props;\n    const { name: reference } = dimension;\n    const { searchText } = this.state;\n    return new StringFilterClause({\n      action: StringFilterAction.CONTAINS,\n      reference,\n      values: Set.of(searchText),\n      ignoreCase: true\n    });\n  }\n\n  onValueClick = (value: string, withModKey: boolean) => {\n    const { selectedValues } = this.state;\n    if (withModKey) {\n      const isValueSingleSelected = selectedValues.contains(value) && selectedValues.count() === 1;\n      return this.setState({ selectedValues: isValueSingleSelected ? Set.of() : Set.of(value) });\n    }\n    return this.setState({ selectedValues: toggle(selectedValues, value) });\n  };\n\n  onOkClick = () => {\n    if (!this.isFilterValid()) return;\n    const { saveClause, onClose } = this.props;\n    saveClause(this.constructClause());\n    onClose();\n  };\n\n  enablePasteMode = () => this.setState({ pasteModeEnabled: true });\n\n  disablePasteMode = () => this.setState({ pasteModeEnabled: false });\n\n  selectValues = (values: Set<string>) => this.setState({ selectedValues: values });\n\n  isFilterValid(): boolean {\n    const { selectedValues } = this.state;\n    if (selectedValues.isEmpty()) return false;\n    const { essence: { filter }, dimension } = this.props;\n    const newClause = this.constructClause();\n    const oldClause = filter.getClauseForDimension(dimension);\n    return newClause && !newClause.equals(oldClause);\n  }\n\n  renderSelectMode(): JSX.Element {\n    const { filterMode, onClose, dimension } = this.props;\n    const { dataset, selectedValues, searchText } = this.state;\n\n    return <React.Fragment>\n      <div className=\"paste-icon\" onClick={this.enablePasteMode} title=\"Paste multiple values\">\n        <SvgIcon svg={require(\"../../icons/full-multi.svg\")} />\n      </div>\n      <div className=\"search-box\">\n        <ClearableInput\n          placeholder=\"Search\"\n          focusOnMount={true}\n          value={searchText}\n          onChange={this.updateSearchText}\n        />\n      </div>\n      <div className={classNames(\"selectable-string-filter-menu\", filterMode)}>\n        <div className=\"menu-table\">\n          <div className=\"rows\">\n            {isLoaded(dataset) && <StringValuesList\n              onRowSelect={this.onValueClick}\n              dimension={dimension}\n              dataset={dataset.dataset}\n              searchText={searchText}\n              selectedValues={selectedValues}\n              promotedValues={this.initialSelection()}\n              filterMode={filterMode} />}\n            {isError(dataset) && <QueryError error={dataset.error} />}\n            {isLoading(dataset) && <Loader />}\n          </div>\n        </div>\n        <div className=\"ok-cancel-bar\">\n          <Button type=\"primary\" title={STRINGS.ok} onClick={this.onOkClick} disabled={!this.isFilterValid()} />\n          <Button type=\"secondary\" title={STRINGS.cancel} onClick={onClose} />\n        </div>\n      </div>\n    </React.Fragment>;\n  }\n\n  renderImportMode(): JSX.Element {\n    return <React.Fragment>\n      <div className=\"paste-prompt\">Paste values separated by newlines</div>\n      <div className=\"paste-form\">\n        <PasteForm onSelect={this.selectValues} onClose={this.disablePasteMode} />\n      </div>\n    </React.Fragment>;\n  }\n\n  render() {\n    const { pasteModeEnabled } = this.state;\n    return <React.Fragment>\n      <GlobalEventListener keyDown={this.globalKeyDownListener} />\n      {pasteModeEnabled ? this.renderImportMode() : this.renderSelectMode()}\n    </React.Fragment>;\n  }\n}\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Dimension } from \"../../../../common/models/dimension/dimension\";\nimport { Essence } from \"../../../../common/models/essence/essence\";\nimport { FilterClause } from \"../../../../common/models/filter-clause/filter-clause\";\nimport { FilterMode } from \"../../../../common/models/filter/filter\";\nimport { Stage } from \"../../../../common/models/stage/stage\";\nimport { Timekeeper } from \"../../../../common/models/timekeeper/timekeeper\";\nimport { Unary } from \"../../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../../common/utils/general/general\";\nimport { BubbleMenu } from \"../../bubble-menu/bubble-menu\";\nimport { FilterOption, FilterOptionsDropdown } from \"../../filter-options-dropdown/filter-options-dropdown\";\nimport { PreviewStringFilterMenu } from \"../../preview-string-filter-menu/preview-string-filter-menu\";\nimport { SelectableStringFilterMenu } from \"../../selectable-string-filter-menu/selectable-string-filter-menu\";\nimport \"./string-filter-menu.scss\";\n\nexport interface StringFilterMenuProps {\n  dimension: Dimension;\n  saveClause: Unary<FilterClause, void>;\n  essence: Essence;\n  timekeeper: Timekeeper;\n  onClose: Fn;\n  containerStage?: Stage;\n  openOn: Element;\n}\n\nexport interface StringFilterMenuState {\n  filterMode?: FilterMode;\n}\n\nexport class StringFilterMenu extends React.Component<StringFilterMenuProps, StringFilterMenuState> {\n\n  private initialFilterMode = (): FilterMode => {\n    const { essence: { filter }, dimension } = this.props;\n    const filterMode = filter.getModeForDimension(dimension);\n    return filterMode || FilterMode.INCLUDE;\n  };\n\n  state: StringFilterMenuState = { filterMode: this.initialFilterMode() };\n\n  onSelectFilterOption = (filterMode: FilterMode) => this.setState({ filterMode });\n\n  getFilterOptions() {\n    const { dimension } = this.props;\n    const dimensionKind = dimension.kind;\n\n    let filterOptions: FilterOption[] = FilterOptionsDropdown.getFilterOptions(FilterMode.INCLUDE, FilterMode.EXCLUDE);\n    if (dimensionKind !== \"boolean\") filterOptions = filterOptions.concat(FilterOptionsDropdown.getFilterOptions(FilterMode.REGEX, FilterMode.CONTAINS));\n\n    return filterOptions;\n  }\n\n  renderFilterControls(): JSX.Element {\n    const { dimension, saveClause, essence, timekeeper, onClose } = this.props;\n    const { filterMode } = this.state;\n    const props = { dimension, essence, timekeeper, onClose, saveClause };\n    switch (filterMode) {\n      case FilterMode.EXCLUDE:\n      case FilterMode.INCLUDE:\n        const selectableProps = { ...props, filterMode };\n        return <SelectableStringFilterMenu {...selectableProps} />;\n      case FilterMode.REGEX:\n      case FilterMode.CONTAINS:\n        const previewProps = { ...props, filterMode };\n        return <PreviewStringFilterMenu key={filterMode} {...previewProps} />;\n    }\n  }\n\n  render() {\n    const { dimension, onClose, containerStage, openOn } = this.props;\n    const { filterMode } = this.state;\n    if (!dimension) return null;\n\n    return <BubbleMenu\n      className=\"string-filter-menu\"\n      direction=\"down\"\n      containerStage={containerStage}\n      stage={Stage.fromSize(300, 410)}\n      openOn={openOn}\n      onClose={onClose}\n    >\n      <div className=\"string-filter-content\">\n        <FilterOptionsDropdown\n          selectedOption={filterMode}\n          onSelectOption={this.onSelectFilterOption}\n          filterOptions={this.getFilterOptions()}\n        />\n        {this.renderFilterControls()}\n      </div>\n    </BubbleMenu>;\n  }\n}\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Timezone } from \"chronoshift\";\nimport React from \"react\";\nimport { combineDateAndTimeIntoMoment, formatISODate, formatISOTime, normalizeISODate, normalizeISOTime, validateISODate, validateISOTime } from \"../../../common/utils/time/time\";\nimport \"./date-range-input.scss\";\n\nexport interface DateRangeInputProps {\n  time: Date;\n  timezone: Timezone;\n  onChange: (t: Date) => void;\n  hide?: boolean;\n  type?: string;\n  label: string;\n}\n\nexport interface DateRangeInputState {\n  dateString?: string;\n  timeString?: string;\n}\n\nexport class DateRangeInput extends React.Component<DateRangeInputProps, DateRangeInputState> {\n  state = {\n    dateString: \"\",\n    timeString: \"\"\n  };\n\n  componentDidMount() {\n    const { time, timezone } = this.props;\n    this.updateStateFromTime(time, timezone);\n  }\n\n  UNSAFE_componentWillReceiveProps(nextProps: DateRangeInputProps) {\n    const { time, timezone } = nextProps;\n    this.updateStateFromTime(time, timezone);\n  }\n\n  updateStateFromTime(time: Date, timezone: Timezone) {\n    if (!time) return;\n    if (isNaN(time.valueOf())) {\n      this.setState({\n        dateString: \"\"\n      });\n      return;\n    }\n\n    this.setState({\n      dateString: formatISODate(time, timezone),\n      timeString: formatISOTime(time, timezone)\n    });\n  }\n\n  dateChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const dateString = normalizeISODate(e.target.value);\n    this.setState({\n      dateString\n    });\n    if (validateISODate(dateString)) {\n      this.changeDate(dateString, this.state.timeString);\n    }\n  };\n\n  timeChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const timeString = normalizeISOTime(e.target.value);\n    this.setState({\n      timeString\n    });\n    if (validateISOTime(timeString)) {\n      this.changeDate(this.state.dateString, timeString);\n    }\n  };\n\n  changeDate(possibleDateString: string, possibleTimeString: string): void {\n    const { timezone, onChange } = this.props;\n\n    const possibleMoment = combineDateAndTimeIntoMoment(possibleDateString, possibleTimeString, timezone);\n    if (possibleMoment && possibleMoment.isValid()) {\n      onChange(possibleMoment.toDate());\n    }\n  }\n\n  render() {\n    const { hide, label } = this.props;\n    const { dateString, timeString } = this.state;\n    const dateValue = hide ? \"\" : dateString;\n    const timeValue = hide ? \"\" : timeString;\n\n    return <div className=\"date-range-input\">\n      <div className=\"label\">{label}</div>\n      <input placeholder=\"YYYY-MM-DD\" className=\"date-field\" value={dateValue} onChange={this.dateChange} />\n      <input placeholder=\"HH:MM\" className=\"time-field\" value={timeValue} onChange={this.timeChange} />\n    </div>;\n  }\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { day, Timezone } from \"chronoshift\";\nimport { Locale } from \"../../../common/models/locale/locale\";\nimport { range } from \"../../../common/utils/functional/functional\";\nimport { getMoment } from \"../../../common/utils/time/time\";\n\nexport function calendarDays(startDay: Date, timezone: Timezone, locale: Locale): Date[][] {\n  const monthWeeks = monthToWeeks(startDay, timezone, locale);\n  const firstWeek = monthWeeks[0];\n  const lastWeek = monthWeeks[monthWeeks.length - 1];\n  const middleWeeks = monthWeeks.slice(1, -1);\n  return [\n    padFirstWeek(firstWeek, timezone),\n    ...middleWeeks,\n    padLastWeek(lastWeek, timezone)\n  ];\n}\n\nfunction padLastWeek(lastWeek: Date[], timezone: Timezone): Date[] {\n  const lastDate = lastWeek[lastWeek.length - 1];\n  const padCount = 7 - lastWeek.length;\n  return [...lastWeek, ...nextNDates(lastDate, padCount, timezone)];\n}\n\nfunction padFirstWeek(firstWeek: Date[], timezone: Timezone): Date[] {\n  const firstDate = firstWeek[0];\n  const padCount = 7 - firstWeek.length;\n  return [...previousNDates(firstDate, padCount, timezone), ...firstWeek];\n}\n\nexport function monthToWeeks(startDay: Date, timezone: Timezone, locale: Locale): Date[][] {\n  const weeks: Date[][] = [];\n  const firstDayOfMonth = getMoment(startDay, timezone);\n  const firstDayOfNextMonth = firstDayOfMonth.clone().add(1, \"month\");\n\n  let week: Date[] = [];\n  let currentPointer = firstDayOfMonth.clone().startOf(\"day\");\n  while (currentPointer.isBefore(firstDayOfNextMonth)) {\n    if ((currentPointer.day() === locale.weekStart || 0) && week.length > 0) {\n      weeks.push(week);\n      week = [];\n    }\n\n    week.push(currentPointer.toDate());\n    currentPointer = currentPointer.add(1, \"day\");\n  }\n  // push last week\n  if (week.length > 0) weeks.push(week);\n  return weeks;\n}\n\nexport function previousNDates(start: Date, n: number, timezone: Timezone): Date[] {\n  return range(0, n)\n    .map(i => day.shift(start, timezone, -n + i));\n}\n\nexport function nextNDates(start: Date, n: number, timezone: Timezone): Date[] {\n  return range(0, n)\n    .map(i => day.shift(start, timezone, i + 1));\n}\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { day, month, Timezone } from \"chronoshift\";\nimport { TimeRange } from \"plywood\";\nimport React from \"react\";\nimport { Locale } from \"../../../common/models/locale/locale\";\nimport { cyclicShift } from \"../../../common/utils/functional/functional\";\nimport { datesEqual, formatYearMonth, getDayInMonth } from \"../../../common/utils/time/time\";\nimport { classNames } from \"../../utils/dom/dom\";\nimport { DateRangeInput } from \"../date-range-input/date-range-input\";\nimport { SvgIcon } from \"../svg-icon/svg-icon\";\nimport { calendarDays } from \"./calendar\";\nimport \"./date-range-picker.scss\";\n\nexport interface DateRangePickerProps {\n  startTime?: Date;\n  endTime?: Date;\n  maxTime?: Date;\n  timezone: Timezone;\n  onStartChange: (t: Date) => void;\n  onEndChange: (t: Date) => void;\n  locale: Locale;\n}\n\nexport interface DateRangePickerState {\n  activeMonthStartDate?: Date;\n  hoverTimeRange?: TimeRange;\n  selectionSet?: boolean;\n}\n\nexport class DateRangePicker extends React.Component<DateRangePickerProps, DateRangePickerState> {\n\n  state: DateRangePickerState = {\n    activeMonthStartDate: month.floor(this.props.startTime || new Date(), this.props.timezone),\n    hoverTimeRange: null,\n    selectionSet: true\n  };\n\n  navigateToMonth(offset: number): void {\n    const { timezone } = this.props;\n    const { activeMonthStartDate } = this.state;\n    const newDate = month.shift(activeMonthStartDate, timezone, offset);\n    this.setState({\n      activeMonthStartDate: newDate\n    });\n  }\n\n  goToPreviousMonth = () => this.navigateToMonth(-1);\n\n  goToNextMonth = () => this.navigateToMonth(1);\n\n  calculateHoverTimeRange(mouseEnteredDay: Date) {\n    const { startTime, endTime } = this.props;\n    let hoverTimeRange: TimeRange = null;\n    if (startTime && !endTime) {\n      let start = startTime;\n      let end = mouseEnteredDay;\n      // if mousing over backwards, set end to old start time\n      if (mouseEnteredDay < startTime) {\n        start = mouseEnteredDay;\n        end = startTime;\n      }\n      hoverTimeRange = new TimeRange({ start, end, bounds: \"[]\" });\n    }\n\n    this.setState({ hoverTimeRange });\n  }\n\n  onCalendarMouseLeave = () => {\n    this.setState({ hoverTimeRange: null });\n  };\n\n  selectNewRange(startDate: Date, endDate?: Date) {\n    const { onStartChange, onEndChange, timezone } = this.props;\n    onStartChange(startDate);\n    // real end points are exclusive so +1 full day to selection (which is floored) to get the real end point\n    if (endDate) endDate = day.shift(endDate, timezone, 1);\n    onEndChange(endDate);\n  }\n\n  selectDay(selection: Date): void {\n    const { startTime } = this.props;\n    const { selectionSet } = this.state;\n\n    if (selectionSet) {\n      this.setState({ hoverTimeRange: null, selectionSet: false });\n      this.selectNewRange(selection, null);\n    } else {\n      const isDoubleClickSameDay = datesEqual(selection, startTime);\n      const isBackwardSelection = selection < startTime;\n\n      if (isDoubleClickSameDay) {\n        this.selectNewRange(startTime, startTime);\n      } else if (isBackwardSelection) {\n        this.selectNewRange(selection, startTime);\n      } else {\n        this.selectNewRange(startTime, selection);\n      }\n      this.setState({ selectionSet: true });\n    }\n  }\n\n  getIsSelectable(date: Date): boolean {\n    const { hoverTimeRange, selectionSet } = this.state;\n    const inHoverTimeRange = hoverTimeRange && hoverTimeRange.contains(date);\n    return inHoverTimeRange && !selectionSet;\n  }\n\n  renderDays(weeks: Date[][], monthStart: Date): JSX.Element[] {\n    const { startTime, endTime, maxTime, timezone } = this.props;\n    const startDay = day.floor(startTime, timezone);\n    const dayBeforeEnd = endTime && day.shift(endTime, timezone, -1);\n    const nextMonthStart = month.shift(monthStart, timezone, 1);\n\n    return weeks.map((daysInWeek: Date[], row: number) => {\n      return <div className=\"week\" key={row}> {daysInWeek.map((dayDate: Date, column: number) => {\n        const isPast = dayDate < monthStart;\n        const isFuture = dayDate >= nextMonthStart;\n        const isBeyondMaxRange = dayDate > maxTime;\n        const isSelected = startDay <= dayDate && dayDate < endTime;\n        const isSelectedEdgeStart = datesEqual(dayDate, startTime);\n        const isSelectedEdgeEnd = datesEqual(dayDate, dayBeforeEnd);\n        const className = classNames(\"day\", \"value\",\n          {\n            \"past\": isPast,\n            \"future\": isFuture,\n            \"beyond-max-range\": isBeyondMaxRange,\n            \"selectable\": this.getIsSelectable(dayDate),\n            \"selected\": isSelected,\n            \"selected-edge\": isSelectedEdgeStart || isSelectedEdgeEnd\n          });\n\n        return <div\n          className={className}\n          key={column}\n          onClick={this.selectDay.bind(this, dayDate)}\n          onMouseEnter={this.calculateHoverTimeRange.bind(this, dayDate)}\n        >{getDayInMonth(dayDate, timezone)}</div>;\n      })}</div>;\n    });\n  }\n\n  renderCalendar(startDate: Date): JSX.Element[] {\n    const { timezone, locale } = this.props;\n    const weeks: Date[][] = calendarDays(startDate, timezone, locale);\n    return this.renderDays(weeks, startDate);\n  }\n\n  renderCalendarNav(startDate: Date): JSX.Element {\n    const { timezone } = this.props;\n\n    return <div className=\"calendar-nav\">\n      <div\n        className=\"caret left\"\n        onClick={this.goToPreviousMonth}\n      >\n        <SvgIcon svg={require(\"../../icons/full-caret-left.svg\")} />\n      </div>\n      {formatYearMonth(startDate, timezone)}\n      <div\n        className=\"caret right\"\n        onClick={this.goToNextMonth}\n      >\n        <SvgIcon svg={require(\"../../icons/full-caret-right.svg\")} />\n      </div>\n    </div>;\n  }\n\n  render() {\n    const { locale, startTime, endTime, timezone, onStartChange, onEndChange } = this.props;\n    const { activeMonthStartDate, selectionSet } = this.state;\n    if (!activeMonthStartDate) return null;\n\n    const days = cyclicShift(locale.shortDays, locale.weekStart);\n    return <div className=\"date-range-picker\">\n      <div>\n        <DateRangeInput label=\"Start\" type=\"start\" time={startTime} timezone={timezone} onChange={onStartChange} />\n        <DateRangeInput label=\"End\" type=\"end\" time={endTime} timezone={timezone} onChange={onEndChange} hide={!selectionSet} />\n      </div>\n      <div\n        className=\"calendar\"\n        onMouseLeave={this.onCalendarMouseLeave}\n      >\n        {this.renderCalendarNav(activeMonthStartDate)}\n        <div className=\"week\">\n          {days.map((day, i) => {\n            return <div className=\"day label\" key={day + i}><span className=\"space\" />{day}</div>;\n          })\n          }\n        </div>\n        {this.renderCalendar(activeMonthStartDate)}\n      </div>\n    </div>;\n  }\n}\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Duration, Timezone } from \"chronoshift\";\nimport React from \"react\";\nimport { DateRange } from \"../../../../common/models/date-range/date-range\";\nimport { TimeDimension } from \"../../../../common/models/dimension/dimension\";\nimport { isValidTimeShift } from \"../../../../common/models/time-shift/time-shift\";\nimport { Unary } from \"../../../../common/utils/functional/functional\";\nimport { formatTimeRange } from \"../../../../common/utils/time/time\";\nimport { STRINGS } from \"../../../config/constants\";\nimport { Preset } from \"../../input-with-presets/input-with-presets\";\nimport { StringInputWithPresets } from \"../../input-with-presets/string-input-with-presets\";\nimport { normalizeDurationName } from \"./presets\";\n\nfunction safeDurationFromJS(duration: string): Duration | null {\n  try {\n    return Duration.fromJS(duration);\n  } catch {\n    return null;\n  }\n}\n\nfunction timeShiftPreviewForRange({\n                                    shift,\n                                    time,\n                                    timezone\n                                  }: Pick<TimeShiftSelectorProps, \"shift\" | \"time\" | \"timezone\">): string {\n  if (time === null || !time.start || !time.end) return null;\n  const duration: Duration = safeDurationFromJS(shift);\n  if (duration === null) return null;\n  const shiftedTimeRange = time.shift(duration, timezone);\n  return formatTimeRange(shiftedTimeRange, timezone);\n}\n\nexport interface TimeShiftSelectorProps {\n  shift: string;\n  dimension: TimeDimension;\n  time: DateRange;\n  timezone: Timezone;\n  onShiftChange: Unary<string, void>;\n}\n\nfunction presets(dimension: TimeDimension): Array<Preset<string>> {\n  return [\n    { name: \"Off\", identity: null },\n    ...dimension.timeShiftDurations.map(shift => ({\n      name: normalizeDurationName(shift.toJS()),\n      identity: shift.toJS()\n    }))\n  ];\n}\n\nexport const TimeShiftSelector: React.FunctionComponent<TimeShiftSelectorProps> = props => {\n  const { onShiftChange, dimension, shift: selectedTimeShift } = props;\n  const timeShiftPreview = timeShiftPreviewForRange(props);\n\n  return <React.Fragment>\n    <StringInputWithPresets\n      title={STRINGS.timeShift}\n      presets={presets(dimension)}\n      selected={selectedTimeShift}\n      onChange={onShiftChange}\n      errorMessage={isValidTimeShift(selectedTimeShift) ? null : STRINGS.invalidDurationFormat}\n      placeholder={STRINGS.timeShiftExamples}/>\n    {timeShiftPreview ? <div className=\"preview\">{timeShiftPreview}</div> : null}\n  </React.Fragment>;\n};\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { day } from \"chronoshift\";\nimport { List } from \"immutable\";\nimport React from \"react\";\nimport { Clicker } from \"../../../../common/models/clicker/clicker\";\nimport { getMaxTime } from \"../../../../common/models/data-cube/data-cube\";\nimport { DateRange } from \"../../../../common/models/date-range/date-range\";\nimport { TimeDimension } from \"../../../../common/models/dimension/dimension\";\nimport { Essence } from \"../../../../common/models/essence/essence\";\nimport { FilterClause, FixedTimeFilterClause } from \"../../../../common/models/filter-clause/filter-clause\";\nimport { Locale } from \"../../../../common/models/locale/locale\";\nimport { isValidTimeShift, TimeShift } from \"../../../../common/models/time-shift/time-shift\";\nimport { Timekeeper } from \"../../../../common/models/timekeeper/timekeeper\";\nimport { Unary } from \"../../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../../common/utils/general/general\";\nimport { STRINGS } from \"../../../config/constants\";\nimport { Button } from \"../../button/button\";\nimport { DateRangePicker } from \"../../date-range-picker/date-range-picker\";\nimport { TimeShiftSelector } from \"./time-shift-selector\";\n\nexport interface FixedTimeTabProps {\n  essence: Essence;\n  timekeeper: Timekeeper;\n  locale: Locale;\n  dimension: TimeDimension;\n  onClose: Fn;\n  clicker: Clicker;\n  saveClause: Unary<FilterClause, void>;\n}\n\nexport interface FixedTimeTabState {\n  start: Date;\n  end: Date;\n  shift: string;\n}\n\nexport class FixedTimeTab extends React.Component<FixedTimeTabProps, FixedTimeTabState> {\n\n  initialState = (): FixedTimeTabState => {\n    const { essence, timekeeper, dimension: { name } } = this.props;\n    const shift = essence.timeShift.toJS();\n\n    const timeFilter = essence.getEffectiveFilter(timekeeper).clauseForReference(name);\n    if (timeFilter && timeFilter instanceof FixedTimeFilterClause && !timeFilter.values.isEmpty()) {\n      const { start, end } = timeFilter.values.get(0);\n      return { start, end, shift };\n    }\n    return { start: null, end: null, shift };\n  };\n\n  onStartChange = (start: Date) => this.setState({ start });\n\n  onEndChange = (end: Date) => this.setState({ end });\n\n  setTimeShift = (shift: string) => this.setState({ shift });\n\n  state: FixedTimeTabState = this.initialState();\n\n  createDateRange(): DateRange | null {\n    const { start, end: maybeEnd } = this.state;\n    if (!start) return null;\n    const timezone = this.props.essence.timezone;\n    const end = maybeEnd || day.shift(start, timezone, 1);\n    if (start >= end) return null;\n    return new DateRange({ start, end });\n  }\n\n  constructFixedClause(): FixedTimeFilterClause {\n    const { dimension: { name: reference } } = this.props;\n\n    const values = List.of(this.createDateRange());\n    return new FixedTimeFilterClause({ reference, values });\n  }\n\n  constructTimeShift(): TimeShift {\n    return TimeShift.fromJS(this.state.shift);\n  }\n\n  doesTimeShiftOverlap(): boolean {\n    const shift = this.constructTimeShift();\n    if (shift.isEmpty()) return false;\n    const { essence: { timezone } } = this.props;\n    const currentRange = this.createDateRange();\n    const duration = shift.valueOf();\n    const previousRange = currentRange.shift(duration, timezone);\n    return currentRange.intersects(previousRange);\n  }\n\n  validateOverlap(): string | null {\n    const periodsOverlap = this.isTimeShiftValid() && this.areDatesValid() && this.doesTimeShiftOverlap();\n    return periodsOverlap ? STRINGS.overlappingPeriods : null;\n  }\n\n  isTimeShiftValid(): boolean {\n    return isValidTimeShift(this.state.shift);\n  }\n\n  areDatesValid(): boolean {\n    return this.createDateRange() !== null;\n  }\n\n  isFormValid(): boolean {\n    return this.areDatesValid() && this.isTimeShiftValid() && !this.doesTimeShiftOverlap();\n  }\n\n  isFilterDifferent(): boolean {\n    const { essence: { filter, timeShift }, dimension } = this.props;\n    const newTimeShift = this.constructTimeShift();\n    const oldClause = filter.getClauseForDimension(dimension);\n    const newClause = this.constructFixedClause();\n    return !oldClause.equals(newClause) || !timeShift.equals(newTimeShift);\n  }\n\n  validate(): boolean {\n    return this.isFormValid() && this.isFilterDifferent();\n  }\n\n  onOkClick = () => {\n    if (!this.validate()) return;\n    const { saveClause, clicker, onClose } = this.props;\n    saveClause(this.constructFixedClause());\n    clicker.changeComparisonShift(this.constructTimeShift());\n    onClose();\n  };\n\n  render() {\n    const { locale, essence: { timezone, dataCube }, timekeeper, dimension, onClose } = this.props;\n    if (!dimension) return null;\n    const { shift, start, end } = this.state;\n    const overlapError = this.validateOverlap();\n\n    return <div>\n      <DateRangePicker\n        locale={locale}\n        startTime={start}\n        endTime={end}\n        maxTime={getMaxTime(dataCube, timekeeper)}\n        timezone={timezone}\n        onStartChange={this.onStartChange}\n        onEndChange={this.onEndChange}\n      />\n      <div className=\"cont\">\n        <TimeShiftSelector\n          dimension={dimension}\n          shift={shift}\n          time={this.createDateRange()}\n          onShiftChange={this.setTimeShift}\n          timezone={timezone} />\n        {overlapError && <div className=\"overlap-error-message\">{overlapError}</div>}\n      </div>\n      <div className=\"ok-cancel-bar\">\n        <Button type=\"primary\" onClick={this.onOkClick} disabled={!this.validate()} title={STRINGS.ok} />\n        <Button type=\"secondary\" onClick={onClose} title={STRINGS.cancel} />\n      </div>\n    </div>;\n  }\n}\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Duration } from \"chronoshift\";\nimport React from \"react\";\nimport { Clicker } from \"../../../../common/models/clicker/clicker\";\nimport { isTimeAttribute } from \"../../../../common/models/data-cube/data-cube\";\nimport { TimeDimension } from \"../../../../common/models/dimension/dimension\";\nimport { Essence } from \"../../../../common/models/essence/essence\";\nimport {\n  FilterClause,\n  RelativeTimeFilterClause,\n  TimeFilterPeriod\n} from \"../../../../common/models/filter-clause/filter-clause\";\nimport { isValidTimeShift, TimeShift } from \"../../../../common/models/time-shift/time-shift\";\nimport { Timekeeper } from \"../../../../common/models/timekeeper/timekeeper\";\nimport { Unary } from \"../../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../../common/utils/general/general\";\nimport { isValidDuration } from \"../../../../common/utils/plywood/duration\";\nimport { formatTimeRange } from \"../../../../common/utils/time/time\";\nimport { STRINGS } from \"../../../config/constants\";\nimport { ButtonGroup } from \"../../button-group/button-group\";\nimport { Button } from \"../../button/button\";\nimport { Preset } from \"../../input-with-presets/input-with-presets\";\nimport { StringInputWithPresets } from \"../../input-with-presets/string-input-with-presets\";\nimport { getTimeFilterPresets, normalizeDurationName } from \"./presets\";\nimport { TimeShiftSelector } from \"./time-shift-selector\";\n\nexport interface PresetTimeTabProps {\n  essence: Essence;\n  timekeeper: Timekeeper;\n  dimension: TimeDimension;\n  clicker: Clicker;\n  saveClause: Unary<FilterClause, void>;\n  onClose: Fn;\n}\n\nexport interface PresetTimeTabState {\n  filterPeriod: TimeFilterPeriod;\n  filterDuration: string;\n  timeShift: string;\n}\n\nfunction initialState(essence: Essence, dimension: TimeDimension): PresetTimeTabState {\n  const filterClause = essence.filter.getClauseForDimension(dimension);\n  const timeShift = essence.timeShift.toJS();\n  if (filterClause instanceof RelativeTimeFilterClause) {\n    const { duration, period } = filterClause;\n    return { timeShift, filterDuration: duration.toJS(), filterPeriod: period };\n  }\n  return {\n    filterPeriod: null,\n    filterDuration: null,\n    timeShift\n  };\n}\n\nexport class PresetTimeTab extends React.Component<PresetTimeTabProps, PresetTimeTabState> {\n\n  setFilter = (filterPeriod: TimeFilterPeriod, filterDuration: string) => this.setState({ filterDuration, filterPeriod });\n\n  setTimeShift = (timeShift: string) => this.setState({ timeShift });\n\n  state: PresetTimeTabState = initialState(this.props.essence, this.props.dimension);\n\n  saveTimeFilter = () => {\n    if (!this.validate()) return;\n    const { clicker, saveClause, onClose } = this.props;\n    saveClause(this.constructRelativeClause());\n    clicker.changeComparisonShift(this.constructTimeShift());\n    onClose();\n  };\n\n  constructTimeShift(): TimeShift {\n    return TimeShift.fromJS(this.state.timeShift);\n  }\n\n  constructRelativeClause(): RelativeTimeFilterClause | null {\n    const { dimension: { name: reference } } = this.props;\n    const { filterPeriod: period, filterDuration } = this.state;\n    if (!isValidDuration(filterDuration)) return null;\n    const duration = Duration.fromJS(filterDuration);\n    return new RelativeTimeFilterClause({ period, duration, reference });\n  }\n\n  doesTimeShiftOverlap(): boolean {\n    const timeShift = this.constructTimeShift();\n    if (timeShift.isEmpty()) return false;\n    const timeShiftDuration = timeShift.valueOf();\n    const filterDuration = Duration.fromJS(this.state.filterDuration);\n    return filterDuration.getCanonicalLength() > timeShiftDuration.getCanonicalLength();\n  }\n\n  isTimeShiftValid(): boolean {\n    return isValidTimeShift(this.state.timeShift);\n  }\n\n  isDurationValid(): boolean {\n    return isValidDuration(this.state.filterDuration);\n  }\n\n  validateOverlap(): string | null {\n    const periodOverlaps = this.isTimeShiftValid() && this.isDurationValid() && this.doesTimeShiftOverlap();\n    return periodOverlaps ? STRINGS.overlappingPeriods : null;\n  }\n\n  isFormValid(): boolean {\n    const { filterPeriod } = this.state;\n    return filterPeriod && this.isDurationValid() && this.isTimeShiftValid() && !this.doesTimeShiftOverlap();\n  }\n\n  isFilterDifferent(): boolean {\n    const { essence: { filter, timeShift }, dimension } = this.props;\n    const newTimeShift = this.constructTimeShift();\n    const oldClause = filter.getClauseForDimension(dimension);\n    const newClause = this.constructRelativeClause();\n    return !oldClause.equals(newClause) || !timeShift.equals(newTimeShift);\n  }\n\n  validate(): boolean {\n    return this.isFormValid() && this.isFilterDifferent();\n  }\n\n  private renderLatestPresets() {\n    const { dimension } = this.props;\n    const { filterDuration, filterPeriod } = this.state;\n    const presets: Array<Preset<string>> = dimension.latestPeriodDurations.map(duration => {\n      return {\n        name: normalizeDurationName(duration.toJS()),\n        identity: duration.toJS()\n      };\n    });\n\n    const latestPeriod = filterPeriod === TimeFilterPeriod.LATEST;\n    return <StringInputWithPresets\n      title={STRINGS.latest}\n      presets={presets}\n      errorMessage={latestPeriod && !isValidDuration(filterDuration) && STRINGS.invalidDurationFormat}\n      selected={latestPeriod ? filterDuration : undefined}\n      onChange={(duration: string) => this.setFilter(TimeFilterPeriod.LATEST, duration)}\n      placeholder={STRINGS.durationsExamples} />;\n  }\n\n  private renderButtonGroup(title: string, period: TimeFilterPeriod.CURRENT | TimeFilterPeriod.PREVIOUS) {\n    const { filterDuration, filterPeriod } = this.state;\n    const activePeriod = period === filterPeriod;\n    const presets = getTimeFilterPresets(period);\n    const groupMembers = presets.map(({ duration, name }) => {\n      return {\n        title: name,\n        key: name,\n        isSelected: activePeriod && filterDuration === duration,\n        onClick: () => this.setFilter(period, duration)\n      };\n    });\n    return <ButtonGroup title={title} groupMembers={groupMembers} />;\n  }\n\n  private getFilterRange() {\n    const filter = this.constructRelativeClause();\n    if (!filter) return null;\n    const { essence, timekeeper } = this.props;\n    const fixedFilter = essence.evaluateSelection(filter, timekeeper);\n    return fixedFilter.values.get(0);\n  }\n\n  render() {\n    const { essence, dimension } = this.props;\n    if (!dimension) return null;\n\n    const { timeShift } = this.state;\n\n    const { timezone } = essence;\n\n    const previewFilter = this.getFilterRange();\n    const previewText = previewFilter ? formatTimeRange(previewFilter, timezone) : STRINGS.noFilter;\n    const overlapError = this.validateOverlap();\n\n    return <div className=\"cont\">\n      {isTimeAttribute(essence.dataCube, dimension.expression) && this.renderLatestPresets()}\n      {this.renderButtonGroup(STRINGS.current, TimeFilterPeriod.CURRENT)}\n      {this.renderButtonGroup(STRINGS.previous, TimeFilterPeriod.PREVIOUS)}\n      <div className=\"preview preview--with-spacing\">{previewText}</div>\n      <TimeShiftSelector\n        dimension={dimension}\n        shift={timeShift}\n        time={previewFilter}\n        timezone={essence.timezone}\n        onShiftChange={this.setTimeShift} />\n      {overlapError && <div className=\"overlap-error-message\">{overlapError}</div>}\n      <div className=\"ok-cancel-bar\">\n        <Button type=\"primary\" onClick={this.saveTimeFilter} disabled={!this.validate()} title={STRINGS.ok} />\n        <Button type=\"secondary\" onClick={this.props.onClose} title={STRINGS.cancel} />\n      </div>\n    </div>;\n  }\n}\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Clicker } from \"../../../../common/models/clicker/clicker\";\nimport { TimeDimension } from \"../../../../common/models/dimension/dimension\";\nimport { Essence } from \"../../../../common/models/essence/essence\";\nimport { FilterClause, RelativeTimeFilterClause } from \"../../../../common/models/filter-clause/filter-clause\";\nimport { Locale } from \"../../../../common/models/locale/locale\";\nimport { Stage } from \"../../../../common/models/stage/stage\";\nimport { Timekeeper } from \"../../../../common/models/timekeeper/timekeeper\";\nimport { Unary } from \"../../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../../common/utils/general/general\";\nimport { STRINGS } from \"../../../config/constants\";\nimport { BubbleMenu } from \"../../bubble-menu/bubble-menu\";\nimport { ButtonGroup } from \"../../button-group/button-group\";\nimport { FixedTimeTab } from \"./fixed-time-tab\";\nimport { PresetTimeTab } from \"./preset-time-tab\";\nimport \"./time-filter-menu.scss\";\n\nconst MENU_WIDTH = 250;\n\ninterface TabSelectorProps {\n  selectedTab: TimeFilterTab;\n  onTabSelect: Unary<TimeFilterTab, void>;\n}\n\nfunction tabTitle(tab: TimeFilterTab) {\n  return tab === TimeFilterTab.RELATIVE ? STRINGS.relative : STRINGS.fixed;\n}\n\nconst TabSelector: React.FunctionComponent<TabSelectorProps> = props => {\n  const { selectedTab, onTabSelect } = props;\n  const tabs = [TimeFilterTab.RELATIVE, TimeFilterTab.FIXED].map(tab => {\n    return {\n      isSelected: selectedTab === tab,\n      title: tabTitle(tab),\n      key: tab,\n      onClick: () => onTabSelect(tab)\n    };\n  });\n  return <ButtonGroup groupMembers={tabs} />;\n};\n\nexport interface TimeFilterMenuProps {\n  clicker: Clicker;\n  saveClause: Unary<FilterClause, void>;\n  timekeeper: Timekeeper;\n  essence: Essence;\n  locale: Locale;\n  dimension: TimeDimension;\n  onClose: Fn;\n  containerStage?: Stage;\n  openOn: Element;\n}\n\nenum TimeFilterTab { RELATIVE = \"relative\", FIXED = \"fixed\"}\n\nexport interface TimeFilterMenuState {\n  tab: TimeFilterTab;\n}\n\nfunction initialTab(essence: Essence): TimeFilterTab {\n  const isRelativeTimeFilter = essence.timeFilter() instanceof RelativeTimeFilterClause;\n  return isRelativeTimeFilter ? TimeFilterTab.RELATIVE : TimeFilterTab.FIXED;\n}\n\nexport class TimeFilterMenu extends React.Component<TimeFilterMenuProps, TimeFilterMenuState> {\n\n  state: TimeFilterMenuState = { tab: initialTab(this.props.essence) };\n\n  selectTab = (tab: TimeFilterTab) => this.setState({ tab });\n\n  render() {\n    const { essence, saveClause, timekeeper, clicker, dimension, onClose, containerStage, locale, openOn } = this.props;\n    if (!dimension) return null;\n    const { tab } = this.state;\n    const menuSize = Stage.fromSize(MENU_WIDTH, 410);\n    const isRelativeTab = tab === TimeFilterTab.RELATIVE;\n    const tabProps = { saveClause, essence, dimension, timekeeper, onClose, clicker, locale };\n\n    return <BubbleMenu\n      className=\"time-filter-menu\"\n      direction=\"down\"\n      containerStage={containerStage}\n      stage={menuSize}\n      openOn={openOn}\n      onClose={onClose}\n    >\n      <TabSelector selectedTab={tab} onTabSelect={this.selectTab} />\n      {isRelativeTab ? <PresetTimeTab {...tabProps} /> : <FixedTimeTab {...tabProps} />}\n    </BubbleMenu>;\n  }\n}\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Clicker } from \"../../../common/models/clicker/clicker\";\nimport { Dimension } from \"../../../common/models/dimension/dimension\";\nimport { Essence } from \"../../../common/models/essence/essence\";\nimport { FilterClause } from \"../../../common/models/filter-clause/filter-clause\";\nimport { Locale } from \"../../../common/models/locale/locale\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Timekeeper } from \"../../../common/models/timekeeper/timekeeper\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { BooleanFilterMenu } from \"./boolean-filter-menu/boolean-filter-menu\";\nimport \"./filter-menu.scss\";\nimport { NumberFilterMenu } from \"./number-filter-menu/number-filter-menu\";\nimport { StringFilterMenu } from \"./string-filter-menu/string-filter-menu\";\nimport { TimeFilterMenu } from \"./time-filter-menu/time-filter-menu\";\n\nexport interface FilterMenuProps {\n  essence: Essence;\n  timekeeper: Timekeeper;\n  locale: Locale;\n  clicker: Clicker;\n  saveClause: Unary<FilterClause, void>;\n  containerStage?: Stage;\n  openOn: Element;\n  dimension: Dimension;\n  onClose: Fn;\n}\n\nexport const FilterMenu: React.FunctionComponent<FilterMenuProps> = ({ dimension, ...props }: FilterMenuProps) => {\n  if (!dimension) return null;\n  switch (dimension.kind) {\n    case \"time\":\n      return <TimeFilterMenu dimension={dimension} {...props} />;\n    case \"boolean\":\n      return <BooleanFilterMenu dimension={dimension}{...props} />;\n    case \"number\":\n      return <NumberFilterMenu dimension={dimension} {...props} />;\n    default:\n      return <StringFilterMenu dimension={dimension}{...props} />;\n  }\n};\n","/*\n * Copyright 2017-2021 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Clicker } from \"../../../common/models/clicker/clicker\";\nimport { Dimension } from \"../../../common/models/dimension/dimension\";\nimport { Essence } from \"../../../common/models/essence/essence\";\nimport { FilterClause, isTimeFilter } from \"../../../common/models/filter-clause/filter-clause\";\nimport { Locale } from \"../../../common/models/locale/locale\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Timekeeper } from \"../../../common/models/timekeeper/timekeeper\";\nimport { getFormattedClause } from \"../../../common/utils/formatter/formatter\";\nimport { Ternary, Unary } from \"../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { classNames } from \"../../utils/dom/dom\";\nimport { FilterMenu } from \"../filter-menu/filter-menu\";\nimport { SvgIcon } from \"../svg-icon/svg-icon\";\nimport { WithRef } from \"../with-ref/with-ref\";\nimport { FilterClauseLabel } from \"./filter-clause-label\";\nimport timeShiftLabel from \"./time-shift-label\";\n\nfunction tileTitle(dimension: Dimension, clause: FilterClause, essence: Essence): string {\n  const { title, values } = getFormattedClause(dimension, clause, essence.timezone);\n  const timeShift = timeShiftLabel(dimension, essence);\n\n  return `${title} ${values} ${timeShift || \"\"}`;\n}\n\ninterface FilterTileProps {\n  clause: FilterClause;\n  open: boolean;\n  dimension: Dimension;\n  style?: React.CSSProperties;\n  removeClause?: Unary<FilterClause, void>;\n  saveClause: Unary<FilterClause, void>;\n  openFilterMenu: Unary<FilterClause, void>;\n  closeFilterMenu: Fn;\n  dragStart: Ternary<Dimension, FilterClause, React.DragEvent<HTMLElement>, void>;\n  stage: Stage;\n  essence: Essence;\n  timekeeper: Timekeeper;\n  locale: Locale;\n  clicker: Clicker;\n}\n\nexport const FILTER_CLASS_NAME = \"filter\";\n\nexport const FilterTile: React.FunctionComponent<FilterTileProps> = props => {\n  const {\n    clause,\n    open,\n    dimension,\n    style,\n    removeClause,\n    saveClause,\n    openFilterMenu,\n    closeFilterMenu,\n    dragStart,\n    stage,\n    essence,\n    locale,\n    timekeeper,\n    clicker\n  } = props;\n\n  const excluded = clause && !isTimeFilter(clause) && clause.not;\n  return <WithRef>\n    {({ ref: openOn, setRef }) => <React.Fragment>\n      <div\n        className={classNames(\"tile dimension\", {\n          selected: open,\n          excluded,\n          included: !excluded\n        })}\n        draggable={true}\n        ref={setRef}\n        onClick={() => openFilterMenu(clause)}\n        onDragStart={e => dragStart(dimension, clause, e)}\n        style={style}\n        title={tileTitle(dimension, clause, essence)}\n      >\n        <FilterClauseLabel dimension={dimension} clause={clause} essence={essence} />\n        {removeClause && <div className=\"remove\" onClick={() => removeClause(clause)}>\n          <SvgIcon svg={require(\"../../icons/x.svg\")} />\n        </div>}\n      </div>\n      {open && openOn && <FilterMenu\n        containerStage={stage}\n        essence={essence}\n        timekeeper={timekeeper}\n        locale={locale}\n        clicker={clicker}\n        saveClause={saveClause}\n        openOn={openOn}\n        dimension={dimension}\n        onClose={closeFilterMenu} />}\n    </React.Fragment>}\n  </WithRef>;\n};\n","/*\n * Copyright 2017-2021 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Clicker } from \"../../../common/models/clicker/clicker\";\nimport { Dimension } from \"../../../common/models/dimension/dimension\";\nimport { Essence } from \"../../../common/models/essence/essence\";\nimport { FilterClause } from \"../../../common/models/filter-clause/filter-clause\";\nimport { Locale } from \"../../../common/models/locale/locale\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Timekeeper } from \"../../../common/models/timekeeper/timekeeper\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { FilterMenu } from \"../filter-menu/filter-menu\";\nimport { WithRef } from \"../with-ref/with-ref\";\n\ninterface PartialFilterTileProps {\n  dimension: Dimension;\n  style?: React.CSSProperties;\n  essence: Essence;\n  timekeeper: Timekeeper;\n  locale: Locale;\n  clicker: Clicker;\n  saveClause: Unary<FilterClause, void>;\n  stage: Stage;\n  closeItem: Fn;\n}\n\nexport const PartialFilterTile: React.FunctionComponent<PartialFilterTileProps> = props => {\n  const { closeItem, saveClause, essence, timekeeper, locale, clicker, stage, dimension, style } = props;\n  return <WithRef>\n    {({ ref: openOn, setRef }) => <div\n      className={\"tile dimension selected included\"}\n      ref={setRef}\n      style={style}>\n      <div className=\"reading\">{dimension.title}</div>\n      {openOn && <FilterMenu\n        essence={essence}\n        timekeeper={timekeeper}\n        locale={locale}\n        clicker={clicker}\n        saveClause={saveClause}\n        openOn={openOn}\n        dimension={dimension}\n        containerStage={stage}\n        onClose={closeItem} />}\n        </div>}\n  </WithRef>;\n};\n","/*\n * Copyright 2017-2021 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { ReactElement } from \"react\";\nimport { Clicker } from \"../../../common/models/clicker/clicker\";\nimport { Dimension } from \"../../../common/models/dimension/dimension\";\nimport { findDimensionByName } from \"../../../common/models/dimension/dimensions\";\nimport { DragPosition } from \"../../../common/models/drag-position/drag-position\";\nimport { Essence } from \"../../../common/models/essence/essence\";\nimport { FilterClause } from \"../../../common/models/filter-clause/filter-clause\";\nimport { Locale } from \"../../../common/models/locale/locale\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Timekeeper } from \"../../../common/models/timekeeper/timekeeper\";\nimport { insert } from \"../../../common/utils/array/array\";\nimport { Ternary, Unary } from \"../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { transformStyle } from \"../../utils/dom/dom\";\nimport { SECTION_WIDTH } from \"../../utils/pill-tile/pill-tile\";\nimport { PartialFilter } from \"../../views/cube-view/partial-tiles-provider\";\nimport { TileOverflowContainer } from \"../tile-overflow-container/tile-overflow-container\";\nimport { FilterTile } from \"./filter-tile\";\nimport { PartialFilterTile } from \"./partial-filter-tile\";\n\ninterface FilterTilesProps {\n  menuStage: Stage;\n  maxItems: number;\n  essence: Essence;\n  clicker: Clicker;\n  timekeeper: Timekeeper;\n  locale: Locale;\n  removeFilter: Unary<FilterClause, void>;\n  openedFilterMenu?: FilterClause;\n  openFilterMenu: Unary<FilterClause, void>;\n  closeFilterMenu: Fn;\n  dragStart: Ternary<Dimension, FilterClause, React.DragEvent<HTMLElement>, void>;\n  partialFilter?: PartialFilter;\n  removePartialFilter: Fn;\n  overflowOpen: boolean;\n  closeOverflowMenu: Fn;\n  openOverflowMenu: Fn;\n}\n\nexport const FilterTiles: React.FunctionComponent<FilterTilesProps> = props => {\n  const {\n    menuStage,\n    maxItems,\n    essence,\n    clicker,\n    timekeeper,\n    locale,\n    removeFilter,\n    openedFilterMenu,\n    openFilterMenu,\n    closeFilterMenu,\n    dragStart,\n    partialFilter,\n    removePartialFilter,\n    overflowOpen,\n    closeOverflowMenu,\n    openOverflowMenu\n  } = props;\n\n  const clauses = essence.filter.clauses.toArray();\n  const dimensions = essence.dataCube.dimensions;\n\n  function updateClause(clause: FilterClause) {\n    clicker.changeFilter(essence.filter.setClause(clause));\n  }\n\n  function insertClause(clause: FilterClause, position: DragPosition) {\n    const { filter } = essence;\n    const newFilter = position.isInsert()\n      ? filter.insertByIndex(position.insert, clause)\n      : filter.replaceByIndex(position.replace, clause);\n    clicker.changeFilter(newFilter);\n  }\n\n  const filterTiles = clauses.map(clause => {\n    const dimension = findDimensionByName(dimensions, clause.reference);\n    const isTimeClause = dimension.name === essence.getTimeDimension().name;\n    return <FilterTile\n      key={clause.reference}\n      stage={menuStage}\n      essence={essence}\n      timekeeper={timekeeper}\n      clicker={clicker}\n      locale={locale}\n      clause={clause}\n      open={clause.equals(openedFilterMenu)}\n      dimension={dimension}\n      removeClause={isTimeClause ? undefined : removeFilter}\n      saveClause={updateClause}\n      openFilterMenu={openFilterMenu}\n\n      closeFilterMenu={closeFilterMenu}\n      dragStart={dragStart} />;\n  });\n\n  function insertPartialTile<T>(tiles: Array<ReactElement<T>>): Array<ReactElement<T>> {\n    if (!partialFilter) return tiles;\n    const { dimension, position } = partialFilter;\n    const partialTile = <PartialFilterTile\n      key=\"partial-filter-tile\"\n      dimension={dimension}\n      essence={essence}\n      timekeeper={timekeeper}\n      locale={locale}\n      clicker={clicker}\n      saveClause={clause => insertClause(clause, partialFilter.position)}\n      stage={menuStage}\n      closeItem={removePartialFilter}/>;\n\n    return insert(tiles, position.getIndex(), partialTile);\n  }\n\n  const tilesWithPlaceholder = insertPartialTile(filterTiles);\n\n  const visibleItems = tilesWithPlaceholder\n      .slice(0, maxItems)\n      .map((el, idx) => React.cloneElement(el, { style: transformStyle(idx * SECTION_WIDTH, 0) }));\n  const overflowItems = tilesWithPlaceholder.slice(maxItems);\n\n  if (overflowItems.length <= 0) return <React.Fragment>{visibleItems}</React.Fragment>;\n\n  const overflowClauses = clauses.slice(maxItems);\n\n  const anyOverflowItemOpen = overflowClauses.some(clause => clause.equals(openedFilterMenu));\n  const isPartialFilterInOverflow = overflowItems.some(element => element.type  === PartialFilterTile);\n  const overflowOpened = overflowOpen || anyOverflowItemOpen || isPartialFilterInOverflow;\n\n  const filterItemOverflow = <TileOverflowContainer\n    key=\"overflow-menu\"\n    className=\"dimension\"\n    x={visibleItems.length * SECTION_WIDTH}\n    items={overflowItems}\n    open={overflowOpened}\n    openOverflowMenu={openOverflowMenu}\n    closeOverflowMenu={closeOverflowMenu} />;\n\n  return <React.Fragment>\n    {[...visibleItems, filterItemOverflow]}\n  </React.Fragment>;\n};\n","/*\n * Copyright 2017-2021 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { getTimeDimensionReference } from \"../../../common/models/data-cube/data-cube\";\nimport { Dimension } from \"../../../common/models/dimension/dimension\";\nimport { findDimensionByName } from \"../../../common/models/dimension/dimensions\";\nimport { DragPosition } from \"../../../common/models/drag-position/drag-position\";\nimport { FilterClause } from \"../../../common/models/filter-clause/filter-clause\";\nimport { Locale } from \"../../../common/models/locale/locale\";\nimport { Split } from \"../../../common/models/split/split\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Timekeeper } from \"../../../common/models/timekeeper/timekeeper\";\nimport { Binary } from \"../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { CORE_ITEM_GAP, CORE_ITEM_WIDTH, STRINGS } from \"../../config/constants\";\nimport { getXFromEvent, setDragData, setDragGhost } from \"../../utils/dom/dom\";\nimport { DraggedElementType, DragManager } from \"../../utils/drag-manager/drag-manager\";\nimport { getMaxItems } from \"../../utils/pill-tile/pill-tile\";\nimport { CubeContext, CubeContextValue } from \"../../views/cube-view/cube-context\";\nimport { PartialFilter } from \"../../views/cube-view/partial-tiles-provider\";\nimport { DragIndicator } from \"../drag-indicator/drag-indicator\";\nimport { AddFilter } from \"./add-filter\";\nimport { FilterTiles } from \"./filter-tiles\";\n\ninterface FilterTilesRowProps {\n  menuStage: Stage;\n  timekeeper: Timekeeper;\n  locale: Locale;\n  removePartialFilter: Fn;\n  addPartialFilter: Binary<Dimension, DragPosition, void>;\n  partialFilter?: PartialFilter;\n}\n\ninterface FilterTilesRowState {\n  dragPosition?: DragPosition;\n  openedClause?: FilterClause;\n  overflowOpen?: boolean;\n}\n\nexport class FilterTilesRow extends React.Component<FilterTilesRowProps, FilterTilesRowState> {\n  static contextType = CubeContext;\n  context: CubeContextValue;\n\n  state: FilterTilesRowState = {};\n  private items = React.createRef<HTMLDivElement>();\n\n  private maxItems(): number {\n    const { essence: { filter } } = this.context;\n    const { menuStage } = this.props;\n    return menuStage && getMaxItems(menuStage.width, filter.length());\n  }\n\n  openFilterMenu = (clause: FilterClause) => this.setState({ openedClause: clause });\n\n  closeFilterMenu = () => this.setState({ openedClause: null });\n\n  openOverflowMenu = () => this.setState({ overflowOpen: true });\n\n  closeOverflowMenu = () => this.setState({ overflowOpen: false });\n\n  canDrop(): boolean {\n    const { essence: { filter } } = this.context;\n    switch (DragManager.dragging.type) {\n      case DraggedElementType.DIMENSION:\n        return !filter.getClauseForDimension(DragManager.draggingDimension());\n      case DraggedElementType.SPLIT:\n        return !filter.clauseForReference(DragManager.draggingSplit().reference);\n      case DraggedElementType.FILTER:\n        return true;\n      case DraggedElementType.MEASURE:\n        return false;\n      case DraggedElementType.SERIES:\n        return false;\n      case DraggedElementType.NONE:\n        return false;\n    }\n  }\n\n  dragStart = (dimension: Dimension, clause: FilterClause, e: React.DragEvent<HTMLElement>) => {\n    const label = dimension.title;\n    const dataTransfer = e.dataTransfer;\n    dataTransfer.effectAllowed = \"all\";\n    setDragData(dataTransfer, \"text/plain\", label);\n\n    DragManager.setDragFilter(clause);\n    setDragGhost(dataTransfer, label);\n\n    this.closeOverflowMenu();\n  };\n\n  calculateDragPosition(e: React.DragEvent<HTMLElement>): DragPosition {\n    const { essence } = this.context;\n    const numItems = essence.filter.length();\n    const rect = this.items.current.getBoundingClientRect();\n    const offset = getXFromEvent(e) - rect.left;\n    const position = DragPosition.calculateFromOffset(offset, numItems, CORE_ITEM_WIDTH, CORE_ITEM_GAP);\n    if (position.replace === this.maxItems()) {\n      return DragPosition.insertAt(position.replace);\n    }\n    return position;\n  }\n\n  dragEnter = (e: React.DragEvent<HTMLElement>) => {\n    if (!this.canDrop()) return;\n    e.preventDefault();\n    this.setState({\n      dragPosition: this.calculateDragPosition(e)\n    });\n  };\n\n  dragOver = (e: React.DragEvent<HTMLElement>) => {\n    if (!this.canDrop()) return;\n    e.preventDefault();\n    const dragPosition = this.calculateDragPosition(e);\n    if (dragPosition.equals(this.state.dragPosition)) return;\n    this.setState({ dragPosition });\n  };\n\n  dragLeave = () => {\n    if (!this.canDrop()) return;\n    this.setState({ dragPosition: null });\n  };\n\n  drop = (e: React.DragEvent<HTMLElement>) => {\n    if (!this.canDrop()) return;\n    e.preventDefault();\n    this.setState({ dragPosition: null });\n\n    const position = this.calculateDragPosition(e);\n    switch (DragManager.dragging.type) {\n      case DraggedElementType.DIMENSION:\n        this.dropDimension(DragManager.draggingDimension(), position);\n        break;\n      case DraggedElementType.FILTER:\n        this.dropFilter(DragManager.draggingFilter(), position);\n        break;\n      case DraggedElementType.SPLIT:\n        this.dropSplit(DragManager.draggingSplit(), position);\n        break;\n    }\n  };\n\n  private dropSplit(split: Split, position: DragPosition) {\n    const { essence: { dataCube: { dimensions } } } = this.context;\n    const dimension = findDimensionByName(dimensions, split.reference);\n    this.dropDimension(dimension, position);\n  }\n\n  private dropDimension(dimension: Dimension, position: DragPosition) {\n    const { essence: { filter, dataCube } } = this.context;\n    const { addPartialFilter } = this.props;\n    let tryingToReplaceTime = false;\n    if (position.isReplace()) {\n      const targetClause = filter.clauses.get(position.replace);\n      tryingToReplaceTime = targetClause && targetClause.reference === getTimeDimensionReference(dataCube);\n      if (tryingToReplaceTime) return;\n    }\n    addPartialFilter(dimension, position);\n  }\n\n  private dropFilter(clause: FilterClause, position: DragPosition) {\n    const { clicker, essence: { filter } } = this.context;\n    const newFilter = position.isReplace()\n      ? filter.replaceByIndex(position.replace, clause)\n      : filter.insertByIndex(position.insert, clause);\n    if (!filter.equals(newFilter)) {\n      clicker.changeFilter(newFilter);\n    }\n  }\n\n  appendFilter = (dimension: Dimension) => {\n    const { essence } = this.context;\n    const { addPartialFilter } = this.props;\n    addPartialFilter(dimension, DragPosition.insertAt(essence.filter.length()));\n  }\n\n  removeFilter = (clause: FilterClause) => {\n    const { essence, clicker } = this.context;\n    clicker.changeFilter(essence.filter.removeClause(clause.reference));\n    this.closeOverflowMenu();\n  }\n\n  render() {\n    const { dragPosition, openedClause, overflowOpen } = this.state;\n    const { menuStage, timekeeper, locale, partialFilter, removePartialFilter } = this.props;\n    const { essence, clicker } = this.context;\n    return <div className=\"tile-row filter-tile-row\" onDragEnter={this.dragEnter}>\n      <div className=\"title\">{STRINGS.filter}</div>\n      <div className=\"items\" ref={this.items}>\n        <FilterTiles\n          menuStage={menuStage}\n          maxItems={this.maxItems()}\n          essence={essence}\n          clicker={clicker}\n          timekeeper={timekeeper}\n          locale={locale}\n          removeFilter={this.removeFilter}\n          openFilterMenu={this.openFilterMenu}\n          closeFilterMenu={this.closeFilterMenu}\n          dragStart={this.dragStart}\n          removePartialFilter={removePartialFilter}\n          partialFilter={partialFilter}\n          overflowOpen={overflowOpen}\n          closeOverflowMenu={this.closeOverflowMenu}\n          openedFilterMenu={openedClause}\n          openOverflowMenu={this.openOverflowMenu}/>\n      </div>\n      <AddFilter\n        menuStage={menuStage}\n        essence={essence}\n        appendFilter={this.appendFilter}/>\n      <DragIndicator\n        dragOver={this.dragOver}\n        dragLeave={this.dragLeave}\n        drop={this.drop}\n        dragPosition={dragPosition}/>\n    </div>;\n  }\n}\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Clicker } from \"../../../common/models/clicker/clicker\";\nimport { Essence, VisStrategy } from \"../../../common/models/essence/essence\";\nimport { Resolution } from \"../../../common/models/visualization-manifest/visualization-manifest\";\nimport { MessageCard } from \"../message-card/message-card\";\nimport \"./manual-fallback.scss\";\n\nexport interface ManualFallbackProps {\n  clicker: Clicker;\n  essence: Essence;\n}\n\nexport class ManualFallback extends React.Component<ManualFallbackProps, {}> {\n\n  onResolutionClick(resolution: Resolution): void {\n    const { clicker } = this.props;\n    const { adjustment: { splits, series } } = resolution;\n\n    if (series != null) {\n      clicker.changeSeriesList(series);\n    }\n    if (splits != null) {\n      clicker.changeSplits(splits, VisStrategy.KeepAlways);\n    }\n  }\n\n  render() {\n    const { essence } = this.props;\n    const { visResolve } = essence;\n\n    if (!visResolve.isManual()) return null;\n\n    const resolutionItems = visResolve.resolutions.map((resolution, i) => {\n      return <li className=\"resolution-item\" key={i} onClick={this.onResolutionClick.bind(this, resolution)}>{resolution.description}</li>;\n    });\n\n    return <MessageCard title={visResolve.message}>\n      <ul className=\"manual-fallback\">\n        {resolutionItems}\n      </ul>\n    </MessageCard>;\n  }\n}\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Essence } from \"../../../common/models/essence/essence\";\nimport { Measure } from \"../../../common/models/measure/measure\";\nimport { allMeasures } from \"../../../common/models/measure/measures\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { AddTile } from \"../add-tile/add-tile\";\n\ninterface AddSeriesProps {\n  appendMeasureSeries: Unary<Measure, void>;\n  menuStage: Stage;\n  essence: Essence;\n}\n\nexport const AddSeries: React.FunctionComponent<AddSeriesProps> = props => {\n  const { appendMeasureSeries, menuStage, essence: { dataCube, series } } = props;\n  const tiles = allMeasures(dataCube.measures)\n    .filter(measure => !series.hasMeasure(measure))\n    .map(measure => {\n      return {\n        key: measure.name,\n        label: measure.title,\n        value: measure\n      };\n    });\n\n  return <AddTile<Measure>\n    containerStage={menuStage}\n    onSelect={appendMeasureSeries}\n    tiles={tiles} />;\n\n};\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { ClientMeasure } from \"../../../common/models/measure/measure\";\nimport {\n  customFormat,\n  DEFAULT_FORMAT,\n  EXACT_FORMAT,\n  exactFormat,\n  measureDefaultFormat,\n  PERCENT_FORMAT,\n  percentFormat,\n  SeriesFormat,\n  seriesFormatter,\n  SeriesFormatType\n} from \"../../../common/models/series/series-format\";\nimport { concatTruthy, Unary } from \"../../../common/utils/functional/functional\";\nimport { STRINGS } from \"../../config/constants\";\nimport { StringInputWithPresets } from \"../input-with-presets/string-input-with-presets\";\n\nconst PREVIEW_VALUE = 23667.25431;\n\ninterface FormatPickerProps {\n  measure: ClientMeasure;\n  format: SeriesFormat;\n  formatChange: Unary<SeriesFormat, void>;\n}\n\nfunction readFormat(format: string, measureFormat: string): SeriesFormat {\n  switch (format) {\n    case measureFormat:\n      return DEFAULT_FORMAT;\n    case exactFormat:\n      return EXACT_FORMAT;\n    case percentFormat:\n      return PERCENT_FORMAT;\n    default:\n      return customFormat(format);\n  }\n}\n\nfunction printFormat(format: SeriesFormat, measureFormat: string): string {\n  switch (format.type) {\n    case SeriesFormatType.DEFAULT:\n      return measureFormat;\n    case SeriesFormatType.EXACT:\n      return exactFormat;\n    case SeriesFormatType.PERCENT:\n      return percentFormat;\n    case SeriesFormatType.CUSTOM:\n      return format.value;\n  }\n}\n\nexport const FormatPicker: React.FunctionComponent<FormatPickerProps> = ({ format, measure, formatChange }) => {\n  const measureFormat = measure.format;\n\n  const formatPresets = concatTruthy(\n    { name: \"Default\", identity: measureFormat },\n    measureFormat !== exactFormat && { name: \"Exact\", identity: exactFormat },\n    { name: \"Percent\", identity: percentFormat }\n  );\n\n  function onFormatChange(format: string) {\n    formatChange(readFormat(format, measureFormat));\n  }\n\n  return <React.Fragment>\n    <StringInputWithPresets\n      presets={formatPresets}\n      title={STRINGS.format}\n      selected={printFormat(format, measureFormat)}\n      placeholder={`Custom format e.g. ${measureDefaultFormat}`}\n      onChange={onFormatChange} />\n    {format.type === SeriesFormatType.CUSTOM && <div className=\"format-hint\">\n      You can use custom numbro format to present measure values.\n      Please refer to the <a target=\"_blank\" className=\"documentation-link\" href=\"https://numbrojs.com/old-format.html\">numbro documentation</a>\n    </div>}\n    <div className=\"preview\">\n      <span className=\"value\">{PREVIEW_VALUE}  </span>\n      <span className=\"formatted\">{seriesFormatter(format, measure)(PREVIEW_VALUE)}</span>\n    </div>\n  </React.Fragment>;\n};\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { ArithmeticExpression, ArithmeticOperation } from \"../../../common/models/expression/concreteArithmeticOperation\";\nimport { ExpressionSeriesOperation } from \"../../../common/models/expression/expression\";\nimport { ClientMeasure, isApproximate } from \"../../../common/models/measure/measure\";\nimport { ClientMeasures, findMeasureByName } from \"../../../common/models/measure/measures\";\nimport { SeriesList } from \"../../../common/models/series-list/series-list\";\nimport { ExpressionConcreteSeries } from \"../../../common/models/series/expression-concrete-series\";\nimport { ExpressionSeries } from \"../../../common/models/series/expression-series\";\nimport { Series } from \"../../../common/models/series/series\";\nimport { SeriesFormat } from \"../../../common/models/series/series-format\";\nimport { Binary, values } from \"../../../common/utils/functional/functional\";\nimport { isTruthy } from \"../../../common/utils/general/general\";\nimport { Dropdown } from \"../dropdown/dropdown\";\nimport \"./arithmetic-series-menu.scss\";\nimport { FormatPicker } from \"./format-picker\";\n\ninterface ArithmeticOperationSeriesMenuProps {\n  measure: ClientMeasure;\n  measures: ClientMeasures;\n  seriesList: SeriesList;\n  series: ExpressionSeries;\n  initialSeries: Series;\n  onChange: Binary<ExpressionSeries, boolean, void>;\n}\n\ninterface Operation {\n  id: ArithmeticOperation;\n  label: string;\n}\n\nconst OPERATIONS: Operation[] = [{\n  id: ExpressionSeriesOperation.ADD, label: \"Add\"\n}, {\n  id: ExpressionSeriesOperation.SUBTRACT, label: \"Subtract\"\n}, {\n  id: ExpressionSeriesOperation.MULTIPLY, label: \"Multiply\"\n}, {\n  id: ExpressionSeriesOperation.DIVIDE, label: \"Divide\"\n}];\n\nconst renderOperation = (op: Operation): string => op.label;\n\nconst renderMeasure = (m: ClientMeasure): string => m.title;\nconst renderSelectedMeasure = (m: ClientMeasure): string => m ? m.title : \"Select measure\";\n\nfunction expressionSeriesTitle(series: ExpressionSeries, measure: ClientMeasure, measures: ClientMeasures): string {\n  const concreteSeries = new ExpressionConcreteSeries(series, measure, measures);\n  return concreteSeries.title();\n}\n\nexport const ArithmeticSeriesMenu: React.FunctionComponent<ArithmeticOperationSeriesMenuProps> = props => {\n  const { measure, measures, initialSeries, series, seriesList, onChange } = props;\n\n  function isSeriesValid({ expression }: ExpressionSeries): boolean {\n    return expression instanceof ArithmeticExpression && isTruthy(expression.reference);\n  }\n\n  function onSeriesChange(series: ExpressionSeries) {\n    onChange(series, isSeriesValid(series));\n  }\n\n  function onFormatChange(format: SeriesFormat) {\n    onSeriesChange(series.set(\"format\", format));\n  }\n\n  function onOperationSelect({ id }: Operation) {\n    onSeriesChange(series.setIn([\"expression\", \"operation\"], id));\n  }\n\n  function onOperandSelect({ name }: ClientMeasure) {\n    onSeriesChange(series.setIn([\"expression\", \"reference\"], name));\n  }\n\n  const otherSeries = seriesList.removeSeries(initialSeries);\n  const duplicate = otherSeries.getSeriesWithKey(series.key());\n  const expression = series.expression as ArithmeticExpression;\n  const operation = OPERATIONS.find(op => op.id === expression.operation);\n  const operand = findMeasureByName(measures, expression.reference);\n  const items = values(measures.byName).filter(m => m.name !== measure.name && !isApproximate(m));\n\n  return <React.Fragment>\n    <div className=\"operation-select__title\">Select operation</div>\n    <Dropdown<Operation>\n      className=\"operation-select\"\n      items={OPERATIONS}\n      renderItem={renderOperation}\n      equal={(a, b) => a.id === b.id}\n      selectedItem={operation}\n      onSelect={onOperationSelect}\n    />\n    <div className=\"operand-select__title\">Select measure</div>\n    <Dropdown<ClientMeasure>\n      className=\"operand-select\"\n      items={items}\n      renderItem={renderMeasure}\n      renderSelectedItem={renderSelectedMeasure}\n      equal={(a, b) => a.name === b.name}\n      selectedItem={operand}\n      onSelect={onOperandSelect}\n    />\n    {duplicate &&\n    <div className=\"arithmetic-operation-warning\">\n      \"{expressionSeriesTitle(duplicate as ExpressionSeries, measure, measures)}\" is already defined\n    </div>}\n    <FormatPicker\n      measure={measure}\n      format={series.format}\n      formatChange={onFormatChange}\n    />\n  </React.Fragment>;\n};\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Measure } from \"../../../common/models/measure/measure\";\nimport { MeasureSeries } from \"../../../common/models/series/measure-series\";\nimport { SeriesFormat } from \"../../../common/models/series/series-format\";\nimport { Binary } from \"../../../common/utils/functional/functional\";\nimport { FormatPicker } from \"./format-picker\";\n\ninterface MeasureSeriesMenuProps {\n  measure: Measure;\n  series: MeasureSeries;\n  onChange: Binary<MeasureSeries, boolean, void>;\n}\n\nexport const MeasureSeriesMenu: React.FunctionComponent<MeasureSeriesMenuProps> = ({ measure, series, onChange }) => {\n\n  function onFormatChange(format: SeriesFormat) {\n    onChange(series.set(\"format\", format), true);\n  }\n\n  return <React.Fragment>\n    <FormatPicker\n      measure={measure}\n      format={series.format}\n      formatChange={onFormatChange}\n    />\n  </React.Fragment>;\n};\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { ExpressionSeriesOperation } from \"../../../common/models/expression/expression\";\nimport { PercentExpression, PercentOperation } from \"../../../common/models/expression/percent\";\nimport { Measure } from \"../../../common/models/measure/measure\";\nimport { SeriesList } from \"../../../common/models/series-list/series-list\";\nimport { ExpressionSeries } from \"../../../common/models/series/expression-series\";\nimport { SeriesFormat } from \"../../../common/models/series/series-format\";\nimport { Binary } from \"../../../common/utils/functional/functional\";\nimport { Dropdown } from \"../dropdown/dropdown\";\nimport { FormatPicker } from \"./format-picker\";\nimport \"./percent-series-menu.scss\";\n\ninterface PercentSeriesMenuProps {\n  measure: Measure;\n  series: ExpressionSeries;\n  seriesList: SeriesList;\n  onChange: Binary<ExpressionSeries, boolean, void>;\n}\n\ninterface Operation {\n  id: PercentOperation;\n  label: string;\n}\n\nconst OPERATIONS: Operation[] = [{\n  id: ExpressionSeriesOperation.PERCENT_OF_PARENT, label: \"Percent of parent\"\n}, {\n  id: ExpressionSeriesOperation.PERCENT_OF_TOTAL, label: \"Percent of total\"\n}];\n\nfunction operationToExpression(operation: PercentOperation): PercentExpression {\n  return new PercentExpression({ operation });\n}\n\nconst renderOperation = (op: Operation): string => op.label;\n\nexport const PercentSeriesMenu: React.FunctionComponent<PercentSeriesMenuProps> = ({ series, seriesList, measure, onChange }) => {\n\n  const selectedOperations = seriesList\n    .getExpressionSeriesFor(measure.name)\n    .filter(s => !s.equals(series))\n    .filter(s => s.expression instanceof PercentExpression)\n    .map((s: ExpressionSeries) => s.expression.operation)\n    .toSet();\n\n  function isSeriesValid(series: ExpressionSeries): boolean {\n    return series.expression instanceof PercentExpression;\n  }\n\n  function onSeriesChange(series: ExpressionSeries) {\n    onChange(series, isSeriesValid(series));\n  }\n\n  function onFormatChange(format: SeriesFormat) {\n    onSeriesChange(series.set(\"format\", format));\n  }\n\n  function onOperationSelect({ id }: Operation) {\n    onSeriesChange(series.set(\"expression\", operationToExpression(id)));\n  }\n\n  return <React.Fragment>\n    <Dropdown<Operation>\n      className=\"percent-operation-picker\"\n      items={OPERATIONS.filter(({ id }) => !selectedOperations.has(id))}\n      renderItem={renderOperation}\n      renderSelectedItem={renderOperation}\n      equal={(a, b) => a.id === b.id}\n      selectedItem={series.expression && OPERATIONS.find(op => op.id === series.expression.operation)}\n      onSelect={onOperationSelect}\n    />\n    <FormatPicker\n      measure={measure}\n      format={series.format}\n      formatChange={onFormatChange}\n    />\n  </React.Fragment>;\n};\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Omit } from \"../../../common/utils/functional/functional\";\nimport { InputWithPresets, InputWithPresetsProps } from \"../input-with-presets/input-with-presets\";\n\ntype QuantilePickerProps = Omit<InputWithPresetsProps<number>, \"parseCustomValue\" | \"formatCustomValue\">;\n\nfunction parse(s: string): number {\n  const n = parseFloat(s);\n  return isNaN(n) ? 0 : n;\n}\n\nfunction format(n: number): string {\n  return n.toString();\n}\n\nexport const QuantilePicker: React.FunctionComponent<QuantilePickerProps> = props =>\n  <InputWithPresets<number> {...props} parseCustomValue={parse} formatCustomValue={format} />;\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Measure } from \"../../../common/models/measure/measure\";\nimport { SeriesList } from \"../../../common/models/series-list/series-list\";\nimport { QuantileSeries } from \"../../../common/models/series/quantile-series\";\nimport { Series } from \"../../../common/models/series/series\";\nimport { SeriesFormat } from \"../../../common/models/series/series-format\";\nimport { Binary } from \"../../../common/utils/functional/functional\";\nimport { Preset } from \"../input-with-presets/input-with-presets\";\nimport { FormatPicker } from \"./format-picker\";\nimport { QuantilePicker } from \"./quantile-picker\";\nimport \"./quantile-series-menu.scss\";\n\ninterface QuantileSeriesMenuProps {\n  measure: Measure;\n  initialSeries: Series;\n  series: QuantileSeries;\n  seriesList: SeriesList;\n  onChange: Binary<QuantileSeries, boolean, void>;\n}\n\nconst percentiles: Array<Preset<number>> = [\n  { identity: 50, name: \"50\" },\n  { identity: 75, name: \"75\" },\n  { identity: 90, name: \"90\" },\n  { identity: 95, name: \"95\" },\n  { identity: 99, name: \"99\" }\n];\n\nexport const QuantileSeriesMenu: React.FunctionComponent<QuantileSeriesMenuProps> = ({ seriesList, initialSeries, measure, series, onChange }) => {\n\n  const otherSeries = seriesList.removeSeries(initialSeries);\n\n  function validateSeries(series: QuantileSeries): string | null {\n    if (series.percentile <= 0 || series.percentile >= 100) {\n      return \"Percentile must be a number greater than 0 and lower than 100\";\n    }\n    if (otherSeries.hasSeriesWithKey(series.key())) {\n      return \"This percentile is already define for this measure\";\n    }\n    return null;\n  }\n\n  function isSeriesValid(series: QuantileSeries) {\n    return validateSeries(series) === null;\n  }\n\n  function onSeriesChange(series: QuantileSeries) {\n    onChange(series, isSeriesValid(series));\n  }\n\n  function onFormatChange(format: SeriesFormat) {\n    onSeriesChange(series.set(\"format\", format));\n  }\n\n  function onPercentileChange(percentile: number) {\n    onSeriesChange(series.set(\"percentile\", percentile));\n  }\n\n  const error = validateSeries(series);\n\n  return <React.Fragment>\n    <div className=\"percentile-picker\">\n      <QuantilePicker\n        title=\"Percentile\"\n        placeholder=\"Type percentile e.g. 55\"\n        selected={series.percentile}\n        presets={percentiles}\n        errorMessage={error}\n        onChange={onPercentileChange} />\n    </div>\n    <FormatPicker\n      measure={measure}\n      format={series.format}\n      formatChange={onFormatChange}\n    />\n  </React.Fragment>;\n};\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { ArithmeticExpression } from \"../../../common/models/expression/concreteArithmeticOperation\";\nimport { PercentExpression } from \"../../../common/models/expression/percent\";\nimport { Measure } from \"../../../common/models/measure/measure\";\nimport { Measures } from \"../../../common/models/measure/measures\";\nimport { SeriesList } from \"../../../common/models/series-list/series-list\";\nimport { ExpressionSeries } from \"../../../common/models/series/expression-series\";\nimport { MeasureSeries } from \"../../../common/models/series/measure-series\";\nimport { QuantileSeries } from \"../../../common/models/series/quantile-series\";\nimport { Series } from \"../../../common/models/series/series\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { Fn, isTruthy } from \"../../../common/utils/general/general\";\nimport { STRINGS } from \"../../config/constants\";\nimport { enterKey } from \"../../utils/dom/dom\";\nimport { BubbleMenu } from \"../bubble-menu/bubble-menu\";\nimport { Button } from \"../button/button\";\nimport { ArithmeticSeriesMenu } from \"./arithmetic-series-menu\";\nimport { MeasureSeriesMenu } from \"./measure-series-menu\";\nimport { PercentSeriesMenu } from \"./percent-series-menu\";\nimport { QuantileSeriesMenu } from \"./quantile-series-menu\";\nimport \"./series-menu.scss\";\n\ninterface SeriesMenuProps {\n  saveSeries: Unary<Series, void>;\n  measure: Measure;\n  measures: Measures;\n  seriesList: SeriesList;\n  containerStage: Stage;\n  onClose: Fn;\n  initialSeries: Series;\n  openOn: Element;\n}\n\ninterface SeriesMenuState {\n  series: Series;\n  isValid: boolean;\n}\n\nexport class SeriesMenu extends React.Component<SeriesMenuProps, SeriesMenuState> {\n\n  state: SeriesMenuState = { series: this.props.initialSeries, isValid: true };\n\n  componentDidMount() {\n    window.addEventListener(\"keydown\", this.globalKeyDownListener);\n  }\n\n  componentWillUnmount() {\n    window.removeEventListener(\"keydown\", this.globalKeyDownListener);\n  }\n\n  globalKeyDownListener = (e: KeyboardEvent) => enterKey(e) && this.onOkClick();\n\n  saveSeries = (series: Series, isValid: boolean) => this.setState({ series, isValid });\n\n  onCancelClick = () => this.props.onClose();\n\n  onOkClick = () => {\n    if (!this.validate()) return;\n    const { saveSeries, onClose } = this.props;\n    const { series } = this.state;\n    saveSeries(series);\n    onClose();\n  };\n\n  validate(): boolean {\n    const { isValid, series } = this.state;\n    const { initialSeries, seriesList } = this.props;\n    const isModified = !initialSeries.equals(series);\n    const otherSeries = seriesList.series.filter(s => !s.equals(initialSeries));\n    const isUnique = !isTruthy(otherSeries.find(s => s.key() === series.key()));\n    return isValid && isModified && isUnique;\n  }\n\n  render() {\n    const { measure, measures, initialSeries, seriesList, containerStage, onClose, openOn } = this.props;\n    const { series } = this.state;\n\n    return <BubbleMenu\n      className=\"series-menu\"\n      direction=\"down\"\n      containerStage={containerStage}\n      stage={Stage.fromSize(250, 240)}\n      openOn={openOn}\n      onClose={onClose}\n    >\n      {series instanceof MeasureSeries && <MeasureSeriesMenu\n        series={series}\n        measure={measure}\n        onChange={this.saveSeries}\n      />}\n      {series instanceof ExpressionSeries && series.expression instanceof PercentExpression && <PercentSeriesMenu\n        seriesList={seriesList}\n        series={series}\n        measure={measure}\n        onChange={this.saveSeries}\n      />}\n      {series instanceof ExpressionSeries && series.expression instanceof ArithmeticExpression && <ArithmeticSeriesMenu\n        seriesList={seriesList}\n        series={series}\n        initialSeries={initialSeries}\n        measure={measure}\n        measures={measures}\n        onChange={this.saveSeries}\n      />}\n      {series instanceof QuantileSeries && <QuantileSeriesMenu\n        seriesList={seriesList}\n        measure={measure}\n        onChange={this.saveSeries}\n        initialSeries={initialSeries}\n        series={series}\n      />}\n      <div className=\"button-bar\">\n        <Button className=\"ok\" type=\"primary\" disabled={!this.validate()} onClick={this.onOkClick} title={STRINGS.ok} />\n        <Button type=\"secondary\" onClick={this.onCancelClick} title={STRINGS.cancel} />\n      </div>\n    </BubbleMenu>;\n  }\n}\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Measure } from \"../../../common/models/measure/measure\";\nimport { Measures } from \"../../../common/models/measure/measures\";\nimport { SeriesList } from \"../../../common/models/series-list/series-list\";\nimport { Series } from \"../../../common/models/series/series\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { SeriesMenu } from \"../series-menu/series-menu\";\nimport { WithRef } from \"../with-ref/with-ref\";\n\ninterface PlaceholderSeriesTileProps {\n  measure: Measure;\n  measures: Measures;\n  seriesList: SeriesList;\n  series: Series;\n  style?: React.CSSProperties;\n  containerStage: Stage;\n  saveSeries: Unary<Series, void>;\n  closeItem: Fn;\n}\n\nexport const PlaceholderSeriesTile: React.FunctionComponent<PlaceholderSeriesTileProps> = props => {\n  const { series, measures, seriesList, containerStage, saveSeries, closeItem, style, measure } = props;\n  return <WithRef>\n    {({ ref: openOn, setRef }) => <div\n      className=\"tile measure\"\n      ref={setRef}\n      style={style}>\n      <div className=\"reading\">{measure.title}</div>\n      {openOn && <SeriesMenu\n        key=\"placeholder-series\"\n        measures={measures}\n        seriesList={seriesList}\n        openOn={openOn}\n        containerStage={containerStage}\n        onClose={closeItem}\n        initialSeries={series}\n        measure={measure}\n        saveSeries={saveSeries} />}\n    </div>}\n  </WithRef>;\n};\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Measures } from \"../../../common/models/measure/measures\";\nimport { SeriesList } from \"../../../common/models/series-list/series-list\";\nimport { ConcreteSeries } from \"../../../common/models/series/concrete-series\";\nimport { Series } from \"../../../common/models/series/series\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Binary, Ternary, Unary } from \"../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { SeriesMenu } from \"../series-menu/series-menu\";\nimport { SvgIcon } from \"../svg-icon/svg-icon\";\nimport { WithRef } from \"../with-ref/with-ref\";\n\ninterface SeriesTileProps {\n  item: ConcreteSeries;\n  open: boolean;\n  seriesList: SeriesList;\n  measures: Measures;\n  style?: React.CSSProperties;\n  removeSeries: Unary<Series, void>;\n  updateSeries: Binary<Series, Series, void>;\n  openSeriesMenu: Unary<Series, void>;\n  closeSeriesMenu: Fn;\n  dragStart: Ternary<string, Series, React.DragEvent<HTMLElement>, void>;\n  containerStage: Stage;\n}\n\nexport const SeriesTile: React.FunctionComponent<SeriesTileProps> = props => {\n  const { seriesList, measures, open, item, style, updateSeries, removeSeries, openSeriesMenu, closeSeriesMenu, dragStart, containerStage } = props;\n  const { definition, measure } = item;\n  const title = item.title();\n\n  const saveSeries = (newSeries: Series) => updateSeries(definition, newSeries);\n  const remove = (e: React.MouseEvent<HTMLElement>) => {\n    e.stopPropagation();\n    removeSeries(definition);\n  };\n\n  return <WithRef>\n    {({ ref: openOn, setRef }) => <React.Fragment>\n      <div\n        className=\"tile measure\"\n        draggable={true}\n        ref={setRef}\n        onClick={() => openSeriesMenu(definition)}\n        onDragStart={e => dragStart(measure.title, definition, e)}\n        style={style}\n        title={title}\n      >\n        <div className=\"reading\">{title}</div>\n        <div className=\"remove\" onClick={remove}>\n          <SvgIcon svg={require(\"../../icons/x.svg\")} />\n        </div>\n      </div>\n      {open && openOn && <SeriesMenu\n        key={definition.key()}\n        openOn={openOn}\n        seriesList={seriesList}\n        measures={measures}\n        containerStage={containerStage}\n        onClose={closeSeriesMenu}\n        initialSeries={definition}\n        measure={measure}\n        saveSeries={saveSeries} />}\n    </React.Fragment>}\n  </WithRef>;\n};\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { ReactElement } from \"react\";\nimport { Essence } from \"../../../common/models/essence/essence\";\nimport { findMeasureByName } from \"../../../common/models/measure/measures\";\nimport { Series } from \"../../../common/models/series/series\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { insert } from \"../../../common/utils/array/array\";\nimport { Binary, Ternary, Unary } from \"../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { transformStyle } from \"../../utils/dom/dom\";\nimport { SECTION_WIDTH } from \"../../utils/pill-tile/pill-tile\";\nimport { PartialSeries } from \"../../views/cube-view/partial-tiles-provider\";\nimport { TileOverflowContainer } from \"../tile-overflow-container/tile-overflow-container\";\nimport { PlaceholderSeriesTile } from \"./placeholder-series\";\nimport { SeriesTile } from \"./series-tile\";\n\ninterface SeriesTilesProps {\n  menuStage: Stage;\n  maxItems: number;\n  essence: Essence;\n  removeSeries: Unary<Series, void>;\n  updateSeries: Binary<Series, Series, void>;\n  openedSeriesMenu?: Series;\n  openSeriesMenu: Unary<Series, void>;\n  closeSeriesMenu: Fn;\n  dragStart: Ternary<string, Series, React.DragEvent<HTMLElement>, void>;\n  partialSeries?: PartialSeries;\n  removePlaceholderSeries: Fn;\n  savePlaceholderSeries: Unary<Series, void>;\n  overflowOpen: boolean;\n  closeOverflowMenu: Fn;\n  openOverflowMenu: Fn;\n}\n\nexport const SeriesTiles: React.FunctionComponent<SeriesTilesProps> = props => {\n  const {\n    openedSeriesMenu,\n    menuStage,\n    removeSeries,\n    dragStart,\n    closeSeriesMenu,\n    updateSeries,\n    removePlaceholderSeries,\n    savePlaceholderSeries,\n    openOverflowMenu,\n    closeOverflowMenu,\n    essence,\n    openSeriesMenu,\n    overflowOpen,\n    partialSeries,\n    maxItems\n  } = props;\n\n  const series = essence.getConcreteSeries().toArray();\n\n  const seriesTiles = series.map(item => <SeriesTile\n    seriesList={essence.series}\n    measures={essence.dataCube.measures}\n    key={item.definition.key()}\n    item={item}\n    open={item.definition.equals(openedSeriesMenu)}\n    closeSeriesMenu={closeSeriesMenu}\n    removeSeries={removeSeries}\n    dragStart={dragStart}\n    containerStage={menuStage}\n    openSeriesMenu={openSeriesMenu}\n    updateSeries={updateSeries} />);\n\n  function insertPlaceholder<T>(tiles: Array<ReactElement<T>>): Array<ReactElement<T>> {\n    if (!partialSeries) return tiles;\n    const { series, position } = partialSeries;\n    const measure = findMeasureByName(essence.dataCube.measures, series.reference);\n\n    const placeholderTile = <PlaceholderSeriesTile\n      key=\"placeholder-series-tile\"\n      measure={measure}\n      seriesList={essence.series}\n      measures={essence.dataCube.measures}\n      series={series}\n      containerStage={menuStage}\n      saveSeries={savePlaceholderSeries}\n      closeItem={removePlaceholderSeries} />;\n\n    return insert(tiles, position.getIndex(), placeholderTile);\n  }\n\n  const tilesWithPlaceholder = insertPlaceholder(seriesTiles);\n\n  const visibleItems = tilesWithPlaceholder\n    .slice(0, maxItems)\n    .map((element, idx) => React.cloneElement(element, { style: transformStyle(idx * SECTION_WIDTH, 0) }));\n  const overflowItems = tilesWithPlaceholder.slice(maxItems);\n\n  if (overflowItems.length <= 0) return <React.Fragment>{visibleItems}</React.Fragment>;\n\n  const anyOverflowItemOpen = series.slice(maxItems).some(({ definition }) => definition.equals(openedSeriesMenu));\n  const isDummySeriesInOverflow = overflowItems.some(element => element.type === PlaceholderSeriesTile);\n  const overflowOpened = overflowOpen || anyOverflowItemOpen || isDummySeriesInOverflow;\n\n  const seriesItemOverflow = <TileOverflowContainer\n    key=\"overflow-menu\"\n    items={overflowItems}\n    open={overflowOpened}\n    openOverflowMenu={openOverflowMenu}\n    x={visibleItems.length * SECTION_WIDTH}\n    closeOverflowMenu={closeOverflowMenu}\n    className=\"measure\" />;\n\n  return <React.Fragment>\n    {[...visibleItems, seriesItemOverflow]}\n  </React.Fragment>;\n};\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { DragPosition } from \"../../../common/models/drag-position/drag-position\";\nimport { Measure } from \"../../../common/models/measure/measure\";\nimport { MeasureSeries } from \"../../../common/models/series/measure-series\";\nimport { QuantileSeries } from \"../../../common/models/series/quantile-series\";\nimport { fromMeasure, Series } from \"../../../common/models/series/series\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Binary } from \"../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { CORE_ITEM_GAP, CORE_ITEM_WIDTH, STRINGS } from \"../../config/constants\";\nimport { getXFromEvent, setDragData, setDragGhost } from \"../../utils/dom/dom\";\nimport { DragManager } from \"../../utils/drag-manager/drag-manager\";\nimport { getMaxItems } from \"../../utils/pill-tile/pill-tile\";\nimport { CubeContext, CubeContextValue } from \"../../views/cube-view/cube-context\";\nimport { PartialSeries } from \"../../views/cube-view/partial-tiles-provider\";\nimport { DragIndicator } from \"../drag-indicator/drag-indicator\";\nimport { AddSeries } from \"./add-series\";\nimport { SeriesTiles } from \"./series-tiles\";\n\ninterface SeriesTilesRowProps {\n  menuStage: Stage;\n  partialSeries: PartialSeries | null;\n  addPartialSeries: Binary<Series, DragPosition, void>;\n  removePartialSeries: Fn;\n}\n\ninterface SeriesTilesRowState {\n  dragPosition?: DragPosition;\n  openedSeries?: Series;\n  overflowOpen?: boolean;\n}\n\nexport class SeriesTilesRow extends React.Component<SeriesTilesRowProps, SeriesTilesRowState> {\n  static contextType = CubeContext;\n  context: CubeContextValue;\n\n  state: SeriesTilesRowState = {};\n  private items = React.createRef<HTMLDivElement>();\n\n  private maxItems(): number {\n    const { essence: { series } } = this.context;\n    const { menuStage } = this.props;\n    return menuStage && getMaxItems(menuStage.width, series.count());\n  }\n\n  openSeriesMenu = (series: Series) => this.setState({ openedSeries: series });\n\n  closeSeriesMenu = () => this.setState({ openedSeries: null });\n\n  openOverflowMenu = () => this.setState({ overflowOpen: true });\n\n  closeOverflowMenu = () => this.setState({ overflowOpen: false });\n\n  updateSeries = (oldSeries: Series, series: Series) => {\n    const { essence, clicker } = this.context;\n    clicker.changeSeriesList(essence.series.replaceSeries(oldSeries, series));\n  };\n\n  savePlaceholderSeries = (series: Series) => {\n    const { removePartialSeries } = this.props;\n    const { clicker } = this.context;\n    clicker.addSeries(series);\n    removePartialSeries();\n  };\n\n  removeSeries = (series: Series) => {\n    const { clicker } = this.context;\n    clicker.removeSeries(series);\n    this.closeOverflowMenu();\n  };\n\n  canDrop(): boolean {\n    const { essence: { series: seriesList } } = this.context;\n    const measure = DragManager.draggingMeasure();\n    if (measure) return !seriesList.hasMeasure(measure);\n    return DragManager.isDraggingSeries();\n  }\n\n  dragStart = (label: string, series: Series, e: React.DragEvent<HTMLElement>) => {\n    const dataTransfer = e.dataTransfer;\n    dataTransfer.effectAllowed = \"all\";\n    setDragData(dataTransfer, \"text/plain\", label);\n\n    DragManager.setDragSeries(series);\n    setDragGhost(dataTransfer, label);\n\n    this.closeOverflowMenu();\n  };\n\n  calculateDragPosition(e: React.DragEvent<HTMLElement>): DragPosition {\n    const { essence } = this.context;\n    const numItems = essence.series.count();\n    const rect = this.items.current.getBoundingClientRect();\n    const x = getXFromEvent(e);\n    const offset = x - rect.left;\n    const position = DragPosition.calculateFromOffset(offset, numItems, CORE_ITEM_WIDTH, CORE_ITEM_GAP);\n    if (position.replace === this.maxItems()) {\n      return DragPosition.insertAt(position.replace);\n    }\n    return position;\n  }\n\n  dragEnter = (e: React.DragEvent<HTMLElement>) => {\n    if (!this.canDrop()) return;\n    e.preventDefault();\n    this.setState({\n      dragPosition: this.calculateDragPosition(e)\n    });\n  };\n\n  dragOver = (e: React.DragEvent<HTMLElement>) => {\n    if (!this.canDrop()) return;\n    e.preventDefault();\n    const dragPosition = this.calculateDragPosition(e);\n    if (dragPosition.equals(this.state.dragPosition)) return;\n    this.setState({ dragPosition });\n  };\n\n  dragLeave = () => {\n    if (!this.canDrop()) return;\n    this.setState({\n      dragPosition: null\n    });\n  };\n\n  drop = (e: React.DragEvent<HTMLElement>) => {\n    if (!this.canDrop()) return;\n    e.preventDefault();\n    this.setState({ dragPosition: null });\n\n    if (DragManager.isDraggingSeries()) {\n      this.rearrangeSeries(DragManager.draggingSeries(), this.calculateDragPosition(e));\n    } else {\n      this.dropNewSeries(fromMeasure(DragManager.draggingMeasure()), this.calculateDragPosition(e));\n    }\n  };\n\n  private dropNewSeries(newSeries: Series, dragPosition: DragPosition) {\n    const { addPartialSeries } = this.props;\n    const { clicker, essence: { series } } = this.context;\n    const isDuplicateQuantile = newSeries instanceof QuantileSeries && series.hasSeries(newSeries);\n    if (isDuplicateQuantile) {\n      if (dragPosition.isReplace()) {\n        clicker.removeSeries(series.series.get(dragPosition.replace));\n        addPartialSeries(newSeries, dragPosition);\n      } else {\n        addPartialSeries(newSeries, dragPosition);\n      }\n    } else {\n      this.rearrangeSeries(newSeries, dragPosition);\n    }\n  }\n\n  private rearrangeSeries(series: Series, dragPosition: DragPosition) {\n    const { clicker, essence } = this.context;\n\n    if (dragPosition.isReplace()) {\n      clicker.changeSeriesList(essence.series.replaceByIndex(dragPosition.replace, series));\n    } else {\n      clicker.changeSeriesList(essence.series.insertByIndex(dragPosition.insert, series));\n    }\n  }\n\n  appendMeasureSeries = (measure: Measure) => {\n    const { addPartialSeries } = this.props;\n    const { clicker, essence } = this.context;\n    const series = fromMeasure(measure);\n    const isMeasureSeries = series instanceof MeasureSeries;\n    const isUniqueQuantile = series instanceof QuantileSeries && !this.context.essence.series.hasSeries(series);\n    if (isMeasureSeries || isUniqueQuantile) {\n      clicker.addSeries(series);\n    } else {\n      addPartialSeries(series, DragPosition.insertAt(essence.series.count()));\n    }\n  };\n\n  render() {\n    const { dragPosition, openedSeries, overflowOpen } = this.state;\n    const { essence } = this.context;\n    const { menuStage, removePartialSeries, partialSeries } = this.props;\n    return <div className=\"tile-row series-tile-row\" onDragEnter={this.dragEnter}>\n      <div className=\"title\">{STRINGS.series}</div>\n      <div className=\"items\" ref={this.items}>\n        <SeriesTiles\n          menuStage={menuStage}\n          partialSeries={partialSeries}\n          maxItems={this.maxItems()}\n          essence={essence}\n          removeSeries={this.removeSeries}\n          updateSeries={this.updateSeries}\n          openSeriesMenu={this.openSeriesMenu}\n          closeSeriesMenu={this.closeSeriesMenu}\n          dragStart={this.dragStart}\n          removePlaceholderSeries={removePartialSeries}\n          savePlaceholderSeries={this.savePlaceholderSeries}\n          overflowOpen={overflowOpen}\n          closeOverflowMenu={this.closeOverflowMenu}\n          openOverflowMenu={this.openOverflowMenu}\n          openedSeriesMenu={openedSeries} />\n      </div>\n      <AddSeries menuStage={menuStage} essence={essence} appendMeasureSeries={this.appendMeasureSeries} />\n      <DragIndicator dragOver={this.dragOver} dragLeave={this.dragLeave} drop={this.drop} dragPosition={dragPosition} />\n    </div>;\n  }\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { VisualizationSettingsComponent } from \"../../../common/models/visualization-settings/visualization-settings\";\nimport { LineChartSettings } from \"../../../common/visualization-manifests/line-chart/settings\";\nimport { Checkbox } from \"../../components/checkbox/checkbox\";\n\nexport const LineChartSettingsComponent: VisualizationSettingsComponent<LineChartSettings> = ({ settings, onChange }) => {\n  const toggleGroupSeries = () => onChange(settings.update(\"groupSeries\", groupSeries => !groupSeries));\n  return <div className=\"settings-row\">\n    <Checkbox\n      selected={settings.groupSeries}\n      label=\"Group series\"\n      onClick={toggleGroupSeries} />\n  </div>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Visualization } from \"../../common/models/visualization-manifest/visualization-manifest\";\nimport { LineChartSettingsComponent } from \"./line-chart/line-chart-settings\";\nimport { ScatterplotSettingsComponent } from \"./scatterplot/scatterplot-settings\";\nimport { TableSettingsComponent } from \"./table/table-settings\";\n\ninterface SettingsComponents {\n  \"table\": typeof TableSettingsComponent;\n  \"bar-chart\": null;\n  \"line-chart\": typeof LineChartSettingsComponent;\n  \"heatmap\": null;\n  \"grid\": null;\n  \"totals\": null;\n  \"scatterplot\": typeof ScatterplotSettingsComponent;\n}\n\nconst Components: SettingsComponents = {\n  \"bar-chart\": null,\n  \"line-chart\": LineChartSettingsComponent,\n  \"heatmap\": null,\n  \"grid\": null,\n  \"totals\": null,\n  \"table\": TableSettingsComponent,\n  \"scatterplot\": ScatterplotSettingsComponent\n};\n\nexport function settingsComponent<T extends Visualization>(visualization: T): SettingsComponents[T] {\n  return Components[visualization];\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { VisualizationSettingsComponent } from \"../../../common/models/visualization-settings/visualization-settings\";\nimport { TableSettings } from \"../../../common/visualization-manifests/table/settings\";\nimport { Checkbox } from \"../../components/checkbox/checkbox\";\n\nexport const TableSettingsComponent: VisualizationSettingsComponent<TableSettings> = ({ settings, onChange }) => {\n  const toggleCollapseRows = () => onChange(settings.update(\"collapseRows\", collapse => !collapse));\n  return <div className=\"settings-row\">\n    <Checkbox\n      selected={settings.collapseRows}\n      label=\"Collapse rows\"\n      onClick={toggleCollapseRows} />\n  </div>;\n};\n","/*\n * Copyright 2017-2022 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { VisualizationSettingsComponent } from \"../../../common/models/visualization-settings/visualization-settings\";\nimport { ScatterplotSettings } from \"../../../common/visualization-manifests/scatterplot/settings\";\nimport { Checkbox } from \"../../components/checkbox/checkbox\";\nexport const ScatterplotSettingsComponent: VisualizationSettingsComponent<ScatterplotSettings> = props => {\n  const { settings, onChange } = props;\n  const toggleSummary = () => onChange(settings.update(\"showSummary\", showSummary => !showSummary));\n  return <div className=\"settings-row\">\n    <Checkbox\n      selected={settings.showSummary}\n      label=\"Show heatmap summary\"\n      onClick={toggleSummary} />\n  </div>;\n};\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { VisualizationManifest } from \"../../../common/models/visualization-manifest/visualization-manifest\";\nimport { VisualizationSettings } from \"../../../common/models/visualization-settings/visualization-settings\";\nimport { Binary, Unary } from \"../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { ImmutableRecord } from \"../../../common/utils/immutable-utils/immutable-utils\";\nimport { MANIFESTS } from \"../../../common/visualization-manifests\";\nimport { LineChartSettings } from \"../../../common/visualization-manifests/line-chart/settings\";\nimport { ScatterplotSettings } from \"../../../common/visualization-manifests/scatterplot/settings\";\nimport { TableSettings } from \"../../../common/visualization-manifests/table/settings\";\nimport { STRINGS } from \"../../config/constants\";\nimport { settingsComponent } from \"../../visualization-settings/settings-component\";\nimport { Button } from \"../button/button\";\nimport { VisSelectorItem } from \"./vis-selector-item\";\nimport \"./vis-selector-menu.scss\";\n\nexport interface VisSelectorMenuProps {\n  onSelect: Binary<VisualizationManifest, VisualizationSettings, void>;\n  initialVisualization: VisualizationManifest;\n  initialSettings: VisualizationSettings;\n  onClose: Fn;\n}\n\ninterface VisSelectorMenuState {\n  visualization: VisualizationManifest;\n  visualizationSettings: VisualizationSettings;\n}\n\nexport class VisSelectorMenu extends React.Component<VisSelectorMenuProps, VisSelectorMenuState> {\n\n  state: VisSelectorMenuState = {\n    visualization: this.props.initialVisualization,\n    visualizationSettings: this.props.initialSettings\n  };\n\n  save = () => {\n    const { onSelect, onClose } = this.props;\n    const { visualization, visualizationSettings } = this.state;\n    onSelect(visualization, visualizationSettings);\n    onClose();\n  };\n\n  close = () => this.props.onClose();\n\n  changeVisualization = (visualization: VisualizationManifest) => this.setState({ visualization, visualizationSettings: visualization.visualizationSettings.defaults });\n  changeSettings = (visualizationSettings: VisualizationSettings) => this.setState({ visualizationSettings });\n\n  renderSettings() {\n    const component = this.settingsComponent();\n    if (!component) return null;\n    return <div className=\"vis-settings\">\n      <div className=\"vis-settings-title\">Settings</div>\n      {component}\n    </div>;\n  }\n\n  settingsComponent(): JSX.Element | null {\n    const { visualization, visualizationSettings } = this.state;\n    /*\n      TODO:\n      Right now visualization and settings do not share type parameter.\n      We need to:\n        * move them together into union type indexed by visualization.name\n        * create getters for manifest in essence\n        * use switch to unpack both fields at once\n        * create mapped type acting like Visualization -> VisualizationSettings<Visualization>\n     */\n    switch (visualization.name) {\n      case \"table\":\n        const TableSettingsComponent = settingsComponent(visualization.name);\n        return <TableSettingsComponent onChange={this.changeSettings as Unary<ImmutableRecord<TableSettings>, void>}\n                                       settings={visualizationSettings as ImmutableRecord<TableSettings>} />;\n      case \"grid\":\n        return null;\n      case \"heatmap\":\n        return null;\n      case \"totals\":\n        return null;\n      case \"bar-chart\":\n        return null;\n      case \"line-chart\":\n        const LineChartSettingsComponent = settingsComponent(visualization.name);\n        return <LineChartSettingsComponent onChange={this.changeSettings as Unary<ImmutableRecord<LineChartSettings>, void>}\n                                           settings={visualizationSettings as ImmutableRecord<LineChartSettings>}/>;\n      case \"scatterplot\":\n        const ScatterplotSettingsComponent = settingsComponent(visualization.name);\n        return <ScatterplotSettingsComponent onChange={this.changeSettings as Unary<ImmutableRecord<ScatterplotSettings>, void>}\n                                             settings={visualizationSettings as ImmutableRecord<ScatterplotSettings>} />;\n    }\n  }\n\n  render() {\n    const { visualization: selected } = this.state;\n\n    return <div className=\"vis-selector-menu\">\n      <div className=\"vis-items\">\n        {MANIFESTS.map(visualization => <VisSelectorItem\n          key={visualization.name}\n          visualization={visualization}\n          selected={visualization.name === selected.name}\n          onClick={this.changeVisualization} />)}\n      </div>\n      {this.renderSettings()}\n      <div className=\"ok-cancel-bar\">\n        <Button type=\"primary\" title={STRINGS.ok} onClick={this.save} />\n        <Button type=\"secondary\" title={STRINGS.cancel} onClick={this.close} />\n      </div>\n    </div>;\n  }\n}\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Clicker } from \"../../../common/models/clicker/clicker\";\nimport { Essence } from \"../../../common/models/essence/essence\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { VisualizationManifest } from \"../../../common/models/visualization-manifest/visualization-manifest\";\nimport { VisualizationSettings } from \"../../../common/models/visualization-settings/visualization-settings\";\nimport { classNames } from \"../../utils/dom/dom\";\nimport { BubbleMenu } from \"../bubble-menu/bubble-menu\";\nimport { VisSelectorItem } from \"./vis-selector-item\";\nimport { VisSelectorMenu } from \"./vis-selector-menu\";\nimport \"./vis-selector.scss\";\n\nexport interface VisSelectorProps {\n  clicker: Clicker;\n  essence: Essence;\n}\n\nexport interface VisSelectorState {\n  openMenu: boolean;\n}\n\nconst visSelectorMenuStage = Stage.fromSize(268, 176);\n\nexport class VisSelector extends React.Component<VisSelectorProps, VisSelectorState> {\n\n  private selector = React.createRef<HTMLDivElement>();\n\n  state: VisSelectorState = { openMenu: false };\n\n  openMenu = (e: React.MouseEvent<HTMLElement>) => {\n    const { openMenu } = this.state;\n    const target = e.currentTarget;\n    if (openMenu && this.selector.current === target) {\n      this.closeMenu();\n      return;\n    }\n    this.setState({\n      openMenu: true\n    });\n  };\n\n  closeMenu = () => this.setState({ openMenu: false });\n\n  changeVisualization = (vis: VisualizationManifest, settings: VisualizationSettings) => this.props.clicker.changeVisualization(vis, settings);\n\n  renderMenu() {\n    const { openMenu } = this.state;\n\n    if (!openMenu) return null;\n    const { essence } = this.props;\n    return <BubbleMenu\n      className=\"vis-selector-menu-container\"\n      direction=\"down\"\n      stage={visSelectorMenuStage}\n      openOn={this.selector.current}\n      onClose={this.closeMenu}\n    >\n      <VisSelectorMenu\n        initialVisualization={essence.visualization}\n        initialSettings={essence.visualizationSettings}\n        onClose={this.closeMenu}\n        onSelect={this.changeVisualization} />\n    </BubbleMenu>;\n  }\n\n  render() {\n    const { essence: { visualization } } = this.props;\n    const { openMenu } = this.state;\n\n    return <React.Fragment>\n      <div\n        ref={this.selector}\n        className={classNames(\"vis-selector\", { active: openMenu })}\n        onClick={this.openMenu}>\n        <VisSelectorItem visualization={visualization} selected={true} />\n      </div>\n      {this.renderMenu()}\n    </React.Fragment>;\n  }\n}\n","/*\n * Copyright 2017-2021 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Dataset } from \"plywood\";\nimport React from \"react\";\nimport {\n  DatasetRequest,\n  DatasetRequestStatus,\n  error,\n  isError,\n  isLoaded,\n  loaded,\n  loading\n} from \"../../../common/models/dataset-request/dataset-request\";\nimport { Essence } from \"../../../common/models/essence/essence\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Timekeeper } from \"../../../common/models/timekeeper/timekeeper\";\nimport { debounceWithPromise, Unary } from \"../../../common/utils/functional/functional\";\nimport { Loader } from \"../../components/loader/loader\";\nimport { QueryError } from \"../../components/query-error/query-error\";\nimport { reportError } from \"../../utils/error-reporter/error-reporter\";\nimport { VisualizationQuery } from \"../../views/cube-view/api-context\";\nimport { DownloadableDataset, DownloadableDatasetContext } from \"../../views/cube-view/downloadable-dataset-context\";\n\ninterface DataProviderProps {\n  refreshRequestTimestamp: number;\n  essence: Essence;\n  timekeeper: Timekeeper;\n  stage: Stage;\n  query: VisualizationQuery;\n  children: Unary<Dataset, React.ReactNode>;\n}\n\ninterface DataProviderState {\n  dataset: DatasetRequest;\n}\n\nexport class DataProvider extends React.Component<DataProviderProps, DataProviderState> {\n  static contextType = DownloadableDatasetContext;\n  context: DownloadableDataset;\n\n  state: DataProviderState = { dataset: loading };\n\n  private lastQueryEssence: Essence = null;\n\n  componentDidMount() {\n    const { essence } = this.props;\n    this.loadData(essence);\n  }\n\n  componentWillUnmount() {\n    this.lastQueryEssence = null;\n    this.debouncedCallExecutor.cancel();\n  }\n\n  UNSAFE_componentWillReceiveProps(nextProps: DataProviderProps) {\n    if (this.shouldFetchData(nextProps) && this.visualisationNotResized(nextProps)) {\n      const { essence } = nextProps;\n      const hadDataLoaded = isLoaded(this.state.dataset);\n      const essenceChanged = !essence.equals(this.props.essence);\n      this.loadData(essence, hadDataLoaded && essenceChanged);\n    }\n  }\n\n  private loadData(essence: Essence, showSpinner = true) {\n    if (showSpinner) this.handleDatasetLoad(loading);\n    this.fetchData(essence)\n      .then(loadedDataset => {\n        // TODO: encode it better\n        // null is here when we get out of order request, so we just ignore it\n        if (!loadedDataset) return;\n        if (isError(loadedDataset)) {\n          this.handleDatasetLoad(loadedDataset);\n        }\n        if (isLoaded(loadedDataset)) {\n          this.handleDatasetLoad(loadedDataset);\n        }\n      });\n  }\n\n  private fetchData(essence: Essence): Promise<DatasetRequest | null> {\n    this.lastQueryEssence = essence;\n    return this.debouncedCallExecutor(essence);\n  }\n\n  private callExecutor = (essence: Essence): Promise<DatasetRequest | null> =>\n    this.props.query(essence)\n      .then((dataset: Dataset) => {\n          // signal out of order requests with null\n          if (!this.wasUsedForLastQuery(essence)) return null;\n          return loaded(dataset);\n        },\n        err => {\n          // signal out of order requests with null\n          if (!this.wasUsedForLastQuery(essence)) return null;\n          reportError(err);\n          return error(err);\n        });\n\n  private wasUsedForLastQuery(essence: Essence) {\n    return essence.equals(this.lastQueryEssence);\n  }\n\n  private debouncedCallExecutor = debounceWithPromise(this.callExecutor, 500);\n\n  private handleDatasetLoad(dataset: DatasetRequest) {\n    this.setState({ dataset });\n    const { setDataset } = this.context;\n    setDataset(isLoaded(dataset) ? dataset.dataset : null);\n  }\n\n  protected shouldFetchData(nextProps: DataProviderProps): boolean {\n    return this.differentVisualizationDefinition(nextProps);\n  }\n\n  private differentVisualizationDefinition(nextProps: DataProviderProps) {\n    const { essence, timekeeper } = this.props;\n    const nextEssence = nextProps.essence;\n    const nextTimekeeper = nextProps.timekeeper;\n    return nextEssence.differentDataCube(essence) ||\n      nextEssence.differentEffectiveFilter(essence, timekeeper, nextTimekeeper) ||\n      nextEssence.differentTimeShift(essence) ||\n      nextEssence.differentSplits(essence) ||\n      nextEssence.differentSeries(essence) ||\n      nextEssence.differentSettings(essence) ||\n      this.differentBucketingTimezone(nextEssence) ||\n      this.differentLastRefreshRequestTimestamp(nextProps);\n  }\n\n  private differentBucketingTimezone(newEssence: Essence): boolean {\n    const { essence } = this.props;\n    return !essence.timezone.equals(newEssence.timezone) && newEssence.splits.hasSplitOn(essence.getTimeDimension());\n  }\n\n  private differentLastRefreshRequestTimestamp({ refreshRequestTimestamp }: DataProviderProps): boolean {\n    return refreshRequestTimestamp !== this.props.refreshRequestTimestamp;\n  }\n\n  private visualisationNotResized(nextProps: DataProviderProps): boolean {\n    return this.props.stage.equals(nextProps.stage);\n  }\n\n  render() {\n    const { children } = this.props;\n    const { dataset } = this.state;\n    switch (dataset.status) {\n      case DatasetRequestStatus.LOADING:\n        return <Loader/>;\n      case DatasetRequestStatus.ERROR:\n        return <QueryError error={dataset.error}/>;\n      case DatasetRequestStatus.LOADED:\n        return children(dataset.dataset);\n    }\n  }\n}\n","/*\n * Copyright 2017-2021 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { ChartProps } from \"../../../../common/models/chart-props/chart-props\";\nimport { Clicker } from \"../../../../common/models/clicker/clicker\";\nimport { ClientCustomization } from \"../../../../common/models/customization/customization\";\nimport { Dimension } from \"../../../../common/models/dimension/dimension\";\nimport { DragPosition } from \"../../../../common/models/drag-position/drag-position\";\nimport { Essence } from \"../../../../common/models/essence/essence\";\nimport { Series } from \"../../../../common/models/series/series\";\nimport { Stage } from \"../../../../common/models/stage/stage\";\nimport { Timekeeper } from \"../../../../common/models/timekeeper/timekeeper\";\nimport { Binary, Omit, Unary } from \"../../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../../common/utils/general/general\";\nimport { DropIndicator } from \"../../../components/drop-indicator/drop-indicator\";\nimport { FilterTilesRow } from \"../../../components/filter-tile/filter-tiles-row\";\nimport { ManualFallback } from \"../../../components/manual-fallback/manual-fallback\";\nimport { SeriesTilesRow } from \"../../../components/series-tile/series-tiles-row\";\nimport {\n  DefaultSplitTilesRow,\n  SplitTilesRowBaseProps\n} from \"../../../components/split-tile/split-tiles-row\";\nimport { VisSelector } from \"../../../components/vis-selector/vis-selector\";\nimport VisualizationControlsLayout from \"../../../components/visualization-controls-layout/visualization-controls-layout\";\nimport { classNames } from \"../../../utils/dom/dom\";\nimport { DataProvider } from \"../../../visualizations/data-provider/data-provider\";\nimport { HighlightController } from \"../../../visualizations/highlight-controller/highlight-controller\";\nimport { ApiContext } from \"../api-context\";\nimport { PartialFilter, PartialSeries } from \"../partial-tiles-provider\";\n\nexport interface VisualizationControlsBaseProps {\n  essence: Essence;\n  clicker: Clicker;\n  stage: Stage;\n  timekeeper: Timekeeper;\n  customization: ClientCustomization;\n  addSeries: Binary<Series, DragPosition, void>;\n  addFilter: Binary<Dimension, DragPosition, void>;\n  partialSeries: PartialSeries | null;\n  partialFilter: PartialFilter | null;\n  removeTile: Fn;\n}\n\ninterface VisualizationControlsProps extends VisualizationControlsBaseProps {\n  splitTilesRow: React.ComponentType<SplitTilesRowBaseProps>;\n}\n\nexport const DefaultVisualizationControls: React.FunctionComponent<VisualizationControlsBaseProps> = props => {\n  return <VisualizationControls {...props} splitTilesRow={DefaultSplitTilesRow}/>;\n};\n\nexport const VisualizationControls: React.FunctionComponent<VisualizationControlsProps> = props => {\n  const {\n    splitTilesRow: SplitTilesRow,\n    addSeries,\n    addFilter,\n    clicker,\n    essence,\n    customization,\n    timekeeper,\n    stage,\n    partialSeries,\n    partialFilter,\n    removeTile\n  } = props;\n  return <VisualizationControlsLayout\n    tiles={\n      <>\n        <FilterTilesRow\n          locale={customization.locale}\n          timekeeper={timekeeper}\n          menuStage={stage}\n          partialFilter={partialFilter}\n          removePartialFilter={removeTile}\n          addPartialFilter={addFilter}\n        />\n        <SplitTilesRow\n          clicker={clicker}\n          essence={essence}\n          menuStage={stage}\n        />\n        <SeriesTilesRow\n          removePartialSeries={removeTile}\n          partialSeries={partialSeries}\n          menuStage={stage}\n          addPartialSeries={addSeries}/>\n      </>\n    }\n    selector={\n      <VisSelector clicker={clicker} essence={essence}/>}/>;\n};\n\ninterface ChartPanelProps {\n  essence: Essence;\n  clicker: Clicker;\n  stage: Stage;\n  chartComponent: React.ComponentType<ChartProps>;\n  timekeeper: Timekeeper;\n  lastRefreshRequestTimestamp: number;\n  dragEnter: Unary<React.DragEvent<HTMLElement>, void>;\n  dragOver: Unary<React.DragEvent<HTMLElement>, void>;\n  isDraggedOver: boolean;\n  dragLeave: Fn;\n  drop: Unary<React.DragEvent<HTMLElement>, void>;\n}\n\nexport const ChartPanel: React.FunctionComponent<ChartPanelProps> = props => {\n  const {\n    chartComponent,\n    essence,\n    clicker,\n    timekeeper,\n    lastRefreshRequestTimestamp,\n    stage,\n    isDraggedOver,\n    dragOver,\n    dragEnter,\n    dragLeave,\n    drop\n  } = props;\n  return <div\n    className=\"center-main\"\n    onDragEnter={dragEnter}\n  >\n    <div className=\"visualization\">\n      <ChartWrapper\n        chartComponent={chartComponent}\n        essence={essence}\n        clicker={clicker}\n        timekeeper={timekeeper}\n        lastRefreshRequestTimestamp={lastRefreshRequestTimestamp}\n        stage={stage}/>\n    </div>\n    {isDraggedOver && <React.Fragment>\n      <DropIndicator/>\n      <div\n        className=\"drag-mask\"\n        onDragOver={dragOver}\n        onDragLeave={dragLeave}\n        onDragExit={dragLeave}\n        onDrop={drop}\n      />\n    </React.Fragment>\n    }\n  </div>;\n};\n\ntype ChartWrapperProps = Pick<ChartPanelProps,\n  \"timekeeper\" |\n  \"essence\" |\n  \"clicker\" |\n  \"stage\" |\n  \"lastRefreshRequestTimestamp\" |\n  \"chartComponent\">;\n\nfunction ChartWrapper(props: ChartWrapperProps) {\n  const {\n    chartComponent: ChartComponent,\n    essence,\n    clicker,\n    timekeeper,\n    stage,\n    lastRefreshRequestTimestamp\n  } = props;\n  if (essence.visResolve.isManual()) {\n    return <ManualFallback clicker={clicker} essence={essence}/>;\n  }\n\n  return <HighlightController essence={essence} clicker={clicker}>\n    {highlightProps =>\n      <ApiContext.Consumer>\n        {({ visualizationQuery }) =>\n          <DataProvider\n            refreshRequestTimestamp={lastRefreshRequestTimestamp}\n            query={visualizationQuery}\n            essence={essence}\n            timekeeper={timekeeper}\n            stage={stage}>\n            {data => <div className={classNames(\"visualization-root\", essence.visualization.name)}>\n              <ChartComponent\n                data={data}\n                clicker={clicker}\n                essence={essence}\n                timekeeper={timekeeper}\n                stage={stage}\n                {...highlightProps} />\n            </div>}\n          </DataProvider>}\n      </ApiContext.Consumer>\n    }\n  </HighlightController>;\n}\n\ntype VisualizationPanelProps = ChartPanelProps & VisualizationControlsBaseProps;\nexport type VisualizationProps = Omit<VisualizationPanelProps, \"chartComponent\" | \"queryFactory\">;\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\n\ninterface WithRefProps {\n  children: Unary<{ ref?: Element, setRef: Unary<Element, void> }, JSX.Element>;\n}\n\ninterface WithRefState {\n  ref?: Element;\n}\n\nexport class WithRef extends React.Component<WithRefProps, WithRefState> {\n  state: WithRefState = {};\n\n  setRef = (ref: Element) => this.setState({ ref });\n\n  render() {\n    const setRef = this.setRef;\n    const { ref } = this.state;\n    return this.props.children({ ref, setRef });\n  }\n}\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { identity, Omit } from \"../../../common/utils/functional/functional\";\nimport { InputWithPresets, InputWithPresetsProps } from \"./input-with-presets\";\n\ntype StringInputWithPresetsProps = Omit<InputWithPresetsProps<string>, \"parseCustomValue\" | \"formatCustomValue\">;\n\nexport const StringInputWithPresets: React.FunctionComponent<StringInputWithPresetsProps> = props =>\n  <InputWithPresets<string> {...props} parseCustomValue={identity} formatCustomValue={identity} />;\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Dimension, isContinuous } from \"../../../common/models/dimension/dimension\";\nimport { ContinuousDimensionKind, formatGranularity, getGranularities, granularityToString, validateGranularity } from \"../../../common/models/granularity/granularity\";\nimport { Bucket } from \"../../../common/models/split/split\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { STRINGS } from \"../../config/constants\";\nimport { StringInputWithPresets } from \"../input-with-presets/string-input-with-presets\";\n\nexport interface GranularityPickerProps {\n  dimension: Dimension;\n  granularity: string;\n  granularityChange: Unary<string, void>;\n}\n\nexport const GranularityPicker: React.FunctionComponent<GranularityPickerProps> = ({ dimension, granularity, granularityChange }) => {\n  if (!isContinuous(dimension)) return null;\n\n  const granularities = dimension.granularities || getGranularities(dimension.kind as ContinuousDimensionKind, dimension.bucketedBy);\n  const presets = granularities.map((g: Bucket) => {\n    return {\n      name: formatGranularity(g),\n      identity: granularityToString(g)\n    };\n  });\n\n  const placeholder = dimension.kind === \"time\" ? STRINGS.floorableDurationsExamples : \"Bucket size\";\n\n  return <StringInputWithPresets\n    title={STRINGS.granularity}\n    selected={granularity}\n    errorMessage={validateGranularity(dimension.kind, granularity)}\n    onChange={granularityChange}\n    placeholder={placeholder}\n    presets={presets} />;\n};\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { STRINGS } from \"../../config/constants\";\nimport { Dropdown } from \"../dropdown/dropdown\";\n\nfunction formatLimit(limit: number): string {\n  return limit === null ? \"None\" : String(limit);\n}\n\n// TODO: Review again when fixing time split menu in #756\nfunction calculateLimits(limits: number[], includeNone: boolean) {\n  if (!includeNone) return limits;\n  return [...limits, null];\n}\n\nexport interface LimitDropdownProps {\n  selectedLimit: number;\n  limits: number[];\n  includeNone: boolean;\n  onLimitSelect: Unary<number, void>;\n}\n\nexport const LimitDropdown: React.FunctionComponent<LimitDropdownProps> = ({ onLimitSelect, limits, selectedLimit, includeNone }) => {\n  return <Dropdown<number | string>\n    label={STRINGS.limit}\n    items={calculateLimits(limits, includeNone)}\n    selectedItem={selectedLimit}\n    renderItem={formatLimit}\n    onSelect={onLimitSelect}\n  />;\n};\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { SortOn } from \"../../../common/models/sort-on/sort-on\";\nimport { Sort, SortDirection } from \"../../../common/models/sort/sort\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { STRINGS } from \"../../config/constants\";\nimport { Dropdown } from \"../dropdown/dropdown\";\nimport { SvgIcon } from \"../svg-icon/svg-icon\";\n\nexport interface SortDropdownProps {\n  direction: SortDirection;\n  selected: SortOn;\n  options: SortOn[];\n  onChange: Unary<Sort, void>;\n}\n\nexport const SortDropdown: React.FunctionComponent<SortDropdownProps> = ({ direction, options, selected, onChange }) => {\n\n  function toggleDirection() {\n    const newDirection = direction === SortDirection.descending ? SortDirection.ascending : SortDirection.descending;\n    onChange(selected.toSort(newDirection));\n  }\n\n  function selectSort(sortOn: SortOn) {\n    onChange(sortOn.toSort(direction));\n  }\n\n  return <div className=\"sort-direction\">\n    <Dropdown<SortOn>\n      label={STRINGS.sortBy}\n      items={options}\n      selectedItem={selected}\n      equal={SortOn.equals}\n      renderItem={SortOn.getTitle}\n      keyItem={SortOn.getKey}\n      onSelect={selectSort}\n    />\n    <div className={\"direction \" + direction} onClick={toggleDirection}>\n      <SvgIcon svg={require(\"../../icons/sort-arrow.svg\")} />\n    </div>\n  </div>;\n};\n","/*\n * Copyright 2017-2021 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Dimension } from \"../../../common/models/dimension/dimension\";\nimport { coerceGranularity, isGranularityValid } from \"../../../common/models/granularity/granularity\";\nimport { Sort } from \"../../../common/models/sort/sort\";\nimport { Split } from \"../../../common/models/split/split\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { STRINGS } from \"../../config/constants\";\nimport { enterKey } from \"../../utils/dom/dom\";\nimport { BubbleMenu } from \"../bubble-menu/bubble-menu\";\nimport { Button } from \"../button/button\";\n\ninterface SplitAssembly {\n  dimension: Dimension;\n  split: Split;\n  granularity?: string;\n  limit?: number;\n  sort?: Sort;\n}\n\nexport function validateSplit(splitAssembly: SplitAssembly): boolean {\n  const { granularity, split, dimension: { kind } } = splitAssembly;\n  if (!isGranularityValid(kind, granularity)) {\n    return false;\n  }\n  const newSplit = createSplit(splitAssembly);\n  return !split.equals(newSplit);\n}\n\nexport function createSplit({\n                              split: { type, reference },\n                              limit,\n                              granularity,\n                              sort,\n                              dimension: { kind }\n                            }: SplitAssembly): Split {\n  const bucket = coerceGranularity(granularity, kind);\n  return new Split({ type, reference, limit, sort, bucket });\n}\n\ninterface SplitMenuBaseProps {\n  openOn: Element;\n  containerStage: Stage;\n  onClose: Fn;\n  onSave: Fn;\n  dimension: Dimension;\n  isValid: boolean;\n}\n\nexport class SplitMenuBase extends React.Component<SplitMenuBaseProps> {\n\n  componentDidMount() {\n    window.addEventListener(\"keydown\", this.globalKeyDownListener);\n  }\n\n  componentWillUnmount() {\n    window.removeEventListener(\"keydown\", this.globalKeyDownListener);\n  }\n\n  globalKeyDownListener = (e: KeyboardEvent) => enterKey(e) && this.onOkClick();\n\n  onCancelClick = () => this.props.onClose();\n\n  onOkClick = () => {\n    const { isValid, onSave, onClose } = this.props;\n    if (!isValid) return;\n    onSave();\n    onClose();\n  };\n\n  render() {\n    const { containerStage, openOn, dimension, onClose, children, isValid } = this.props;\n    if (!dimension) return null;\n\n    return <BubbleMenu\n      className=\"split-menu\"\n      direction=\"down\"\n      containerStage={containerStage}\n      stage={Stage.fromSize(250, 240)}\n      openOn={openOn}\n      onClose={onClose}\n    >\n      {children}\n      <div className=\"button-bar\">\n        <Button className=\"ok\" type=\"primary\" disabled={!isValid} onClick={this.onOkClick} title={STRINGS.ok}/>\n        <Button type=\"secondary\" onClick={this.onCancelClick} title={STRINGS.cancel}/>\n      </div>\n    </BubbleMenu>;\n  }\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Dimension } from \"../../../common/models/dimension/dimension\";\nimport { allDimensions } from \"../../../common/models/dimension/dimensions\";\nimport { Essence } from \"../../../common/models/essence/essence\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { AddTile } from \"../add-tile/add-tile\";\n\ninterface AddSplitProps {\n  appendSplit: Unary<Dimension, void>;\n  menuStage: Stage;\n  essence: Essence;\n}\n\nexport const AddSplit: React.FunctionComponent<AddSplitProps> = props => {\n  const { appendSplit, menuStage, essence: { dataCube, splits } } = props;\n  const tiles = allDimensions(dataCube.dimensions)\n    .filter(d => splits.findSplitForDimension(d) === undefined)\n    .map(dimension => {\n      return {\n        key: dimension.name,\n        label: dimension.title,\n        value: dimension\n      };\n    });\n\n  return <AddTile<Dimension>\n    containerStage={menuStage}\n    onSelect={appendSplit}\n    tiles={tiles} />;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { findDimensionByName } from \"../../../common/models/dimension/dimensions\";\nimport { Essence } from \"../../../common/models/essence/essence\";\nimport { Split } from \"../../../common/models/split/split\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Binary, Ternary, Unary } from \"../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { transformStyle } from \"../../utils/dom/dom\";\nimport { SECTION_WIDTH } from \"../../utils/pill-tile/pill-tile\";\nimport { TileOverflowContainer } from \"../tile-overflow-container/tile-overflow-container\";\nimport { SplitTileBaseProps } from \"./split-tile\";\n\ninterface SplitTilesProps {\n  essence: Essence;\n  openedSplit: Split;\n  removeSplit: Unary<Split, void>;\n  updateSplit: Binary<Split, Split, void>;\n  openMenu: Unary<Split, void>;\n  closeMenu: Fn;\n  dragStart: Ternary<string, Split, React.DragEvent<HTMLElement>, void>;\n  menuStage: Stage;\n  maxItems: number;\n  overflowOpen: boolean;\n  closeOverflowMenu: Fn;\n  openOverflowMenu: Fn;\n  splitTileComponent: React.ComponentType<SplitTileBaseProps>;\n}\n\nexport const SplitTiles: React.FunctionComponent<SplitTilesProps> = props => {\n  const {\n    splitTileComponent: SplitTile,\n    overflowOpen,\n    closeOverflowMenu,\n    openOverflowMenu,\n    essence,\n    maxItems,\n    removeSplit,\n    updateSplit,\n    openedSplit,\n    openMenu,\n    closeMenu,\n    dragStart,\n    menuStage\n  } = props;\n\n  const splits = essence.splits.splits.toArray();\n\n  const splitTiles = splits.map(split => {\n    const dimension = findDimensionByName(essence.dataCube.dimensions, split.reference);\n    return <SplitTile\n      key={split.toKey()}\n      split={split}\n      dimension={dimension}\n      removeSplit={removeSplit}\n      updateSplit={updateSplit}\n      open={split.equals(openedSplit)}\n      openMenu={openMenu}\n      closeMenu={closeMenu}\n      dragStart={dragStart}\n      containerStage={menuStage}\n      essence={essence} />;\n  });\n\n  const visibleSplits = splitTiles\n    .slice(0, maxItems)\n    .map((el, idx) => React.cloneElement(el, { style: transformStyle(idx * SECTION_WIDTH, 0) }));\n\n  const overflowSplits = splitTiles.slice(maxItems);\n\n  if (overflowSplits.length <= 0) {\n    return <React.Fragment>{visibleSplits}</React.Fragment>;\n  }\n\n  const anyOverflowTileOpen = splits.slice(maxItems).some(split => split.equals(openedSplit));\n  const overflowOpened = overflowOpen || anyOverflowTileOpen;\n\n  const splitOverflow = <TileOverflowContainer\n    className=\"dimension\"\n    key=\"overflow-menu\"\n    items={overflowSplits}\n    open={overflowOpened}\n    openOverflowMenu={openOverflowMenu}\n    closeOverflowMenu={closeOverflowMenu}\n    x={visibleSplits.length * SECTION_WIDTH} />;\n\n  return <React.Fragment>\n    {[...visibleSplits, splitOverflow]}\n  </React.Fragment>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Clicker } from \"../../../common/models/clicker/clicker\";\nimport { Dimension } from \"../../../common/models/dimension/dimension\";\nimport { findDimensionByName } from \"../../../common/models/dimension/dimensions\";\nimport { DragPosition } from \"../../../common/models/drag-position/drag-position\";\nimport { Essence, VisStrategy } from \"../../../common/models/essence/essence\";\nimport { Split } from \"../../../common/models/split/split\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { CORE_ITEM_GAP, CORE_ITEM_WIDTH, STRINGS } from \"../../config/constants\";\nimport { getXFromEvent, setDragData, setDragGhost } from \"../../utils/dom/dom\";\nimport { DraggedElementType, DragManager } from \"../../utils/drag-manager/drag-manager\";\nimport { getMaxItems } from \"../../utils/pill-tile/pill-tile\";\nimport { DragIndicator } from \"../drag-indicator/drag-indicator\";\nimport { AddSplit } from \"./add-split\";\nimport { DefaultSplitTile, SplitTileBaseProps } from \"./split-tile\";\nimport { SplitTiles } from \"./split-tiles\";\n\nexport interface SplitTilesRowBaseProps {\n  clicker: Clicker;\n  essence: Essence;\n  menuStage: Stage;\n}\n\ninterface SplitTilesRowProps extends SplitTilesRowBaseProps {\n  splitTileComponent: React.ComponentType<SplitTileBaseProps>;\n}\n\ninterface SplitTilesRowState {\n  dragPosition?: DragPosition;\n  openedSplit?: Split;\n  overflowOpen?: boolean;\n}\n\nexport const DefaultSplitTilesRow: React.FunctionComponent<SplitTilesRowBaseProps> = props =>\n  <SplitTilesRow {...props} splitTileComponent={DefaultSplitTile} />;\n\nexport class SplitTilesRow extends React.Component<SplitTilesRowProps, SplitTilesRowState> {\n  private items = React.createRef<HTMLDivElement>();\n\n  state: SplitTilesRowState = {};\n\n  private maxItems(): number {\n    const { menuStage, essence: { splits: { splits } } } = this.props;\n    return menuStage && getMaxItems(menuStage.width, splits.count());\n  }\n\n  openMenu = (split: Split) => this.setState({ openedSplit: split });\n\n  closeMenu = () => this.setState({ openedSplit: null });\n\n  openOverflowMenu = () => this.setState({ overflowOpen: true });\n\n  closeOverflowMenu = () => this.setState({ overflowOpen: false });\n\n  updateSplit = (oldSplit: Split, split: Split) => {\n    const { essence, clicker } = this.props;\n    clicker.changeSplits(essence.splits.replace(oldSplit, split), VisStrategy.UnfairGame);\n  };\n\n  removeSplit = (split: Split) => {\n    const { clicker } = this.props;\n    clicker.removeSplit(split, VisStrategy.FairGame);\n    this.closeOverflowMenu();\n  };\n\n  canDrop(): boolean {\n    const { essence: { splits, dataCube } } = this.props;\n    switch (DragManager.dragging.type) {\n      case DraggedElementType.DIMENSION:\n        return !splits.hasSplitOn(DragManager.draggingDimension());\n      case DraggedElementType.FILTER:\n        const dimension = findDimensionByName(dataCube.dimensions, DragManager.draggingFilter().reference);\n        return !splits.hasSplitOn(dimension);\n      case DraggedElementType.SPLIT:\n        return true;\n      case DraggedElementType.MEASURE:\n        return false;\n      case DraggedElementType.SERIES:\n        return false;\n      case DraggedElementType.NONE:\n        return false;\n    }\n  }\n\n  dragStart = (label: string, split: Split, e: React.DragEvent<HTMLElement>) => {\n    const dataTransfer = e.dataTransfer;\n    dataTransfer.effectAllowed = \"all\";\n    setDragData(dataTransfer, \"text/plain\", label);\n\n    DragManager.setDragSplit(split);\n    setDragGhost(dataTransfer, label);\n\n    this.closeOverflowMenu();\n  };\n\n  calculateDragPosition(e: React.DragEvent<HTMLElement>): DragPosition {\n    const { essence } = this.props;\n    const numItems = essence.splits.length();\n    const rect = this.items.current.getBoundingClientRect();\n    const x = getXFromEvent(e);\n    const offset = x - rect.left;\n    const position = DragPosition.calculateFromOffset(offset, numItems, CORE_ITEM_WIDTH, CORE_ITEM_GAP);\n    if (position.replace === this.maxItems()) {\n      return new DragPosition({ insert: position.replace });\n    }\n    return position;\n  }\n\n  dragEnter = (e: React.DragEvent<HTMLElement>) => {\n    if (!this.canDrop()) return;\n    e.preventDefault();\n    this.setState({\n      dragPosition: this.calculateDragPosition(e)\n    });\n  };\n\n  dragOver = (e: React.DragEvent<HTMLElement>) => {\n    if (!this.canDrop()) return;\n    e.preventDefault();\n    const dragPosition = this.calculateDragPosition(e);\n    if (dragPosition.equals(this.state.dragPosition)) return;\n    this.setState({ dragPosition });\n  };\n\n  dragLeave = () => {\n    if (!this.canDrop()) return;\n    this.setState({\n      dragPosition: null\n    });\n  };\n\n  draggingSplit(): Split {\n    const { essence: { dataCube } } = this.props;\n\n    switch (DragManager.dragging.type) {\n      case DraggedElementType.DIMENSION:\n        return Split.fromDimension(DragManager.draggingDimension());\n      case DraggedElementType.FILTER:\n        const dimension = findDimensionByName(dataCube.dimensions, DragManager.draggingFilter().reference);\n        return Split.fromDimension(dimension);\n      case DraggedElementType.SPLIT:\n        return DragManager.draggingSplit();\n    }\n    throw new Error(`Expected Dimension, Filter or Split, got ${DragManager.dragging.type}`);\n  }\n\n  drop = (e: React.DragEvent<HTMLElement>) => {\n    if (!this.canDrop()) return;\n    e.preventDefault();\n    this.setState({ dragPosition: null });\n\n    const split = this.draggingSplit();\n    if (!split) return;\n\n    const position = this.calculateDragPosition(e);\n\n    if (position.isReplace()) {\n      if (position.replace === this.maxItems()) {\n        this.insertSplit(split, position.replace);\n      } else {\n        this.replaceSplit(split, position.replace);\n      }\n    } else {\n      this.insertSplit(split, position.insert);\n    }\n  };\n\n  appendSplit = (dimension: Dimension) => {\n    this.props.clicker.addSplit(Split.fromDimension(dimension), VisStrategy.FairGame);\n  };\n\n  insertSplit = (split: Split, index: number) => {\n    const { clicker, essence: { splits } } = this.props;\n    clicker.changeSplits(splits.insertByIndex(index, split), VisStrategy.FairGame);\n  };\n\n  replaceSplit = (split: Split, index: number) => {\n    const { clicker, essence: { splits } } = this.props;\n    clicker.changeSplits(splits.replaceByIndex(index, split), VisStrategy.FairGame);\n  };\n\n  render() {\n    const { essence, menuStage, splitTileComponent } = this.props;\n    const { dragPosition, overflowOpen, openedSplit } = this.state;\n    return <div className=\"tile-row split-tile-row\" onDragEnter={this.dragEnter}>\n      <div className=\"title\">{STRINGS.split}</div>\n      <div className=\"items\" ref={this.items}>\n        <SplitTiles\n          essence={essence}\n          splitTileComponent={splitTileComponent}\n          openedSplit={openedSplit}\n          removeSplit={this.removeSplit}\n          updateSplit={this.updateSplit}\n          openMenu={this.openMenu}\n          closeMenu={this.closeMenu}\n          dragStart={this.dragStart}\n          menuStage={menuStage}\n          maxItems={this.maxItems()}\n          overflowOpen={overflowOpen}\n          closeOverflowMenu={this.closeOverflowMenu}\n          openOverflowMenu={this.openOverflowMenu} />\n      </div>\n      <DragIndicator dragOver={this.dragOver} dragLeave={this.dragLeave} drop={this.drop} dragPosition={dragPosition} />\n      <AddSplit appendSplit={this.appendSplit} menuStage={menuStage} essence={essence} />\n    </div>;\n  }\n}\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { CORE_ITEM_GAP } from \"../../config/constants\";\nimport { classNames, transformStyle } from \"../../utils/dom/dom\";\nimport { BubbleMenu } from \"../bubble-menu/bubble-menu\";\nimport { WithRef } from \"../with-ref/with-ref\";\n\ninterface TileOverflowContainerMenuProps {\n  items: JSX.Element[];\n  openOn: Element;\n  closeOverflowMenu: Fn;\n}\n\nconst SEGMENT_HEIGHT = 29 + CORE_ITEM_GAP;\n\nconst TileOverflowContainerMenu: React.FunctionComponent<TileOverflowContainerMenuProps> = props => {\n  const { items, openOn, closeOverflowMenu } = props;\n\n  const positionedItems = items.map((item, idx) =>\n    React.cloneElement(item, { style: transformStyle(0, CORE_ITEM_GAP + idx * SEGMENT_HEIGHT) }));\n\n  return <BubbleMenu\n    className=\"overflow-menu\"\n    direction=\"down\"\n    stage={Stage.fromSize(208, CORE_ITEM_GAP + (items.length * SEGMENT_HEIGHT))}\n    fixedSize={true}\n    openOn={openOn}\n    onClose={closeOverflowMenu}\n  >\n    {positionedItems}\n  </BubbleMenu>;\n};\n\ninterface TileOverflowContainerProps {\n  className: string;\n  x: number;\n  items: JSX.Element[];\n  open: boolean;\n  openOverflowMenu: Fn;\n  closeOverflowMenu: Fn;\n}\n\nexport const TileOverflowContainer: React.FunctionComponent<TileOverflowContainerProps> = props => {\n  const { x, items, open, openOverflowMenu, className, closeOverflowMenu } = props;\n\n  const style = transformStyle(x, 0);\n  return <WithRef>\n    {({ ref: openOn, setRef }) => <React.Fragment>\n      <div\n        className={classNames(\"overflow\", className)}\n        style={style}\n        ref={setRef}\n        onClick={openOverflowMenu}>\n        <div className=\"count\">{\"+\" + items.length}</div>\n      </div>\n      {open && openOn && <TileOverflowContainerMenu\n        openOn={openOn}\n        items={items}\n        closeOverflowMenu={closeOverflowMenu} />}\n    </React.Fragment>}\n  </WithRef>;\n};\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Dimension, isContinuous } from \"../../../common/models/dimension/dimension\";\nimport { Essence } from \"../../../common/models/essence/essence\";\nimport { granularityToString } from \"../../../common/models/granularity/granularity\";\nimport { DimensionSortOn, SortOn } from \"../../../common/models/sort-on/sort-on\";\nimport { Sort } from \"../../../common/models/sort/sort\";\nimport { Split } from \"../../../common/models/split/split\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Binary } from \"../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { GranularityPicker } from \"./granularity-picker\";\nimport { LimitDropdown } from \"./limit-dropdown\";\nimport { SortDropdown } from \"./sort-dropdown\";\nimport { createSplit, SplitMenuBase, validateSplit } from \"./split-menu-base\";\nimport \"./split-menu.scss\";\n\nexport interface SplitMenuProps {\n  essence: Essence;\n  saveSplit: Binary<Split, Split, void>;\n  openOn: Element;\n  containerStage: Stage;\n  onClose: Fn;\n  dimension: Dimension;\n  split: Split;\n}\n\nexport interface SplitMenuState {\n  granularity?: string;\n  sort?: Sort;\n  limit?: number;\n}\n\nexport class SplitMenu extends React.Component<SplitMenuProps, SplitMenuState> {\n\n  state: SplitMenuState = {};\n\n  UNSAFE_componentWillMount() {\n    const { split } = this.props;\n    const { bucket, sort, limit } = split;\n\n    this.setState({\n      sort,\n      limit,\n      granularity: bucket && granularityToString(bucket)\n    });\n  }\n\n  saveGranularity = (granularity: string) => this.setState({ granularity });\n\n  saveSort = (sort: Sort) => this.setState({ sort });\n\n  saveLimit = (limit: number) => this.setState({ limit });\n\n  saveSplit = () => {\n    const { split, saveSplit } = this.props;\n    saveSplit(split, this.createSplit());\n  };\n\n  private createSplit(): Split {\n    const { split, dimension } = this.props;\n    const { limit, sort, granularity } = this.state;\n    return createSplit({ split, dimension, limit, sort, granularity });\n  }\n\n  validate() {\n    const { dimension, split } = this.props;\n    const { limit, sort, granularity } = this.state;\n    return validateSplit({ split, dimension, limit, sort, granularity });\n  }\n\n  render() {\n    const { essence, containerStage, openOn, dimension, onClose } = this.props;\n    const { granularity, sort, limit } = this.state;\n\n    const seriesSortOns = essence.seriesSortOns(true).toArray();\n    const options = [new DimensionSortOn(dimension), ...seriesSortOns];\n    const selected = SortOn.fromSort(sort, essence);\n\n    return <SplitMenuBase\n      openOn={openOn}\n      containerStage={containerStage}\n      onClose={onClose}\n      onSave={this.saveSplit}\n      dimension={dimension}\n      isValid={this.validate()}>\n      <GranularityPicker\n        dimension={dimension}\n        granularityChange={this.saveGranularity}\n        granularity={granularity}\n      />\n      <SortDropdown\n        direction={sort.direction}\n        selected={selected}\n        options={options}\n        onChange={this.saveSort}\n      />\n      <LimitDropdown\n        onLimitSelect={this.saveLimit}\n        selectedLimit={limit}\n        includeNone={isContinuous(dimension)}\n        limits={dimension.limits}/>\n    </SplitMenuBase>;\n  }\n}\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Dimension } from \"../../../common/models/dimension/dimension\";\nimport { Essence } from \"../../../common/models/essence/essence\";\nimport { Split } from \"../../../common/models/split/split\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Binary, Ternary, Unary } from \"../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { SplitMenu, SplitMenuProps } from \"../split-menu/split-menu\";\nimport { SvgIcon } from \"../svg-icon/svg-icon\";\nimport { WithRef } from \"../with-ref/with-ref\";\n\nexport interface SplitTileBaseProps {\n  essence: Essence;\n  split: Split;\n  dimension: Dimension;\n  open: boolean;\n  style?: React.CSSProperties;\n  removeSplit: Unary<Split, void>;\n  updateSplit: Binary<Split, Split, void>;\n  openMenu: Unary<Split, void>;\n  closeMenu: Fn;\n  dragStart: Ternary<string, Split, React.DragEvent<HTMLElement>, void>;\n  containerStage: Stage;\n}\n\ninterface SplitTileProps extends SplitTileBaseProps {\n  splitMenuComponent: React.ComponentType<SplitMenuProps>;\n}\n\nexport const DefaultSplitTile: React.FunctionComponent<SplitTileBaseProps> = props => {\n  return <SplitTile {...props} splitMenuComponent={SplitMenu} />;\n};\n\nexport const SplitTile: React.FunctionComponent<SplitTileProps> = props => {\n  const { splitMenuComponent: SplitMenu, essence, open, split, dimension, style, removeSplit, updateSplit, openMenu, closeMenu, dragStart, containerStage } = props;\n\n  const title = split.getTitle(dimension);\n\n  const remove = (e: React.MouseEvent<HTMLElement>) => {\n    e.stopPropagation();\n    removeSplit(split);\n  };\n\n  return <WithRef>\n    {({ ref: openOn, setRef }) => <React.Fragment>\n      <div\n        className=\"tile dimension\"\n        key={split.toKey()}\n        ref={setRef}\n        draggable={true}\n        onClick={() => openMenu(split)}\n        onDragStart={e => dragStart(dimension.title, split, e)}\n        style={style}\n        title={title}\n      >\n        <div className=\"reading\">{title}</div>\n        <div className=\"remove\"\n             onClick={remove}>\n          <SvgIcon svg={require(\"../../icons/x.svg\")} />\n        </div>\n      </div>\n      {open && openOn && <SplitMenu\n        saveSplit={updateSplit}\n        essence={essence}\n        openOn={openOn}\n        containerStage={containerStage}\n        onClose={closeMenu}\n        dimension={dimension}\n        split={split} />}\n    </React.Fragment>}\n  </WithRef>;\n};\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { DragPosition } from \"../../../common/models/drag-position/drag-position\";\nimport { CORE_ITEM_GAP, CORE_ITEM_WIDTH } from \"../../config/constants\";\nimport { SvgIcon } from \"../svg-icon/svg-icon\";\nimport \"./fancy-drag-indicator.scss\";\n\nexport interface FancyDragIndicatorProps {\n  dragPosition: DragPosition;\n}\n\nexport interface FancyDragIndicatorState {\n}\n\nexport class FancyDragIndicator extends React.Component<FancyDragIndicatorProps, FancyDragIndicatorState> {\n\n  render() {\n    const { dragPosition } = this.props;\n    if (!dragPosition) return null;\n\n    const sectionWidth = CORE_ITEM_WIDTH + CORE_ITEM_GAP;\n\n    let ghostArrowLeft: number;\n    let dragGhostElement: JSX.Element = null;\n    if (dragPosition.isInsert()) {\n      ghostArrowLeft = dragPosition.insert * sectionWidth - CORE_ITEM_GAP / 2;\n    } else {\n      ghostArrowLeft = dragPosition.replace * sectionWidth + CORE_ITEM_WIDTH / 2;\n      const left = dragPosition.replace * sectionWidth;\n      dragGhostElement = <div className=\"drag-ghost-element\" style={{ left }} />;\n    }\n\n    return <div className=\"fancy-drag-indicator\">\n      {dragGhostElement}\n      <SvgIcon className=\"drag-ghost-arrow\" svg={require(\"../../icons/drag-arrow.svg\")} style={{ left: ghostArrowLeft }} />\n    </div>;\n  }\n}\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { DragPosition } from \"../../../common/models/drag-position/drag-position\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { FancyDragIndicator } from \"./fancy-drag-indicator\";\n\ninterface DragIndicatorProps {\n  drop: Unary<React.DragEvent<HTMLElement>, void>;\n  dragLeave: Fn;\n  dragOver: Unary<React.DragEvent<HTMLElement>, void>;\n  dragPosition?: DragPosition;\n}\n\nexport const DragIndicator: React.FunctionComponent<DragIndicatorProps> = props => {\n  const { dragPosition, dragOver, drop, dragLeave } = props;\n  if (!dragPosition) return null;\n  return <React.Fragment>\n    <FancyDragIndicator dragPosition={dragPosition} />\n    <div className=\"drag-mask\"\n         onDragOver={dragOver}\n         onDragLeave={dragLeave}\n         onDragExit={dragLeave}\n         onDrop={drop} />\n  </React.Fragment>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport \"./message-card.scss\";\n\ninterface MessageCardProps {\n  title: string;\n}\n\nexport const MessageCard: React.FunctionComponent<MessageCardProps> = props => {\n  const { title, children } = props;\n  return <div className=\"message-card\">\n    <div className=\"message-card-title\">{title}</div>\n    {children}\n  </div>;\n};\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { BubbleMenu } from \"../bubble-menu/bubble-menu\";\nimport { ClearableInput } from \"../clearable-input/clearable-input\";\nimport { HighlightString } from \"../highlight-string/highlight-string\";\nimport { SvgIcon } from \"../svg-icon/svg-icon\";\nimport \"./add-tile.scss\";\n\nexport interface Tile<T> {\n  key: string;\n  label: string;\n  value: T;\n}\n\ninterface AddTileProps<T> {\n  tiles: Array<Tile<T>>;\n  onSelect: Unary<T, void>;\n  containerStage: Stage;\n}\n\ninterface AddTileState {\n  openMenu: boolean;\n  query: string;\n}\n\nexport class AddTile<T> extends React.Component<AddTileProps<T>, AddTileState> {\n\n  state: AddTileState = { openMenu: false, query: \"\" };\n\n  private menuOpenOn: HTMLElement = null;\n\n  mountAdd = (addButton: HTMLElement) => {\n    this.menuOpenOn = addButton;\n  };\n\n  closeMenu = () => this.setState({ openMenu: false });\n\n  openMenu = () => this.setState({ openMenu: true });\n\n  setQuery = (query: string) => this.setState({ query });\n\n  resetQuery = () => this.setQuery(\"\");\n\n  selectTile = (value: T) => {\n    this.props.onSelect(value);\n    this.resetQuery();\n    this.closeMenu();\n  };\n\n  renderRows(rows: Array<Tile<T>>) {\n    const { query } = this.state;\n    return rows.map(({ value, key, label }) => <div\n      className=\"tile-row\"\n      key={key}\n      onClick={() => this.selectTile(value)}>\n      <HighlightString className=\"label\" text={label} highlight={query} />\n    </div>);\n  }\n\n  renderTable() {\n    const { tiles } = this.props;\n    const { query } = this.state;\n    if (query.length === 0) return this.renderRows(tiles);\n    const filteredRows = tiles.filter(({ label }) =>\n      label.toLowerCase().includes(query.toLowerCase()));\n    if (filteredRows.length > 0) return this.renderRows(filteredRows);\n    return <div className=\"tile-row no-results\">\n      No results for {query}\n    </div>;\n  }\n\n  renderMenu() {\n    const { containerStage } = this.props;\n    const { openMenu, query } = this.state;\n    if (!openMenu) return null;\n\n    return <BubbleMenu\n      className=\"add-tile-menu\"\n      direction=\"down\"\n      stage={Stage.fromSize(250, 410)}\n      containerStage={containerStage}\n      openOn={this.menuOpenOn}\n      onClose={this.closeMenu}>\n      <div className=\"search-box\">\n        <ClearableInput\n          placeholder=\"Search\"\n          focusOnMount={true}\n          value={query}\n          onChange={this.setQuery} />\n      </div>\n      <div className=\"tile-rows\">\n        {this.renderTable()}\n      </div>\n    </BubbleMenu>;\n  }\n\n  render() {\n    return <div className=\"add-tile\">\n      <div className=\"add-button\" ref={this.mountAdd} onClick={this.openMenu}>\n        <SvgIcon svg={require(\"../../icons/preview-subsplit.svg\")} />\n      </div>\n      {this.renderMenu()}\n    </div>;\n  }\n}\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { classNames } from \"../../utils/dom/dom\";\nimport \"./button-group.scss\";\n\nexport interface GroupMember {\n  title: string;\n  onClick: Fn;\n  key: string | number;\n  className?: string;\n  isSelected?: boolean;\n}\n\nexport interface ButtonGroupProps {\n  groupMembers: GroupMember[];\n  title?: string;\n  className?: string;\n}\n\nexport interface ButtonGroupState {\n}\n\nexport class ButtonGroup extends React.Component<ButtonGroupProps, ButtonGroupState> {\n\n  renderMembers() {\n    const { groupMembers } = this.props;\n    return groupMembers.map(button => {\n      return <li\n        className={classNames(\"group-member\", button.className, { selected: button.isSelected })}\n        key={button.key}\n        onClick={button.onClick}\n      >\n        {button.title}\n      </li>;\n    });\n  }\n\n  render() {\n    const { title, className } = this.props;\n\n    return <div className={classNames(\"button-group\", className)}>\n      {title ? <div className=\"button-group-title\">{title}</div> : null}\n      <ul className=\"group-container\">{this.renderMembers()}</ul>\n    </div>;\n  }\n}\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { List } from \"immutable\";\nimport { FilterClause } from \"../../../common/models/filter-clause/filter-clause\";\n\nexport class Highlight {\n  constructor(public readonly clauses: List<FilterClause>, public readonly key: string | null) {\n  }\n}\n","/*\n * Copyright 2017-2021 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { List } from \"immutable\";\nimport React from \"react\";\nimport { ReactNode } from \"react\";\nimport { Clicker } from \"../../../common/models/clicker/clicker\";\nimport { Essence } from \"../../../common/models/essence/essence\";\nimport { FilterClause } from \"../../../common/models/filter-clause/filter-clause\";\nimport { Binary, Nullary, Unary } from \"../../../common/utils/functional/functional\";\nimport { Highlight } from \"./highlight\";\n\ninterface HighlightProps {\n  dropHighlight: Nullary<void>;\n  acceptHighlight: Nullary<void>;\n  highlight: Highlight | null;\n  saveHighlight: Binary<List<FilterClause>, string | null, void>;\n}\n\ninterface HighlightControllerProps {\n  essence: Essence;\n  clicker: Clicker;\n  children: Unary<HighlightProps, ReactNode>;\n}\n\ninterface HighlightControllerState {\n  highlight: Highlight | null;\n}\n\nexport function hasHighlightOn(highlight: Highlight | null, key: string): boolean {\n  if (!highlight) return false;\n  return highlight.key === key;\n}\n\nexport class HighlightController extends React.Component<HighlightControllerProps, HighlightControllerState> {\n  state: HighlightControllerState = { highlight: null };\n\n  private dropHighlight = () => this.setState({ highlight: null });\n\n  private acceptHighlight = () => {\n    const { highlight } = this.state;\n    if (highlight === null) return;\n    const { essence, clicker } = this.props;\n    clicker.changeFilter(essence.filter.mergeClauses(highlight.clauses));\n    this.setState({ highlight: null });\n  };\n\n  private saveHighlight = (clauses: List<FilterClause>, key: string | null = null) => {\n    const highlight = new Highlight(clauses, key);\n    this.setState({ highlight });\n  };\n\n  render() {\n    const { children } = this.props;\n    const { highlight } = this.state;\n    const highlightProps = {\n      dropHighlight: this.dropHighlight,\n      acceptHighlight: this.acceptHighlight,\n      saveHighlight: this.saveHighlight,\n      highlight\n    };\n    return children(highlightProps);\n  }\n}\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { classNames } from \"../../utils/dom/dom\";\nimport { ButtonGroup, GroupMember } from \"../button-group/button-group\";\nimport \"./input-with-presets.scss\";\n\nexport interface Preset<T> {\n  name: string;\n  identity: T;\n}\n\nexport interface InputWithPresetsProps<T> {\n  presets: Array<Preset<T>>;\n  selected?: T;\n  onChange: Unary<T, void>;\n  errorMessage?: string;\n  placeholder?: string;\n  title?: string;\n  parseCustomValue: Unary<string, T>;\n  formatCustomValue: Unary<T, string>;\n}\n\ninterface InputWithPresetsState {\n  customPicked: boolean;\n  customValue: string;\n}\n\nexport class InputWithPresets<T> extends React.Component<InputWithPresetsProps<T>, InputWithPresetsState> {\n\n  initialState(): InputWithPresetsState {\n    const { selected, presets, formatCustomValue } = this.props;\n    const isPresetPicked = presets.some(({ identity }) => identity === selected);\n    const customPicked = selected !== undefined && !isPresetPicked;\n    const customValue = customPicked ? formatCustomValue(selected) : \"\";\n    return { customPicked, customValue };\n  }\n\n  state = this.initialState();\n\n  customValueUpdate = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const { onChange, parseCustomValue } = this.props;\n    const customValue = e.currentTarget.value;\n    onChange(parseCustomValue(customValue));\n    this.setState({ customValue });\n  };\n\n  pickCustom = () => {\n    const { onChange, parseCustomValue } = this.props;\n    this.setState({ customPicked: true });\n    onChange(parseCustomValue(this.state.customValue));\n  };\n\n  pickPreset = (value: T) => {\n    const { onChange } = this.props;\n    this.setState({ customPicked: false });\n    onChange(value);\n  };\n\n  render() {\n    const { errorMessage, selected, presets, placeholder, title, parseCustomValue } = this.props;\n    const { customPicked, customValue } = this.state;\n\n    const presetButtons = presets.map(({ name, identity }) => ({\n      key: String(identity),\n      title: name,\n      isSelected: !customPicked && identity === selected,\n      onClick: () => this.pickPreset(identity)\n    }));\n\n    const customSelected = customPicked && selected === parseCustomValue(customValue);\n\n    const customButton: GroupMember = {\n      key: \"custom\",\n      title: \"\",\n      onClick: this.pickCustom,\n      isSelected: customSelected\n    };\n\n    const members = [...presetButtons, customButton];\n\n    const renderErrorMessage = customSelected && errorMessage && customValue.length > 0;\n\n    return <React.Fragment>\n      <ButtonGroup title={title} groupMembers={members} />\n      {customSelected && <input type=\"text\"\n                                className={classNames(\"custom-input\", { invalid: errorMessage })}\n                                placeholder={placeholder}\n                                value={customValue}\n                                onChange={this.customValueUpdate} />}\n      {renderErrorMessage && <span className=\"error-message\">{errorMessage}</span>}\n    </React.Fragment>;\n  }\n}\n"],"sourceRoot":""}