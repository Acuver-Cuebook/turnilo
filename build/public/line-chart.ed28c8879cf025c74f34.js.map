{"version":3,"sources":["webpack:///./src/client/utils/dataset/selectors/selectors.ts","webpack:///./src/client/visualizations/line-chart/utils/splits.ts","webpack:///./src/client/components/bubble-title/bubble-title.tsx","webpack:///./src/client/utils/linear-scale/linear-scale.ts","webpack:///./src/client/components/series-bubble-content/series-bubble-content.tsx","webpack:///./src/client/components/modal-bubble/modal-bubble.tsx","webpack:///./src/client/components/highlight-modal/highlight-modal.tsx","webpack:///./src/client/components/segment-bubble/segment-bubble.tsx","webpack:///./src/client/components/measure-bubble-content/measure-bubble-content.tsx","webpack:///./src/client/components/grid-lines/grid-lines.tsx","webpack:///./src/client/utils/highlight-clause/highlight-clause.ts","webpack:///./src/client/visualizations/line-chart/utils/is-valid-clause.ts","webpack:///./src/client/components/color-swabs/color-entry.tsx","webpack:///./src/client/components/vis-measure-label/vis-measure-label.tsx","webpack:///./src/client/components/vertical-axis/vertical-axis.tsx","webpack:///./src/client/components/color-swabs/color-swabs.tsx","webpack:///./src/client/utils/extent/extent.ts","webpack:///./src/client/components/tooltip-within-stage/calculate-position.ts","webpack:///./src/client/components/tooltip-within-stage/tooltip-within-stage.tsx","webpack:///./src/client/components/timeseries-visualization-controls/split-menu.tsx","webpack:///./src/client/components/timeseries-visualization-controls/visualization-controls.tsx","webpack:///./src/client/components/grid-border/grid-border.tsx","webpack:///./src/client/components/highlighter/highlighter.tsx","webpack:///./src/client/visualizations/line-chart/legend/legend.tsx","webpack:///./src/client/visualizations/line-chart/legend/split-legend.tsx","webpack:///./src/client/visualizations/line-chart/charts/calculate-chart-stage.ts","webpack:///./src/client/visualizations/line-chart/interactions/interaction.ts","webpack:///./src/client/utils/mouse-event-offset/mouse-event-offset.ts","webpack:///./src/client/visualizations/line-chart/base-chart/background/background.tsx","webpack:///./src/client/visualizations/line-chart/base-chart/foreground/highlight-modal.tsx","webpack:///./src/client/visualizations/line-chart/base-chart/foreground/hover-tooltip.tsx","webpack:///./src/client/visualizations/line-chart/interactions/continuous-range.ts","webpack:///./src/client/visualizations/line-chart/base-chart/foreground/selection-overlay.tsx","webpack:///./src/client/visualizations/line-chart/base-chart/foreground/foreground.tsx","webpack:///./src/client/visualizations/line-chart/base-chart/foreground/hover-guide.tsx","webpack:///./src/client/visualizations/line-chart/base-chart/base-chart.tsx","webpack:///./src/client/visualizations/line-chart/chart-line/prepare-data-points.ts","webpack:///./src/client/visualizations/line-chart/chart-line/chart-line.tsx","webpack:///./src/client/visualizations/line-chart/chart-line/series-chart-line.tsx","webpack:///./src/client/visualizations/line-chart/chart-line/colored-series-chart-line.tsx","webpack:///./src/client/visualizations/line-chart/chart-line/singleton-series-chart-line.tsx","webpack:///./src/client/visualizations/line-chart/charts/charts-per-series/series-hover-content.tsx","webpack:///./src/client/visualizations/line-chart/charts/charts-per-series/series-chart.tsx","webpack:///./src/client/visualizations/line-chart/utils/extent.ts","webpack:///./src/client/visualizations/line-chart/charts/charts-per-series/charts-per-series.tsx","webpack:///./src/client/visualizations/line-chart/legend/series-legend.tsx","webpack:///./src/client/visualizations/line-chart/charts/charts-per-split/label.tsx","webpack:///./src/client/visualizations/line-chart/charts/charts-per-split/split-hover-content.tsx","webpack:///./src/client/visualizations/line-chart/charts/charts-per-split/split-chart.tsx","webpack:///./src/client/visualizations/line-chart/charts/charts-per-split/charts-per-split.tsx","webpack:///./src/client/visualizations/line-chart/charts/charts-per-split/nominal-value-key.ts","webpack:///./src/client/visualizations/line-chart/charts/charts.tsx","webpack:///./src/client/visualizations/line-chart/interactions/find-closest-datum.ts","webpack:///./src/client/visualizations/line-chart/interactions/snap-range-to-grid.ts","webpack:///./src/client/visualizations/line-chart/interactions/interaction-controller.tsx","webpack:///./src/client/visualizations/line-chart/utils/pick-x-axis-ticks.ts","webpack:///./src/client/visualizations/line-chart/utils/x-scale.ts","webpack:///./src/common/utils/plywood/range.ts","webpack:///./src/client/visualizations/line-chart/x-axis/x-axis.tsx","webpack:///./src/client/visualizations/line-chart/line-chart.tsx"],"names":["selectMainDatum","dataset","data","selectSplitDataset","datum","SPLIT","selectDatums","selectSplitDatums","compose","selectFirstSplitDataset","selectFirstSplitDatums","dimensionForSplit","essence","split","findDimensionByName","dataCube","dimensions","reference","getContinuousSplit","splits","last","getContinuousDimension","getContinuousReference","getNominalSplit","count","first","hasNominalSplit","getNominalDimension","BubbleTitle","title","minWidth","clamp","length","className","style","pickTicks","scale","ticksCount","ticks","filter","n","getScale","height","min","max","isNaN","d3","domain","Math","nice","range","SeriesBubbleContent","props","series","showPrevious","Fragment","formatValue","currentValue","selectValue","previousValue","SeriesDerivation","PREVIOUS","formatter","lowerIsBetter","measure","current","previous","ModalBubble","el","modalRef","e","target","isInside","onClose","this","children","left","top","mouseDown","onMouseDown","classNames","ref","setModalRef","direction","React","Component","HighlightModal","acceptHighlight","dropHighlight","type","onClick","STRINGS","select","cancel","SegmentBubble","content","SegmentBubbleContent","MeasureBubbleContent","GridLines","orientation","stage","transform","getTransform","map","tick","value","roundToHalfPx","coordinates","x1","x2","width","y1","y2","lineCoordinates","key","String","toFilterClause","TimeRange","isTimeRange","dateRange","DateRange","values","List","of","FixedTimeFilterClause","PlywoodNumberRange","isNumberRange","numberRange","NumberRange","NumberFilterClause","Error","toPlywoodRange","clause","isValidClause","Range","fromJS","createColorEntry","color","name","hasComparison","delta","VisMeasureLabel","CURRENT","renderPrevious","VerticalAxis","tickSize","inputTicks","topLineExtend","hideZero","lines","y","labelX","labels","x","dy","ColorSwabs","colorSwabs","colorEntries","swabStyle","background","seriesSelectors","get","d","readNumber","datumsExtent","datums","selectors","reduce","acc","selector","extent","calculatePosition","rect","initialTop","initialLeft","margin","stageBottom","stageRight","bottom","right","TooltipWithinStage","createRef","setState","self","getBoundingClientRect","state","TimeSeriesContinuousSplitMenu","saveSplit","containerStage","dimension","openOn","useState","bucket","granularityToString","granularity","setGranularity","isValid","validateSplit","onSave","newSplit","createSplit","granularityChange","TimeSeriesCategorySplitMenu","sortOptions","DimensionSortOn","seriesSortOns","toArray","useSettingsContext","customization","visualizationColors","limitOptions","useMemo","colorSplitLimits","sort","setSort","limit","setLimit","selected","SortOn","fromSort","options","onChange","selectedLimit","limits","includeNone","onLimitSelect","TimeSeriesSplitMenu","equals","TimeSeriesSplitTile","splitMenuComponent","TimeSeriesSplitTilesRow","splitTileComponent","TimeSeriesVisualizationControls","splitTilesRow","BottomBorder","tickLength","RightBorder","Highlighter","whiteoutLeftStyle","frameStyle","whiteoutRightStyle","LegendValues","i","Legend","SplitLegend","legendSplit","legendDimension","getTitle","calculateChartStage","chartsCount","VIS_H_PADDING","maxHeightFromRatio","heightFromStageDivision","boundedChartHeight","floor","Stage","InteractionKind","mouseEventOffset","event","element","currentTarget","cx","clientX","cy","clientY","window","createHover","kind","HOVER","isHover","interaction","createDragging","start","end","DRAGGING","isDragging","isHighlight","HIGHLIGHT","Background","gridStage","axisStage","xScale","yScale","xTicks","timezone","midpoint","HoverTooltip","constructRange","a","b","shiftByOne","orderValues","Date","second","shift","SelectionOverlay","getHighlightRange","getLeftTopWidthHeight","Foreground","container","visualisationStage","hoverContent","HoverGuide","hover","offsetX","BaseChart","interactions","yDomain","chartStage","chartId","label","mouseLeave","dragStart","handleHover","xRange","lineStage","within","hasInteraction","getWidthHeight","viewBox","getViewBox","onMouseMove","onMouseLeave","areDetached","valueOf","nextMidpoint","rangeWidth","previousMidpoint","prepareDataPoints","getX","getY","flatMap","index","maybeY","concatTruthy","currentIndex","shouldInsertPreviousPoint","next","shouldInsertNextPoint","ChartLine","mainColor","main","dashed","showArea","area","y0","line","points","scaledPoints","hasMultiplePoints","hasSinglePoint","stroke","strokeDasharray","undefined","fill","alphaMain","r","SeriesChartLine","reactKey","ColoredSeriesChartLine","SingletonSeriesChartLine","nominalSplit","continuousRef","hoverDatum","dimensionName","findDatumByAttribute","findSplitDatumByAttribute","SeriesHoverContent","entries","continuousDimension","measureLabel","SeriesChart","continuousSplitDataset","continuousSplit","getters","splitDataset","extentAcrossSplits","splitKey","plywoodKey","ChartsPerSeries","concreteSeries","getConcreteSeries","SeriesLegend","Label","nominalDimension","splitValue","formatSegment","ColoredSeries","SplitHoverContent","SplitChart","selectDatum","splitDatum","s","extentAcrossSeries","firstSeries","defaultFormatter","ChartsPerSplit","hasMultipleSeries","getNthDatum","getChartsSelectors","nominalValueKey","Charts","visualizationSettings","groupSeries","findClosest","scaleX","closestDatum","minDist","Infinity","continuousSegmentValue","isRange","mid","dist","abs","distPx","roundTo","v","round","snapRangeToGrid","duration","bucketSize","startFloored","endFloored","InteractionController","scrollTop","offset","hoverRange","findRangeUnderOffset","findValueUnderOffset","calculateOffset","saveHighlight","scrollEvent","chartsContainerRef","invert","flatten","findClosestDatum","highlight","clauses","createHighlight","hocProps","handleDragStart","mouseUp","stopDragging","mouseMove","dragging","scroll","scrollCharts","pickXAxisTicks","materialize","generateDateTicks","getBestBucketUnitForRange","sequence","generateNumberTicks","getFilterRange","timekeeper","continuousFilterClause","getEffectiveFilter","clauseForReference","filterRange","maxTime","continuousBucket","Duration","filterRangeEnd","filterRangeEndFloored","filterRangeEndCeiled","includeMaxTimeBucket","getMaxTime","safeRangeSum","extend","calculateXRange","datasetRange","getDatasetXRange","union","floatFormat","XAxis","fromSize","format","scaleTicksFormatter","date","getMoment","labelFormatter","TICK_HEIGHT","textAnchor","LineChartVisualization","chartComponent","LineChart","LINE_CHART_MANIFEST","domainRange","createContinuousScale","maxHeight","chartsRef","changeHeight"],"mappings":"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","file":"line-chart.ed28c8879cf025c74f34.js","sourcesContent":["/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Dataset, Datum } from \"plywood\";\nimport { compose } from \"../../../../common/utils/functional/functional\";\nimport { SPLIT } from \"../../../config/constants\";\n\nexport const selectMainDatum = (dataset: Dataset): Datum =>\n  dataset.data[0];\n\nexport const selectSplitDataset = (datum: Datum): Dataset =>\n  datum[SPLIT] as Dataset;\n\nexport const selectDatums = (dataset: Dataset): Datum[] =>\n  dataset.data;\n\nexport const selectSplitDatums: (datum: Datum) => Datum[] =\n  compose(selectSplitDataset, selectDatums);\n\nexport const selectFirstSplitDataset: (dataset: Dataset) => Dataset =\n  compose(selectMainDatum, selectSplitDataset);\n\nexport const selectFirstSplitDatums: (dataset: Dataset) => Datum[] =\n  compose(selectFirstSplitDataset, selectDatums);\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Dimension } from \"../../../../common/models/dimension/dimension\";\nimport { findDimensionByName } from \"../../../../common/models/dimension/dimensions\";\nimport { Essence } from \"../../../../common/models/essence/essence\";\nimport { Split } from \"../../../../common/models/split/split\";\n\nfunction dimensionForSplit(essence: Essence, split: Split): Dimension {\n   return findDimensionByName(essence.dataCube.dimensions, split.reference);\n}\n\nexport function getContinuousSplit({ splits: { splits } }: Essence): Split {\n   return splits.last();\n}\n\nexport function getContinuousDimension(essence: Essence): Dimension {\n   const split = getContinuousSplit(essence);\n   return dimensionForSplit(essence, split);\n}\n\nexport function getContinuousReference(essence: Essence): string {\n   return getContinuousSplit(essence).reference;\n}\n\nexport function getNominalSplit({ splits: { splits } }: Essence): Split | null {\n   return splits.count() === 1 ? null : splits.first();\n}\n\nexport function hasNominalSplit(essence: Essence): boolean {\n   return getNominalSplit(essence) !== null;\n}\n\nexport function getNominalDimension(essence: Essence): Dimension | null {\n   const split = getNominalSplit(essence);\n   return split && dimensionForSplit(essence, split);\n}\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { clamp } from \"../../utils/dom/dom\";\n\nconst PER_LETTER_PIXELS = 8;\nconst MIN_TITLE_WIDTH = 80;\nconst MAX_TITLE_WIDTH = 300;\n\ninterface BubbleTitleProps {\n  title: string;\n}\n\nexport const BubbleTitle: React.FunctionComponent<BubbleTitleProps> = ({ title }) => {\n  const minWidth = clamp(title.length * PER_LETTER_PIXELS, MIN_TITLE_WIDTH, MAX_TITLE_WIDTH);\n  return <div className=\"title\" style={{ minWidth }}>{title}</div>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as d3 from \"d3\";\n\nexport type LinearScale = d3.ScaleLinear<number, number>;\n\nexport const TICKS_COUNT = 5;\n\nexport function pickTicks(scale: LinearScale, ticksCount = TICKS_COUNT): number[] {\n  return scale.ticks(ticksCount).filter(n => n !== 0);\n}\n\nexport default function getScale([min, max]: number[], height: number): LinearScale | null {\n  if (isNaN(min) || isNaN(max)) {\n    return null;\n  }\n\n  return d3.scaleLinear()\n    .domain([Math.min(min, 0), Math.max(max, 0)])\n    .nice(TICKS_COUNT)\n    .range([height, 0]);\n}\n","/*\n * Copyright 2017-2020 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Datum } from \"plywood\";\nimport React from \"react\";\nimport { ConcreteSeries, SeriesDerivation } from \"../../../common/models/series/concrete-series\";\nimport { MeasureBubbleContent } from \"../measure-bubble-content/measure-bubble-content\";\n\ninterface SeriesBubbleContentProps {\n  series: ConcreteSeries;\n  datum: Datum;\n  showPrevious: boolean;\n}\n\nexport const SeriesBubbleContent: React.FunctionComponent<SeriesBubbleContentProps> = props => {\n  const { series, datum, showPrevious } = props;\n  if (!showPrevious) {\n    return <React.Fragment>\n      {series.formatValue(datum)}\n    </React.Fragment>;\n  }\n  const currentValue = series.selectValue(datum);\n  const previousValue = series.selectValue(datum, SeriesDerivation.PREVIOUS);\n  const formatter = series.formatter();\n  return <MeasureBubbleContent\n    lowerIsBetter={series.measure.lowerIsBetter}\n    formatter={formatter}\n    current={currentValue}\n    previous={previousValue}\n  />;\n};\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { classNames, isInside } from \"../../utils/dom/dom\";\nimport { BodyPortal } from \"../body-portal/body-portal\";\nimport { GlobalEventListener } from \"../global-event-listener/global-event-listener\";\nimport { Shpitz } from \"../shpitz/shpitz\";\nimport \"./modal-bubble.scss\";\n\ninterface ModalProps {\n  left: number;\n  top: number;\n  onClose: Fn;\n  className?: string;\n}\n\nexport class ModalBubble extends React.Component<ModalProps, {}> {\n\n  modalRef: HTMLDivElement;\n\n  setModalRef = (el: HTMLDivElement) => {\n    this.modalRef = el;\n  };\n\n  onMouseDown = (e: MouseEvent) => {\n    const target = e.target as Element;\n    if (isInside(target, this.modalRef)) return;\n    this.props.onClose();\n  };\n\n  render() {\n    const { className, children, left, top } = this.props;\n    return <React.Fragment>\n      <GlobalEventListener mouseDown={this.onMouseDown} />\n      <BodyPortal left={left} top={top}>\n        <div className={classNames(\"modal-bubble\", className)} ref={this.setModalRef}>\n          {children}\n          <Shpitz direction=\"up\" />\n        </div>\n      </BodyPortal>\n    </React.Fragment>;\n  }\n}\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { STRINGS } from \"../../config/constants\";\nimport { BubbleTitle } from \"../bubble-title/bubble-title\";\nimport { Button } from \"../button/button\";\nimport { ModalBubble } from \"../modal-bubble/modal-bubble\";\nimport \"./highlight-modal.scss\";\n\ninterface HighlightModalProps {\n  title: string;\n  left: number;\n  top: number;\n  dropHighlight: Fn;\n  acceptHighlight: Fn;\n}\n\nexport const HighlightModal: React.FunctionComponent<HighlightModalProps> = ({ title, children, left, top, acceptHighlight, dropHighlight }) =>\n  <ModalBubble className=\"highlight-modal\" left={left} top={top} onClose={dropHighlight}>\n    <BubbleTitle title={title} />\n    <div className=\"value\">{children}</div>\n    <div className=\"actions\">\n      <Button type=\"primary\" className=\"accept mini\" onClick={acceptHighlight} title={STRINGS.select} />\n      <Button type=\"secondary\" className=\"drop mini\" onClick={dropHighlight} title={STRINGS.cancel} />\n    </div>\n  </ModalBubble>;\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { ReactNode } from \"react\";\nimport { BodyPortal } from \"../body-portal/body-portal\";\nimport { BubbleTitle } from \"../bubble-title/bubble-title\";\nimport { Shpitz } from \"../shpitz/shpitz\";\nimport \"./segment-bubble.scss\";\n\nconst OFFSET_V = -10;\n\nexport interface SegmentBubbleProps extends SegmentBubbleContentProps {\n  left: number;\n  top: number;\n}\n\nexport const SegmentBubble: React.FunctionComponent<SegmentBubbleProps> = (props: SegmentBubbleProps) => {\n  const { left, top, title, content } = props;\n  return <BodyPortal left={left} top={top + OFFSET_V}>\n    <div className=\"segment-bubble\">\n      <SegmentBubbleContent title={title} content={content} />\n      <Shpitz direction=\"up\" />\n    </div>\n  </BodyPortal>;\n};\n\nexport interface SegmentBubbleContentProps {\n  title: string;\n  content?: ReactNode;\n}\n\nexport const SegmentBubbleContent: React.FunctionComponent<SegmentBubbleContentProps> = ({ title, content }: SegmentBubbleContentProps) => (\n  <div className=\"segment-bubble-text\">\n    <BubbleTitle title={title} />\n    {content ? <div className=\"content\">{content}</div> : null}\n  </div>\n);\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { Delta } from \"../delta/delta\";\nimport \"./measure-bubble-content.scss\";\n\nexport interface MeasureBubbleContentProps {\n  current: number;\n  previous: number;\n  formatter: Unary<number, string>;\n  lowerIsBetter?: boolean;\n}\n\nexport const MeasureBubbleContent: React.FunctionComponent<MeasureBubbleContentProps> = ({ lowerIsBetter, formatter, current, previous }) => {\n  const currentValue = formatter(current);\n  const previousValue = formatter(previous);\n  return <React.Fragment>\n    <strong className=\"current-value\">{currentValue}</strong>\n    <span className=\"previous-value\">{previousValue}</span>\n    <Delta formatter={formatter} currentValue={current} previousValue={previous} lowerIsBetter={lowerIsBetter} />\n  </React.Fragment>;\n};\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { classNames, roundToHalfPx } from \"../../utils/dom/dom\";\nimport \"./grid-lines.scss\";\n\nexport interface GridLinesProps {\n  orientation: \"horizontal\" | \"vertical\";\n  stage: Stage;\n  ticks: unknown[];\n  scale: Unary<unknown, number>;\n}\n\ninterface Coordinates {\n  x1: number;\n  x2: number;\n  y1: number;\n  y2: number;\n}\n\nfunction lineCoordinates(orientation: \"horizontal\" | \"vertical\", value: number, stage: Stage): Coordinates {\n  switch (orientation) {\n    case \"horizontal\":\n      return { x1: 0, x2: stage.width, y1: value, y2: value };\n    case \"vertical\":\n      return { x1: value, x2: value, y1: 0, y2: stage.height };\n  }\n}\n\nexport const GridLines: React.FunctionComponent<GridLinesProps> = props => {\n  const { orientation, stage, ticks, scale } = props;\n\n  return <g className={classNames(\"grid-lines\", orientation)} transform={stage.getTransform()}>\n    {ticks.map((tick: unknown) => {\n      const value = roundToHalfPx(scale(tick));\n      const coordinates = lineCoordinates(orientation, value, stage);\n      return <line key={String(tick)} {...coordinates} />;\n    })}\n  </g>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { List } from \"immutable\";\nimport { NumberRange as PlywoodNumberRange, Range, TimeRange } from \"plywood\";\nimport { DateRange } from \"../../../common/models/date-range/date-range\";\nimport { FilterClause, FixedTimeFilterClause, NumberFilterClause, NumberRange } from \"../../../common/models/filter-clause/filter-clause\";\nimport { ContinuousRange } from \"../../visualizations/line-chart/utils/continuous-types\";\nimport { isValidClause } from \"../../visualizations/line-chart/utils/is-valid-clause\";\n\nexport function toFilterClause(range: ContinuousRange, reference: string): FilterClause {\n  if (TimeRange.isTimeRange(range)) {\n    const dateRange = new DateRange(range);\n    const values = List.of(dateRange);\n    return new FixedTimeFilterClause({ reference, values });\n  }\n  if (PlywoodNumberRange.isNumberRange(range)) {\n    const numberRange = new NumberRange(range);\n    const values = List.of(numberRange);\n    return new NumberFilterClause({ reference, values });\n  }\n  throw new Error(`Expected Number or Time range, got: ${range}`);\n}\n\nexport function toPlywoodRange(clause: FilterClause): ContinuousRange {\n  if (!isValidClause(clause)) {\n    throw new Error(`Expected Number or FixedTime Filter Clause. Got ${clause}`);\n  }\n  const value = clause.values.first();\n  return Range.fromJS(value) as ContinuousRange;\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { FilterClause, FixedTimeFilterClause, NumberFilterClause } from \"../../../../common/models/filter-clause/filter-clause\";\n\nexport function isValidClause(clause: FilterClause): clause is FixedTimeFilterClause | NumberFilterClause {\n  return (clause instanceof FixedTimeFilterClause) || (clause instanceof NumberFilterClause);\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Datum } from \"plywood\";\nimport React from \"react\";\nimport { ConcreteSeries, SeriesDerivation } from \"../../../common/models/series/concrete-series\";\nimport { Delta } from \"../delta/delta\";\n\nexport interface ColorEntry {\n  color: string;\n  name: string;\n  value: string;\n  previous?: string;\n  delta?: JSX.Element;\n}\n\ninterface Parameters {\n  color: string;\n  name: string;\n  series: ConcreteSeries;\n  datum: Datum;\n  hasComparison: boolean;\n}\n\nexport function createColorEntry({ color, name, series, datum, hasComparison }: Parameters): ColorEntry {\n  const current = {\n    color,\n    name,\n    value: series.formatValue(datum)\n  };\n\n  if (!hasComparison) return current;\n\n  return {\n    ...current,\n    previous: series.formatValue(datum, SeriesDerivation.PREVIOUS),\n    delta: <Delta\n      currentValue={series.selectValue(datum)}\n      previousValue={series.selectValue(datum, SeriesDerivation.PREVIOUS)}\n      lowerIsBetter={series.measure.lowerIsBetter}\n      formatter={series.formatter()} />\n  };\n}\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Datum } from \"plywood\";\nimport React from \"react\";\nimport { ConcreteSeries, SeriesDerivation } from \"../../../common/models/series/concrete-series\";\nimport { Delta } from \"../delta/delta\";\nimport \"./vis-measure-label.scss\";\n\nexport interface VisMeasureLabelProps {\n  series: ConcreteSeries;\n  datum: Datum;\n  showPrevious: boolean;\n}\n\nfunction renderPrevious(datum: Datum, series: ConcreteSeries): JSX.Element {\n  const current = series.selectValue(datum, SeriesDerivation.CURRENT);\n  const previous = series.selectValue(datum, SeriesDerivation.PREVIOUS);\n  const formatter = series.formatter();\n  return <React.Fragment>\n    <span className=\"measure-previous-value\">\n      {formatter(previous)}\n      </span>\n    <Delta\n      formatter={formatter}\n      lowerIsBetter={series.measure.lowerIsBetter}\n      currentValue={current}\n      previousValue={previous} />\n  </React.Fragment>;\n}\n\nexport const VisMeasureLabel: React.FunctionComponent<VisMeasureLabelProps> = ({ series, datum, showPrevious }) => {\n  return <div className=\"vis-measure-label\">\n    <span className=\"measure-title\">{series.title()}</span>\n    <span className=\"colon\">: </span>\n    <span className=\"measure-value\">{series.formatValue(datum)}</span>\n    {showPrevious && renderPrevious(datum, series)}\n  </div>;\n};\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { roundToHalfPx } from \"../../utils/dom/dom\";\nimport \"./vertical-axis.scss\";\n\nconst TEXT_OFFSET = 2;\n\nexport interface VerticalAxisProps {\n  stage: Stage;\n  ticks: number[];\n  tickSize: number;\n  scale: any;\n  formatter: Unary<number, string>;\n  topLineExtend?: number;\n  hideZero?: boolean;\n}\n\nexport const VerticalAxis: React.FunctionComponent<VerticalAxisProps> = ({ formatter, stage, tickSize, ticks: inputTicks, scale, topLineExtend = 0, hideZero }) => {\n  const ticks = hideZero ? inputTicks.filter((tick: number) => tick !== 0) : inputTicks;\n\n  const lines = ticks.map((tick: any) => {\n    const y = roundToHalfPx(scale(tick));\n    return <line className=\"tick\" key={String(tick)} x1={0} y1={y} x2={tickSize} y2={y} />;\n  });\n\n  const labelX = tickSize + TEXT_OFFSET;\n  const dy = \"0.31em\";\n\n  const labels = ticks.map((tick: any) => {\n    const y = scale(tick);\n    return <text className=\"tick\" key={String(tick)} x={labelX} y={y} dy={dy}>{formatter(tick)}</text>;\n  });\n\n  return <g className=\"vertical-axis\" transform={stage.getTransform()}>\n    <line className=\"border\" x1={0.5} y1={-topLineExtend} x2={0.5} y2={stage.height} />\n    {lines}\n    {labels}\n  </g>;\n};\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { ColorEntry } from \"./color-entry\";\nimport \"./color-swabs.scss\";\n\ninterface ColorSwabsProps {\n  colorEntries: ColorEntry[];\n}\n\nexport const ColorSwabs: React.FunctionComponent<ColorSwabsProps> = ({ colorEntries }) => {\n  const colorSwabs = colorEntries.map(({ color, name, value, previous, delta }: ColorEntry) => {\n    const swabStyle = { background: color };\n    return <tr key={name}>\n      <td>\n        <div className=\"color-swab\" style={swabStyle} />\n      </td>\n      <td className=\"color-name\">{name}</td>\n      <td className=\"color-value\">{value}</td>\n      {previous && <td className=\"color-previous\">{previous}</td>}\n      {delta && <td className=\"color-delta\">{delta}</td>}\n    </tr>;\n  });\n\n  return <table className=\"color-swabs\">\n    <tbody>{colorSwabs}</tbody>\n  </table>;\n};\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport * as d3 from \"d3\";\nimport { Datum } from \"plywood\";\nimport { ConcreteSeries, SeriesDerivation } from \"../../../common/models/series/concrete-series\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { readNumber } from \"../../../common/utils/general/general\";\n\nexport type Selector = Unary<Datum, number>;\nexport type Extent = [number, number];\n\nexport function seriesSelectors(series: ConcreteSeries, hasComparison: boolean): Selector[] {\n  const get = (d: Datum) => readNumber(series.selectValue(d));\n  if (!hasComparison) return [get];\n  return [\n    get,\n    (d: Datum) => readNumber(series.selectValue(d, SeriesDerivation.PREVIOUS))\n  ];\n}\n\nexport function datumsExtent(datums: Datum[], selectors: Selector[]): Extent {\n  return selectors.reduce((acc, selector) => {\n    const extent =  d3.extent(datums, selector);\n    return d3.extent([...extent, ...acc]);\n  }, [0, 0]) as Extent;\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { TooltipWithinStageProps } from \"./tooltip-within-stage\";\n\nexport type Rect = ClientRect | DOMRect;\n\nexport type Position = Pick<React.CSSProperties, \"left\" | \"top\">;\n\nexport function calculatePosition(props: TooltipWithinStageProps, rect?: Rect): Position {\n  const { top: initialTop, left: initialLeft, stage, margin = 10 } = props;\n  if (!rect) {\n    const top = initialTop + margin;\n    const left = initialLeft + margin;\n    return { top, left };\n  }\n\n  const stageBottom = stage.y + stage.height;\n  const stageRight = stage.x + stage.width;\n\n  const top = rect.bottom > stageBottom\n    ? initialTop - margin - rect.height\n    : rect.top < stage.y\n      ? initialTop + rect.height\n      : initialTop + margin;\n\n  const left = rect.right > stageRight\n    ? initialLeft - margin - rect.width\n    : rect.left < stage.x\n      ? initialLeft + rect.width\n      : initialLeft + margin;\n\n  return { top, left };\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { calculatePosition, Rect } from \"./calculate-position\";\nimport \"./tooltip-within-stage.scss\";\n\nexport interface TooltipWithinStageProps {\n  stage: Stage;\n  top: number;\n  left: number;\n  margin?: number;\n}\n\ninterface TooltipWithinStageState {\n  rect?: Rect;\n}\n\nexport class TooltipWithinStage extends React.Component<TooltipWithinStageProps, TooltipWithinStageState> {\n\n  private self = React.createRef<HTMLDivElement>();\n\n  state: TooltipWithinStageState = {};\n\n  componentDidMount() {\n    this.setState({\n      rect: this.self.current.getBoundingClientRect()\n    });\n  }\n\n  render() {\n    const { children } = this.props;\n    return <div\n      className=\"tooltip-within-stage\"\n      style={calculatePosition(this.props, this.state.rect)}\n      ref={this.self}>\n      {children}\n    </div>;\n  }\n}\n","/*\n * Copyright 2017-2022 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React, { useMemo, useState } from \"react\";\nimport { colorSplitLimits } from \"../../../common/models/colors/colors\";\nimport { granularityToString } from \"../../../common/models/granularity/granularity\";\nimport { DimensionSortOn, SortOn } from \"../../../common/models/sort-on/sort-on\";\nimport { useSettingsContext } from \"../../views/cube-view/settings-context\";\nimport { getContinuousSplit } from \"../../visualizations/line-chart/utils/splits\";\nimport { GranularityPicker } from \"../split-menu/granularity-picker\";\nimport { LimitDropdown } from \"../split-menu/limit-dropdown\";\nimport { SortDropdown } from \"../split-menu/sort-dropdown\";\nimport { SplitMenuProps } from \"../split-menu/split-menu\";\nimport { createSplit, SplitMenuBase, validateSplit } from \"../split-menu/split-menu-base\";\n\nconst TimeSeriesContinuousSplitMenu: React.FunctionComponent<SplitMenuProps> = props => {\n  const { saveSplit, containerStage, split, dimension, onClose, openOn } = props;\n  const [granularity, setGranularity] = useState(() => split.bucket && granularityToString(split.bucket));\n\n  const onSave = () => {\n    const newSplit = createSplit({\n      dimension,\n      split,\n      granularity\n    });\n    saveSplit(split, newSplit);\n  };\n\n  const isValid = validateSplit({ split, dimension, granularity });\n\n  return <SplitMenuBase\n    openOn={openOn}\n    containerStage={containerStage}\n    onClose={onClose}\n    onSave={onSave}\n    dimension={dimension}\n    isValid={isValid}>\n    <GranularityPicker\n      granularity={granularity}\n      dimension={dimension}\n      granularityChange={setGranularity}/>\n  </SplitMenuBase>;\n};\n\nconst TimeSeriesCategorySplitMenu: React.FunctionComponent<SplitMenuProps> = props => {\n  const { openOn, containerStage, onClose, dimension, saveSplit, split, essence } = props;\n\n  const sortOptions = [\n    new DimensionSortOn(dimension),\n    ...essence.seriesSortOns(true).toArray()\n  ];\n\n  const { customization: { visualizationColors: { series } } } = useSettingsContext();\n  const limitOptions = useMemo(() => colorSplitLimits(series.length), [series.length]);\n\n  const [sort, setSort] = useState(split.sort);\n  const [limit, setLimit] = useState(split.limit);\n\n  const isValid = validateSplit({ split, dimension, limit, sort });\n\n  const onSave = () => {\n    const newSplit = createSplit({\n      dimension,\n      split,\n      limit,\n      sort\n    });\n    saveSplit(split, newSplit);\n  };\n\n  return <SplitMenuBase\n    openOn={openOn}\n    containerStage={containerStage}\n    onClose={onClose}\n    onSave={onSave}\n    dimension={dimension}\n    isValid={isValid}>\n    <SortDropdown\n      direction={sort.direction}\n      selected={SortOn.fromSort(sort, essence)}\n      options={sortOptions}\n      onChange={setSort}/>\n    <LimitDropdown\n      selectedLimit={limit}\n      limits={limitOptions}\n      includeNone={false}\n      onLimitSelect={setLimit}/>\n  </SplitMenuBase>;\n};\n\nexport const TimeSeriesSplitMenu: React.FunctionComponent<SplitMenuProps> = props => {\n  const { essence, split } = props;\n\n  const isContinuousSplit = split.equals(getContinuousSplit(essence));\n\n  if (isContinuousSplit) {\n    return <TimeSeriesContinuousSplitMenu {...props} />;\n  } else {\n    return <TimeSeriesCategorySplitMenu {...props} />;\n  }\n};\n","/*\n * Copyright 2017-2022 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { VisualizationControls, VisualizationControlsBaseProps } from \"../../views/cube-view/center-panel/center-panel\";\nimport { SplitTile, SplitTileBaseProps } from \"../split-tile/split-tile\";\nimport { SplitTilesRow, SplitTilesRowBaseProps } from \"../split-tile/split-tiles-row\";\nimport { TimeSeriesSplitMenu } from \"./split-menu\";\n\nconst TimeSeriesSplitTile: React.FunctionComponent<SplitTileBaseProps> = props =>\n  <SplitTile splitMenuComponent={TimeSeriesSplitMenu} {...props} />;\n\nconst TimeSeriesSplitTilesRow: React.FunctionComponent<SplitTilesRowBaseProps> = props =>\n  <SplitTilesRow {...props} splitTileComponent={TimeSeriesSplitTile}/>;\n\nexport const TimeSeriesVisualizationControls: React.FunctionComponent<VisualizationControlsBaseProps> = props =>\n  <VisualizationControls {...props} splitTilesRow={TimeSeriesSplitTilesRow}/>;\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { roundToHalfPx } from \"../../utils/dom/dom\";\nimport \"./grid-border.scss\";\n\ninterface BottomBorderProps {\n  stage: Stage;\n  tickLength: number;\n}\n\nexport const BottomBorder: React.FunctionComponent<BottomBorderProps> = ({ stage, tickLength }) => {\n  return <line\n    className=\"grid-border grid-bottom-border\"\n    transform={stage.getTransform()}\n    x1={0}\n    x2={stage.width + tickLength}\n    y1={roundToHalfPx(stage.height - 1)}\n    y2={roundToHalfPx(stage.height - 1)}\n  />;\n};\n\ninterface RightBorderProps {\n stage: Stage;\n}\n\nexport const RightBorder: React.FunctionComponent<RightBorderProps> = ({ stage }) => {\n  return <line\n    className=\"grid-border grid-right-border\"\n    transform={stage.getTransform()}\n    x1={roundToHalfPx(stage.width - 1)}\n    x2={roundToHalfPx(stage.width - 1)}\n    y1={0}\n    y2={stage.height} />;\n};\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport \"./highlighter.scss\";\n\nexport interface HighlighterProps {\n  left: number;\n  right: number;\n  top?: number;\n  bottom?: number;\n}\n\nexport function Highlighter(props: HighlighterProps) {\n  const { left, bottom = 0, right, top = 0 } = props;\n\n  const whiteoutLeftStyle = {\n    width: Math.max(left, 0)\n  };\n\n  const frameStyle = {\n    left,\n    top,\n    bottom,\n    width: Math.max(right - left, 0)\n  };\n\n  const whiteoutRightStyle = {\n    left: right\n  };\n\n  return <div className=\"highlighter\">\n    <div className=\"whiteout left\" style={whiteoutLeftStyle} />\n    <div className=\"frame\" style={frameStyle} />\n    <div className=\"whiteout right\" style={whiteoutRightStyle} />\n  </div>;\n}\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { useSettingsContext } from \"../../../views/cube-view/settings-context\";\nimport \"./legend.scss\";\n\nexport interface LegendProps {\n  values: string[];\n  title: string;\n}\n\ninterface LegendValuesProps {\n  values: string[];\n}\n\nconst LegendValues: React.FunctionComponent<LegendValuesProps> = props => {\n  const { customization: { visualizationColors } } = useSettingsContext();\n  const { values } = props;\n  return <div className=\"legend-values\">\n    <table className=\"legend-values-table\">\n      <tbody>\n      {values.map((value, i) => {\n        const style = { background: visualizationColors.series[i] };\n        return <tr key={value} className=\"legend-value\">\n          <td className=\"legend-value-color-cell\">\n            <div className=\"legend-value-color\" style={style} />\n          </td>\n          <td className=\"legend-value-label\">\n            <span className=\"legend-value-name\">{value}</span>\n          </td>\n        </tr>;\n      })}\n      </tbody>\n    </table>\n  </div>;\n};\n\nexport const Legend: React.FunctionComponent<LegendProps> = props => {\n  const { values, title } = props;\n\n  return <div className=\"line-chart-legend\">\n    <div className=\"legend-header\">\n      {title}\n    </div>\n    <LegendValues values={values} />\n  </div>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Dataset } from \"plywood\";\nimport React from \"react\";\nimport { findDimensionByName } from \"../../../../common/models/dimension/dimensions\";\nimport { Essence } from \"../../../../common/models/essence/essence\";\nimport { selectFirstSplitDatums } from \"../../../utils/dataset/selectors/selectors\";\nimport { Legend } from \"./legend\";\n\ninterface SplitLegendProps {\n  dataset: Dataset;\n  essence: Essence;\n}\n\nexport const SplitLegend: React.FunctionComponent<SplitLegendProps> = props => {\n  const { essence, dataset } = props;\n  const legendSplit = essence.splits.splits.first();\n\n  const legendDimension = findDimensionByName(essence.dataCube.dimensions, legendSplit.reference);\n  const title = legendSplit.getTitle(legendDimension);\n\n  const nestedDataset = selectFirstSplitDatums(dataset);\n  const values = nestedDataset.map(datum => String(legendSplit.selectValue(datum)));\n\n  return <Legend\n    values={values}\n    title={title}/>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Stage } from \"../../../../common/models/stage/stage\";\nimport { VIS_H_PADDING } from \"../../../config/constants\";\n\nconst X_AXIS_HEIGHT = 30;\nconst MIN_CHART_HEIGHT = 200;\nconst MAX_ASPECT_RATIO = 1; // width / height\n\nexport function calculateChartStage(stage: Stage, chartsCount: number): Stage {\n  const width = stage.width - VIS_H_PADDING * 2;\n  const maxHeightFromRatio = width / MAX_ASPECT_RATIO;\n  const heightFromStageDivision = (stage.height - X_AXIS_HEIGHT) / chartsCount;\n  const boundedChartHeight = Math.floor(Math.min(\n    maxHeightFromRatio,\n    heightFromStageDivision\n  ));\n  const height = Math.max(MIN_CHART_HEIGHT, boundedChartHeight);\n\n  return new Stage({\n    x: VIS_H_PADDING,\n    y: 0,\n    width,\n    height\n  });\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { FilterClause } from \"../../../../common/models/filter-clause/filter-clause\";\nimport { Highlight as VizHighlight } from \"../../highlight-controller/highlight\";\nimport { ContinuousRange, ContinuousValue } from \"../utils/continuous-types\";\n\nenum InteractionKind { HOVER, DRAGGING, HIGHLIGHT }\n\ninterface InteractionBase {\n  kind: InteractionKind;\n  key: string;\n}\n\nexport interface Hover extends InteractionBase {\n  kind: InteractionKind.HOVER;\n  range: ContinuousRange;\n}\n\nexport const createHover = (key: string, range: ContinuousRange): Hover => ({\n  kind: InteractionKind.HOVER,\n  range,\n  key\n});\n\nexport const isHover = (interaction?: Interaction): interaction is Hover => interaction && interaction.kind === InteractionKind.HOVER;\n\nexport interface Dragging extends InteractionBase {\n  kind: InteractionKind.DRAGGING;\n  start: ContinuousValue;\n  end: ContinuousValue;\n}\n\nexport const createDragging = (key: string, start: ContinuousValue, end: ContinuousValue): Dragging => ({\n  kind: InteractionKind.DRAGGING,\n  start,\n  end,\n  key\n});\n\nexport const isDragging = (interaction?: Interaction): interaction is Dragging => interaction && interaction.kind === InteractionKind.DRAGGING;\n\nexport interface Highlight extends InteractionBase {\n  kind: InteractionKind.HIGHLIGHT;\n  clause: FilterClause;\n}\n\nexport const createHighlight = (highlight: VizHighlight): Highlight => ({\n  kind: InteractionKind.HIGHLIGHT,\n  clause: highlight.clauses.first(),\n  key: highlight.key\n});\n\nexport const isHighlight = (interaction?: Interaction): interaction is Highlight => interaction && interaction.kind === InteractionKind.HIGHLIGHT;\n\nexport type MouseInteraction = Hover | Dragging;\n\nexport type Interaction = Hover | Dragging | Highlight;\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\n\nfunction getBoundingClientOffset(element: HTMLElement | Window): { left: number, top: number } {\n  if (element === window) {\n    return { top: 0, left: 0 };\n  }\n  // typescript doesn't know that window is only value inhabiting Window type and can't narrow type here\n  return (element as HTMLElement).getBoundingClientRect();\n}\n\nexport function mouseEventOffset(event: React.MouseEvent<HTMLElement> | MouseEvent): [number, number] {\n  const target = event.currentTarget as HTMLElement;\n  const cx = event.clientX || 0;\n  const cy = event.clientY || 0;\n  const { left, top } = getBoundingClientOffset(target);\n  return [cx - left, cy - top];\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Stage } from \"../../../../../common/models/stage/stage\";\nimport { Unary } from \"../../../../../common/utils/functional/functional\";\nimport { BottomBorder } from \"../../../../components/grid-border/grid-border\";\nimport { GridLines } from \"../../../../components/grid-lines/grid-lines\";\nimport { VerticalAxis } from \"../../../../components/vertical-axis/vertical-axis\";\nimport { LinearScale, pickTicks } from \"../../../../utils/linear-scale/linear-scale\";\nimport { ContinuousScale } from \"../../utils/continuous-types\";\nimport { ContinuousTicks } from \"../../utils/pick-x-axis-ticks\";\n\nexport const TICK_WIDTH = 5;\n\ninterface BackgroundProps {\n  gridStage: Stage;\n  axisStage: Stage;\n  xScale: ContinuousScale;\n  xTicks: ContinuousTicks;\n  yScale: LinearScale;\n  formatter: Unary<number, string>;\n}\n\nexport const Background: React.FunctionComponent<BackgroundProps> = props => {\n  const { formatter, gridStage, axisStage, xScale, yScale, xTicks } = props;\n\n  return <React.Fragment>\n    <GridLines\n      orientation=\"horizontal\"\n      scale={yScale}\n      ticks={pickTicks(yScale)}\n      stage={gridStage}\n    />\n    {/* TODO: omit last xTick if it's equal to last data point so we don't overplot with yAxis */}\n    <GridLines\n      orientation=\"vertical\"\n      scale={xScale}\n      ticks={xTicks}\n      stage={gridStage}\n    />\n    <VerticalAxis\n      tickSize={TICK_WIDTH}\n      stage={axisStage}\n      formatter={formatter}\n      ticks={pickTicks(yScale)}\n      scale={yScale}\n    />\n    <BottomBorder stage={gridStage} tickLength={TICK_WIDTH} />\n  </React.Fragment>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Timezone } from \"chronoshift\";\nimport React from \"react\";\nimport { formatValue } from \"../../../../../common/utils/formatter/formatter\";\nimport { Nullary } from \"../../../../../common/utils/functional/functional\";\nimport { HighlightModal as BaseHighlightModal } from \"../../../../components/highlight-modal/highlight-modal\";\nimport { toPlywoodRange } from \"../../../../utils/highlight-clause/highlight-clause\";\nimport { Highlight } from \"../../interactions/interaction\";\nimport { ContinuousScale } from \"../../utils/continuous-types\";\n\ninterface HighlightModalProps {\n  interaction: Highlight;\n  dropHighlight: Nullary<void>;\n  acceptHighlight: Nullary<void>;\n  timezone: Timezone;\n  xScale: ContinuousScale;\n  rect: ClientRect | DOMRect;\n}\n\nexport const HighlightModal: React.FunctionComponent<HighlightModalProps> = props => {\n  const { rect: { left, top }, interaction, timezone, dropHighlight, acceptHighlight, xScale } = props;\n  const range = toPlywoodRange(interaction.clause);\n  const x = xScale(range.midpoint());\n  return <BaseHighlightModal\n    title={formatValue(range, timezone)}\n    left={left + x}\n    top={top + 80}\n    dropHighlight={dropHighlight}\n    acceptHighlight={acceptHighlight} />;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Timezone } from \"chronoshift\";\nimport React from \"react\";\nimport { ReactNode } from \"react\";\nimport { Stage } from \"../../../../../common/models/stage/stage\";\nimport { formatValue } from \"../../../../../common/utils/formatter/formatter\";\nimport { SegmentBubbleContent } from \"../../../../components/segment-bubble/segment-bubble\";\nimport { TooltipWithinStage } from \"../../../../components/tooltip-within-stage/tooltip-within-stage\";\nimport { Hover } from \"../../interactions/interaction\";\nimport { ContinuousScale } from \"../../utils/continuous-types\";\n\ninterface HoverTooltipProps {\n  interaction: Hover;\n  xScale: ContinuousScale;\n  timezone: Timezone;\n  content: ReactNode;\n  stage: Stage;\n}\n\nexport const HoverTooltip: React.FunctionComponent<HoverTooltipProps> = props => {\n  const { content, interaction, xScale, timezone, stage } = props;\n  const { range } = interaction;\n  const x = xScale(range.midpoint());\n\n  return <TooltipWithinStage key={x} top={60} left={x} stage={stage}>\n    <SegmentBubbleContent\n      title={formatValue(range, timezone)}\n      content={content} />\n  </TooltipWithinStage>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { second, Timezone } from \"chronoshift\";\nimport { Range } from \"plywood\";\nimport { ContinuousDomain, ContinuousRange, ContinuousValue } from \"../utils/continuous-types\";\n\nfunction orderValues(a: ContinuousValue, b: ContinuousValue, timezone: Timezone): ContinuousDomain {\n  if (a > b) return [b, a];\n  if (b > a) return [a, b];\n  return [a, shiftByOne(a, timezone)];\n}\n\nexport function constructRange(a: ContinuousValue, b: ContinuousValue, timezone: Timezone): ContinuousRange {\n  const [start, end] = orderValues(a, b, timezone);\n  return Range.fromJS({ start, end }) as ContinuousRange;\n}\n\nexport function shiftByOne(value: ContinuousValue, timezone: Timezone): ContinuousValue {\n  return value instanceof Date ? second.shift(value, timezone, 1) : value + 1;\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Timezone } from \"chronoshift\";\nimport { Range } from \"plywood\";\nimport React from \"react\";\nimport { Stage } from \"../../../../../common/models/stage/stage\";\nimport { Highlighter } from \"../../../../components/highlighter/highlighter\";\nimport { constructRange } from \"../../interactions/continuous-range\";\nimport { Interaction, isDragging, isHighlight } from \"../../interactions/interaction\";\nimport { ContinuousRange, ContinuousScale } from \"../../utils/continuous-types\";\nimport { isValidClause } from \"../../utils/is-valid-clause\";\n\ninterface SelectionOverlayProps {\n  interaction: Interaction;\n  stage: Stage;\n  xScale: ContinuousScale;\n  timezone: Timezone;\n}\n\nfunction getHighlightRange(interaction: Interaction, timezone: Timezone): ContinuousRange | null {\n  if (isDragging(interaction)) {\n    return constructRange(interaction.start, interaction.end, timezone);\n  }\n  if (isHighlight(interaction)) {\n    const { clause } = interaction;\n    if (!isValidClause(clause)) {\n      throw new Error(`Expected FixedTime or Number Filter clause. Got: ${clause}`);\n    }\n    return Range.fromJS(clause.values.first()) as ContinuousRange;\n  }\n  return null;\n}\n\nexport const SelectionOverlay: React.FunctionComponent<SelectionOverlayProps> = props => {\n  const { stage, timezone, interaction, xScale } = props;\n  const range = getHighlightRange(interaction, timezone);\n  if (!range) return null;\n\n  const left = xScale(range.start);\n  const right = xScale(range.end);\n\n  return <div style={stage.getLeftTopWidthHeight()}>\n    <Highlighter left={left} right={right}/>\n  </div>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Timezone } from \"chronoshift\";\nimport React from \"react\";\nimport { ReactNode } from \"react\";\nimport { Stage } from \"../../../../../common/models/stage/stage\";\nimport { Nullary } from \"../../../../../common/utils/functional/functional\";\nimport { Interaction, isHighlight, isHover } from \"../../interactions/interaction\";\nimport { ContinuousScale } from \"../../utils/continuous-types\";\nimport { HighlightModal } from \"./highlight-modal\";\nimport { HoverTooltip } from \"./hover-tooltip\";\nimport { SelectionOverlay } from \"./selection-overlay\";\n\ninterface ForegroundProps {\n  interaction: Interaction;\n  stage: Stage;\n  visualisationStage: Stage;\n  container: React.RefObject<HTMLDivElement>;\n  dropHighlight: Nullary<void>;\n  acceptHighlight: Nullary<void>;\n  hoverContent?: ReactNode;\n  xScale: ContinuousScale;\n  timezone: Timezone;\n}\n\nexport const Foreground: React.FunctionComponent<ForegroundProps> = props => {\n  const { stage, interaction, container, xScale, timezone, visualisationStage, hoverContent, dropHighlight, acceptHighlight } = props;\n\n  return <React.Fragment>\n    <SelectionOverlay\n      stage={stage}\n      interaction={interaction}\n      timezone={timezone}\n      xScale={xScale} />\n    {isHover(interaction) && <HoverTooltip\n      stage={visualisationStage}\n      interaction={interaction}\n      xScale={xScale}\n      content={hoverContent}\n      timezone={timezone} />}\n    {isHighlight(interaction) && <HighlightModal\n      rect={container.current.getBoundingClientRect()}\n      interaction={interaction}\n      xScale={xScale}\n      timezone={timezone}\n      dropHighlight={dropHighlight}\n      acceptHighlight={acceptHighlight} />}\n  </React.Fragment>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as d3 from \"d3\";\nimport React from \"react\";\nimport { Stage } from \"../../../../../common/models/stage/stage\";\nimport { Hover } from \"../../interactions/interaction\";\nimport { ContinuousScale } from \"../../utils/continuous-types\";\n\ninterface HoverGuideProps {\n  hover: Hover;\n  stage: Stage;\n  yScale: d3.ScaleLinear<number, number>;\n  xScale: ContinuousScale;\n}\n\nexport const HoverGuide: React.FunctionComponent<HoverGuideProps> = props => {\n  const { stage, hover: { range }, yScale, xScale } = props;\n  const midpoint = range.midpoint();\n  const x = xScale(midpoint);\n  const [y2, y1] = yScale.range();\n  return <line\n    transform={stage.getTransform()}\n    x1={x}\n    x2={x}\n    y1={0}\n    y2={stage.height}\n    className=\"hover-guide\" />;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Timezone } from \"chronoshift\";\nimport React from \"react\";\nimport { ReactNode } from \"react\";\nimport { Stage } from \"../../../../common/models/stage/stage\";\nimport { Unary } from \"../../../../common/utils/functional/functional\";\nimport getScale from \"../../../utils/linear-scale/linear-scale\";\nimport { mouseEventOffset } from \"../../../utils/mouse-event-offset/mouse-event-offset\";\nimport { Scale } from \"../chart-line/chart-line\";\nimport { isHover } from \"../interactions/interaction\";\nimport { InteractionsProps } from \"../interactions/interaction-controller\";\nimport { ContinuousScale } from \"../utils/continuous-types\";\nimport { ContinuousTicks } from \"../utils/pick-x-axis-ticks\";\nimport { Background } from \"./background/background\";\nimport \"./base-chart.scss\";\nimport { Foreground } from \"./foreground/foreground\";\nimport { HoverGuide } from \"./foreground/hover-guide\";\n\ninterface ChartLinesProps {\n  yScale: Scale;\n  lineStage: Stage;\n}\n\nclass BaseChartProps {\n  chartId: string;\n  children: Unary<ChartLinesProps, ReactNode>;\n  label: ReactNode;\n  hoverContent?: ReactNode;\n  xScale: ContinuousScale;\n  timezone: Timezone;\n  xTicks: ContinuousTicks;\n  chartStage: Stage;\n  visualisationStage: Stage;\n  formatter: Unary<number, string>;\n  yDomain: [number, number];\n  interactions: InteractionsProps;\n}\n\nconst TEXT_SPACER = 36;\n\nconst offsetX = (e: React.MouseEvent<HTMLElement> | MouseEvent) => mouseEventOffset(e)[0];\n\nexport class BaseChart extends React.Component<BaseChartProps> {\n\n  private container = React.createRef<HTMLDivElement>();\n\n  render() {\n    const { hoverContent, interactions, timezone, yDomain, visualisationStage, chartStage, chartId, children, label, formatter, xScale, xTicks } = this.props;\n    const { interaction, dropHighlight, acceptHighlight, mouseLeave, dragStart, handleHover } = interactions;\n\n    const [, xRange] = xScale.range();\n    const lineStage = chartStage.within({ top: TEXT_SPACER, right: chartStage.width - xRange });\n    const axisStage = chartStage.within({ top: TEXT_SPACER, left: xRange });\n\n    const yScale = getScale(yDomain, lineStage.height);\n    const hasInteraction = interaction && interaction.key === chartId;\n\n    return <React.Fragment>\n      <div className=\"line-base-chart\" ref={this.container} style={chartStage.getWidthHeight()}>\n        <svg className=\"chart-stage\" viewBox={chartStage.getViewBox()}>\n          <Background\n            axisStage={axisStage}\n            formatter={formatter}\n            gridStage={lineStage}\n            xScale={xScale}\n            xTicks={xTicks}\n            yScale={yScale} />\n          {children({ yScale, lineStage })}\n          {hasInteraction && isHover(interaction) && <HoverGuide\n            hover={interaction}\n            stage={lineStage}\n            yScale={yScale}\n            xScale={xScale} />}\n        </svg>\n        <div style={lineStage.getWidthHeight()}\n             className=\"event-region\"\n             onMouseDown={e => dragStart(chartId, offsetX(e))}\n             onMouseMove={e => handleHover(chartId, offsetX(e))}\n             onMouseLeave={mouseLeave}\n        />\n        {label}\n        {hasInteraction && <Foreground\n          container={this.container}\n          stage={lineStage}\n          visualisationStage={visualisationStage}\n          interaction={interaction}\n          hoverContent={hoverContent}\n          dropHighlight={dropHighlight}\n          acceptHighlight={acceptHighlight}\n          xScale={xScale}\n          timezone={timezone} />}\n      </div>\n    </React.Fragment>;\n  }\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Datum, PlywoodRange } from \"plywood\";\nimport { concatTruthy, flatMap, Unary } from \"../../../../common/utils/functional/functional\";\nimport { ContinuousRange } from \"../utils/continuous-types\";\n\ntype DataPoint = [number, number];\n\nfunction areDetached(a: PlywoodRange | null, b: PlywoodRange | null): boolean {\n  return a && b && a.end.valueOf() !== b.start.valueOf();\n}\n\nfunction nextMidpoint(range: ContinuousRange): number {\n  const rangeWidth = range.end.valueOf() - range.start.valueOf();\n  return range.midpoint().valueOf() + rangeWidth;\n}\n\nfunction previousMidpoint(range: ContinuousRange): number {\n  const rangeWidth = range.end.valueOf() - range.start.valueOf();\n  return range.midpoint().valueOf() - rangeWidth;\n}\n\nfunction shouldInsertPreviousPoint(dataset: Datum[], currentIndex: number, getX: Unary<Datum, ContinuousRange>): boolean {\n  const previous = dataset[currentIndex - 1];\n  if (!previous) return false;\n  const current = dataset[currentIndex];\n  return areDetached(getX(previous), getX(current));\n}\n\nfunction shouldInsertNextPoint(dataset: Datum[], currentIndex: number, getX: Unary<Datum, ContinuousRange>): boolean {\n  const next = dataset[currentIndex + 1];\n  if (!next) return false;\n  const current = dataset[currentIndex];\n  return areDetached(getX(current), getX(next));\n}\n\nexport function prepareDataPoints(dataset: Datum[], getX: Unary<Datum, ContinuousRange>, getY: Unary<Datum, number>): DataPoint[] {\n  return flatMap(dataset, (datum, index) => {\n    const range = getX(datum);\n    const x = range.midpoint().valueOf();\n    const maybeY = getY(datum);\n    const y = isNaN(maybeY) ? 0 : maybeY;\n\n    return concatTruthy<DataPoint>(\n      shouldInsertPreviousPoint(dataset, index, getX) && [previousMidpoint(range), 0],\n      [x, y],\n      shouldInsertNextPoint(dataset, index, getX) && [nextMidpoint(range), 0]\n    );\n  });\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as d3 from \"d3\";\nimport { Datum } from \"plywood\";\nimport React from \"react\";\nimport { alphaMain } from \"../../../../common/models/colors/colors\";\nimport { Stage } from \"../../../../common/models/stage/stage\";\nimport { Unary } from \"../../../../common/utils/functional/functional\";\nimport { useSettingsContext } from \"../../../views/cube-view/settings-context\";\nimport { ContinuousRange, ContinuousScale } from \"../utils/continuous-types\";\nimport \"./chart-line.scss\";\nimport { prepareDataPoints } from \"./prepare-data-points\";\n\nexport type Scale = d3.ScaleLinear<number, number>;\n\nexport interface ChartLineProps {\n  xScale: ContinuousScale;\n  yScale: Scale;\n  getX: Unary<Datum, ContinuousRange>;\n  getY: Unary<Datum, number>;\n  color?: string;\n  showArea: boolean;\n  dashed: boolean;\n  dataset: Datum[];\n  stage: Stage;\n}\n\nexport const ChartLine: React.FunctionComponent<ChartLineProps> = props => {\n  const { customization: { visualizationColors } } = useSettingsContext();\n  const mainColor = visualizationColors.main;\n  const { color = mainColor, dashed, getX, getY, dataset, showArea, stage, xScale, yScale } = props;\n\n  const area = d3.area().y0(yScale(0));\n  const line = d3.line();\n\n  const points = prepareDataPoints(dataset, getX, getY);\n  const scaledPoints = points.map(([x, y]) => [xScale(x), yScale(y)] as [number, number]);\n  const hasMultiplePoints = points.length > 1;\n  const hasSinglePoint = points.length === 1;\n\n  return <g className=\"chart-line\" transform={stage.getTransform()}>\n    {hasMultiplePoints && <path\n      className=\"line\"\n      d={line(scaledPoints)}\n      stroke={color}\n      strokeDasharray={dashed ? \"4 2\" : undefined}/>}\n    {hasMultiplePoints && showArea && <path\n      className=\"area\"\n      fill={alphaMain(visualizationColors)}\n      d={area(scaledPoints)}/>}\n    {hasSinglePoint && <circle\n      className=\"singleton\"\n      cx={scaledPoints[0][0]}\n      cy={scaledPoints[0][1]}\n      r=\"2\"\n      style={{ fill: color }}\n    />}\n  </g>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Datum } from \"plywood\";\nimport React from \"react\";\nimport { Essence } from \"../../../../common/models/essence/essence\";\nimport { ConcreteSeries, SeriesDerivation } from \"../../../../common/models/series/concrete-series\";\nimport { Unary } from \"../../../../common/utils/functional/functional\";\nimport { readNumber } from \"../../../../common/utils/general/general\";\nimport { ChartLine, ChartLineProps } from \"./chart-line\";\n\ninterface OwnProps {\n  essence: Essence;\n  series: ConcreteSeries;\n}\n\nexport type SeriesChartLineProps = Pick<ChartLineProps, \"showArea\" | \"getX\" | \"xScale\" | \"yScale\" | \"dataset\" | \"color\" | \"stage\"> & OwnProps;\n\nexport const SeriesChartLine: React.FunctionComponent<SeriesChartLineProps> = props => {\n  const { showArea, essence, series, getX, stage, dataset, xScale, yScale, color } = props;\n\n  const getY: Unary<Datum, number> = (d: Datum) => readNumber(series.selectValue(d));\n  const getYP: Unary<Datum, number> = (d: Datum) => readNumber(series.selectValue(d, SeriesDerivation.PREVIOUS));\n  const hasComparison = essence.hasComparison();\n  return <React.Fragment key={series.reactKey()}>\n    <ChartLine\n      key=\"current\"\n      xScale={xScale}\n      yScale={yScale}\n      getX={getX}\n      getY={getY}\n      showArea={showArea}\n      color={color}\n      dashed={false}\n      dataset={dataset}\n      stage={stage} />\n    {hasComparison && <ChartLine\n      key=\"previous\"\n      xScale={xScale}\n      yScale={yScale}\n      getX={getX}\n      getY={getYP}\n      showArea={showArea}\n      color={color}\n      dashed={true}\n      dataset={dataset}\n      stage={stage} />}\n  </React.Fragment>;\n\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Omit } from \"../../../../common/utils/functional/functional\";\nimport { SeriesChartLine, SeriesChartLineProps } from \"./series-chart-line\";\n\ntype ColoredSeriesChartLine = Omit<SeriesChartLineProps, \"color\"  | \"showArea\"> & { color: string };\n\nexport const ColoredSeriesChartLine: React.FunctionComponent<ColoredSeriesChartLine> = props => {\n  return <SeriesChartLine {...props} showArea={false}/>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Omit } from \"../../../../common/utils/functional/functional\";\nimport { SeriesChartLine, SeriesChartLineProps } from \"./series-chart-line\";\n\ntype SingletonSeriesChartLineProps = Omit<SeriesChartLineProps, \"color\" | \"showArea\">;\n\nexport const SingletonSeriesChartLine: React.FunctionComponent<SingletonSeriesChartLineProps> = props => {\n  return <SeriesChartLine {...props} showArea={true} />;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Dataset, Datum, PlywoodRange } from \"plywood\";\nimport React from \"react\";\nimport { ReactNode } from \"react\";\nimport { VisualizationColors } from \"../../../../../common/models/colors/colors\";\nimport { Essence } from \"../../../../../common/models/essence/essence\";\nimport { ConcreteSeries } from \"../../../../../common/models/series/concrete-series\";\nimport { ColorEntry, createColorEntry } from \"../../../../components/color-swabs/color-entry\";\nimport { ColorSwabs } from \"../../../../components/color-swabs/color-swabs\";\nimport { SeriesBubbleContent } from \"../../../../components/series-bubble-content/series-bubble-content\";\nimport { selectSplitDataset } from \"../../../../utils/dataset/selectors/selectors\";\nimport { useSettingsContext } from \"../../../../views/cube-view/settings-context\";\nimport { getContinuousDimension, getContinuousReference, getNominalSplit, hasNominalSplit } from \"../../utils/splits\";\n\nfunction findSplitDatumByAttribute(d: Datum, dimensionName: string, range: PlywoodRange): Datum {\n  const dataset = selectSplitDataset(d);\n  return dataset != null ? dataset.findDatumByAttribute(dimensionName, range) : null;\n}\n\nfunction measureLabel(dataset: Dataset, range: PlywoodRange, series: ConcreteSeries, essence: Essence): ReactNode {\n  const continuousDimension = getContinuousDimension(essence);\n  const datum = dataset.findDatumByAttribute(continuousDimension.name, range);\n  if (!datum) return null;\n\n  return <SeriesBubbleContent series={series} datum={datum} showPrevious={essence.hasComparison()}/>;\n}\n\nfunction colorEntries(dataset: Dataset, range: PlywoodRange, series: ConcreteSeries, essence: Essence, visualizationColors: VisualizationColors): ColorEntry[] {\n  const { data } = dataset;\n  const nominalSplit = getNominalSplit(essence);\n  const continuousRef = getContinuousReference(essence);\n  const hasComparison = essence.hasComparison();\n  return data.map((datum, i) => {\n    const name = String(nominalSplit.selectValue(datum));\n    const color = visualizationColors.series[i];\n    const hoverDatum = findSplitDatumByAttribute(datum, continuousRef, range);\n\n    if (!hoverDatum) {\n      return {\n        color,\n        name,\n        value: \"-\"\n      };\n    }\n\n    return createColorEntry({\n      color,\n      name,\n      series,\n      datum: hoverDatum,\n      hasComparison\n    });\n  });\n}\n\ninterface SeriesHoverContentProps {\n  essence: Essence;\n  dataset: Dataset;\n  range: PlywoodRange;\n  series: ConcreteSeries;\n}\n\nexport const SeriesHoverContent: React.FunctionComponent<SeriesHoverContentProps> = props => {\n  const { customization: { visualizationColors } } = useSettingsContext();\n  const { essence, range, series, dataset } = props;\n  if (hasNominalSplit(essence)) {\n    const entries = colorEntries(dataset, range, series, essence, visualizationColors);\n    return <ColorSwabs colorEntries={entries} />;\n  }\n  return <React.Fragment>\n    {measureLabel(dataset, range, series, essence)}\n  </React.Fragment>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Dataset, Datum, NumberRange, TimeRange } from \"plywood\";\nimport React from \"react\";\nimport { Essence } from \"../../../../../common/models/essence/essence\";\nimport { ConcreteSeries } from \"../../../../../common/models/series/concrete-series\";\nimport { Stage } from \"../../../../../common/models/stage/stage\";\nimport { VisMeasureLabel } from \"../../../../components/vis-measure-label/vis-measure-label\";\nimport { selectFirstSplitDataset, selectMainDatum, selectSplitDatums } from \"../../../../utils/dataset/selectors/selectors\";\nimport { useSettingsContext } from \"../../../../views/cube-view/settings-context\";\nimport { BaseChart } from \"../../base-chart/base-chart\";\nimport { ColoredSeriesChartLine } from \"../../chart-line/colored-series-chart-line\";\nimport { SingletonSeriesChartLine } from \"../../chart-line/singleton-series-chart-line\";\nimport { isHover } from \"../../interactions/interaction\";\nimport { InteractionsProps } from \"../../interactions/interaction-controller\";\nimport { ContinuousScale } from \"../../utils/continuous-types\";\nimport { extentAcrossSplits } from \"../../utils/extent\";\nimport { ContinuousTicks } from \"../../utils/pick-x-axis-ticks\";\nimport { getContinuousSplit, getNominalSplit, hasNominalSplit } from \"../../utils/splits\";\nimport { SeriesHoverContent } from \"./series-hover-content\";\n\ninterface SeriesChartProps {\n  chartId: string;\n  interactions: InteractionsProps;\n  essence: Essence;\n  dataset: Dataset;\n  series: ConcreteSeries;\n  xScale: ContinuousScale;\n  xTicks: ContinuousTicks;\n  chartStage: Stage;\n  visualisationStage: Stage;\n}\n\nexport const SeriesChart: React.FunctionComponent<SeriesChartProps> = props => {\n  const { customization: { visualizationColors } } = useSettingsContext();\n  const { chartId, interactions, visualisationStage, chartStage, essence, series, xScale, xTicks, dataset } = props;\n  const hasComparison = essence.hasComparison();\n  const continuousSplitDataset = selectFirstSplitDataset(dataset);\n  const { interaction } = interactions;\n\n  const hoverContent = isHover(interaction) && <SeriesHoverContent\n    essence={essence}\n    dataset={continuousSplitDataset}\n    range={interaction.range}\n    series={series}/>;\n\n  const label = <VisMeasureLabel\n    series={series}\n    datum={selectMainDatum(dataset)}\n    showPrevious={hasComparison} />;\n\n  const continuousSplit = getContinuousSplit(essence);\n  const getX = (d: Datum) => continuousSplit.selectValue<TimeRange | NumberRange>(d);\n\n  const domain = extentAcrossSplits(continuousSplitDataset, essence, series);\n\n  if (hasNominalSplit(essence)) {\n    const nominalSplit = getNominalSplit(essence);\n    return <BaseChart\n      visualisationStage={visualisationStage}\n      chartId={chartId}\n      interactions={interactions}\n      hoverContent={hoverContent}\n      timezone={essence.timezone}\n      label={label}\n      xScale={xScale}\n      xTicks={xTicks}\n      chartStage={chartStage}\n      formatter={series.formatter()}\n      yDomain={domain}>\n      {({ yScale, lineStage }) => <React.Fragment>\n        {continuousSplitDataset.data.map((datum, index) => {\n          const splitKey = nominalSplit.selectValue(datum);\n          const color = visualizationColors.series[index];\n          return <ColoredSeriesChartLine\n            key={String(splitKey)}\n            xScale={xScale}\n            yScale={yScale}\n            getX={getX}\n            color={color}\n            dataset={selectSplitDatums(datum)}\n            stage={lineStage}\n            essence={essence}\n            series={series} />;\n        })}\n      </React.Fragment>}\n    </BaseChart>;\n  }\n  return <BaseChart\n    chartId={series.plywoodKey()}\n    visualisationStage={visualisationStage}\n    interactions={interactions}\n    hoverContent={hoverContent}\n    timezone={essence.timezone}\n    label={label}\n    chartStage={chartStage}\n    yDomain={domain}\n    formatter={series.formatter()}\n    xScale={xScale}\n    xTicks={xTicks}>\n    {({ yScale, lineStage }) => <SingletonSeriesChartLine\n      xScale={xScale}\n      yScale={yScale}\n      getX={getX}\n      dataset={continuousSplitDataset.data}\n      stage={lineStage}\n      essence={essence}\n      series={series} />}\n  </BaseChart>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as d3 from \"d3\";\nimport { Dataset } from \"plywood\";\nimport { Essence } from \"../../../../common/models/essence/essence\";\nimport { ConcreteSeries } from \"../../../../common/models/series/concrete-series\";\nimport { flatMap } from \"../../../../common/utils/functional/functional\";\nimport { selectSplitDataset } from \"../../../utils/dataset/selectors/selectors\";\nimport { datumsExtent, Extent, seriesSelectors } from \"../../../utils/extent/extent\";\nimport { hasNominalSplit } from \"./splits\";\n\nexport function extentAcrossSeries(dataset: Dataset, essence: Essence): Extent {\n  const hasComparison = essence.hasComparison();\n  const series = essence.getConcreteSeries().toArray();\n  const getters = flatMap(series, s => seriesSelectors(s, hasComparison));\n  return datumsExtent(dataset.data, getters);\n}\n\nexport function extentAcrossSplits(dataset: Dataset, essence: Essence, series: ConcreteSeries): Extent {\n  const getters = seriesSelectors(series, essence.hasComparison());\n  if (hasNominalSplit(essence)) {\n    return dataset.data.reduce((acc, datum) => {\n      const splitDataset = selectSplitDataset(datum);\n      if (!splitDataset) return acc;\n      const extent = datumsExtent(splitDataset.data, getters);\n      return d3.extent([...acc, ...extent]);\n    }, [0, 0]) as Extent;\n  }\n\n  return datumsExtent(dataset.data, getters);\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Dataset } from \"plywood\";\nimport React from \"react\";\nimport { Essence } from \"../../../../../common/models/essence/essence\";\nimport { Stage } from \"../../../../../common/models/stage/stage\";\nimport { LegendSpot } from \"../../../../components/pinboard-panel/pinboard-panel\";\nimport { InteractionsProps } from \"../../interactions/interaction-controller\";\nimport { SplitLegend } from \"../../legend/split-legend\";\nimport { ContinuousScale } from \"../../utils/continuous-types\";\nimport { ContinuousTicks } from \"../../utils/pick-x-axis-ticks\";\nimport { hasNominalSplit } from \"../../utils/splits\";\nimport { calculateChartStage } from \"../calculate-chart-stage\";\nimport { SeriesChart } from \"./series-chart\";\n\ninterface ChartsPerSeriesProps {\n  interactions: InteractionsProps;\n  essence: Essence;\n  dataset: Dataset;\n  xScale: ContinuousScale;\n  xTicks: ContinuousTicks;\n  stage: Stage;\n}\n\nexport const ChartsPerSeries: React.FunctionComponent<ChartsPerSeriesProps> = props => {\n  const { interactions, xScale, xTicks, essence, dataset, stage } = props;\n\n  const concreteSeries = essence.getConcreteSeries().toArray();\n  const chartStage = calculateChartStage(stage, essence.series.count());\n\n  return <React.Fragment>\n    {hasNominalSplit(essence) && <LegendSpot>\n      <SplitLegend dataset={dataset} essence={essence}/>\n    </LegendSpot>}\n    {concreteSeries.map(series => {\n      const key = series.reactKey();\n      return <SeriesChart\n          interactions={interactions}\n          key={key}\n          chartId={key}\n          dataset={dataset}\n          essence={essence}\n          series={series}\n          chartStage={chartStage}\n          visualisationStage={stage}\n          xScale={xScale}\n          xTicks={xTicks} />;\n      }\n    )}\n  </React.Fragment>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Essence } from \"../../../../common/models/essence/essence\";\nimport { Legend } from \"./legend\";\n\ninterface SeriesLegend {\n  essence: Essence;\n}\n\nexport const SeriesLegend: React.FunctionComponent<SeriesLegend> = props => {\n  const { essence } = props;\n  const series = essence.getConcreteSeries().toArray();\n  const values = series.map(series => series.title());\n  return <Legend values={values} title=\"Series\" />;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Datum } from \"plywood\";\nimport React from \"react\";\nimport { Essence } from \"../../../../../common/models/essence/essence\";\nimport { formatSegment } from \"../../../../../common/utils/formatter/formatter\";\nimport { getNominalDimension, getNominalSplit, hasNominalSplit } from \"../../utils/splits\";\nimport \"./label.scss\";\n\ninterface LabelProps {\n  essence: Essence;\n  datum: Datum;\n}\n\nexport const Label: React.FunctionComponent<LabelProps> = props => {\n  const { essence, datum } = props;\n  if (hasNominalSplit(essence)) {\n    const nominalSplit = getNominalSplit(essence);\n    const nominalDimension = getNominalDimension(essence);\n    const splitValue = nominalSplit.selectValue(datum);\n    return <div className=\"split-chart-label\">\n    <span className=\"split-chart-dimension-title\">\n      {nominalDimension.title}\n    </span>\n      <span className=\"split-chart-value\">\n      : {formatSegment(splitValue, essence.timezone)}\n    </span>\n    </div>;\n  }\n  return null;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Dataset, Datum } from \"plywood\";\nimport React from \"react\";\nimport { Essence } from \"../../../../../common/models/essence/essence\";\nimport { ConcreteSeries } from \"../../../../../common/models/series/concrete-series\";\nimport { createColorEntry } from \"../../../../components/color-swabs/color-entry\";\nimport { ColorSwabs } from \"../../../../components/color-swabs/color-swabs\";\nimport { SeriesBubbleContent } from \"../../../../components/series-bubble-content/series-bubble-content\";\nimport { useSettingsContext } from \"../../../../views/cube-view/settings-context\";\nimport { Hover } from \"../../interactions/interaction\";\nimport { getContinuousReference } from \"../../utils/splits\";\n\ninterface SplitHoverContentProps {\n  interaction: Hover;\n  essence: Essence;\n  dataset: Dataset;\n}\n\ninterface ColoredSeriesProps {\n  series: ConcreteSeries[];\n  datum: Datum;\n  hasComparison: boolean;\n}\n\nconst ColoredSeries: React.FunctionComponent<ColoredSeriesProps> = props => {\n  const { customization: { visualizationColors } } = useSettingsContext();\n  const { datum, hasComparison, series } = props;\n  const colorEntries = series.map((series, index) => {\n    const color = visualizationColors.series[index];\n    const name = series.title();\n    return createColorEntry({ color, name, hasComparison, datum, series });\n  });\n  return <ColorSwabs colorEntries={colorEntries} />;\n};\n\nexport const SplitHoverContent: React.FunctionComponent<SplitHoverContentProps> = props => {\n  const { essence, dataset, interaction: { range } } = props;\n  const series = essence.getConcreteSeries().toArray();\n  const hasComparison = essence.hasComparison();\n  const reference = getContinuousReference(essence);\n  const datum = dataset.findDatumByAttribute(reference, range) || {};\n  if (series.length === 1) {\n    return <SeriesBubbleContent series={series[0]} datum={datum} showPrevious={hasComparison}/>;\n  }\n  return <ColoredSeries  datum={datum} series={series} hasComparison={hasComparison}/>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Dataset, Datum, NumberRange, TimeRange } from \"plywood\";\nimport React from \"react\";\nimport { Essence } from \"../../../../../common/models/essence/essence\";\nimport { defaultFormatter } from \"../../../../../common/models/series/series-format\";\nimport { Stage } from \"../../../../../common/models/stage/stage\";\nimport { Unary } from \"../../../../../common/utils/functional/functional\";\nimport { selectSplitDataset } from \"../../../../utils/dataset/selectors/selectors\";\nimport { useSettingsContext } from \"../../../../views/cube-view/settings-context\";\nimport { BaseChart } from \"../../base-chart/base-chart\";\nimport { ColoredSeriesChartLine } from \"../../chart-line/colored-series-chart-line\";\nimport { SingletonSeriesChartLine } from \"../../chart-line/singleton-series-chart-line\";\nimport { isHover } from \"../../interactions/interaction\";\nimport { InteractionsProps } from \"../../interactions/interaction-controller\";\nimport { ContinuousScale } from \"../../utils/continuous-types\";\nimport { extentAcrossSeries } from \"../../utils/extent\";\nimport { ContinuousTicks } from \"../../utils/pick-x-axis-ticks\";\nimport { getContinuousSplit } from \"../../utils/splits\";\nimport { Label } from \"./label\";\nimport { SplitHoverContent } from \"./split-hover-content\";\n\ninterface SplitChartProps {\n  interactions: InteractionsProps;\n  chartId: string;\n  essence: Essence;\n  dataset: Dataset;\n  selectDatum: Unary<Dataset, Datum>;\n  xScale: ContinuousScale;\n  xTicks: ContinuousTicks;\n  chartStage: Stage;\n  visualisationStage: Stage;\n}\n\nexport const SplitChart: React.FunctionComponent<SplitChartProps> = props => {\n  const { customization: { visualizationColors } } = useSettingsContext();\n  const {\n    chartId,\n    interactions,\n    visualisationStage,\n    chartStage,\n    essence,\n    xScale,\n    xTicks,\n    selectDatum,\n    dataset\n  } = props;\n  const { interaction } = interactions;\n  const splitDatum = selectDatum(dataset);\n  const splitDataset = selectSplitDataset(splitDatum);\n\n  const series = essence.getConcreteSeries();\n\n  const label = <Label essence={essence} datum={splitDatum}/>;\n  const hoverContent = isHover(interaction) && <SplitHoverContent\n    interaction={interaction}\n    essence={essence}\n    dataset={splitDataset}/>;\n\n  const continuousSplit = getContinuousSplit(essence);\n  const getX = (d: Datum) => continuousSplit.selectValue<TimeRange | NumberRange>(d);\n  const domain = extentAcrossSeries(splitDataset, essence);\n\n  if (series.count() === 1) {\n    const firstSeries = series.first();\n    return <BaseChart\n      chartId={chartId}\n      interactions={interactions}\n      hoverContent={hoverContent}\n      timezone={essence.timezone}\n      label={label}\n      xScale={xScale}\n      xTicks={xTicks}\n      chartStage={chartStage}\n      formatter={firstSeries.formatter()}\n      yDomain={domain} visualisationStage={visualisationStage}>\n      {({ yScale, lineStage }) => {\n        return <SingletonSeriesChartLine\n          xScale={xScale}\n          yScale={yScale}\n          getX={getX}\n          dataset={splitDataset.data}\n          stage={lineStage}\n          essence={essence}\n          series={firstSeries}/>;\n      }}\n    </BaseChart>;\n  }\n\n  return <BaseChart\n    chartId={chartId}\n    visualisationStage={visualisationStage}\n    timezone={essence.timezone}\n    hoverContent={hoverContent}\n    interactions={interactions}\n    label={label}\n    xScale={xScale}\n    xTicks={xTicks}\n    chartStage={chartStage}\n    formatter={defaultFormatter}\n    yDomain={domain}>\n    {({ yScale, lineStage }) => <React.Fragment>\n      {series.toArray().map((series, index) => {\n        const color = visualizationColors.series[index];\n        return <ColoredSeriesChartLine\n          key={series.plywoodKey()}\n          xScale={xScale}\n          yScale={yScale}\n          getX={getX}\n          dataset={splitDataset.data}\n          stage={lineStage}\n          essence={essence}\n          series={series}\n          color={color}/>;\n      })}\n    </React.Fragment>}\n  </BaseChart>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Dataset, Datum } from \"plywood\";\nimport React from \"react\";\nimport { Essence } from \"../../../../../common/models/essence/essence\";\nimport { Stage } from \"../../../../../common/models/stage/stage\";\nimport { compose, Unary } from \"../../../../../common/utils/functional/functional\";\nimport { LegendSpot } from \"../../../../components/pinboard-panel/pinboard-panel\";\nimport { selectFirstSplitDatums, selectMainDatum, selectSplitDatums } from \"../../../../utils/dataset/selectors/selectors\";\nimport { InteractionsProps } from \"../../interactions/interaction-controller\";\nimport { SeriesLegend } from \"../../legend/series-legend\";\nimport { ContinuousScale } from \"../../utils/continuous-types\";\nimport { ContinuousTicks } from \"../../utils/pick-x-axis-ticks\";\nimport { hasNominalSplit } from \"../../utils/splits\";\nimport { calculateChartStage } from \"../calculate-chart-stage\";\nimport { nominalValueKey } from \"./nominal-value-key\";\nimport { SplitChart } from \"./split-chart\";\n\ninterface ChartsPerSplit {\n  interactions: InteractionsProps;\n  essence: Essence;\n  dataset: Dataset;\n  xScale: ContinuousScale;\n  xTicks: ContinuousTicks;\n  stage: Stage;\n}\n\nfunction getChartsSelectors(essence: Essence, dataset: Dataset): Array<Unary<Dataset, Datum>> {\n  if (!hasNominalSplit(essence)) {\n    return [selectMainDatum];\n  }\n\n  const splitDatums = selectFirstSplitDatums(dataset);\n  return splitDatums.map((datum, index) => {\n    const getNthDatum = compose(selectSplitDatums, datums => datums[index]);\n    return compose<Dataset, Datum, Datum>(selectMainDatum, getNthDatum);\n  });\n}\n\nexport const ChartsPerSplit: React.FunctionComponent<ChartsPerSplit> = props => {\n  const { interactions, xScale, xTicks, essence, dataset, stage } = props;\n\n  const hasMultipleSeries = essence.series.count() > 1;\n  const selectors = getChartsSelectors(essence, dataset);\n  const chartStage = calculateChartStage(stage, selectors.length);\n  return <React.Fragment>\n    {hasMultipleSeries && <LegendSpot>\n      <SeriesLegend essence={essence} />\n    </LegendSpot>}\n    {selectors.map(selector => {\n      const key = nominalValueKey(selector(dataset), essence);\n      return <SplitChart\n        key={key}\n        chartId={key}\n        interactions={interactions}\n        essence={essence}\n        dataset={dataset}\n        selectDatum={selector}\n        xScale={xScale}\n        xTicks={xTicks}\n        visualisationStage={stage}\n        chartStage={chartStage} />;\n    })}\n  </React.Fragment>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Datum } from \"plywood\";\nimport { Essence } from \"../../../../../common/models/essence/essence\";\nimport { formatSegment } from \"../../../../../common/utils/formatter/formatter\";\nimport { getNominalSplit, hasNominalSplit } from \"../../utils/splits\";\n\nexport function nominalValueKey(datum: Datum, essence: Essence): string {\n  if (!hasNominalSplit(essence)) return \"no-nominal-split\";\n  const nominalSplit = getNominalSplit(essence);\n  const splitValue = nominalSplit.selectValue(datum);\n  return formatSegment(splitValue, essence.timezone);\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Dataset } from \"plywood\";\nimport React from \"react\";\nimport { Essence } from \"../../../../common/models/essence/essence\";\nimport { Stage } from \"../../../../common/models/stage/stage\";\nimport { ImmutableRecord } from \"../../../../common/utils/immutable-utils/immutable-utils\";\nimport { LineChartSettings } from \"../../../../common/visualization-manifests/line-chart/settings\";\nimport { InteractionsProps } from \"../interactions/interaction-controller\";\nimport { ContinuousScale } from \"../utils/continuous-types\";\nimport { ContinuousTicks } from \"../utils/pick-x-axis-ticks\";\nimport { ChartsPerSeries } from \"./charts-per-series/charts-per-series\";\nimport { ChartsPerSplit } from \"./charts-per-split/charts-per-split\";\n\ninterface ChartsProps {\n  interactions: InteractionsProps;\n  essence: Essence;\n  xScale: ContinuousScale;\n  xTicks: ContinuousTicks;\n  dataset: Dataset;\n  stage: Stage;\n}\n\nexport const Charts: React.FunctionComponent<ChartsProps> = props => {\n  const { essence } = props;\n  const { groupSeries } = essence.visualizationSettings as ImmutableRecord<LineChartSettings>;\n\n  return groupSeries\n    ? <ChartsPerSplit {...props} />\n    : <ChartsPerSeries {...props} />;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Dataset, Datum, NumberRange, Range, TimeRange } from \"plywood\";\nimport { Essence } from \"../../../../common/models/essence/essence\";\nimport { Split } from \"../../../../common/models/split/split\";\nimport { selectFirstSplitDataset, selectFirstSplitDatums } from \"../../../utils/dataset/selectors/selectors\";\nimport { ContinuousScale, ContinuousValue } from \"../utils/continuous-types\";\nimport { getContinuousSplit, hasNominalSplit } from \"../utils/splits\";\n\nconst MAX_HOVER_DIST = 50;\n\nfunction findClosest(data: Datum[], value: ContinuousValue, scaleX: ContinuousScale, continuousSplit: Split): Datum | null {\n  let closestDatum: Datum = null;\n  let minDist = Infinity;\n  for (const datum of data) {\n    const continuousSegmentValue = continuousSplit.selectValue<TimeRange | NumberRange>(datum);\n    if (!continuousSegmentValue || !Range.isRange(continuousSegmentValue)) continue; // !Range.isRange => temp solution for non-bucketed reaching here\n    const mid = continuousSegmentValue.midpoint();\n    const dist = Math.abs(mid.valueOf() - value.valueOf());\n    const distPx = Math.abs(scaleX(mid) - scaleX(value));\n    if ((!closestDatum || dist < minDist) && distPx < MAX_HOVER_DIST) { // Make sure it is not too far way\n      closestDatum = datum;\n      minDist = dist;\n    }\n  }\n  return closestDatum;\n}\n\nexport function findClosestDatum(value: ContinuousValue, essence: Essence, dataset: Dataset, xScale: ContinuousScale): Datum | null {\n  const continuousSplit = getContinuousSplit(essence);\n  if (hasNominalSplit(essence)) {\n    const flattened = selectFirstSplitDataset(dataset).flatten();\n    return findClosest(flattened.data, value, xScale, continuousSplit);\n  }\n  return findClosest(selectFirstSplitDatums(dataset), value, xScale, continuousSplit);\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { Duration } from \"chronoshift\";\nimport { NumberRange, PlywoodRange, TimeRange } from \"plywood\";\nimport { Essence } from \"../../../../common/models/essence/essence\";\nimport { ContinuousRange } from \"../utils/continuous-types\";\nimport { getContinuousSplit } from \"../utils/splits\";\n\nfunction roundTo(v: number, roundTo: number) {\n  return Math.round(Math.floor(v / roundTo)) * roundTo;\n}\n\nexport function snapRangeToGrid(range: PlywoodRange, essence: Essence): ContinuousRange {\n  // floors range to scale ranges\n  const continuousSplit = getContinuousSplit(essence);\n\n  if (TimeRange.isTimeRange(range)) {\n    const { timezone } = essence;\n    const duration = continuousSplit.bucket as Duration;\n    return TimeRange.fromJS({\n      start: duration.floor(range.start, timezone),\n      end: duration.shift(duration.floor(range.end, timezone), timezone, 1)\n    });\n  }\n  if (NumberRange.isNumberRange(range)) {\n    const bucketSize = continuousSplit.bucket as number;\n    const startFloored = roundTo((range as NumberRange).start, bucketSize);\n    let endFloored = roundTo((range as NumberRange).end, bucketSize);\n\n    if (endFloored - startFloored < bucketSize) {\n      endFloored += bucketSize;\n    }\n\n    return NumberRange.fromJS({\n      start: startFloored,\n      end: endFloored\n    });\n  }\n\n  return null;\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { List } from \"immutable\";\nimport { Dataset } from \"plywood\";\nimport React from \"react\";\nimport { ReactNode } from \"react\";\nimport { Essence } from \"../../../../common/models/essence/essence\";\nimport { FilterClause } from \"../../../../common/models/filter-clause/filter-clause\";\nimport { Binary, Nullary, Unary } from \"../../../../common/utils/functional/functional\";\nimport { GlobalEventListener } from \"../../../components/global-event-listener/global-event-listener\";\nimport { toFilterClause } from \"../../../utils/highlight-clause/highlight-clause\";\nimport { mouseEventOffset } from \"../../../utils/mouse-event-offset/mouse-event-offset\";\nimport { Highlight } from \"../../highlight-controller/highlight\";\nimport { ContinuousRange, ContinuousScale, ContinuousValue } from \"../utils/continuous-types\";\nimport { getContinuousReference } from \"../utils/splits\";\nimport { constructRange, shiftByOne } from \"./continuous-range\";\nimport { findClosestDatum } from \"./find-closest-datum\";\nimport { createDragging, createHighlight, createHover, Interaction, isDragging, isHighlight, isHover, MouseInteraction } from \"./interaction\";\nimport { snapRangeToGrid } from \"./snap-range-to-grid\";\n\ninterface InteractionControllerProps {\n  xScale: ContinuousScale;\n  essence: Essence;\n  dataset: Dataset;\n  children: Unary<InteractionsProps, ReactNode>;\n  highlight?: Highlight;\n  saveHighlight: Binary<List<FilterClause>, string, void>;\n  dropHighlight: Nullary<void>;\n  acceptHighlight: Nullary<void>;\n  chartsContainerRef: React.RefObject<HTMLDivElement>;\n}\n\ninterface InteractionsState {\n  interaction: MouseInteraction | null;\n  scrollTop: number;\n}\n\nexport interface InteractionsProps {\n  interaction: Interaction | null;\n  dropHighlight: Nullary<void>;\n  acceptHighlight: Nullary<void>;\n  dragStart: Binary<string, number, void>;\n  handleHover: Binary<string, number, void>;\n  mouseLeave: Nullary<void>;\n}\n\nexport class InteractionController extends React.Component<InteractionControllerProps, InteractionsState> {\n\n  state: InteractionsState = { interaction: null, scrollTop: 0 };\n\n  handleHover = (chartId: string, offset: number) => {\n    // calculate hover range and setState\n    const { interaction } = this.state;\n    if (isDragging(interaction) || isHighlight(interaction)) return;\n    const hoverRange = this.findRangeUnderOffset(offset);\n    if (hoverRange === null) {\n      this.setState({ interaction: null });\n      return;\n    }\n    /*\n      Plywood expects that `equals` argument in concrete Range types (NumberRange, TimeRange)\n      have exact type as object. Because we move union type into covariant position, typescript\n      would expect that `hoverRange` has type NumberRange & TimeRange which is impossible.\n      Plywood handles mismatched types correctly.\n     */\n    // @ts-ignore\n    if (isHover(interaction) && interaction.range.equals(hoverRange)) return;\n    this.setState({ interaction: createHover(chartId, hoverRange) });\n  };\n\n  onMouseLeave = () => {\n    const { interaction } = this.state;\n    if (!isHover(interaction)) return;\n    this.setState({ interaction: null });\n  };\n\n  handleDragStart = (chartId: string, offset: number) => {\n    const { essence: { timezone } } = this.props;\n    const start = this.findValueUnderOffset(offset);\n    const end = shiftByOne(start, timezone);\n    this.setState({ interaction: createDragging(chartId, start, end) });\n  };\n\n  private calculateOffset(e: MouseEvent): number | null {\n    const { chartsContainerRef } = this.props;\n    if (!chartsContainerRef.current) return null;\n    const [x] = mouseEventOffset(e);\n    const { left } = chartsContainerRef.current.getBoundingClientRect();\n    return x - left;\n  }\n\n  dragging = (e: MouseEvent) => {\n    const { interaction } = this.state;\n    if (!isDragging(interaction)) return;\n    const offset = this.calculateOffset(e);\n    if (offset === null) return;\n    const end = this.findValueUnderOffset(offset);\n    const { start, key } = interaction;\n    this.setState({ interaction: createDragging(key, start, end) });\n  };\n\n  stopDragging = (e: MouseEvent) => {\n    const { interaction } = this.state;\n    if (!isDragging(interaction)) return;\n    const offset = this.calculateOffset(e);\n    if (offset === null) return;\n    this.setState({ interaction: null });\n    const { essence, saveHighlight } = this.props;\n    const { start, key } = interaction;\n    const end = this.findValueUnderOffset(offset);\n    const range = snapRangeToGrid(constructRange(start, end, essence.timezone), essence);\n    saveHighlight(List.of(toFilterClause(range, getContinuousReference(essence))), key);\n  };\n\n  private findValueUnderOffset(offset: number): ContinuousValue {\n    const { xScale } = this.props;\n    return xScale.invert(offset);\n  }\n\n  private findRangeUnderOffset(offset: number): ContinuousRange | null {\n    const value = this.findValueUnderOffset(offset);\n    const { essence, xScale, dataset } = this.props;\n    const closestDatum = findClosestDatum(value, essence, dataset, xScale);\n    const range = closestDatum && closestDatum[getContinuousReference(essence)];\n    return range as ContinuousRange;\n  }\n\n  scrollCharts = (scrollEvent: MouseEvent) => {\n    const { scrollTop } = scrollEvent.target as Element;\n\n    this.setState({\n      interaction: null,\n      scrollTop\n    });\n  };\n\n  interaction(): Interaction | null {\n    const { highlight } = this.props;\n    if (highlight) return createHighlight(highlight);\n    return this.state.interaction;\n  }\n\n  render() {\n    const interaction = this.interaction();\n    const { children, acceptHighlight, dropHighlight } = this.props;\n    const hocProps: InteractionsProps = {\n      interaction,\n      acceptHighlight,\n      dropHighlight,\n      dragStart: this.handleDragStart,\n      handleHover: this.handleHover,\n      mouseLeave: this.onMouseLeave\n    };\n    return <React.Fragment>\n      <GlobalEventListener\n        mouseUp={this.stopDragging}\n        mouseMove={this.dragging}\n        scroll={this.scrollCharts} />\n      {children(hocProps)}\n    </React.Fragment>;\n  }\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Duration, Timezone } from \"chronoshift\";\nimport { range } from \"d3\";\nimport { NumberRange, TimeRange } from \"plywood\";\nimport { getBestBucketUnitForRange } from \"../../../../common/models/granularity/granularity\";\nimport { ContinuousDomain } from \"./continuous-types\";\n\nexport type ContinuousTicks = Array<Date | number>;\n\nfunction generateDateTicks(bucket: Duration, start: Date, end: Date, timezone: Timezone): Date[] {\n  return bucket.materialize(start, end as Date, timezone);\n}\n\nfunction generateNumberTicks(bucket: number, start: number, end: number): number[] {\n  const sequence = range(start, end, bucket);\n  return [...sequence, end];\n}\n\nexport default function pickXAxisTicks([start, end]: ContinuousDomain, timezone: Timezone): ContinuousTicks {\n  if (start instanceof Date && end instanceof Date) {\n    const bucket = getBestBucketUnitForRange(TimeRange.fromJS({ start, end }), true) as Duration;\n    return generateDateTicks(bucket, start, end, timezone);\n  }\n  if (typeof start === \"number\" && typeof end === \"number\") {\n    const bucket = getBestBucketUnitForRange(NumberRange.fromJS({ start, end }), true) as number;\n    return generateNumberTicks(bucket, start, end);\n  }\n  throw new Error(`Expected domain to be continuous. Got [${start}, ${end}]`);\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Duration, Timezone } from \"chronoshift\";\nimport * as d3 from \"d3\";\nimport { Dataset, PlywoodRange, Range } from \"plywood\";\nimport { getMaxTime } from \"../../../../common/models/data-cube/data-cube\";\nimport { Essence } from \"../../../../common/models/essence/essence\";\nimport { ContinuousDimensionKind } from \"../../../../common/models/granularity/granularity\";\nimport { Split } from \"../../../../common/models/split/split\";\nimport { Timekeeper } from \"../../../../common/models/timekeeper/timekeeper\";\nimport { union } from \"../../../../common/utils/plywood/range\";\nimport { toPlywoodRange } from \"../../../utils/highlight-clause/highlight-clause\";\nimport { ContinuousRange, ContinuousScale } from \"./continuous-types\";\nimport { getContinuousDimension, getContinuousSplit } from \"./splits\";\n\n// This function is responsible for aligning d3 types with our domain types.\nexport function createContinuousScale(essence: Essence, domainRange: PlywoodRange, width: number): ContinuousScale {\n  const continuousDimension = getContinuousDimension(essence);\n  const kind = continuousDimension.kind as ContinuousDimensionKind;\n  const range = [0, width];\n  switch (kind) {\n    case \"number\": {\n      const domain = [domainRange.start, domainRange.end] as [number, number];\n      return (d3.scaleLinear().clamp(true) as unknown as ContinuousScale).domain(domain).range(range);\n    }\n    case \"time\": {\n      const domain = [domainRange.start, domainRange.end] as [Date, Date];\n      return (d3.scaleTime().clamp(true) as unknown as ContinuousScale).domain(domain).range(range);\n    }\n  }\n}\n\nfunction includeMaxTimeBucket(filterRange: PlywoodRange, maxTime: Date, continuousSplit: Split, timezone: Timezone) {\n  const continuousBucket = continuousSplit.bucket;\n  /*\n    Special treatment for realtime data:\n    Max time could be inside last bucket of time filter.\n   */\n  if (maxTime && continuousBucket instanceof Duration) {\n    const filterRangeEnd = filterRange.end as Date;\n    const filterRangeEndFloored = continuousBucket.floor(filterRangeEnd, timezone);\n    const filterRangeEndCeiled = continuousBucket.shift(filterRangeEndFloored, timezone);\n    if (filterRangeEndFloored < maxTime && maxTime < filterRangeEndCeiled) {\n      return Range.fromJS({ start: filterRange.start, end: filterRangeEndCeiled });\n    }\n  }\n  return filterRange;\n}\n\nfunction getFilterRange(essence: Essence, timekeeper: Timekeeper): PlywoodRange | null {\n  const continuousSplit = getContinuousSplit(essence);\n  const effectiveFilter = essence.getEffectiveFilter(timekeeper);\n  const continuousFilterClause = effectiveFilter.clauseForReference(continuousSplit.reference);\n  if (!continuousFilterClause) return null;\n  const filterRange = toPlywoodRange(continuousFilterClause);\n  const maxTime = getMaxTime(essence.dataCube, timekeeper);\n  return includeMaxTimeBucket(filterRange, maxTime, continuousSplit, essence.timezone);\n}\n\nfunction safeRangeSum(a: PlywoodRange | null, b: PlywoodRange | null): PlywoodRange | null {\n  return (a && b) ? a.extend(b) : (a || b);\n}\n\nfunction getDatasetXRange(dataset: Dataset, continuousSplit: Split): PlywoodRange | null {\n  const flatDataset = dataset.flatten();\n  return flatDataset\n    .data\n    .map(datum => continuousSplit.selectValue(datum) as PlywoodRange)\n    .reduce(safeRangeSum, null);\n}\n\nexport function calculateXRange(essence: Essence, timekeeper: Timekeeper, dataset: Dataset): ContinuousRange | null {\n  const continuousSplit = getContinuousSplit(essence);\n  const filterRange = getFilterRange(essence, timekeeper);\n  const datasetRange = getDatasetXRange(dataset, continuousSplit);\n  return union(filterRange, datasetRange) as ContinuousRange;\n}\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { PlywoodRange, Range } from \"plywood\";\n\nexport function union(first: PlywoodRange | null, second: PlywoodRange | null): PlywoodRange | null {\n  if (!Range.isRange(first) && !Range.isRange(second)) {\n    return null;\n  }\n  if (!Range.isRange(first)) {\n    return second;\n  }\n  if (!Range.isRange(second)) {\n    return first;\n  }\n  return first.union(second);\n}\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Timezone } from \"chronoshift\";\nimport * as d3 from \"d3\";\nimport React from \"react\";\nimport { Stage } from \"../../../../common/models/stage/stage\";\nimport { Unary } from \"../../../../common/utils/functional/functional\";\nimport { getMoment, scaleTicksFormatter } from \"../../../../common/utils/time/time\";\nimport { roundToHalfPx } from \"../../../utils/dom/dom\";\nimport { ContinuousScale } from \"../utils/continuous-types\";\nimport \"./x-axis.scss\";\n\nconst TICK_HEIGHT = 5;\nconst TEXT_OFFSET = 12;\nconst X_AXIS_HEIGHT = 30;\n\nexport interface XAxisProps {\n  width: number;\n  ticks: Array<Date | number>;\n  scale: ContinuousScale;\n  timezone: Timezone;\n}\n\nconst floatFormat = d3.format(\".1f\");\n\nfunction labelFormatter(scale: ContinuousScale, timezone: Timezone): Unary<Date | number, string> {\n  const [start] = scale.domain();\n  if (start instanceof Date) {\n    const formatter = scaleTicksFormatter(scale as any);\n    return (date: Date) => formatter(getMoment(date, timezone));\n  }\n  return (value: number) => String(floatFormat(value));\n}\n\nexport const XAxis: React.FunctionComponent<XAxisProps> = props => {\n  const { width, ticks, scale, timezone } = props;\n  const stage = Stage.fromSize(width, X_AXIS_HEIGHT);\n  const format = labelFormatter(scale, timezone);\n\n  const lines = ticks.map((tick: any) => {\n    const x = roundToHalfPx(scale(tick));\n    return <line key={String(tick)} x1={x} y1={0} x2={x} y2={TICK_HEIGHT} />;\n  });\n\n  const labelY = TICK_HEIGHT + TEXT_OFFSET;\n  const labels = ticks.map((tick: any, index: number) => {\n    const x = scale(tick);\n    return <text key={String(tick)} x={x} y={labelY} style={{ textAnchor: index === 0 ? \"start\" : \"middle\" }}>{format(tick)}</text>;\n  });\n\n  return <svg className=\"bottom-axis\" width={stage.width} height={stage.height}>\n    <g className=\"line-chart-axis\" transform={stage.getTransform()}>\n      {lines}\n      {labels}\n    </g>\n  </svg>;\n};\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { ChartProps } from \"../../../common/models/chart-props/chart-props\";\nimport { LINE_CHART_MANIFEST } from \"../../../common/visualization-manifests/line-chart/line-chart\";\nimport { MessageCard } from \"../../components/message-card/message-card\";\nimport { TimeSeriesVisualizationControls } from \"../../components/timeseries-visualization-controls/visualization-controls\";\nimport { ChartPanel, VisualizationProps } from \"../../views/cube-view/center-panel/center-panel\";\nimport { Charts } from \"./charts/charts\";\nimport { InteractionController } from \"./interactions/interaction-controller\";\nimport \"./line-chart.scss\";\nimport pickXAxisTicks from \"./utils/pick-x-axis-ticks\";\nimport { calculateXRange, createContinuousScale } from \"./utils/x-scale\";\nimport { XAxis } from \"./x-axis/x-axis\";\n\nconst Y_AXIS_WIDTH = 60;\nconst X_AXIS_HEIGHT = 30;\n\nexport default function LineChartVisualization(props: VisualizationProps) {\n  return <React.Fragment>\n    <TimeSeriesVisualizationControls {...props} />\n    <ChartPanel {...props} chartComponent={LineChart}/>\n  </React.Fragment>;\n}\n\nclass LineChart extends React.Component<ChartProps> {\n  protected className = LINE_CHART_MANIFEST.name;\n\n  private chartsRef = React.createRef<HTMLDivElement>();\n\n  render(): JSX.Element {\n    const { essence, data, timekeeper, stage, highlight, dropHighlight, acceptHighlight, saveHighlight } = this.props;\n\n    const range = calculateXRange(essence, timekeeper, data);\n    if (!range) {\n      return <MessageCard title=\"No data found. Try different filters.\"/>;\n    }\n    const scale = createContinuousScale(essence, range, stage.width - Y_AXIS_WIDTH);\n    const ticks = pickXAxisTicks(scale.domain(), essence.timezone);\n\n    const maxHeight = stage.height - X_AXIS_HEIGHT;\n\n    return <InteractionController\n      dataset={data}\n      xScale={scale}\n      chartsContainerRef={this.chartsRef}\n      essence={essence}\n      highlight={highlight}\n      dropHighlight={dropHighlight}\n      acceptHighlight={acceptHighlight}\n      saveHighlight={saveHighlight}>\n      {interactions => {\n        return <div className=\"line-chart-container\">\n          <div className=\"line-charts\" ref={this.chartsRef} style={{ maxHeight }}>\n            <Charts\n              interactions={interactions}\n              stage={stage.changeHeight(maxHeight)}\n              essence={essence}\n              xScale={scale}\n              xTicks={ticks}\n              dataset={data}/>\n          </div>\n          <XAxis\n            width={stage.width}\n            ticks={ticks}\n            scale={scale}\n            timezone={essence.timezone}/>\n        </div>;\n      }}\n    </InteractionController>;\n  }\n}\n"],"sourceRoot":""}