{"version":3,"sources":["webpack:///./src/client/components/delta/delta.tsx","webpack:///./src/client/components/drop-indicator/drop-indicator.tsx","webpack:///./src/client/components/filter-tile/add-filter.tsx","webpack:///./src/common/utils/array/array.ts","webpack:///./src/client/components/filter-menu/boolean-filter-menu/boolean-filter-menu.tsx","webpack:///./src/client/components/filter-options-dropdown/filter-options-dropdown.tsx","webpack:///./src/client/components/range-handle/range-handle.tsx","webpack:///./src/client/components/number-range-picker/number-range-picker.tsx","webpack:///./src/client/components/filter-menu/number-filter-menu/number-filter-menu.tsx","webpack:///./src/client/components/preview-string-filter-menu/preview-list.tsx","webpack:///./src/client/components/preview-string-filter-menu/preview-string-filter-menu.tsx","webpack:///./src/client/components/paste-form/paste-form.tsx","webpack:///./src/client/components/selectable-string-filter-menu/string-value.tsx","webpack:///./src/client/components/selectable-string-filter-menu/string-values-list.tsx","webpack:///./src/client/components/selectable-string-filter-menu/selectable-string-filter-menu.tsx","webpack:///./src/client/components/filter-menu/string-filter-menu/string-filter-menu.tsx","webpack:///./src/client/components/date-range-input/date-range-input.tsx","webpack:///./src/client/components/date-range-picker/calendar.ts","webpack:///./src/client/components/date-range-picker/date-range-picker.tsx","webpack:///./src/client/components/filter-menu/time-filter-menu/time-shift-selector.tsx","webpack:///./src/client/components/filter-menu/time-filter-menu/fixed-time-tab.tsx","webpack:///./src/client/components/filter-menu/time-filter-menu/preset-time-tab.tsx","webpack:///./src/client/components/filter-menu/time-filter-menu/time-filter-menu.tsx","webpack:///./src/client/components/filter-menu/filter-menu.tsx","webpack:///./src/client/components/filter-tile/filter-tile.tsx","webpack:///./src/client/components/filter-tile/partial-filter-tile.tsx","webpack:///./src/client/components/filter-tile/filter-tiles.tsx","webpack:///./src/client/components/filter-tile/filter-tiles-row.tsx","webpack:///./src/client/components/manual-fallback/manual-fallback.tsx","webpack:///./src/client/components/series-tile/add-series.tsx","webpack:///./src/client/components/series-menu/format-picker.tsx","webpack:///./src/client/components/series-menu/arithmetic-series-menu.tsx","webpack:///./src/client/components/series-menu/measure-series-menu.tsx","webpack:///./src/client/components/series-menu/percent-series-menu.tsx","webpack:///./src/client/components/series-menu/quantile-picker.tsx","webpack:///./src/client/components/series-menu/quantile-series-menu.tsx","webpack:///./src/client/components/series-menu/series-menu.tsx","webpack:///./src/client/components/series-tile/placeholder-series.tsx","webpack:///./src/client/components/series-tile/series-tile.tsx","webpack:///./src/client/components/series-tile/series-tiles.tsx","webpack:///./src/client/components/series-tile/series-tiles-row.tsx","webpack:///./src/client/visualization-settings/settings-component.ts","webpack:///./src/client/visualization-settings/line-chart/line-chart-settings.tsx","webpack:///./src/client/visualization-settings/table/table-settings.tsx","webpack:///./src/client/visualization-settings/scatterplot/scatterplot-settings.tsx","webpack:///./src/client/components/vis-selector/vis-selector-menu.tsx","webpack:///./src/client/components/vis-selector/vis-selector.tsx","webpack:///./src/client/visualizations/data-provider/data-provider.tsx","webpack:///./src/client/views/cube-view/center-panel/center-panel.tsx","webpack:///./src/client/components/with-ref/with-ref.tsx","webpack:///./src/client/components/input-with-presets/string-input-with-presets.tsx","webpack:///./src/client/components/split-menu/granularity-picker.tsx","webpack:///./src/client/components/split-menu/limit-dropdown.tsx","webpack:///./src/client/components/split-menu/sort-dropdown.tsx","webpack:///./src/client/components/split-menu/split-menu-base.tsx","webpack:///./src/client/components/split-tile/add-split.tsx","webpack:///./src/client/components/split-tile/split-tiles.tsx","webpack:///./src/client/components/split-tile/split-tiles-row.tsx","webpack:///./src/client/components/tile-overflow-container/tile-overflow-container.tsx","webpack:///./src/client/components/split-menu/split-menu.tsx","webpack:///./src/client/components/split-tile/split-tile.tsx","webpack:///./src/client/components/drag-indicator/fancy-drag-indicator.tsx","webpack:///./src/client/components/drag-indicator/drag-indicator.tsx","webpack:///./src/client/components/message-card/message-card.tsx","webpack:///./src/client/components/add-tile/add-tile.tsx","webpack:///./src/client/components/button-group/button-group.tsx","webpack:///./src/client/visualizations/highlight-controller/highlight.ts","webpack:///./src/client/visualizations/highlight-controller/highlight-controller.tsx","webpack:///./src/client/components/input-with-presets/input-with-presets.tsx"],"names":["deltaSignToClassName","deltaSign","lowerIsBetter","percentageFormatter","format","Delta","currentValue","previousValue","formatter","formattedDelta","isNil","delta","deltaRatio","Math","abs","formatDelta","className","ratio","deltaSignToSymbol","isFinite","DropIndicator","svg","require","React","Component","AddFilter","props","appendFilter","menuStage","essence","filter","dataCube","tiles","allDimensions","dimensions","dimension","getClauseForDimension","map","key","name","label","title","value","onSelect","containerStage","insert","array","index","element","slice","BooleanFilterMenu","initialValues","actionEnabled","saveClause","onClose","constructClause","selectedValues","state","newSelection","has","remove","add","setState","String","onClick","selectValue","selected","this","clause","Set","of","values","BooleanFilterClause","Error","fetchData","booleanFilterQuery","context","loading","then","dataset","data","d","error","isEmpty","reference","newClause","oldClause","equals","openOn","direction","stage","Stage","fromSize","renderRow","type","STRINGS","ok","onOkClick","disabled","cancel","onCancelClick","ApiContext","FILTER_OPTIONS","include","FilterMode","INCLUDE","checkType","exclude","EXCLUDE","contains","CONTAINS","regex","REGEX","FilterOptionsDropdown","option","onSelectOption","selectedOption","filterOptions","selectedItem","find","menuClassName","items","equal","a","b","keyItem","renderItem","renderFilterOption","renderSelectedItem","filterTypes","indexOf","RangeHandle","anchor","event","onChange","leftBound","rightBound","newX","getXFromEvent","clamp","offset","positionLeft","preventDefault","window","addEventListener","onGlobalMouseUp","onGlobalMouseMove","removeEventListener","isAny","isBeyondMin","isBeyondMax","style","left","classNames","onMouseDown","addNubSize","subtractNubSize","getAdjustedStartHalf","start","NUB_SIZE","NumberRangePicker","createRef","absolutePosition","onRangeStartChange","relativePosition","leftOffset","relativePositionToValue","onRangeEndChange","min","max","step","timekeeper","numberFilterQuery","mounted","isTruthy","rect","picker","current","getBoundingClientRect","width","position","n","totalDigits","range","toSignificantDigits","getNumberOfWholeDigits","positionStart","positionEnd","e","absoluteX","relativeX","updateStart","startNubPosition","endNubPosition","isAfterEnd","inBetween","updateEnd","distanceFromEnd","distanceFromStart","end","content","relativeStart","valueToRelativePosition","relativeEnd","adjustedRightBound","rangeBarSelected","absoluteRightBound","onBarClick","bind","inverted","ref","numberOrAnyToString","any","stringToNumberOrAny","startInput","parse","parseFloat","isNaN","getFilterOptions","NumberFilterMenu","enterKey","target","endInput","filterMode","NumberFilterClause","count","first","getModeForDimension","globalKeyDownListener","not","List","NumberRange","bounds","Boolean","menuSize","onSelectFilterOption","onRangeInputStartChange","onRangeInputEndChange","errorNotice","Row","highlight","text","filterValues","list","searchText","includes","escaped","replace","regexp","RegExp","test","predicate","PreviewList","regexErrorMessage","limit","length","filtered","Fragment","PreviewStringFilterMenu","StringFilterClause","action","StringFilterAction","IN","initialSearchText","stringFilterQuery","lastSearchText","loaded","catch","err","reportError","debounceWithPromise","queryFilter","SEARCH_WAIT","sendQueryFilter","debouncedQueryFilter","message","checkRegex","loadRows","prevProps","prevState","MATCH","hasMore","isLoaded","keyDown","placeholder","focusOnMount","updateSearchText","isError","isLoading","focus","textArea","PasteForm","split","s","trim","saveValue","select","StringValue","checkboxStyle","onRowSelect","altKey","ctrlKey","metaKey","hasModKey","StringValuesList","rows","promoted","promotedValues","rowValues","matchingValues","searchTextLower","toLowerCase","filterRows","toggle","set","SelectableStringFilterMenu","pasteModeEnabled","initialSelection","withModKey","isValueSingleSelected","isFilterValid","_","constructSearchTextClause","ignoreCase","enablePasteMode","onValueClick","selectValues","disablePasteMode","renderImportMode","renderSelectMode","StringFilterMenu","initialFilterMode","dimensionKind","kind","concat","selectableProps","previewProps","renderFilterControls","DateRangeInput","dateString","timeString","normalizeISODate","validateISODate","changeDate","normalizeISOTime","validateISOTime","time","timezone","updateStateFromTime","nextProps","valueOf","formatISODate","formatISOTime","possibleDateString","possibleTimeString","possibleMoment","combineDateAndTimeIntoMoment","isValid","toDate","hide","dateValue","timeValue","dateChange","timeChange","calendarDays","startDay","locale","monthWeeks","weeks","firstDayOfMonth","getMoment","firstDayOfNextMonth","clone","week","currentPointer","startOf","isBefore","day","weekStart","push","monthToWeeks","firstWeek","lastWeek","middleWeeks","padFirstWeek","padLastWeek","lastDate","padCount","i","shift","nextNDates","firstDate","previousNDates","DateRangePicker","activeMonthStartDate","month","floor","startTime","Date","hoverTimeRange","selectionSet","navigateToMonth","newDate","mouseEnteredDay","endTime","TimeRange","startDate","endDate","onStartChange","onEndChange","selection","selectNewRange","isBackwardSelection","datesEqual","date","monthStart","maxTime","dayBeforeEnd","nextMonthStart","daysInWeek","row","dayDate","column","isPast","isFuture","isBeyondMaxRange","isSelected","isSelectedEdgeStart","isSelectedEdgeEnd","getIsSelectable","selectDay","onMouseEnter","calculateHoverTimeRange","getDayInMonth","renderDays","goToPreviousMonth","formatYearMonth","goToNextMonth","days","cyclicShift","shortDays","onMouseLeave","onCalendarMouseLeave","renderCalendarNav","renderCalendar","timeShiftPreviewForRange","duration","Duration","fromJS","safeDurationFromJS","shiftedTimeRange","formatTimeRange","presets","identity","timeShiftDurations","normalizeDurationName","toJS","TimeShiftSelector","onShiftChange","selectedTimeShift","timeShiftPreview","timeShift","errorMessage","isValidTimeShift","invalidDurationFormat","timeShiftExamples","FixedTimeTab","timeFilter","getEffectiveFilter","clauseForReference","FixedTimeFilterClause","get","initialState","validate","clicker","constructFixedClause","changeComparisonShift","constructTimeShift","maybeEnd","DateRange","createDateRange","TimeShift","currentRange","previousRange","intersects","isTimeShiftValid","areDatesValid","doesTimeShiftOverlap","overlappingPeriods","newTimeShift","isFormValid","isFilterDifferent","overlapError","validateOverlap","getMaxTime","setTimeShift","filterClause","RelativeTimeFilterClause","period","filterDuration","filterPeriod","PresetTimeTab","constructRelativeClause","isValidDuration","timeShiftDuration","getCanonicalLength","isDurationValid","latestPeriodDurations","latestPeriod","TimeFilterPeriod","LATEST","latest","undefined","setFilter","durationsExamples","activePeriod","groupMembers","getTimeFilterPresets","evaluateSelection","previewFilter","getFilterRange","previewText","noFilter","isTimeAttribute","expression","renderLatestPresets","renderButtonGroup","CURRENT","previous","PREVIOUS","saveTimeFilter","tabTitle","tab","TimeFilterTab","RELATIVE","relative","fixed","TabSelector","selectedTab","onTabSelect","tabs","FIXED","initialTab","TimeFilterMenu","isRelativeTab","tabProps","selectTab","FilterMenu","tileTitle","getFormattedClause","timeShiftLabel","FilterTile","open","removeClause","openFilterMenu","closeFilterMenu","dragStart","excluded","isTimeFilter","setRef","included","draggable","onDragStart","PartialFilterTile","closeItem","FilterTiles","maxItems","removeFilter","openedFilterMenu","partialFilter","removePartialFilter","overflowOpen","closeOverflowMenu","openOverflowMenu","clauses","toArray","updateClause","changeFilter","setClause","tilesWithPlaceholder","partialTile","newFilter","isInsert","insertByIndex","replaceByIndex","insertClause","getIndex","insertPartialTile","findDimensionByName","isTimeClause","getTimeDimension","visibleItems","el","idx","cloneElement","transformStyle","SECTION_WIDTH","overflowItems","anyOverflowItemOpen","some","isPartialFilterInOverflow","overflowOpened","filterItemOverflow","x","FilterTilesRow","openedClause","dataTransfer","effectAllowed","setDragData","DragManager","setDragFilter","setDragGhost","canDrop","dragPosition","calculateDragPosition","dragging","DraggedElementType","DIMENSION","dropDimension","draggingDimension","FILTER","dropFilter","draggingFilter","SPLIT","dropSplit","draggingSplit","addPartialFilter","DragPosition","insertAt","getMaxItems","MEASURE","SERIES","NONE","numItems","calculateFromOffset","CORE_ITEM_WIDTH","CORE_ITEM_GAP","isReplace","targetClause","getTimeDimensionReference","onDragEnter","dragEnter","dragOver","dragLeave","drop","CubeContext","ManualFallback","resolution","adjustment","splits","series","changeSeriesList","changeSplits","VisStrategy","KeepAlways","visResolve","isManual","resolutionItems","resolutions","onResolutionClick","description","AddSeries","appendMeasureSeries","allMeasures","measures","measure","hasMeasure","printFormat","measureFormat","SeriesFormatType","DEFAULT","EXACT","exactFormat","PERCENT","percentFormat","CUSTOM","FormatPicker","formatChange","formatPresets","concatTruthy","measureDefaultFormat","DEFAULT_FORMAT","EXACT_FORMAT","PERCENT_FORMAT","customFormat","readFormat","href","seriesFormatter","OPERATIONS","id","ExpressionSeriesOperation","ADD","SUBTRACT","MULTIPLY","DIVIDE","renderOperation","op","renderMeasure","m","renderSelectedMeasure","ArithmeticSeriesMenu","initialSeries","seriesList","onSeriesChange","ArithmeticExpression","isSeriesValid","duplicate","removeSeries","getSeriesWithKey","operation","operand","findMeasureByName","byName","isApproximate","setIn","ExpressionConcreteSeries","expressionSeriesTitle","MeasureSeriesMenu","PERCENT_OF_PARENT","PERCENT_OF_TOTAL","PercentSeriesMenu","selectedOperations","getExpressionSeriesFor","PercentExpression","toSet","toString","QuantilePicker","parseCustomValue","formatCustomValue","percentiles","QuantileSeriesMenu","otherSeries","validateSeries","percentile","hasSeriesWithKey","SeriesMenu","saveSeries","isModified","isUnique","MeasureSeries","ExpressionSeries","QuantileSeries","PlaceholderSeriesTile","SeriesTile","item","updateSeries","openSeriesMenu","closeSeriesMenu","definition","newSeries","stopPropagation","SeriesTiles","openedSeriesMenu","removePlaceholderSeries","savePlaceholderSeries","partialSeries","getConcreteSeries","placeholderTile","insertPlaceholder","isDummySeriesInOverflow","seriesItemOverflow","SeriesTilesRow","openedSeries","oldSeries","replaceSeries","removePartialSeries","addSeries","setDragSeries","isDraggingSeries","rearrangeSeries","draggingSeries","dropNewSeries","fromMeasure","draggingMeasure","addPartialSeries","isMeasureSeries","isUniqueQuantile","hasSeries","Components","settings","groupSeries","update","collapseRows","collapse","showSummary","settingsComponent","visualization","VisSelectorMenu","initialVisualization","visualizationSettings","initialSettings","defaults","component","TableSettingsComponent","changeSettings","LineChartSettingsComponent","ScatterplotSettingsComponent","MANIFESTS","changeVisualization","renderSettings","save","close","visSelectorMenuStage","VisSelector","openMenu","currentTarget","selector","closeMenu","vis","active","renderMenu","DataProvider","query","wasUsedForLastQuery","callExecutor","loadData","lastQueryEssence","debouncedCallExecutor","shouldFetchData","visualisationNotResized","hadDataLoaded","essenceChanged","showSpinner","handleDatasetLoad","loadedDataset","setDataset","differentVisualizationDefinition","nextEssence","nextTimekeeper","differentDataCube","differentEffectiveFilter","differentTimeShift","differentSplits","differentSeries","differentSettings","differentBucketingTimezone","differentLastRefreshRequestTimestamp","newEssence","hasSplitOn","refreshRequestTimestamp","children","status","DatasetRequestStatus","LOADING","ERROR","LOADED","DownloadableDatasetContext","DefaultVisualizationControls","splitTilesRow","DefaultSplitTilesRow","VisualizationControls","SplitTilesRow","addFilter","customization","removeTile","ChartPanel","chartComponent","lastRefreshRequestTimestamp","isDraggedOver","ChartWrapper","onDragOver","onDragLeave","onDragExit","onDrop","ChartComponent","highlightProps","Consumer","visualizationQuery","WithRef","StringInputWithPresets","GranularityPicker","granularity","granularityChange","isContinuous","granularities","getGranularities","bucketedBy","g","formatGranularity","granularityToString","floorableDurationsExamples","validateGranularity","formatLimit","calculateLimits","limits","includeNone","LimitDropdown","onLimitSelect","selectedLimit","SortDropdown","options","sortBy","SortOn","getTitle","getKey","sortOn","toSort","newDirection","SortDirection","descending","ascending","validateSplit","splitAssembly","isGranularityValid","newSplit","createSplit","sort","bucket","coerceGranularity","Split","SplitMenuBase","onSave","AddSplit","appendSplit","findSplitForDimension","SplitTiles","SplitTile","splitTileComponent","removeSplit","updateSplit","openedSplit","splitTiles","toKey","visibleSplits","overflowSplits","anyOverflowTileOpen","splitOverflow","DefaultSplitTile","oldSplit","UnfairGame","FairGame","setDragSplit","insertSplit","replaceSplit","addSplit","fromDimension","SEGMENT_HEIGHT","TileOverflowContainerMenu","positionedItems","fixedSize","TileOverflowContainer","SplitMenu","saveSplit","seriesSortOns","DimensionSortOn","fromSort","saveGranularity","saveSort","saveLimit","splitMenuComponent","FancyDragIndicator","ghostArrowLeft","sectionWidth","dragGhostElement","DragIndicator","MessageCard","AddTile","addButton","menuOpenOn","setQuery","resetQuery","selectTile","renderRows","filteredRows","renderTable","mountAdd","ButtonGroup","button","renderMembers","Highlight","hasHighlightOn","HighlightController","mergeClauses","dropHighlight","acceptHighlight","saveHighlight","InputWithPresets","customValue","customPicked","isPresetPicked","presetButtons","pickPreset","customSelected","customButton","pickCustom","members","renderErrorMessage","invalid","customValueUpdate"],"mappings":"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","file":"default~bar-chart~grid~heatmap~line-chart~scatterplot~table~totals.ed28c8879cf025c74f34.js","sourcesContent":["/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { format } from \"d3\";\nimport React from \"react\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { isNil } from \"../../../common/utils/general/general\";\nimport \"./delta.scss\";\n\nexport type DeltaSign = -1 | 0 | 1;\n\nexport interface DeltaAttributes {\n  delta: number;\n  deltaRatio: number;\n  deltaSign: DeltaSign;\n}\n\nexport function formatDelta(currentValue: number, previousValue: number): DeltaAttributes {\n  if (isNil(currentValue) || isNil(previousValue)) {\n    return null;\n  }\n\n  const delta = currentValue - previousValue;\n  const deltaSign = delta ? delta < 0 ? -1 : 1 : 0;\n  const deltaRatio = Math.abs(delta / previousValue);\n\n  return { deltaSign, deltaRatio, delta };\n}\n\nfunction deltaSignToSymbol(deltaSign: DeltaSign): string {\n  switch (deltaSign) {\n    case -1:\n      return \"▼\";\n    case 0:\n      return \"\";\n    case 1:\n      return \"▲\";\n  }\n}\n\nfunction deltaSignToClassName(deltaSign: DeltaSign, lowerIsBetter = false): string {\n  switch (deltaSign) {\n    case -1:\n      return lowerIsBetter ? \"delta-positive\" : \"delta-negative\";\n    case 0:\n      return \"delta-neutral\";\n    case 1:\n      return lowerIsBetter ? \"delta-negative\" : \"delta-positive\";\n  }\n}\n\nconst percentageFormatter = format(\".1%\");\n\nfunction printDeltaRatio(ratio: number): string | null {\n  if (!isFinite(ratio)) return null;\n  return ` (${percentageFormatter(ratio)})`;\n}\n\nexport interface DeltaProps {\n  currentValue: number;\n  previousValue: number;\n  formatter: Unary<number, string>;\n  lowerIsBetter?: boolean;\n}\n\nexport const Delta: React.FunctionComponent<DeltaProps> = ({ lowerIsBetter, currentValue, previousValue, formatter }) => {\n  const formattedDelta = formatDelta(currentValue, previousValue);\n  if (formattedDelta === null) {\n    return <span className=\"delta-neutral\">-</span>;\n  }\n\n  const { delta, deltaRatio, deltaSign } = formattedDelta;\n  return <span className={deltaSignToClassName(deltaSign, lowerIsBetter)}>\n    {deltaSignToSymbol(deltaSign)}\n    {formatter(Math.abs(delta))}\n    {printDeltaRatio(deltaRatio)}\n  </span>;\n};\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { SvgIcon } from \"../svg-icon/svg-icon\";\nimport \"./drop-indicator.scss\";\n\nexport interface DropIndicatorProps {\n}\n\nexport interface DropIndicatorState {\n}\n\nexport class DropIndicator extends React.Component<DropIndicatorProps, DropIndicatorState> {\n\n  render() {\n    return <div className=\"drop-indicator\">\n      <div className=\"white-out\" />\n      <div className=\"action\">\n        <SvgIcon svg={require(\"../../icons/split-replace.svg\")} />\n      </div>\n    </div>;\n  }\n}\n","/*\n * Copyright 2017-2021 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Dimension } from \"../../../common/models/dimension/dimension\";\nimport { allDimensions } from \"../../../common/models/dimension/dimensions\";\nimport { Essence } from \"../../../common/models/essence/essence\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { AddTile } from \"../add-tile/add-tile\";\n\ninterface AddFilterProps {\n  appendFilter: Unary<Dimension, void>;\n  menuStage: Stage;\n  essence: Essence;\n}\n\nexport const AddFilter: React.FunctionComponent<AddFilterProps> = props => {\n  const { appendFilter, menuStage, essence: { filter, dataCube } } = props;\n  const tiles = allDimensions(dataCube.dimensions)\n    .filter(dimension => !filter.getClauseForDimension(dimension))\n    .map(dimension => {\n      return {\n        key: dimension.name,\n        label: dimension.title,\n        value: dimension\n      };\n    });\n\n  return <AddTile<Dimension>\n    tiles={tiles}\n    onSelect={appendFilter}\n    containerStage={menuStage} />;\n};\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nexport function insert<T>(array: T[], index: number, element: T): T[] {\n  return [...array.slice(0, index), element, ...array.slice(index)];\n}\n\nexport function shallowEqualArrays(a: unknown[], b: unknown[]): boolean {\n  if (a === b) return true;\n  if (!a || !b) return false;\n  if (b.length !== a.length) return false;\n\n  for (let i = 0; i < a.length; i++) {\n    if (a[i] !== b[i]) {\n      return false;\n    }\n  }\n\n  return true;\n}\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Set } from \"immutable\";\nimport { Dataset } from \"plywood\";\nimport React from \"react\";\nimport { Dimension } from \"../../../../common/models/dimension/dimension\";\nimport { Essence } from \"../../../../common/models/essence/essence\";\nimport { BooleanFilterClause, FilterClause } from \"../../../../common/models/filter-clause/filter-clause\";\nimport { Stage } from \"../../../../common/models/stage/stage\";\nimport { Unary } from \"../../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../../common/utils/general/general\";\nimport { STRINGS } from \"../../../config/constants\";\nimport { ApiContext, ApiContextValue } from \"../../../views/cube-view/api-context\";\nimport { BubbleMenu } from \"../../bubble-menu/bubble-menu\";\nimport { Button } from \"../../button/button\";\nimport { Checkbox } from \"../../checkbox/checkbox\";\nimport { Loader } from \"../../loader/loader\";\nimport { QueryError } from \"../../query-error/query-error\";\nimport \"./boolean-filter-menu.scss\";\n\ninterface BooleanFilterMenuProps {\n  dimension: Dimension;\n  saveClause: Unary<FilterClause, void>;\n  essence: Essence;\n  onClose: Fn;\n  containerStage?: Stage;\n  openOn: Element;\n}\n\nexport type Booleanish = string | boolean | null;\n\ninterface BooleanFilterMenuState {\n  loading?: boolean;\n  error?: Error;\n  values: Booleanish[];\n  selectedValues: Set<Booleanish>;\n}\n\nexport class BooleanFilterMenu extends React.Component<BooleanFilterMenuProps, BooleanFilterMenuState> {\n  static contextType = ApiContext;\n\n  context: ApiContextValue;\n\n  state = this.initialValues();\n\n  initialValues(): BooleanFilterMenuState {\n    const { essence: { filter }, dimension } = this.props;\n    const clause = filter.getClauseForDimension(dimension);\n    if (!clause) {\n      return { selectedValues: Set.of(), values: [] };\n    }\n    if (!(clause instanceof BooleanFilterClause)) {\n      throw new Error(`Expected boolean filter clause, got: ${clause}`);\n    }\n    return { selectedValues: clause.values, values: [] };\n  }\n\n  componentDidMount() {\n    this.fetchData();\n  }\n\n  fetchData() {\n    const { booleanFilterQuery } = this.context;\n    const { essence, dimension } = this.props;\n\n    this.setState({ loading: true });\n    booleanFilterQuery(essence, dimension)\n      .then(\n        (dataset: Dataset) => {\n          this.setState({\n            loading: false,\n            values: dataset.data.map(d => d[dimension.name] as Booleanish),\n            error: null\n          });\n        },\n        error => {\n          this.setState({\n            loading: false,\n            values: [],\n            error\n          });\n        }\n      );\n\n  }\n\n  constructClause(): BooleanFilterClause | null {\n    const { selectedValues } = this.state;\n    if (selectedValues.isEmpty()) return null;\n\n    const { dimension } = this.props;\n    return new BooleanFilterClause({\n      reference: dimension.name,\n      values: selectedValues\n    });\n  }\n\n  actionEnabled(): boolean {\n    const { essence: { filter }, dimension } = this.props;\n    const newClause = this.constructClause();\n    const oldClause = filter.getClauseForDimension(dimension);\n    return newClause && !newClause.equals(oldClause);\n  }\n\n  onOkClick = () => {\n    if (!this.actionEnabled()) return;\n    const { saveClause, onClose } = this.props;\n    saveClause(this.constructClause());\n    onClose();\n  };\n\n  onCancelClick = () => {\n    const { onClose } = this.props;\n    onClose();\n  };\n\n  selectValue = (value: Booleanish) => {\n    const { selectedValues } = this.state;\n    const newSelection = selectedValues.has(value) ? selectedValues.remove(value) : selectedValues.add(value);\n    this.setState({ selectedValues: newSelection });\n  };\n\n  renderRow = (value: Booleanish) => {\n    const { selectedValues } = this.state;\n    return <div\n      className=\"row\"\n      key={String(value)}\n      title={String(value)}\n      onClick={() => this.selectValue(value)}>\n      <div className=\"row-wrapper\">\n        <Checkbox selected={selectedValues.has(value)} />\n        <span className=\"label\">{String(value)}</span>\n      </div>\n    </div>;\n  };\n\n  render() {\n    const { onClose, containerStage, openOn } = this.props;\n    const { values, error, loading } = this.state;\n\n    return <BubbleMenu\n      className=\"boolean-filter-menu\"\n      direction=\"down\"\n      containerStage={containerStage}\n      stage={Stage.fromSize(250, 210)}\n      openOn={openOn}\n      onClose={onClose}>\n      <div className=\"menu-table\">\n        <div className=\"rows\">\n          {values.map(this.renderRow)}\n        </div>\n        {error && <QueryError error={error} />}\n        {loading && <Loader />}\n      </div>\n      <div className=\"ok-cancel-bar\">\n        <Button type=\"primary\" title={STRINGS.ok} onClick={this.onOkClick} disabled={!this.actionEnabled()} />\n        <Button type=\"secondary\" title={STRINGS.cancel} onClick={this.onCancelClick} />\n      </div>\n    </BubbleMenu>;\n  }\n}\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { FilterMode } from \"../../../common/models/filter/filter\";\nimport { STRINGS } from \"../../config/constants\";\nimport { CheckboxType } from \"../checkbox/checkbox\";\nimport { Dropdown } from \"../dropdown/dropdown\";\nimport { SvgIcon } from \"../svg-icon/svg-icon\";\nimport \"./filter-options-dropdown.scss\";\n\nexport interface FilterOption {\n  label: string;\n  value: FilterMode;\n  svg: string;\n  checkType?: CheckboxType;\n}\n\nconst FILTER_OPTIONS: FilterOption[] = [\n  {\n    label: STRINGS.include,\n    value: FilterMode.INCLUDE,\n    svg: require(\"../../icons/filter-include.svg\"),\n    checkType: \"check\"\n  },\n  {\n    label: STRINGS.exclude,\n    value: FilterMode.EXCLUDE,\n    svg: require(\"../../icons/filter-exclude.svg\"),\n    checkType: \"cross\"\n  },\n  {\n    label: STRINGS.contains,\n    value: FilterMode.CONTAINS,\n    svg: require(\"../../icons/filter-contains.svg\")\n  },\n  {\n    label: STRINGS.regex,\n    value: FilterMode.REGEX,\n    svg: require(\"../../icons/filter-regex.svg\")\n  }\n];\n\nexport interface FilterOptionsDropdownProps {\n  selectedOption: FilterMode;\n  onSelectOption: (o: FilterMode) => void;\n  filterOptions?: FilterOption[];\n}\n\nexport class FilterOptionsDropdown extends React.Component<FilterOptionsDropdownProps> {\n  static getFilterOptions(...filterTypes: string[]) {\n    return FILTER_OPTIONS.filter(option => filterTypes.indexOf(option.value) !== -1);\n  }\n\n  onSelectOption = (option: FilterOption) => {\n    this.props.onSelectOption(option.value);\n  };\n\n  renderFilterOption = (option: FilterOption) => {\n    return <span className=\"filter-option\">\n      <SvgIcon className=\"icon\" svg={option.svg} />\n      <span className=\"option-label\">{option.label}</span>\n    </span>;\n  };\n\n  render() {\n    const { selectedOption, filterOptions = FILTER_OPTIONS } = this.props;\n    const selectedItem = filterOptions.find(({ value }) => value === selectedOption) || filterOptions[0];\n\n    return <div className=\"filter-options-dropdown\">\n      <Dropdown<FilterOption>\n        menuClassName=\"filter-options\"\n        items={filterOptions}\n        selectedItem={selectedItem}\n        equal={(a, b) => a.value === b.value}\n        keyItem={d => d.value}\n        renderItem={this.renderFilterOption}\n        renderSelectedItem={d => <SvgIcon className=\"icon\" svg={d.svg} />}\n        onSelect={this.onSelectOption}\n      />\n    </div>;\n  }\n}\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { clamp, classNames, getXFromEvent } from \"../../utils/dom/dom\";\nimport \"./range-handle.scss\";\n\nexport interface RangeHandleProps {\n  positionLeft: number;\n  onChange: (x: number) => void;\n  offset: number;\n  isAny: boolean;\n  isBeyondMin?: boolean;\n  isBeyondMax?: boolean;\n  rightBound?: number;\n  leftBound?: number;\n}\n\nexport interface RangeHandleState {\n  anchor: number;\n}\n\nexport class RangeHandle extends React.Component<RangeHandleProps, RangeHandleState> {\n  public mounted: boolean;\n\n  state: RangeHandleState = {\n    anchor: null\n  };\n\n  onGlobalMouseMove = (event: MouseEvent) => {\n    const { onChange, leftBound, rightBound } = this.props;\n    const { anchor } = this.state;\n    const newX = getXFromEvent(event) - anchor;\n\n    onChange(clamp(newX, leftBound, rightBound));\n  };\n\n  onMouseDown = (event: React.MouseEvent<HTMLElement>) => {\n    const { offset, positionLeft } = this.props;\n\n    const x = getXFromEvent(event);\n    const anchor = x - offset - positionLeft;\n\n    this.setState({\n      anchor\n    });\n\n    event.preventDefault();\n    window.addEventListener(\"mouseup\", this.onGlobalMouseUp);\n    window.addEventListener(\"mousemove\", this.onGlobalMouseMove);\n  };\n\n  onGlobalMouseUp = () => {\n    window.removeEventListener(\"mouseup\", this.onGlobalMouseUp);\n    window.removeEventListener(\"mousemove\", this.onGlobalMouseMove);\n  };\n\n  render() {\n    const { positionLeft, isAny, isBeyondMin, isBeyondMax } = this.props;\n\n    const style = { left: positionLeft };\n\n    return <div\n      className={classNames(\"range-handle\", { \"empty\": isAny, \"beyond min\": isBeyondMin, \"beyond max\": isBeyondMax })}\n      style={style}\n      onMouseDown={this.onMouseDown}\n    />;\n  }\n}\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Dataset } from \"plywood\";\nimport React from \"react\";\nimport { Dimension } from \"../../../common/models/dimension/dimension\";\nimport { Essence } from \"../../../common/models/essence/essence\";\nimport { Timekeeper } from \"../../../common/models/timekeeper/timekeeper\";\nimport { getNumberOfWholeDigits, isTruthy, toSignificantDigits } from \"../../../common/utils/general/general\";\nimport { clamp, classNames, getXFromEvent } from \"../../utils/dom/dom\";\nimport { ApiContext, ApiContextValue } from \"../../views/cube-view/api-context\";\nimport { Loader } from \"../loader/loader\";\nimport { QueryError } from \"../query-error/query-error\";\nimport { RangeHandle } from \"../range-handle/range-handle\";\nimport \"./number-range-picker.scss\";\n\nexport const ANY_VALUE: any = null;\n\nconst NUB_SIZE = 16;\nconst GRANULARITY_IN_BAR = 300; // this is how many steps we want to represent in the slider bar\n\nfunction addNubSize(value: number) {\n  return value + NUB_SIZE;\n}\n\nfunction subtractNubSize(value: number) {\n  return value && value > NUB_SIZE ? value - NUB_SIZE : 0;\n}\n\nfunction getNumberOfDigitsToShow(n: number) {\n  const totalDigits = getNumberOfWholeDigits(n / GRANULARITY_IN_BAR);\n  return totalDigits > 3 ? Math.min(totalDigits, 4) : 3;\n}\n\n// offset the bar a little because a rectangle at the same position as a circle will peek through\nfunction getAdjustedStartHalf(start: number) {\n  return start + NUB_SIZE / 2;\n}\n\nexport interface NumberRangePickerProps {\n  start: number;\n  end: number;\n  essence: Essence;\n  timekeeper: Timekeeper;\n  dimension: Dimension;\n  onRangeStartChange: (n: number) => void;\n  onRangeEndChange: (n: number) => void;\n  exclude: boolean;\n}\n\nexport interface NumberRangePickerState {\n  leftOffset?: number;\n  rightBound?: number;\n  min?: number;\n  max?: number;\n  step?: number;\n  loading?: boolean;\n  error?: any;\n}\n\nexport class NumberRangePicker extends React.Component<NumberRangePickerProps, NumberRangePickerState> {\n  static contextType = ApiContext;\n\n  context: ApiContextValue;\n  public mounted: boolean;\n  private picker = React.createRef<HTMLDivElement>();\n\n  constructor(props: NumberRangePickerProps) {\n    super(props);\n    this.state = {\n      min: null,\n      max: null,\n      step: null,\n      loading: false,\n      error: null\n    };\n  }\n\n  fetchData(essence: Essence, timekeeper: Timekeeper, dimension: Dimension, rightBound: number): void {\n    const { numberFilterQuery } = this.context;\n    this.setState({\n      loading: true\n    });\n\n    numberFilterQuery(essence, dimension)\n      .then(\n        (dataset: Dataset) => {\n          if (!this.mounted) return;\n          const min = (dataset.data[0][\"Min\"] as number);\n          const max = (dataset.data[0][\"Max\"] as number);\n\n          const areBoundsFinite = isTruthy(max) && isTruthy(min) && isFinite(max) && isFinite(min);\n          const step = areBoundsFinite ? (max - min) / rightBound : 1;\n\n          this.setState({\n            min,\n            max,\n            loading: false,\n            step: step !== 0 && isFinite(step) ? step : 1\n          });\n        },\n        error => {\n          if (!this.mounted) return;\n          this.setState({\n            loading: false,\n            error\n          });\n        }\n      );\n  }\n\n  componentDidMount() {\n    this.mounted = true;\n    const node = this.picker.current;\n    const rect = node.getBoundingClientRect();\n    const { essence, timekeeper, dimension } = this.props;\n    const leftOffset = rect.left;\n    const rightBound = rect.width;\n\n    this.setState({ leftOffset, rightBound });\n    this.fetchData(essence, timekeeper, dimension, rightBound);\n\n  }\n\n  componentWillUnmount() {\n    this.mounted = false;\n  }\n\n  relativePositionToValue(position: number, type: \"start\" | \"end\") {\n    const { step, min, max, rightBound } = this.state;\n    if (position <= addNubSize(0) && type === \"start\") return ANY_VALUE;\n    if (position >= rightBound && type === \"end\") return ANY_VALUE;\n\n    const range = max - min !== 0 ? max - min : Math.abs(max);\n    return toSignificantDigits(position * step, getNumberOfDigitsToShow(range));\n  }\n\n  valueToRelativePosition(value: number) {\n    const { step } = this.state;\n    return value / step;\n  }\n\n  onBarClick(positionStart: number, positionEnd: number, e: MouseEvent) {\n    const { leftOffset } = this.state;\n\n    const clickPadding = 5;\n    const absoluteX = getXFromEvent(e);\n    const relativeX = absoluteX - leftOffset;\n    if (relativeX < NUB_SIZE / 2) return this.updateStart(leftOffset);\n\n    const startNubPosition = addNubSize(positionStart) + clickPadding;\n    const endNubPosition = subtractNubSize(positionEnd) + clickPadding;\n\n    const isBeforeStart = relativeX < positionStart;\n    const isAfterEnd = relativeX > positionEnd + NUB_SIZE;\n    const inBetween = (relativeX < positionEnd) && relativeX > startNubPosition;\n\n    if (isBeforeStart) {\n      this.updateStart(absoluteX - NUB_SIZE);\n    } else if (isAfterEnd) {\n      this.updateEnd(absoluteX);\n    } else if (inBetween) {\n\n      const distanceFromEnd = endNubPosition - relativeX;\n      const distanceFromStart = relativeX - startNubPosition;\n\n      if (distanceFromEnd < distanceFromStart) {\n        this.updateEnd(endNubPosition + leftOffset - distanceFromEnd);\n      } else {\n        this.updateStart(startNubPosition + leftOffset + distanceFromStart - NUB_SIZE);\n      }\n      return;\n    }\n  }\n\n  updateStart = (absolutePosition: number) => {\n    const { onRangeStartChange } = this.props;\n    const { leftOffset } = this.state;\n\n    const relativePosition = absolutePosition - leftOffset;\n    const newValue = this.relativePositionToValue(addNubSize(relativePosition), \"start\");\n    onRangeStartChange(newValue);\n  };\n\n  updateEnd = (absolutePosition: number) => {\n    const { onRangeEndChange } = this.props;\n    const { leftOffset } = this.state;\n\n    const relativePosition = absolutePosition - leftOffset;\n    const newValue = this.relativePositionToValue(relativePosition, \"end\");\n\n    onRangeEndChange(newValue);\n  };\n\n  render() {\n    const { start, end, exclude } = this.props;\n    const { min, max, loading, error, step, rightBound, leftOffset } = this.state;\n\n    let content: JSX.Element = null;\n\n    if (rightBound && step && isFinite(max) && isFinite(min)) {\n      const relativeStart = start === ANY_VALUE ? 0 : subtractNubSize(this.valueToRelativePosition(start));\n      const relativeEnd = end === ANY_VALUE ? rightBound : this.valueToRelativePosition(end);\n      const adjustedRightBound = subtractNubSize(rightBound);\n\n      const positionEnd = clamp(relativeEnd, addNubSize(relativeStart), adjustedRightBound);\n      const positionStart = start ? clamp(relativeStart, 0, subtractNubSize(positionEnd)) : 0;\n\n      const rangeBarSelected = { left: getAdjustedStartHalf(positionStart), width: positionEnd - positionStart };\n\n      const absoluteRightBound = leftOffset + rightBound;\n\n      content = <div className=\"range-slider\" onMouseDown={this.onBarClick.bind(this, positionStart, positionEnd)}>\n        <div className=\"range-bar full\" />\n        <div className=\"range-bar selected\" style={rangeBarSelected} />\n        <RangeHandle\n          positionLeft={positionStart}\n          onChange={this.updateStart}\n          isAny={start === ANY_VALUE}\n          isBeyondMin={start !== ANY_VALUE && start < min}\n          leftBound={leftOffset}\n          rightBound={leftOffset + subtractNubSize(positionEnd)}\n          offset={leftOffset}\n        />\n        <RangeHandle\n          positionLeft={positionEnd}\n          onChange={this.updateEnd}\n          isAny={end === ANY_VALUE}\n          isBeyondMax={end !== ANY_VALUE && max < end}\n          leftBound={leftOffset + addNubSize(positionStart)}\n          rightBound={absoluteRightBound}\n          offset={leftOffset}\n        />\n      </div>;\n    }\n\n    return <div className={classNames(\"number-range-picker\", { inverted: exclude })} ref={this.picker}>\n      {content}\n      {loading && <Loader />}\n      {error && <QueryError error={error} />}\n    </div>;\n  }\n}\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { List } from \"immutable\";\nimport React from \"react\";\nimport { Dimension } from \"../../../../common/models/dimension/dimension\";\nimport { Essence } from \"../../../../common/models/essence/essence\";\nimport { FilterClause, NumberFilterClause, NumberRange } from \"../../../../common/models/filter-clause/filter-clause\";\nimport { FilterMode } from \"../../../../common/models/filter/filter\";\nimport { Stage } from \"../../../../common/models/stage/stage\";\nimport { Timekeeper } from \"../../../../common/models/timekeeper/timekeeper\";\nimport { Unary } from \"../../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../../common/utils/general/general\";\nimport { STRINGS } from \"../../../config/constants\";\nimport { enterKey } from \"../../../utils/dom/dom\";\nimport { BubbleMenu } from \"../../bubble-menu/bubble-menu\";\nimport { Button } from \"../../button/button\";\nimport { FilterOption, FilterOptionsDropdown } from \"../../filter-options-dropdown/filter-options-dropdown\";\nimport { ANY_VALUE, NumberRangePicker } from \"../../number-range-picker/number-range-picker\";\nimport \"./number-filter-menu.scss\";\n\nfunction numberOrAnyToString(start: number): string {\n  if (start === ANY_VALUE) return STRINGS.any;\n  return \"\" + start;\n}\n\nfunction stringToNumberOrAny(startInput: string): number {\n  const parse = parseFloat(startInput);\n  return isNaN(parse) ? ANY_VALUE : parse;\n}\n\nconst MENU_WIDTH = 250;\nconst filterOptions: FilterOption[] = FilterOptionsDropdown.getFilterOptions(FilterMode.INCLUDE, FilterMode.EXCLUDE);\n\nexport interface NumberFilterMenuProps {\n  essence: Essence;\n  timekeeper: Timekeeper;\n  dimension: Dimension;\n  saveClause: Unary<FilterClause, void>;\n  onClose: Fn;\n  containerStage?: Stage;\n  openOn: Element;\n}\n\nexport interface NumberFilterMenuState {\n  leftOffset?: number;\n  rightBound?: number;\n  start?: number;\n  end?: number;\n  significantDigits?: number;\n  filterMode?: FilterMode;\n}\n\nexport class NumberFilterMenu extends React.Component<NumberFilterMenuProps, NumberFilterMenuState> {\n  state: NumberFilterMenuState = {\n    leftOffset: null,\n    rightBound: null,\n    start: ANY_VALUE,\n    end: ANY_VALUE\n  };\n\n  UNSAFE_componentWillMount() {\n    const { essence, dimension } = this.props;\n    const clause = essence.filter.getClauseForDimension(dimension);\n    if (!clause) return;\n    if (!(clause instanceof NumberFilterClause)) {\n      throw new Error(`Expected number filter. Got: ${clause}`);\n    }\n    const hasFilter = clause.values.count() !== 0;\n    if (hasFilter) {\n      const { start, end } = clause.values.first();\n\n      this.setState({\n        start,\n        end,\n        filterMode: essence.filter.getModeForDimension(dimension) || FilterMode.INCLUDE\n      });\n    }\n  }\n\n  componentDidMount() {\n    window.addEventListener(\"keydown\", this.globalKeyDownListener);\n  }\n\n  componentWillUnmount() {\n    window.removeEventListener(\"keydown\", this.globalKeyDownListener);\n  }\n\n  constructClause(): NumberFilterClause {\n    const { dimension } = this.props;\n    const { start, end, filterMode } = this.state;\n\n    if (isNaN(start) || isNaN(end)) return null;\n    if (start === null && end === null) return null;\n    if (start !== null && end !== null && start > end) return null;\n    return new NumberFilterClause({\n      reference: dimension.name,\n      not: filterMode === FilterMode.EXCLUDE,\n      values: List.of(new NumberRange({ start, end, bounds: start === end ? \"[]\" : \"[)\" }))\n    });\n  }\n\n  globalKeyDownListener = (e: KeyboardEvent) => {\n    if (enterKey(e)) {\n      this.onOkClick();\n    }\n  };\n\n  onOkClick = () => {\n    if (!this.actionEnabled()) return;\n    const { saveClause, onClose } = this.props;\n    saveClause(this.constructClause());\n    onClose();\n  };\n\n  onCancelClick = () => {\n    const { onClose } = this.props;\n    onClose();\n  };\n\n  onRangeInputStartChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const startInput = e.target.value;\n    this.setState({\n      start: stringToNumberOrAny(startInput)\n    });\n  };\n\n  onRangeInputEndChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const endInput = e.target.value;\n    this.setState({\n      end: stringToNumberOrAny(endInput)\n    });\n  };\n\n  onRangeStartChange = (start: number) => {\n    this.setState({ start });\n  };\n\n  onRangeEndChange = (end: number) => {\n    this.setState({ end });\n  };\n\n  onSelectFilterOption = (filterMode: FilterMode) => {\n    this.setState({ filterMode });\n  };\n\n  actionEnabled() {\n    const { essence: { filter }, dimension } = this.props;\n    const newClause = this.constructClause();\n    const oldClause = filter.getClauseForDimension(dimension);\n    return Boolean(newClause) && !newClause.equals(oldClause);\n  }\n\n  render() {\n    const { essence, timekeeper, dimension, onClose, containerStage, openOn } = this.props;\n    const { end, start, filterMode } = this.state;\n    const menuSize = Stage.fromSize(MENU_WIDTH, 410);\n\n    return <BubbleMenu\n      className=\"number-filter-menu\"\n      direction=\"down\"\n      containerStage={containerStage}\n      stage={menuSize}\n      openOn={openOn}\n      onClose={onClose}\n    >\n      <div className=\"side-by-side\">\n        <div className=\"group\">\n          <label className=\"input-top-label\">Type</label>\n          <FilterOptionsDropdown\n            selectedOption={filterMode}\n            onSelectOption={this.onSelectFilterOption}\n            filterOptions={filterOptions}\n          />\n        </div>\n        <div className=\"group\">\n          <label className=\"input-top-label\">Min</label>\n          <input value={numberOrAnyToString(start)} onChange={this.onRangeInputStartChange} />\n        </div>\n        <div className=\"group\">\n          <label className=\"input-top-label\">Max</label>\n          <input value={numberOrAnyToString(end)} onChange={this.onRangeInputEndChange} />\n        </div>\n      </div>\n\n      <NumberRangePicker\n        onRangeEndChange={this.onRangeEndChange}\n        onRangeStartChange={this.onRangeStartChange}\n        start={start}\n        end={end}\n        dimension={dimension}\n        essence={essence}\n        timekeeper={timekeeper}\n        exclude={filterMode === FilterMode.EXCLUDE}\n      />\n\n      <div className=\"ok-cancel-bar\">\n        <Button type=\"primary\" title={STRINGS.ok} onClick={this.onOkClick} disabled={!this.actionEnabled()} />\n        <Button type=\"secondary\" title={STRINGS.cancel} onClick={this.onCancelClick} />\n      </div>\n    </BubbleMenu>;\n  }\n}\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Dataset } from \"plywood\";\nimport React from \"react\";\nimport { Dimension } from \"../../../common/models/dimension/dimension\";\nimport { FilterMode } from \"../../../common/models/filter/filter\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { HighlightString } from \"../highlight-string/highlight-string\";\nimport \"./preview-list.scss\";\nimport { PreviewFilterMode } from \"./preview-string-filter-menu\";\n\ninterface PreviewListProps {\n  dimension: Dimension;\n  dataset: Dataset;\n  searchText: string;\n  regexErrorMessage: string;\n  limit: number;\n  filterMode: PreviewFilterMode;\n}\n\nconst errorNotice = (content: string) => <div className=\"error-notice\">{content}</div>;\n\ninterface RowProps {\n  content: string;\n  highlight: string;\n}\n\nconst Row: React.FunctionComponent<RowProps> = ({ content, highlight }) => <div className=\"row no-select\" title={content}>\n  <div className=\"row-wrapper\">\n    <HighlightString className=\"label\" text={content} highlight={highlight} />\n  </div>\n</div>;\n\nfunction predicate(filterMode: PreviewFilterMode, searchText: string): Unary<unknown, boolean> {\n  switch (filterMode) {\n    case FilterMode.CONTAINS:\n      return d => String(d).includes(searchText);\n    case FilterMode.REGEX:\n      const escaped = searchText.replace(/\\\\[^\\\\]]/g, \"\\\\\\\\\");\n      const regexp = new RegExp(escaped);\n      return d => regexp.test(String(d));\n  }\n}\n\nfunction filterValues<T>(list: T[], filterMode: PreviewFilterMode, searchText: string): T[] {\n  if (!searchText) return list;\n  return list.filter(predicate(filterMode, searchText));\n}\n\nexport const PreviewList: React.FunctionComponent<PreviewListProps> = props => {\n  const { regexErrorMessage, searchText, dataset, filterMode, dimension, limit } = props;\n\n  if (regexErrorMessage) return errorNotice(regexErrorMessage);\n\n  const data = dataset.data;\n  if (searchText && data.length === 0) return errorNotice(`No results for \"${searchText}\"`);\n\n  const list = data.slice(0, limit).map(d => d[dimension.name]);\n  const filtered = filterValues(list, filterMode, searchText);\n\n  return <React.Fragment>\n    {searchText && <div className=\"matching-values-message\">Matching Values</div>}\n    {filtered.map(value => <Row content={String(value)} highlight={searchText} key={String(value)} />)}\n  </React.Fragment>;\n};\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Set } from \"immutable\";\nimport { Dataset } from \"plywood\";\nimport React from \"react\";\nimport {\n  DatasetRequest,\n  error,\n  isError,\n  isLoaded,\n  isLoading,\n  loaded,\n  loading\n} from \"../../../common/models/dataset-request/dataset-request\";\nimport { Dimension } from \"../../../common/models/dimension/dimension\";\nimport { Essence } from \"../../../common/models/essence/essence\";\nimport {\n  FilterClause,\n  StringFilterAction,\n  StringFilterClause\n} from \"../../../common/models/filter-clause/filter-clause\";\nimport { FilterMode } from \"../../../common/models/filter/filter\";\nimport { debounceWithPromise, Unary } from \"../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { SEARCH_WAIT, STRINGS } from \"../../config/constants\";\nimport { classNames, enterKey } from \"../../utils/dom/dom\";\nimport { reportError } from \"../../utils/error-reporter/error-reporter\";\nimport { ApiContext, ApiContextValue } from \"../../views/cube-view/api-context\";\nimport { Button } from \"../button/button\";\nimport { ClearableInput } from \"../clearable-input/clearable-input\";\nimport { GlobalEventListener } from \"../global-event-listener/global-event-listener\";\nimport { Loader } from \"../loader/loader\";\nimport { QueryError } from \"../query-error/query-error\";\nimport { PreviewList } from \"./preview-list\";\nimport \"./preview-string-filter-menu.scss\";\n\nfunction checkRegex(text: string): string {\n  try {\n    new RegExp(text);\n  } catch (e) {\n    return e.message;\n  }\n  return null;\n}\n\nconst TOP_N = 100;\n\nexport type PreviewFilterMode = FilterMode.CONTAINS | FilterMode.REGEX;\n\nexport interface PreviewStringFilterMenuProps {\n  dimension: Dimension;\n  essence: Essence;\n  onClose: Fn;\n  filterMode: FilterMode.REGEX | FilterMode.CONTAINS;\n  saveClause: Unary<FilterClause, void>;\n}\n\nexport interface PreviewStringFilterMenuState {\n  searchText: string;\n  dataset: DatasetRequest;\n}\n\nexport class PreviewStringFilterMenu extends React.Component<PreviewStringFilterMenuProps, PreviewStringFilterMenuState> {\n  static contextType = ApiContext;\n\n  context: ApiContextValue;\n\n  private lastSearchText: string;\n\n  initialSearchText = (): string => {\n    const { essence, dimension } = this.props;\n    const clause = essence.filter.getClauseForDimension(dimension);\n    if (clause && clause instanceof StringFilterClause && clause.action !== StringFilterAction.IN) {\n      return clause.values.first();\n    }\n    return \"\";\n  };\n\n  state: PreviewStringFilterMenuState = { dataset: loading, searchText: this.initialSearchText() };\n\n  updateSearchText = (searchText: string) => this.setState({ searchText });\n\n  private loadRows() {\n    if (this.regexErrorMessage()) return;\n    this.setState({ dataset: loading });\n    this.sendQueryFilter()\n      .then(dataset => {\n        // TODO: encode it better\n        // null is here when we get out of order request, so we just ignore it\n        if (!dataset) return;\n        this.setState({ dataset });\n      });\n  }\n\n  private sendQueryFilter(): Promise<DatasetRequest> {\n    const { searchText } = this.state;\n    this.lastSearchText = searchText;\n    return this.debouncedQueryFilter(this.props.essence, this.constructClause());\n  }\n\n  private regexErrorMessage(): string {\n    const { filterMode } = this.props;\n    const { searchText } = this.state;\n    return filterMode === FilterMode.REGEX && searchText && checkRegex(searchText);\n  }\n\n  private queryFilter = (essence: Essence, clause: StringFilterClause): Promise<DatasetRequest> => {\n    const { stringFilterQuery } = this.context;\n    const { searchText } = this.state;\n\n    return stringFilterQuery(essence, clause)\n      .then((dataset: Dataset) => {\n        if (this.lastSearchText !== searchText) return null;\n        return loaded(dataset);\n      })\n      .catch(err => {\n          if (this.lastSearchText !== searchText) return null;\n          reportError(err);\n          return error(err);\n        }\n      );\n  };\n\n  private debouncedQueryFilter = debounceWithPromise(this.queryFilter, SEARCH_WAIT);\n\n  UNSAFE_componentWillMount() {\n    this.loadRows();\n  }\n\n  componentWillUnmount() {\n    this.debouncedQueryFilter.cancel();\n  }\n\n  componentDidUpdate(prevProps: PreviewStringFilterMenuProps, prevState: PreviewStringFilterMenuState): void {\n    if (this.state.searchText !== prevState.searchText) {\n      this.loadRows();\n    }\n  }\n\n  globalKeyDownListener = (e: KeyboardEvent) => {\n    if (enterKey(e)) {\n      this.onOkClick();\n    }\n  };\n\n  constructClause(): StringFilterClause {\n    const { dimension, filterMode } = this.props;\n    const { searchText } = this.state;\n    const { name: reference } = dimension;\n\n    switch (filterMode) {\n      case FilterMode.CONTAINS:\n        return new StringFilterClause({\n          reference,\n          values: Set.of(searchText),\n          action: StringFilterAction.CONTAINS\n        });\n      case FilterMode.REGEX:\n        return new StringFilterClause({\n          reference,\n          values: Set.of(searchText),\n          action: StringFilterAction.MATCH\n        });\n    }\n  }\n\n  onOkClick = () => {\n    if (!this.actionEnabled()) return;\n    const { saveClause, onClose } = this.props;\n    saveClause(this.constructClause());\n    onClose();\n  };\n\n  onCancelClick = () => {\n    this.props.onClose();\n  };\n\n  actionEnabled() {\n    const { essence: { filter }, dimension } = this.props;\n    if (this.regexErrorMessage()) return false;\n    const newClause = this.constructClause();\n    if (!newClause.values.first()) {\n      return false;\n    }\n    const oldClause = filter.getClauseForDimension(dimension);\n    return !newClause.equals(oldClause);\n  }\n\n  render() {\n    const { filterMode, dimension } = this.props;\n    const { dataset, searchText } = this.state;\n\n    const hasMore = isLoaded(dataset) && dataset.dataset.data.length > TOP_N;\n    return <React.Fragment>\n      <GlobalEventListener keyDown={this.globalKeyDownListener} />\n      <div className=\"search-box\">\n        <ClearableInput\n          placeholder=\"Search\"\n          focusOnMount={true}\n          value={searchText}\n          onChange={this.updateSearchText}\n        />\n      </div>\n      <div className=\"preview-string-filter-menu\">\n        <div className={classNames(\"menu-table\", hasMore ? \"has-more\" : \"no-more\")}>\n          <div className=\"rows\">\n            {isLoaded(dataset) && <PreviewList\n              dimension={dimension}\n              dataset={dataset.dataset}\n              searchText={searchText}\n              regexErrorMessage={this.regexErrorMessage()}\n              limit={TOP_N}\n              filterMode={filterMode} />}\n            {isError(dataset) ? <QueryError error={dataset.error} /> : null}\n            {isLoading(dataset) ? <Loader /> : null}\n          </div>\n        </div>\n        <div className=\"ok-cancel-bar\">\n          <Button type=\"primary\" title={STRINGS.ok} onClick={this.onOkClick} disabled={!this.actionEnabled()} />\n          <Button type=\"secondary\" title={STRINGS.cancel} onClick={this.onCancelClick} />\n        </div>\n      </div>\n    </React.Fragment>;\n  }\n}\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Set } from \"immutable\";\nimport React from \"react\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { Button } from \"../button/button\";\nimport \"./paste-form.scss\";\n\ninterface PasteFormProps {\n  onSelect: Unary<Set<string>, void>;\n  onClose: Fn;\n}\n\ninterface PasteFormState {\n  value: string;\n}\n\nfunction focus(textArea: HTMLTextAreaElement): void {\n  if (!textArea) return;\n  textArea.focus();\n}\n\nexport class PasteForm extends React.Component<PasteFormProps, PasteFormState> {\n\n  state: PasteFormState = { value: \"\" };\n\n  values = (): Set<string> => {\n    const { value } = this.state;\n    return Set(value\n      .split(\"\\n\")\n      .map(s => s.trim())\n      .filter(s => s.length > 0));\n  };\n\n  select = () => {\n    const { onClose, onSelect } = this.props;\n    const values = this.values();\n    if (values.isEmpty()) return;\n    onSelect(Set(values));\n    onClose();\n  };\n\n  cancel = () => this.props.onClose();\n\n  saveValue = ({ target: { value } }: React.ChangeEvent<HTMLTextAreaElement>) => this.setState({ value });\n\n  render() {\n    const { value } = this.state;\n    const disabled = this.values().isEmpty();\n    return <div>\n      <textarea ref={focus} className=\"paste-field\" value={value} onChange={this.saveValue} />\n      <div className=\"paste-actions\">\n        <Button type=\"primary\" title=\"Select\" disabled={disabled} onClick={this.select} />\n        <Button type=\"secondary\" title=\"Cancel\" onClick={this.cancel} />\n      </div>\n    </div>;\n  }\n}\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Binary } from \"../../../common/utils/functional/functional\";\nimport { classNames } from \"../../utils/dom/dom\";\nimport { Checkbox, CheckboxType } from \"../checkbox/checkbox\";\nimport { HighlightString } from \"../highlight-string/highlight-string\";\nimport \"./string-value.scss\";\n\ninterface StringValueProps {\n  value: unknown;\n  selected: boolean;\n  checkboxStyle: string;\n  highlight: string;\n  onRowSelect: Binary<unknown, boolean, void>;\n}\n\nconst hasModKey = (e: React.MouseEvent<unknown>) => e.altKey || e.ctrlKey || e.metaKey;\n\nexport const StringValue: React.FunctionComponent<StringValueProps> = props => {\n  const { value, selected, checkboxStyle, highlight, onRowSelect } = props;\n  const label = String(value);\n\n  return <div\n    className={classNames(\"string-value\", { selected })}\n    title={label}\n    onClick={e => onRowSelect(value, hasModKey(e))}\n  >\n    <div className=\"value-wrapper\">\n      <Checkbox type={checkboxStyle as CheckboxType} selected={selected} />\n      <HighlightString className=\"label\" text={label} highlight={highlight} />\n    </div>\n  </div>;\n};\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Set } from \"immutable\";\nimport { Dataset } from \"plywood\";\nimport React from \"react\";\nimport { Dimension } from \"../../../common/models/dimension/dimension\";\nimport { FilterMode } from \"../../../common/models/filter/filter\";\nimport { Binary } from \"../../../common/utils/functional/functional\";\nimport { StringValue } from \"./string-value\";\nimport \"./string-values-list.scss\";\n\nfunction filterRows(rows: unknown[], searchText: string): unknown[] {\n  if (!searchText) return rows;\n  const searchTextLower = searchText.toLowerCase();\n  return rows.filter(d => String(d).toLowerCase().indexOf(searchTextLower) !== -1);\n}\n\nfunction prependPromotedValues(rows: unknown[], promoted: Set<unknown>): unknown[] {\n  return [\n    ...promoted,\n    ...rows.filter(value => !promoted.contains(value))\n    ];\n}\n\ninterface RowsListProps {\n  dimension: Dimension;\n  dataset: Dataset;\n  searchText: string;\n  selectedValues: Set<unknown>;\n  promotedValues: Set<unknown>;\n  filterMode: FilterMode;\n  onRowSelect: Binary<unknown, boolean, void>;\n}\n\nexport const StringValuesList: React.FunctionComponent<RowsListProps> = props => {\n  const { onRowSelect, filterMode, dataset, dimension, searchText, promotedValues, selectedValues } = props;\n  const rowValues: unknown[] = dataset.data.map(d => d[dimension.name]);\n  const values = prependPromotedValues(rowValues, promotedValues);\n  const matchingValues = filterRows(values, searchText);\n  if (searchText && matchingValues.length === 0) {\n    return <div className=\"no-string-values\">{`No results for \"${searchText}\"`}</div>;\n  }\n  const checkboxStyle = filterMode === FilterMode.EXCLUDE ? \"cross\" : \"check\";\n  return <React.Fragment>\n    {matchingValues.map(value => (\n      <StringValue\n        key={String(value)}\n        value={value}\n        onRowSelect={onRowSelect}\n        selected={selectedValues && selectedValues.contains(value)}\n        checkboxStyle={checkboxStyle}\n        highlight={searchText} />))}\n  </React.Fragment>;\n};\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Set } from \"immutable\";\nimport { Dataset } from \"plywood\";\nimport React from \"react\";\nimport {\n  DatasetRequest,\n  error,\n  isError,\n  isLoaded,\n  isLoading,\n  loaded,\n  loading\n} from \"../../../common/models/dataset-request/dataset-request\";\nimport { Dimension } from \"../../../common/models/dimension/dimension\";\nimport { Essence } from \"../../../common/models/essence/essence\";\nimport {\n  FilterClause,\n  StringFilterAction,\n  StringFilterClause\n} from \"../../../common/models/filter-clause/filter-clause\";\nimport { FilterMode } from \"../../../common/models/filter/filter\";\nimport { Timekeeper } from \"../../../common/models/timekeeper/timekeeper\";\nimport { debounceWithPromise, Unary } from \"../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { SEARCH_WAIT, STRINGS } from \"../../config/constants\";\nimport { classNames, enterKey } from \"../../utils/dom/dom\";\nimport { reportError } from \"../../utils/error-reporter/error-reporter\";\nimport { ApiContext, ApiContextValue } from \"../../views/cube-view/api-context\";\nimport { Button } from \"../button/button\";\nimport { ClearableInput } from \"../clearable-input/clearable-input\";\nimport { GlobalEventListener } from \"../global-event-listener/global-event-listener\";\nimport { Loader } from \"../loader/loader\";\nimport { PasteForm } from \"../paste-form/paste-form\";\nimport { QueryError } from \"../query-error/query-error\";\nimport { SvgIcon } from \"../svg-icon/svg-icon\";\nimport \"./selectable-string-filter-menu.scss\";\nimport { StringValuesList } from \"./string-values-list\";\n\nconst TOP_N = 100;\n\nexport interface SelectableStringFilterMenuProps {\n  dimension: Dimension;\n  essence: Essence;\n  timekeeper: Timekeeper;\n  onClose: Fn;\n  filterMode?: FilterMode;\n  saveClause: Unary<FilterClause, void>;\n}\n\nexport interface SelectableStringFilterMenuState {\n  searchText: string;\n  dataset: DatasetRequest;\n  selectedValues: Set<string>;\n  pasteModeEnabled: boolean;\n}\n\nfunction toggle(set: Set<string>, value: string): Set<string> {\n  return set.has(value) ? set.remove(value) : set.add(value);\n}\n\nexport class SelectableStringFilterMenu extends React.Component<SelectableStringFilterMenuProps, SelectableStringFilterMenuState> {\n  static contextType = ApiContext;\n\n  context: ApiContextValue;\n  private lastSearchText: string;\n\n  state: SelectableStringFilterMenuState = {\n    pasteModeEnabled: false,\n    dataset: loading,\n    selectedValues: this.initialSelection(),\n    searchText: \"\"\n  };\n\n  private loadRows() {\n    this.setState({ dataset: loading });\n    this.sendQueryFilter()\n      .then(dataset => {\n        // TODO: encode it better\n        // null is here when we get out of order request, so we just ignore it\n        if (!dataset) return;\n        this.setState({ dataset });\n      })\n      .catch(_ => {\n        // Some weird internal error. All application logic errors are handled earlier\n        this.setState({ dataset: error(new Error(\"Unknown error\")) });\n      });\n  }\n\n  private sendQueryFilter(): Promise<DatasetRequest> {\n    const { searchText } = this.state;\n    this.lastSearchText = searchText;\n    return this.debouncedQueryFilter(this.props.essence, this.constructSearchTextClause());\n  }\n\n  private queryFilter = (essence: Essence, clause: StringFilterClause): Promise<DatasetRequest> => {\n    const { searchText } = this.state;\n    const { stringFilterQuery } = this.context;\n\n    return stringFilterQuery(essence, clause)\n      .then((dataset: Dataset) => {\n        if (this.lastSearchText !== searchText) return null;\n        return loaded(dataset);\n      })\n      .catch(err => {\n          if (this.lastSearchText !== searchText) return null;\n          reportError(err);\n          return error(err);\n        }\n      );\n  };\n\n  private debouncedQueryFilter = debounceWithPromise(this.queryFilter, SEARCH_WAIT);\n\n  UNSAFE_componentWillMount() {\n    this.loadRows();\n  }\n\n  private initialSelection(): Set<string> {\n    const { essence: { filter }, dimension } = this.props;\n    const clause = filter.getClauseForDimension(dimension);\n    if (!clause) return Set();\n    if (!(clause instanceof StringFilterClause)) {\n      throw new Error(`Expected string filter clause, got: ${clause}`);\n    }\n    return clause.action === StringFilterAction.IN ? clause.values : Set();\n  }\n\n  componentWillUnmount() {\n    this.debouncedQueryFilter.cancel();\n  }\n\n  componentDidUpdate(prevProps: SelectableStringFilterMenuProps, prevState: SelectableStringFilterMenuState) {\n    if (this.state.searchText !== prevState.searchText) {\n      this.loadRows();\n    }\n  }\n\n  globalKeyDownListener = (e: KeyboardEvent) => {\n    if (!this.state.pasteModeEnabled && enterKey(e)) {\n      this.onOkClick();\n    }\n  };\n\n  updateSearchText = (searchText: string) => this.setState({ searchText });\n\n  constructClause(): StringFilterClause {\n    const { dimension, filterMode } = this.props;\n    const { selectedValues } = this.state;\n    const { name } = dimension;\n    if (selectedValues.isEmpty()) return null;\n\n    return new StringFilterClause({\n      action: StringFilterAction.IN,\n      reference: name,\n      values: selectedValues,\n      not: filterMode === FilterMode.EXCLUDE\n    });\n  }\n\n  constructSearchTextClause(): StringFilterClause {\n    const { dimension } = this.props;\n    const { name: reference } = dimension;\n    const { searchText } = this.state;\n    return new StringFilterClause({\n      action: StringFilterAction.CONTAINS,\n      reference,\n      values: Set.of(searchText),\n      ignoreCase: true\n    });\n  }\n\n  onValueClick = (value: string, withModKey: boolean) => {\n    const { selectedValues } = this.state;\n    if (withModKey) {\n      const isValueSingleSelected = selectedValues.contains(value) && selectedValues.count() === 1;\n      return this.setState({ selectedValues: isValueSingleSelected ? Set.of() : Set.of(value) });\n    }\n    return this.setState({ selectedValues: toggle(selectedValues, value) });\n  };\n\n  onOkClick = () => {\n    if (!this.isFilterValid()) return;\n    const { saveClause, onClose } = this.props;\n    saveClause(this.constructClause());\n    onClose();\n  };\n\n  enablePasteMode = () => this.setState({ pasteModeEnabled: true });\n\n  disablePasteMode = () => this.setState({ pasteModeEnabled: false });\n\n  selectValues = (values: Set<string>) => this.setState({ selectedValues: values });\n\n  isFilterValid(): boolean {\n    const { selectedValues } = this.state;\n    if (selectedValues.isEmpty()) return false;\n    const { essence: { filter }, dimension } = this.props;\n    const newClause = this.constructClause();\n    const oldClause = filter.getClauseForDimension(dimension);\n    return newClause && !newClause.equals(oldClause);\n  }\n\n  renderSelectMode(): JSX.Element {\n    const { filterMode, onClose, dimension } = this.props;\n    const { dataset, selectedValues, searchText } = this.state;\n\n    return <React.Fragment>\n      <div className=\"paste-icon\" onClick={this.enablePasteMode} title=\"Paste multiple values\">\n        <SvgIcon svg={require(\"../../icons/full-multi.svg\")} />\n      </div>\n      <div className=\"search-box\">\n        <ClearableInput\n          placeholder=\"Search\"\n          focusOnMount={true}\n          value={searchText}\n          onChange={this.updateSearchText}\n        />\n      </div>\n      <div className={classNames(\"selectable-string-filter-menu\", filterMode)}>\n        <div className=\"menu-table\">\n          <div className=\"rows\">\n            {isLoaded(dataset) && <StringValuesList\n              onRowSelect={this.onValueClick}\n              dimension={dimension}\n              dataset={dataset.dataset}\n              searchText={searchText}\n              selectedValues={selectedValues}\n              promotedValues={this.initialSelection()}\n              filterMode={filterMode} />}\n            {isError(dataset) && <QueryError error={dataset.error} />}\n            {isLoading(dataset) && <Loader />}\n          </div>\n        </div>\n        <div className=\"ok-cancel-bar\">\n          <Button type=\"primary\" title={STRINGS.ok} onClick={this.onOkClick} disabled={!this.isFilterValid()} />\n          <Button type=\"secondary\" title={STRINGS.cancel} onClick={onClose} />\n        </div>\n      </div>\n    </React.Fragment>;\n  }\n\n  renderImportMode(): JSX.Element {\n    return <React.Fragment>\n      <div className=\"paste-prompt\">Paste values separated by newlines</div>\n      <div className=\"paste-form\">\n        <PasteForm onSelect={this.selectValues} onClose={this.disablePasteMode} />\n      </div>\n    </React.Fragment>;\n  }\n\n  render() {\n    const { pasteModeEnabled } = this.state;\n    return <React.Fragment>\n      <GlobalEventListener keyDown={this.globalKeyDownListener} />\n      {pasteModeEnabled ? this.renderImportMode() : this.renderSelectMode()}\n    </React.Fragment>;\n  }\n}\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Dimension } from \"../../../../common/models/dimension/dimension\";\nimport { Essence } from \"../../../../common/models/essence/essence\";\nimport { FilterClause } from \"../../../../common/models/filter-clause/filter-clause\";\nimport { FilterMode } from \"../../../../common/models/filter/filter\";\nimport { Stage } from \"../../../../common/models/stage/stage\";\nimport { Timekeeper } from \"../../../../common/models/timekeeper/timekeeper\";\nimport { Unary } from \"../../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../../common/utils/general/general\";\nimport { BubbleMenu } from \"../../bubble-menu/bubble-menu\";\nimport { FilterOption, FilterOptionsDropdown } from \"../../filter-options-dropdown/filter-options-dropdown\";\nimport { PreviewStringFilterMenu } from \"../../preview-string-filter-menu/preview-string-filter-menu\";\nimport { SelectableStringFilterMenu } from \"../../selectable-string-filter-menu/selectable-string-filter-menu\";\nimport \"./string-filter-menu.scss\";\n\nexport interface StringFilterMenuProps {\n  dimension: Dimension;\n  saveClause: Unary<FilterClause, void>;\n  essence: Essence;\n  timekeeper: Timekeeper;\n  onClose: Fn;\n  containerStage?: Stage;\n  openOn: Element;\n}\n\nexport interface StringFilterMenuState {\n  filterMode?: FilterMode;\n}\n\nexport class StringFilterMenu extends React.Component<StringFilterMenuProps, StringFilterMenuState> {\n\n  private initialFilterMode = (): FilterMode => {\n    const { essence: { filter }, dimension } = this.props;\n    const filterMode = filter.getModeForDimension(dimension);\n    return filterMode || FilterMode.INCLUDE;\n  };\n\n  state: StringFilterMenuState = { filterMode: this.initialFilterMode() };\n\n  onSelectFilterOption = (filterMode: FilterMode) => this.setState({ filterMode });\n\n  getFilterOptions() {\n    const { dimension } = this.props;\n    const dimensionKind = dimension.kind;\n\n    let filterOptions: FilterOption[] = FilterOptionsDropdown.getFilterOptions(FilterMode.INCLUDE, FilterMode.EXCLUDE);\n    if (dimensionKind !== \"boolean\") filterOptions = filterOptions.concat(FilterOptionsDropdown.getFilterOptions(FilterMode.REGEX, FilterMode.CONTAINS));\n\n    return filterOptions;\n  }\n\n  renderFilterControls(): JSX.Element {\n    const { dimension, saveClause, essence, timekeeper, onClose } = this.props;\n    const { filterMode } = this.state;\n    const props = { dimension, essence, timekeeper, onClose, saveClause };\n    switch (filterMode) {\n      case FilterMode.EXCLUDE:\n      case FilterMode.INCLUDE:\n        const selectableProps = { ...props, filterMode };\n        return <SelectableStringFilterMenu {...selectableProps} />;\n      case FilterMode.REGEX:\n      case FilterMode.CONTAINS:\n        const previewProps = { ...props, filterMode };\n        return <PreviewStringFilterMenu key={filterMode} {...previewProps} />;\n    }\n  }\n\n  render() {\n    const { dimension, onClose, containerStage, openOn } = this.props;\n    const { filterMode } = this.state;\n    if (!dimension) return null;\n\n    return <BubbleMenu\n      className=\"string-filter-menu\"\n      direction=\"down\"\n      containerStage={containerStage}\n      stage={Stage.fromSize(300, 410)}\n      openOn={openOn}\n      onClose={onClose}\n    >\n      <div className=\"string-filter-content\">\n        <FilterOptionsDropdown\n          selectedOption={filterMode}\n          onSelectOption={this.onSelectFilterOption}\n          filterOptions={this.getFilterOptions()}\n        />\n        {this.renderFilterControls()}\n      </div>\n    </BubbleMenu>;\n  }\n}\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Timezone } from \"chronoshift\";\nimport React from \"react\";\nimport { combineDateAndTimeIntoMoment, formatISODate, formatISOTime, normalizeISODate, normalizeISOTime, validateISODate, validateISOTime } from \"../../../common/utils/time/time\";\nimport \"./date-range-input.scss\";\n\nexport interface DateRangeInputProps {\n  time: Date;\n  timezone: Timezone;\n  onChange: (t: Date) => void;\n  hide?: boolean;\n  type?: string;\n  label: string;\n}\n\nexport interface DateRangeInputState {\n  dateString?: string;\n  timeString?: string;\n}\n\nexport class DateRangeInput extends React.Component<DateRangeInputProps, DateRangeInputState> {\n  state = {\n    dateString: \"\",\n    timeString: \"\"\n  };\n\n  componentDidMount() {\n    const { time, timezone } = this.props;\n    this.updateStateFromTime(time, timezone);\n  }\n\n  UNSAFE_componentWillReceiveProps(nextProps: DateRangeInputProps) {\n    const { time, timezone } = nextProps;\n    this.updateStateFromTime(time, timezone);\n  }\n\n  updateStateFromTime(time: Date, timezone: Timezone) {\n    if (!time) return;\n    if (isNaN(time.valueOf())) {\n      this.setState({\n        dateString: \"\"\n      });\n      return;\n    }\n\n    this.setState({\n      dateString: formatISODate(time, timezone),\n      timeString: formatISOTime(time, timezone)\n    });\n  }\n\n  dateChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const dateString = normalizeISODate(e.target.value);\n    this.setState({\n      dateString\n    });\n    if (validateISODate(dateString)) {\n      this.changeDate(dateString, this.state.timeString);\n    }\n  };\n\n  timeChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const timeString = normalizeISOTime(e.target.value);\n    this.setState({\n      timeString\n    });\n    if (validateISOTime(timeString)) {\n      this.changeDate(this.state.dateString, timeString);\n    }\n  };\n\n  changeDate(possibleDateString: string, possibleTimeString: string): void {\n    const { timezone, onChange } = this.props;\n\n    const possibleMoment = combineDateAndTimeIntoMoment(possibleDateString, possibleTimeString, timezone);\n    if (possibleMoment && possibleMoment.isValid()) {\n      onChange(possibleMoment.toDate());\n    }\n  }\n\n  render() {\n    const { hide, label } = this.props;\n    const { dateString, timeString } = this.state;\n    const dateValue = hide ? \"\" : dateString;\n    const timeValue = hide ? \"\" : timeString;\n\n    return <div className=\"date-range-input\">\n      <div className=\"label\">{label}</div>\n      <input placeholder=\"YYYY-MM-DD\" className=\"date-field\" value={dateValue} onChange={this.dateChange} />\n      <input placeholder=\"HH:MM\" className=\"time-field\" value={timeValue} onChange={this.timeChange} />\n    </div>;\n  }\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { day, Timezone } from \"chronoshift\";\nimport { Locale } from \"../../../common/models/locale/locale\";\nimport { range } from \"../../../common/utils/functional/functional\";\nimport { getMoment } from \"../../../common/utils/time/time\";\n\nexport function calendarDays(startDay: Date, timezone: Timezone, locale: Locale): Date[][] {\n  const monthWeeks = monthToWeeks(startDay, timezone, locale);\n  const firstWeek = monthWeeks[0];\n  const lastWeek = monthWeeks[monthWeeks.length - 1];\n  const middleWeeks = monthWeeks.slice(1, -1);\n  return [\n    padFirstWeek(firstWeek, timezone),\n    ...middleWeeks,\n    padLastWeek(lastWeek, timezone)\n  ];\n}\n\nfunction padLastWeek(lastWeek: Date[], timezone: Timezone): Date[] {\n  const lastDate = lastWeek[lastWeek.length - 1];\n  const padCount = 7 - lastWeek.length;\n  return [...lastWeek, ...nextNDates(lastDate, padCount, timezone)];\n}\n\nfunction padFirstWeek(firstWeek: Date[], timezone: Timezone): Date[] {\n  const firstDate = firstWeek[0];\n  const padCount = 7 - firstWeek.length;\n  return [...previousNDates(firstDate, padCount, timezone), ...firstWeek];\n}\n\nexport function monthToWeeks(startDay: Date, timezone: Timezone, locale: Locale): Date[][] {\n  const weeks: Date[][] = [];\n  const firstDayOfMonth = getMoment(startDay, timezone);\n  const firstDayOfNextMonth = firstDayOfMonth.clone().add(1, \"month\");\n\n  let week: Date[] = [];\n  let currentPointer = firstDayOfMonth.clone().startOf(\"day\");\n  while (currentPointer.isBefore(firstDayOfNextMonth)) {\n    if ((currentPointer.day() === locale.weekStart || 0) && week.length > 0) {\n      weeks.push(week);\n      week = [];\n    }\n\n    week.push(currentPointer.toDate());\n    currentPointer = currentPointer.add(1, \"day\");\n  }\n  // push last week\n  if (week.length > 0) weeks.push(week);\n  return weeks;\n}\n\nexport function previousNDates(start: Date, n: number, timezone: Timezone): Date[] {\n  return range(0, n)\n    .map(i => day.shift(start, timezone, -n + i));\n}\n\nexport function nextNDates(start: Date, n: number, timezone: Timezone): Date[] {\n  return range(0, n)\n    .map(i => day.shift(start, timezone, i + 1));\n}\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { day, month, Timezone } from \"chronoshift\";\nimport { TimeRange } from \"plywood\";\nimport React from \"react\";\nimport { Locale } from \"../../../common/models/locale/locale\";\nimport { cyclicShift } from \"../../../common/utils/functional/functional\";\nimport { datesEqual, formatYearMonth, getDayInMonth } from \"../../../common/utils/time/time\";\nimport { classNames } from \"../../utils/dom/dom\";\nimport { DateRangeInput } from \"../date-range-input/date-range-input\";\nimport { SvgIcon } from \"../svg-icon/svg-icon\";\nimport { calendarDays } from \"./calendar\";\nimport \"./date-range-picker.scss\";\n\nexport interface DateRangePickerProps {\n  startTime?: Date;\n  endTime?: Date;\n  maxTime?: Date;\n  timezone: Timezone;\n  onStartChange: (t: Date) => void;\n  onEndChange: (t: Date) => void;\n  locale: Locale;\n}\n\nexport interface DateRangePickerState {\n  activeMonthStartDate?: Date;\n  hoverTimeRange?: TimeRange;\n  selectionSet?: boolean;\n}\n\nexport class DateRangePicker extends React.Component<DateRangePickerProps, DateRangePickerState> {\n\n  state: DateRangePickerState = {\n    activeMonthStartDate: month.floor(this.props.startTime || new Date(), this.props.timezone),\n    hoverTimeRange: null,\n    selectionSet: true\n  };\n\n  navigateToMonth(offset: number): void {\n    const { timezone } = this.props;\n    const { activeMonthStartDate } = this.state;\n    const newDate = month.shift(activeMonthStartDate, timezone, offset);\n    this.setState({\n      activeMonthStartDate: newDate\n    });\n  }\n\n  goToPreviousMonth = () => this.navigateToMonth(-1);\n\n  goToNextMonth = () => this.navigateToMonth(1);\n\n  calculateHoverTimeRange(mouseEnteredDay: Date) {\n    const { startTime, endTime } = this.props;\n    let hoverTimeRange: TimeRange = null;\n    if (startTime && !endTime) {\n      let start = startTime;\n      let end = mouseEnteredDay;\n      // if mousing over backwards, set end to old start time\n      if (mouseEnteredDay < startTime) {\n        start = mouseEnteredDay;\n        end = startTime;\n      }\n      hoverTimeRange = new TimeRange({ start, end, bounds: \"[]\" });\n    }\n\n    this.setState({ hoverTimeRange });\n  }\n\n  onCalendarMouseLeave = () => {\n    this.setState({ hoverTimeRange: null });\n  };\n\n  selectNewRange(startDate: Date, endDate?: Date) {\n    const { onStartChange, onEndChange, timezone } = this.props;\n    onStartChange(startDate);\n    // real end points are exclusive so +1 full day to selection (which is floored) to get the real end point\n    if (endDate) endDate = day.shift(endDate, timezone, 1);\n    onEndChange(endDate);\n  }\n\n  selectDay(selection: Date): void {\n    const { startTime } = this.props;\n    const { selectionSet } = this.state;\n\n    if (selectionSet) {\n      this.setState({ hoverTimeRange: null, selectionSet: false });\n      this.selectNewRange(selection, null);\n    } else {\n      const isDoubleClickSameDay = datesEqual(selection, startTime);\n      const isBackwardSelection = selection < startTime;\n\n      if (isDoubleClickSameDay) {\n        this.selectNewRange(startTime, startTime);\n      } else if (isBackwardSelection) {\n        this.selectNewRange(selection, startTime);\n      } else {\n        this.selectNewRange(startTime, selection);\n      }\n      this.setState({ selectionSet: true });\n    }\n  }\n\n  getIsSelectable(date: Date): boolean {\n    const { hoverTimeRange, selectionSet } = this.state;\n    const inHoverTimeRange = hoverTimeRange && hoverTimeRange.contains(date);\n    return inHoverTimeRange && !selectionSet;\n  }\n\n  renderDays(weeks: Date[][], monthStart: Date): JSX.Element[] {\n    const { startTime, endTime, maxTime, timezone } = this.props;\n    const startDay = day.floor(startTime, timezone);\n    const dayBeforeEnd = endTime && day.shift(endTime, timezone, -1);\n    const nextMonthStart = month.shift(monthStart, timezone, 1);\n\n    return weeks.map((daysInWeek: Date[], row: number) => {\n      return <div className=\"week\" key={row}> {daysInWeek.map((dayDate: Date, column: number) => {\n        const isPast = dayDate < monthStart;\n        const isFuture = dayDate >= nextMonthStart;\n        const isBeyondMaxRange = dayDate > maxTime;\n        const isSelected = startDay <= dayDate && dayDate < endTime;\n        const isSelectedEdgeStart = datesEqual(dayDate, startTime);\n        const isSelectedEdgeEnd = datesEqual(dayDate, dayBeforeEnd);\n        const className = classNames(\"day\", \"value\",\n          {\n            \"past\": isPast,\n            \"future\": isFuture,\n            \"beyond-max-range\": isBeyondMaxRange,\n            \"selectable\": this.getIsSelectable(dayDate),\n            \"selected\": isSelected,\n            \"selected-edge\": isSelectedEdgeStart || isSelectedEdgeEnd\n          });\n\n        return <div\n          className={className}\n          key={column}\n          onClick={this.selectDay.bind(this, dayDate)}\n          onMouseEnter={this.calculateHoverTimeRange.bind(this, dayDate)}\n        >{getDayInMonth(dayDate, timezone)}</div>;\n      })}</div>;\n    });\n  }\n\n  renderCalendar(startDate: Date): JSX.Element[] {\n    const { timezone, locale } = this.props;\n    const weeks: Date[][] = calendarDays(startDate, timezone, locale);\n    return this.renderDays(weeks, startDate);\n  }\n\n  renderCalendarNav(startDate: Date): JSX.Element {\n    const { timezone } = this.props;\n\n    return <div className=\"calendar-nav\">\n      <div\n        className=\"caret left\"\n        onClick={this.goToPreviousMonth}\n      >\n        <SvgIcon svg={require(\"../../icons/full-caret-left.svg\")} />\n      </div>\n      {formatYearMonth(startDate, timezone)}\n      <div\n        className=\"caret right\"\n        onClick={this.goToNextMonth}\n      >\n        <SvgIcon svg={require(\"../../icons/full-caret-right.svg\")} />\n      </div>\n    </div>;\n  }\n\n  render() {\n    const { locale, startTime, endTime, timezone, onStartChange, onEndChange } = this.props;\n    const { activeMonthStartDate, selectionSet } = this.state;\n    if (!activeMonthStartDate) return null;\n\n    const days = cyclicShift(locale.shortDays, locale.weekStart);\n    return <div className=\"date-range-picker\">\n      <div>\n        <DateRangeInput label=\"Start\" type=\"start\" time={startTime} timezone={timezone} onChange={onStartChange} />\n        <DateRangeInput label=\"End\" type=\"end\" time={endTime} timezone={timezone} onChange={onEndChange} hide={!selectionSet} />\n      </div>\n      <div\n        className=\"calendar\"\n        onMouseLeave={this.onCalendarMouseLeave}\n      >\n        {this.renderCalendarNav(activeMonthStartDate)}\n        <div className=\"week\">\n          {days.map((day, i) => {\n            return <div className=\"day label\" key={day + i}><span className=\"space\" />{day}</div>;\n          })\n          }\n        </div>\n        {this.renderCalendar(activeMonthStartDate)}\n      </div>\n    </div>;\n  }\n}\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Duration, Timezone } from \"chronoshift\";\nimport React from \"react\";\nimport { DateRange } from \"../../../../common/models/date-range/date-range\";\nimport { TimeDimension } from \"../../../../common/models/dimension/dimension\";\nimport { isValidTimeShift } from \"../../../../common/models/time-shift/time-shift\";\nimport { Unary } from \"../../../../common/utils/functional/functional\";\nimport { formatTimeRange } from \"../../../../common/utils/time/time\";\nimport { STRINGS } from \"../../../config/constants\";\nimport { Preset } from \"../../input-with-presets/input-with-presets\";\nimport { StringInputWithPresets } from \"../../input-with-presets/string-input-with-presets\";\nimport { normalizeDurationName } from \"./presets\";\n\nfunction safeDurationFromJS(duration: string): Duration | null {\n  try {\n    return Duration.fromJS(duration);\n  } catch {\n    return null;\n  }\n}\n\nfunction timeShiftPreviewForRange({\n                                    shift,\n                                    time,\n                                    timezone\n                                  }: Pick<TimeShiftSelectorProps, \"shift\" | \"time\" | \"timezone\">): string {\n  if (time === null || !time.start || !time.end) return null;\n  const duration: Duration = safeDurationFromJS(shift);\n  if (duration === null) return null;\n  const shiftedTimeRange = time.shift(duration, timezone);\n  return formatTimeRange(shiftedTimeRange, timezone);\n}\n\nexport interface TimeShiftSelectorProps {\n  shift: string;\n  dimension: TimeDimension;\n  time: DateRange;\n  timezone: Timezone;\n  onShiftChange: Unary<string, void>;\n}\n\nfunction presets(dimension: TimeDimension): Array<Preset<string>> {\n  return [\n    { name: \"Off\", identity: null },\n    ...dimension.timeShiftDurations.map(shift => ({\n      name: normalizeDurationName(shift.toJS()),\n      identity: shift.toJS()\n    }))\n  ];\n}\n\nexport const TimeShiftSelector: React.FunctionComponent<TimeShiftSelectorProps> = props => {\n  const { onShiftChange, dimension, shift: selectedTimeShift } = props;\n  const timeShiftPreview = timeShiftPreviewForRange(props);\n\n  return <React.Fragment>\n    <StringInputWithPresets\n      title={STRINGS.timeShift}\n      presets={presets(dimension)}\n      selected={selectedTimeShift}\n      onChange={onShiftChange}\n      errorMessage={isValidTimeShift(selectedTimeShift) ? null : STRINGS.invalidDurationFormat}\n      placeholder={STRINGS.timeShiftExamples}/>\n    {timeShiftPreview ? <div className=\"preview\">{timeShiftPreview}</div> : null}\n  </React.Fragment>;\n};\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { day } from \"chronoshift\";\nimport { List } from \"immutable\";\nimport React from \"react\";\nimport { Clicker } from \"../../../../common/models/clicker/clicker\";\nimport { getMaxTime } from \"../../../../common/models/data-cube/data-cube\";\nimport { DateRange } from \"../../../../common/models/date-range/date-range\";\nimport { TimeDimension } from \"../../../../common/models/dimension/dimension\";\nimport { Essence } from \"../../../../common/models/essence/essence\";\nimport { FilterClause, FixedTimeFilterClause } from \"../../../../common/models/filter-clause/filter-clause\";\nimport { Locale } from \"../../../../common/models/locale/locale\";\nimport { isValidTimeShift, TimeShift } from \"../../../../common/models/time-shift/time-shift\";\nimport { Timekeeper } from \"../../../../common/models/timekeeper/timekeeper\";\nimport { Unary } from \"../../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../../common/utils/general/general\";\nimport { STRINGS } from \"../../../config/constants\";\nimport { Button } from \"../../button/button\";\nimport { DateRangePicker } from \"../../date-range-picker/date-range-picker\";\nimport { TimeShiftSelector } from \"./time-shift-selector\";\n\nexport interface FixedTimeTabProps {\n  essence: Essence;\n  timekeeper: Timekeeper;\n  locale: Locale;\n  dimension: TimeDimension;\n  onClose: Fn;\n  clicker: Clicker;\n  saveClause: Unary<FilterClause, void>;\n}\n\nexport interface FixedTimeTabState {\n  start: Date;\n  end: Date;\n  shift: string;\n}\n\nexport class FixedTimeTab extends React.Component<FixedTimeTabProps, FixedTimeTabState> {\n\n  initialState = (): FixedTimeTabState => {\n    const { essence, timekeeper, dimension: { name } } = this.props;\n    const shift = essence.timeShift.toJS();\n\n    const timeFilter = essence.getEffectiveFilter(timekeeper).clauseForReference(name);\n    if (timeFilter && timeFilter instanceof FixedTimeFilterClause && !timeFilter.values.isEmpty()) {\n      const { start, end } = timeFilter.values.get(0);\n      return { start, end, shift };\n    }\n    return { start: null, end: null, shift };\n  };\n\n  onStartChange = (start: Date) => this.setState({ start });\n\n  onEndChange = (end: Date) => this.setState({ end });\n\n  setTimeShift = (shift: string) => this.setState({ shift });\n\n  state: FixedTimeTabState = this.initialState();\n\n  createDateRange(): DateRange | null {\n    const { start, end: maybeEnd } = this.state;\n    if (!start) return null;\n    const timezone = this.props.essence.timezone;\n    const end = maybeEnd || day.shift(start, timezone, 1);\n    if (start >= end) return null;\n    return new DateRange({ start, end });\n  }\n\n  constructFixedClause(): FixedTimeFilterClause {\n    const { dimension: { name: reference } } = this.props;\n\n    const values = List.of(this.createDateRange());\n    return new FixedTimeFilterClause({ reference, values });\n  }\n\n  constructTimeShift(): TimeShift {\n    return TimeShift.fromJS(this.state.shift);\n  }\n\n  doesTimeShiftOverlap(): boolean {\n    const shift = this.constructTimeShift();\n    if (shift.isEmpty()) return false;\n    const { essence: { timezone } } = this.props;\n    const currentRange = this.createDateRange();\n    const duration = shift.valueOf();\n    const previousRange = currentRange.shift(duration, timezone);\n    return currentRange.intersects(previousRange);\n  }\n\n  validateOverlap(): string | null {\n    const periodsOverlap = this.isTimeShiftValid() && this.areDatesValid() && this.doesTimeShiftOverlap();\n    return periodsOverlap ? STRINGS.overlappingPeriods : null;\n  }\n\n  isTimeShiftValid(): boolean {\n    return isValidTimeShift(this.state.shift);\n  }\n\n  areDatesValid(): boolean {\n    return this.createDateRange() !== null;\n  }\n\n  isFormValid(): boolean {\n    return this.areDatesValid() && this.isTimeShiftValid() && !this.doesTimeShiftOverlap();\n  }\n\n  isFilterDifferent(): boolean {\n    const { essence: { filter, timeShift }, dimension } = this.props;\n    const newTimeShift = this.constructTimeShift();\n    const oldClause = filter.getClauseForDimension(dimension);\n    const newClause = this.constructFixedClause();\n    return !oldClause.equals(newClause) || !timeShift.equals(newTimeShift);\n  }\n\n  validate(): boolean {\n    return this.isFormValid() && this.isFilterDifferent();\n  }\n\n  onOkClick = () => {\n    if (!this.validate()) return;\n    const { saveClause, clicker, onClose } = this.props;\n    saveClause(this.constructFixedClause());\n    clicker.changeComparisonShift(this.constructTimeShift());\n    onClose();\n  };\n\n  render() {\n    const { locale, essence: { timezone, dataCube }, timekeeper, dimension, onClose } = this.props;\n    if (!dimension) return null;\n    const { shift, start, end } = this.state;\n    const overlapError = this.validateOverlap();\n\n    return <div>\n      <DateRangePicker\n        locale={locale}\n        startTime={start}\n        endTime={end}\n        maxTime={getMaxTime(dataCube, timekeeper)}\n        timezone={timezone}\n        onStartChange={this.onStartChange}\n        onEndChange={this.onEndChange}\n      />\n      <div className=\"cont\">\n        <TimeShiftSelector\n          dimension={dimension}\n          shift={shift}\n          time={this.createDateRange()}\n          onShiftChange={this.setTimeShift}\n          timezone={timezone} />\n        {overlapError && <div className=\"overlap-error-message\">{overlapError}</div>}\n      </div>\n      <div className=\"ok-cancel-bar\">\n        <Button type=\"primary\" onClick={this.onOkClick} disabled={!this.validate()} title={STRINGS.ok} />\n        <Button type=\"secondary\" onClick={onClose} title={STRINGS.cancel} />\n      </div>\n    </div>;\n  }\n}\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Duration } from \"chronoshift\";\nimport React from \"react\";\nimport { Clicker } from \"../../../../common/models/clicker/clicker\";\nimport { isTimeAttribute } from \"../../../../common/models/data-cube/data-cube\";\nimport { TimeDimension } from \"../../../../common/models/dimension/dimension\";\nimport { Essence } from \"../../../../common/models/essence/essence\";\nimport {\n  FilterClause,\n  RelativeTimeFilterClause,\n  TimeFilterPeriod\n} from \"../../../../common/models/filter-clause/filter-clause\";\nimport { isValidTimeShift, TimeShift } from \"../../../../common/models/time-shift/time-shift\";\nimport { Timekeeper } from \"../../../../common/models/timekeeper/timekeeper\";\nimport { Unary } from \"../../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../../common/utils/general/general\";\nimport { isValidDuration } from \"../../../../common/utils/plywood/duration\";\nimport { formatTimeRange } from \"../../../../common/utils/time/time\";\nimport { STRINGS } from \"../../../config/constants\";\nimport { ButtonGroup } from \"../../button-group/button-group\";\nimport { Button } from \"../../button/button\";\nimport { Preset } from \"../../input-with-presets/input-with-presets\";\nimport { StringInputWithPresets } from \"../../input-with-presets/string-input-with-presets\";\nimport { getTimeFilterPresets, normalizeDurationName } from \"./presets\";\nimport { TimeShiftSelector } from \"./time-shift-selector\";\n\nexport interface PresetTimeTabProps {\n  essence: Essence;\n  timekeeper: Timekeeper;\n  dimension: TimeDimension;\n  clicker: Clicker;\n  saveClause: Unary<FilterClause, void>;\n  onClose: Fn;\n}\n\nexport interface PresetTimeTabState {\n  filterPeriod: TimeFilterPeriod;\n  filterDuration: string;\n  timeShift: string;\n}\n\nfunction initialState(essence: Essence, dimension: TimeDimension): PresetTimeTabState {\n  const filterClause = essence.filter.getClauseForDimension(dimension);\n  const timeShift = essence.timeShift.toJS();\n  if (filterClause instanceof RelativeTimeFilterClause) {\n    const { duration, period } = filterClause;\n    return { timeShift, filterDuration: duration.toJS(), filterPeriod: period };\n  }\n  return {\n    filterPeriod: null,\n    filterDuration: null,\n    timeShift\n  };\n}\n\nexport class PresetTimeTab extends React.Component<PresetTimeTabProps, PresetTimeTabState> {\n\n  setFilter = (filterPeriod: TimeFilterPeriod, filterDuration: string) => this.setState({ filterDuration, filterPeriod });\n\n  setTimeShift = (timeShift: string) => this.setState({ timeShift });\n\n  state: PresetTimeTabState = initialState(this.props.essence, this.props.dimension);\n\n  saveTimeFilter = () => {\n    if (!this.validate()) return;\n    const { clicker, saveClause, onClose } = this.props;\n    saveClause(this.constructRelativeClause());\n    clicker.changeComparisonShift(this.constructTimeShift());\n    onClose();\n  };\n\n  constructTimeShift(): TimeShift {\n    return TimeShift.fromJS(this.state.timeShift);\n  }\n\n  constructRelativeClause(): RelativeTimeFilterClause | null {\n    const { dimension: { name: reference } } = this.props;\n    const { filterPeriod: period, filterDuration } = this.state;\n    if (!isValidDuration(filterDuration)) return null;\n    const duration = Duration.fromJS(filterDuration);\n    return new RelativeTimeFilterClause({ period, duration, reference });\n  }\n\n  doesTimeShiftOverlap(): boolean {\n    const timeShift = this.constructTimeShift();\n    if (timeShift.isEmpty()) return false;\n    const timeShiftDuration = timeShift.valueOf();\n    const filterDuration = Duration.fromJS(this.state.filterDuration);\n    return filterDuration.getCanonicalLength() > timeShiftDuration.getCanonicalLength();\n  }\n\n  isTimeShiftValid(): boolean {\n    return isValidTimeShift(this.state.timeShift);\n  }\n\n  isDurationValid(): boolean {\n    return isValidDuration(this.state.filterDuration);\n  }\n\n  validateOverlap(): string | null {\n    const periodOverlaps = this.isTimeShiftValid() && this.isDurationValid() && this.doesTimeShiftOverlap();\n    return periodOverlaps ? STRINGS.overlappingPeriods : null;\n  }\n\n  isFormValid(): boolean {\n    const { filterPeriod } = this.state;\n    return filterPeriod && this.isDurationValid() && this.isTimeShiftValid() && !this.doesTimeShiftOverlap();\n  }\n\n  isFilterDifferent(): boolean {\n    const { essence: { filter, timeShift }, dimension } = this.props;\n    const newTimeShift = this.constructTimeShift();\n    const oldClause = filter.getClauseForDimension(dimension);\n    const newClause = this.constructRelativeClause();\n    return !oldClause.equals(newClause) || !timeShift.equals(newTimeShift);\n  }\n\n  validate(): boolean {\n    return this.isFormValid() && this.isFilterDifferent();\n  }\n\n  private renderLatestPresets() {\n    const { dimension } = this.props;\n    const { filterDuration, filterPeriod } = this.state;\n    const presets: Array<Preset<string>> = dimension.latestPeriodDurations.map(duration => {\n      return {\n        name: normalizeDurationName(duration.toJS()),\n        identity: duration.toJS()\n      };\n    });\n\n    const latestPeriod = filterPeriod === TimeFilterPeriod.LATEST;\n    return <StringInputWithPresets\n      title={STRINGS.latest}\n      presets={presets}\n      errorMessage={latestPeriod && !isValidDuration(filterDuration) && STRINGS.invalidDurationFormat}\n      selected={latestPeriod ? filterDuration : undefined}\n      onChange={(duration: string) => this.setFilter(TimeFilterPeriod.LATEST, duration)}\n      placeholder={STRINGS.durationsExamples} />;\n  }\n\n  private renderButtonGroup(title: string, period: TimeFilterPeriod.CURRENT | TimeFilterPeriod.PREVIOUS) {\n    const { filterDuration, filterPeriod } = this.state;\n    const activePeriod = period === filterPeriod;\n    const presets = getTimeFilterPresets(period);\n    const groupMembers = presets.map(({ duration, name }) => {\n      return {\n        title: name,\n        key: name,\n        isSelected: activePeriod && filterDuration === duration,\n        onClick: () => this.setFilter(period, duration)\n      };\n    });\n    return <ButtonGroup title={title} groupMembers={groupMembers} />;\n  }\n\n  private getFilterRange() {\n    const filter = this.constructRelativeClause();\n    if (!filter) return null;\n    const { essence, timekeeper } = this.props;\n    const fixedFilter = essence.evaluateSelection(filter, timekeeper);\n    return fixedFilter.values.get(0);\n  }\n\n  render() {\n    const { essence, dimension } = this.props;\n    if (!dimension) return null;\n\n    const { timeShift } = this.state;\n\n    const { timezone } = essence;\n\n    const previewFilter = this.getFilterRange();\n    const previewText = previewFilter ? formatTimeRange(previewFilter, timezone) : STRINGS.noFilter;\n    const overlapError = this.validateOverlap();\n\n    return <div className=\"cont\">\n      {isTimeAttribute(essence.dataCube, dimension.expression) && this.renderLatestPresets()}\n      {this.renderButtonGroup(STRINGS.current, TimeFilterPeriod.CURRENT)}\n      {this.renderButtonGroup(STRINGS.previous, TimeFilterPeriod.PREVIOUS)}\n      <div className=\"preview preview--with-spacing\">{previewText}</div>\n      <TimeShiftSelector\n        dimension={dimension}\n        shift={timeShift}\n        time={previewFilter}\n        timezone={essence.timezone}\n        onShiftChange={this.setTimeShift} />\n      {overlapError && <div className=\"overlap-error-message\">{overlapError}</div>}\n      <div className=\"ok-cancel-bar\">\n        <Button type=\"primary\" onClick={this.saveTimeFilter} disabled={!this.validate()} title={STRINGS.ok} />\n        <Button type=\"secondary\" onClick={this.props.onClose} title={STRINGS.cancel} />\n      </div>\n    </div>;\n  }\n}\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Clicker } from \"../../../../common/models/clicker/clicker\";\nimport { TimeDimension } from \"../../../../common/models/dimension/dimension\";\nimport { Essence } from \"../../../../common/models/essence/essence\";\nimport { FilterClause, RelativeTimeFilterClause } from \"../../../../common/models/filter-clause/filter-clause\";\nimport { Locale } from \"../../../../common/models/locale/locale\";\nimport { Stage } from \"../../../../common/models/stage/stage\";\nimport { Timekeeper } from \"../../../../common/models/timekeeper/timekeeper\";\nimport { Unary } from \"../../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../../common/utils/general/general\";\nimport { STRINGS } from \"../../../config/constants\";\nimport { BubbleMenu } from \"../../bubble-menu/bubble-menu\";\nimport { ButtonGroup } from \"../../button-group/button-group\";\nimport { FixedTimeTab } from \"./fixed-time-tab\";\nimport { PresetTimeTab } from \"./preset-time-tab\";\nimport \"./time-filter-menu.scss\";\n\nconst MENU_WIDTH = 250;\n\ninterface TabSelectorProps {\n  selectedTab: TimeFilterTab;\n  onTabSelect: Unary<TimeFilterTab, void>;\n}\n\nfunction tabTitle(tab: TimeFilterTab) {\n  return tab === TimeFilterTab.RELATIVE ? STRINGS.relative : STRINGS.fixed;\n}\n\nconst TabSelector: React.FunctionComponent<TabSelectorProps> = props => {\n  const { selectedTab, onTabSelect } = props;\n  const tabs = [TimeFilterTab.RELATIVE, TimeFilterTab.FIXED].map(tab => {\n    return {\n      isSelected: selectedTab === tab,\n      title: tabTitle(tab),\n      key: tab,\n      onClick: () => onTabSelect(tab)\n    };\n  });\n  return <ButtonGroup groupMembers={tabs} />;\n};\n\nexport interface TimeFilterMenuProps {\n  clicker: Clicker;\n  saveClause: Unary<FilterClause, void>;\n  timekeeper: Timekeeper;\n  essence: Essence;\n  locale: Locale;\n  dimension: TimeDimension;\n  onClose: Fn;\n  containerStage?: Stage;\n  openOn: Element;\n}\n\nenum TimeFilterTab { RELATIVE = \"relative\", FIXED = \"fixed\"}\n\nexport interface TimeFilterMenuState {\n  tab: TimeFilterTab;\n}\n\nfunction initialTab(essence: Essence): TimeFilterTab {\n  const isRelativeTimeFilter = essence.timeFilter() instanceof RelativeTimeFilterClause;\n  return isRelativeTimeFilter ? TimeFilterTab.RELATIVE : TimeFilterTab.FIXED;\n}\n\nexport class TimeFilterMenu extends React.Component<TimeFilterMenuProps, TimeFilterMenuState> {\n\n  state: TimeFilterMenuState = { tab: initialTab(this.props.essence) };\n\n  selectTab = (tab: TimeFilterTab) => this.setState({ tab });\n\n  render() {\n    const { essence, saveClause, timekeeper, clicker, dimension, onClose, containerStage, locale, openOn } = this.props;\n    if (!dimension) return null;\n    const { tab } = this.state;\n    const menuSize = Stage.fromSize(MENU_WIDTH, 410);\n    const isRelativeTab = tab === TimeFilterTab.RELATIVE;\n    const tabProps = { saveClause, essence, dimension, timekeeper, onClose, clicker, locale };\n\n    return <BubbleMenu\n      className=\"time-filter-menu\"\n      direction=\"down\"\n      containerStage={containerStage}\n      stage={menuSize}\n      openOn={openOn}\n      onClose={onClose}\n    >\n      <TabSelector selectedTab={tab} onTabSelect={this.selectTab} />\n      {isRelativeTab ? <PresetTimeTab {...tabProps} /> : <FixedTimeTab {...tabProps} />}\n    </BubbleMenu>;\n  }\n}\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Clicker } from \"../../../common/models/clicker/clicker\";\nimport { Dimension } from \"../../../common/models/dimension/dimension\";\nimport { Essence } from \"../../../common/models/essence/essence\";\nimport { FilterClause } from \"../../../common/models/filter-clause/filter-clause\";\nimport { Locale } from \"../../../common/models/locale/locale\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Timekeeper } from \"../../../common/models/timekeeper/timekeeper\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { BooleanFilterMenu } from \"./boolean-filter-menu/boolean-filter-menu\";\nimport \"./filter-menu.scss\";\nimport { NumberFilterMenu } from \"./number-filter-menu/number-filter-menu\";\nimport { StringFilterMenu } from \"./string-filter-menu/string-filter-menu\";\nimport { TimeFilterMenu } from \"./time-filter-menu/time-filter-menu\";\n\nexport interface FilterMenuProps {\n  essence: Essence;\n  timekeeper: Timekeeper;\n  locale: Locale;\n  clicker: Clicker;\n  saveClause: Unary<FilterClause, void>;\n  containerStage?: Stage;\n  openOn: Element;\n  dimension: Dimension;\n  onClose: Fn;\n}\n\nexport const FilterMenu: React.FunctionComponent<FilterMenuProps> = ({ dimension, ...props }: FilterMenuProps) => {\n  if (!dimension) return null;\n  switch (dimension.kind) {\n    case \"time\":\n      return <TimeFilterMenu dimension={dimension} {...props} />;\n    case \"boolean\":\n      return <BooleanFilterMenu dimension={dimension}{...props} />;\n    case \"number\":\n      return <NumberFilterMenu dimension={dimension} {...props} />;\n    default:\n      return <StringFilterMenu dimension={dimension}{...props} />;\n  }\n};\n","/*\n * Copyright 2017-2021 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Clicker } from \"../../../common/models/clicker/clicker\";\nimport { Dimension } from \"../../../common/models/dimension/dimension\";\nimport { Essence } from \"../../../common/models/essence/essence\";\nimport { FilterClause, isTimeFilter } from \"../../../common/models/filter-clause/filter-clause\";\nimport { Locale } from \"../../../common/models/locale/locale\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Timekeeper } from \"../../../common/models/timekeeper/timekeeper\";\nimport { getFormattedClause } from \"../../../common/utils/formatter/formatter\";\nimport { Ternary, Unary } from \"../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { classNames } from \"../../utils/dom/dom\";\nimport { FilterMenu } from \"../filter-menu/filter-menu\";\nimport { SvgIcon } from \"../svg-icon/svg-icon\";\nimport { WithRef } from \"../with-ref/with-ref\";\nimport { FilterClauseLabel } from \"./filter-clause-label\";\nimport timeShiftLabel from \"./time-shift-label\";\n\nfunction tileTitle(dimension: Dimension, clause: FilterClause, essence: Essence): string {\n  const { title, values } = getFormattedClause(dimension, clause, essence.timezone);\n  const timeShift = timeShiftLabel(dimension, essence);\n\n  return `${title} ${values} ${timeShift || \"\"}`;\n}\n\ninterface FilterTileProps {\n  clause: FilterClause;\n  open: boolean;\n  dimension: Dimension;\n  style?: React.CSSProperties;\n  removeClause?: Unary<FilterClause, void>;\n  saveClause: Unary<FilterClause, void>;\n  openFilterMenu: Unary<FilterClause, void>;\n  closeFilterMenu: Fn;\n  dragStart: Ternary<Dimension, FilterClause, React.DragEvent<HTMLElement>, void>;\n  stage: Stage;\n  essence: Essence;\n  timekeeper: Timekeeper;\n  locale: Locale;\n  clicker: Clicker;\n}\n\nexport const FILTER_CLASS_NAME = \"filter\";\n\nexport const FilterTile: React.FunctionComponent<FilterTileProps> = props => {\n  const {\n    clause,\n    open,\n    dimension,\n    style,\n    removeClause,\n    saveClause,\n    openFilterMenu,\n    closeFilterMenu,\n    dragStart,\n    stage,\n    essence,\n    locale,\n    timekeeper,\n    clicker\n  } = props;\n\n  const excluded = clause && !isTimeFilter(clause) && clause.not;\n  return <WithRef>\n    {({ ref: openOn, setRef }) => <React.Fragment>\n      <div\n        className={classNames(\"tile dimension\", {\n          selected: open,\n          excluded,\n          included: !excluded\n        })}\n        draggable={true}\n        ref={setRef}\n        onClick={() => openFilterMenu(clause)}\n        onDragStart={e => dragStart(dimension, clause, e)}\n        style={style}\n        title={tileTitle(dimension, clause, essence)}\n      >\n        <FilterClauseLabel dimension={dimension} clause={clause} essence={essence} />\n        {removeClause && <div className=\"remove\" onClick={() => removeClause(clause)}>\n          <SvgIcon svg={require(\"../../icons/x.svg\")} />\n        </div>}\n      </div>\n      {open && openOn && <FilterMenu\n        containerStage={stage}\n        essence={essence}\n        timekeeper={timekeeper}\n        locale={locale}\n        clicker={clicker}\n        saveClause={saveClause}\n        openOn={openOn}\n        dimension={dimension}\n        onClose={closeFilterMenu} />}\n    </React.Fragment>}\n  </WithRef>;\n};\n","/*\n * Copyright 2017-2021 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Clicker } from \"../../../common/models/clicker/clicker\";\nimport { Dimension } from \"../../../common/models/dimension/dimension\";\nimport { Essence } from \"../../../common/models/essence/essence\";\nimport { FilterClause } from \"../../../common/models/filter-clause/filter-clause\";\nimport { Locale } from \"../../../common/models/locale/locale\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Timekeeper } from \"../../../common/models/timekeeper/timekeeper\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { FilterMenu } from \"../filter-menu/filter-menu\";\nimport { WithRef } from \"../with-ref/with-ref\";\n\ninterface PartialFilterTileProps {\n  dimension: Dimension;\n  style?: React.CSSProperties;\n  essence: Essence;\n  timekeeper: Timekeeper;\n  locale: Locale;\n  clicker: Clicker;\n  saveClause: Unary<FilterClause, void>;\n  stage: Stage;\n  closeItem: Fn;\n}\n\nexport const PartialFilterTile: React.FunctionComponent<PartialFilterTileProps> = props => {\n  const { closeItem, saveClause, essence, timekeeper, locale, clicker, stage, dimension, style } = props;\n  return <WithRef>\n    {({ ref: openOn, setRef }) => <div\n      className={\"tile dimension selected included\"}\n      ref={setRef}\n      style={style}>\n      <div className=\"reading\">{dimension.title}</div>\n      {openOn && <FilterMenu\n        essence={essence}\n        timekeeper={timekeeper}\n        locale={locale}\n        clicker={clicker}\n        saveClause={saveClause}\n        openOn={openOn}\n        dimension={dimension}\n        containerStage={stage}\n        onClose={closeItem} />}\n        </div>}\n  </WithRef>;\n};\n","/*\n * Copyright 2017-2021 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { ReactElement } from \"react\";\nimport { Clicker } from \"../../../common/models/clicker/clicker\";\nimport { Dimension } from \"../../../common/models/dimension/dimension\";\nimport { findDimensionByName } from \"../../../common/models/dimension/dimensions\";\nimport { DragPosition } from \"../../../common/models/drag-position/drag-position\";\nimport { Essence } from \"../../../common/models/essence/essence\";\nimport { FilterClause } from \"../../../common/models/filter-clause/filter-clause\";\nimport { Locale } from \"../../../common/models/locale/locale\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Timekeeper } from \"../../../common/models/timekeeper/timekeeper\";\nimport { insert } from \"../../../common/utils/array/array\";\nimport { Ternary, Unary } from \"../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { transformStyle } from \"../../utils/dom/dom\";\nimport { SECTION_WIDTH } from \"../../utils/pill-tile/pill-tile\";\nimport { PartialFilter } from \"../../views/cube-view/partial-tiles-provider\";\nimport { TileOverflowContainer } from \"../tile-overflow-container/tile-overflow-container\";\nimport { FilterTile } from \"./filter-tile\";\nimport { PartialFilterTile } from \"./partial-filter-tile\";\n\ninterface FilterTilesProps {\n  menuStage: Stage;\n  maxItems: number;\n  essence: Essence;\n  clicker: Clicker;\n  timekeeper: Timekeeper;\n  locale: Locale;\n  removeFilter: Unary<FilterClause, void>;\n  openedFilterMenu?: FilterClause;\n  openFilterMenu: Unary<FilterClause, void>;\n  closeFilterMenu: Fn;\n  dragStart: Ternary<Dimension, FilterClause, React.DragEvent<HTMLElement>, void>;\n  partialFilter?: PartialFilter;\n  removePartialFilter: Fn;\n  overflowOpen: boolean;\n  closeOverflowMenu: Fn;\n  openOverflowMenu: Fn;\n}\n\nexport const FilterTiles: React.FunctionComponent<FilterTilesProps> = props => {\n  const {\n    menuStage,\n    maxItems,\n    essence,\n    clicker,\n    timekeeper,\n    locale,\n    removeFilter,\n    openedFilterMenu,\n    openFilterMenu,\n    closeFilterMenu,\n    dragStart,\n    partialFilter,\n    removePartialFilter,\n    overflowOpen,\n    closeOverflowMenu,\n    openOverflowMenu\n  } = props;\n\n  const clauses = essence.filter.clauses.toArray();\n  const dimensions = essence.dataCube.dimensions;\n\n  function updateClause(clause: FilterClause) {\n    clicker.changeFilter(essence.filter.setClause(clause));\n  }\n\n  function insertClause(clause: FilterClause, position: DragPosition) {\n    const { filter } = essence;\n    const newFilter = position.isInsert()\n      ? filter.insertByIndex(position.insert, clause)\n      : filter.replaceByIndex(position.replace, clause);\n    clicker.changeFilter(newFilter);\n  }\n\n  const filterTiles = clauses.map(clause => {\n    const dimension = findDimensionByName(dimensions, clause.reference);\n    const isTimeClause = dimension.name === essence.getTimeDimension().name;\n    return <FilterTile\n      key={clause.reference}\n      stage={menuStage}\n      essence={essence}\n      timekeeper={timekeeper}\n      clicker={clicker}\n      locale={locale}\n      clause={clause}\n      open={clause.equals(openedFilterMenu)}\n      dimension={dimension}\n      removeClause={isTimeClause ? undefined : removeFilter}\n      saveClause={updateClause}\n      openFilterMenu={openFilterMenu}\n\n      closeFilterMenu={closeFilterMenu}\n      dragStart={dragStart} />;\n  });\n\n  function insertPartialTile<T>(tiles: Array<ReactElement<T>>): Array<ReactElement<T>> {\n    if (!partialFilter) return tiles;\n    const { dimension, position } = partialFilter;\n    const partialTile = <PartialFilterTile\n      key=\"partial-filter-tile\"\n      dimension={dimension}\n      essence={essence}\n      timekeeper={timekeeper}\n      locale={locale}\n      clicker={clicker}\n      saveClause={clause => insertClause(clause, partialFilter.position)}\n      stage={menuStage}\n      closeItem={removePartialFilter}/>;\n\n    return insert(tiles, position.getIndex(), partialTile);\n  }\n\n  const tilesWithPlaceholder = insertPartialTile(filterTiles);\n\n  const visibleItems = tilesWithPlaceholder\n      .slice(0, maxItems)\n      .map((el, idx) => React.cloneElement(el, { style: transformStyle(idx * SECTION_WIDTH, 0) }));\n  const overflowItems = tilesWithPlaceholder.slice(maxItems);\n\n  if (overflowItems.length <= 0) return <React.Fragment>{visibleItems}</React.Fragment>;\n\n  const overflowClauses = clauses.slice(maxItems);\n\n  const anyOverflowItemOpen = overflowClauses.some(clause => clause.equals(openedFilterMenu));\n  const isPartialFilterInOverflow = overflowItems.some(element => element.type  === PartialFilterTile);\n  const overflowOpened = overflowOpen || anyOverflowItemOpen || isPartialFilterInOverflow;\n\n  const filterItemOverflow = <TileOverflowContainer\n    key=\"overflow-menu\"\n    className=\"dimension\"\n    x={visibleItems.length * SECTION_WIDTH}\n    items={overflowItems}\n    open={overflowOpened}\n    openOverflowMenu={openOverflowMenu}\n    closeOverflowMenu={closeOverflowMenu} />;\n\n  return <React.Fragment>\n    {[...visibleItems, filterItemOverflow]}\n  </React.Fragment>;\n};\n","/*\n * Copyright 2017-2021 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { getTimeDimensionReference } from \"../../../common/models/data-cube/data-cube\";\nimport { Dimension } from \"../../../common/models/dimension/dimension\";\nimport { findDimensionByName } from \"../../../common/models/dimension/dimensions\";\nimport { DragPosition } from \"../../../common/models/drag-position/drag-position\";\nimport { FilterClause } from \"../../../common/models/filter-clause/filter-clause\";\nimport { Locale } from \"../../../common/models/locale/locale\";\nimport { Split } from \"../../../common/models/split/split\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Timekeeper } from \"../../../common/models/timekeeper/timekeeper\";\nimport { Binary } from \"../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { CORE_ITEM_GAP, CORE_ITEM_WIDTH, STRINGS } from \"../../config/constants\";\nimport { getXFromEvent, setDragData, setDragGhost } from \"../../utils/dom/dom\";\nimport { DraggedElementType, DragManager } from \"../../utils/drag-manager/drag-manager\";\nimport { getMaxItems } from \"../../utils/pill-tile/pill-tile\";\nimport { CubeContext, CubeContextValue } from \"../../views/cube-view/cube-context\";\nimport { PartialFilter } from \"../../views/cube-view/partial-tiles-provider\";\nimport { DragIndicator } from \"../drag-indicator/drag-indicator\";\nimport { AddFilter } from \"./add-filter\";\nimport { FilterTiles } from \"./filter-tiles\";\n\ninterface FilterTilesRowProps {\n  menuStage: Stage;\n  timekeeper: Timekeeper;\n  locale: Locale;\n  removePartialFilter: Fn;\n  addPartialFilter: Binary<Dimension, DragPosition, void>;\n  partialFilter?: PartialFilter;\n}\n\ninterface FilterTilesRowState {\n  dragPosition?: DragPosition;\n  openedClause?: FilterClause;\n  overflowOpen?: boolean;\n}\n\nexport class FilterTilesRow extends React.Component<FilterTilesRowProps, FilterTilesRowState> {\n  static contextType = CubeContext;\n  context: CubeContextValue;\n\n  state: FilterTilesRowState = {};\n  private items = React.createRef<HTMLDivElement>();\n\n  private maxItems(): number {\n    const { essence: { filter } } = this.context;\n    const { menuStage } = this.props;\n    return menuStage && getMaxItems(menuStage.width, filter.length());\n  }\n\n  openFilterMenu = (clause: FilterClause) => this.setState({ openedClause: clause });\n\n  closeFilterMenu = () => this.setState({ openedClause: null });\n\n  openOverflowMenu = () => this.setState({ overflowOpen: true });\n\n  closeOverflowMenu = () => this.setState({ overflowOpen: false });\n\n  canDrop(): boolean {\n    const { essence: { filter } } = this.context;\n    switch (DragManager.dragging.type) {\n      case DraggedElementType.DIMENSION:\n        return !filter.getClauseForDimension(DragManager.draggingDimension());\n      case DraggedElementType.SPLIT:\n        return !filter.clauseForReference(DragManager.draggingSplit().reference);\n      case DraggedElementType.FILTER:\n        return true;\n      case DraggedElementType.MEASURE:\n        return false;\n      case DraggedElementType.SERIES:\n        return false;\n      case DraggedElementType.NONE:\n        return false;\n    }\n  }\n\n  dragStart = (dimension: Dimension, clause: FilterClause, e: React.DragEvent<HTMLElement>) => {\n    const label = dimension.title;\n    const dataTransfer = e.dataTransfer;\n    dataTransfer.effectAllowed = \"all\";\n    setDragData(dataTransfer, \"text/plain\", label);\n\n    DragManager.setDragFilter(clause);\n    setDragGhost(dataTransfer, label);\n\n    this.closeOverflowMenu();\n  };\n\n  calculateDragPosition(e: React.DragEvent<HTMLElement>): DragPosition {\n    const { essence } = this.context;\n    const numItems = essence.filter.length();\n    const rect = this.items.current.getBoundingClientRect();\n    const offset = getXFromEvent(e) - rect.left;\n    const position = DragPosition.calculateFromOffset(offset, numItems, CORE_ITEM_WIDTH, CORE_ITEM_GAP);\n    if (position.replace === this.maxItems()) {\n      return DragPosition.insertAt(position.replace);\n    }\n    return position;\n  }\n\n  dragEnter = (e: React.DragEvent<HTMLElement>) => {\n    if (!this.canDrop()) return;\n    e.preventDefault();\n    this.setState({\n      dragPosition: this.calculateDragPosition(e)\n    });\n  };\n\n  dragOver = (e: React.DragEvent<HTMLElement>) => {\n    if (!this.canDrop()) return;\n    e.preventDefault();\n    const dragPosition = this.calculateDragPosition(e);\n    if (dragPosition.equals(this.state.dragPosition)) return;\n    this.setState({ dragPosition });\n  };\n\n  dragLeave = () => {\n    if (!this.canDrop()) return;\n    this.setState({ dragPosition: null });\n  };\n\n  drop = (e: React.DragEvent<HTMLElement>) => {\n    if (!this.canDrop()) return;\n    e.preventDefault();\n    this.setState({ dragPosition: null });\n\n    const position = this.calculateDragPosition(e);\n    switch (DragManager.dragging.type) {\n      case DraggedElementType.DIMENSION:\n        this.dropDimension(DragManager.draggingDimension(), position);\n        break;\n      case DraggedElementType.FILTER:\n        this.dropFilter(DragManager.draggingFilter(), position);\n        break;\n      case DraggedElementType.SPLIT:\n        this.dropSplit(DragManager.draggingSplit(), position);\n        break;\n    }\n  };\n\n  private dropSplit(split: Split, position: DragPosition) {\n    const { essence: { dataCube: { dimensions } } } = this.context;\n    const dimension = findDimensionByName(dimensions, split.reference);\n    this.dropDimension(dimension, position);\n  }\n\n  private dropDimension(dimension: Dimension, position: DragPosition) {\n    const { essence: { filter, dataCube } } = this.context;\n    const { addPartialFilter } = this.props;\n    let tryingToReplaceTime = false;\n    if (position.isReplace()) {\n      const targetClause = filter.clauses.get(position.replace);\n      tryingToReplaceTime = targetClause && targetClause.reference === getTimeDimensionReference(dataCube);\n      if (tryingToReplaceTime) return;\n    }\n    addPartialFilter(dimension, position);\n  }\n\n  private dropFilter(clause: FilterClause, position: DragPosition) {\n    const { clicker, essence: { filter } } = this.context;\n    const newFilter = position.isReplace()\n      ? filter.replaceByIndex(position.replace, clause)\n      : filter.insertByIndex(position.insert, clause);\n    if (!filter.equals(newFilter)) {\n      clicker.changeFilter(newFilter);\n    }\n  }\n\n  appendFilter = (dimension: Dimension) => {\n    const { essence } = this.context;\n    const { addPartialFilter } = this.props;\n    addPartialFilter(dimension, DragPosition.insertAt(essence.filter.length()));\n  }\n\n  removeFilter = (clause: FilterClause) => {\n    const { essence, clicker } = this.context;\n    clicker.changeFilter(essence.filter.removeClause(clause.reference));\n    this.closeOverflowMenu();\n  }\n\n  render() {\n    const { dragPosition, openedClause, overflowOpen } = this.state;\n    const { menuStage, timekeeper, locale, partialFilter, removePartialFilter } = this.props;\n    const { essence, clicker } = this.context;\n    return <div className=\"tile-row filter-tile-row\" onDragEnter={this.dragEnter}>\n      <div className=\"title\">{STRINGS.filter}</div>\n      <div className=\"items\" ref={this.items}>\n        <FilterTiles\n          menuStage={menuStage}\n          maxItems={this.maxItems()}\n          essence={essence}\n          clicker={clicker}\n          timekeeper={timekeeper}\n          locale={locale}\n          removeFilter={this.removeFilter}\n          openFilterMenu={this.openFilterMenu}\n          closeFilterMenu={this.closeFilterMenu}\n          dragStart={this.dragStart}\n          removePartialFilter={removePartialFilter}\n          partialFilter={partialFilter}\n          overflowOpen={overflowOpen}\n          closeOverflowMenu={this.closeOverflowMenu}\n          openedFilterMenu={openedClause}\n          openOverflowMenu={this.openOverflowMenu}/>\n      </div>\n      <AddFilter\n        menuStage={menuStage}\n        essence={essence}\n        appendFilter={this.appendFilter}/>\n      <DragIndicator\n        dragOver={this.dragOver}\n        dragLeave={this.dragLeave}\n        drop={this.drop}\n        dragPosition={dragPosition}/>\n    </div>;\n  }\n}\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Clicker } from \"../../../common/models/clicker/clicker\";\nimport { Essence, VisStrategy } from \"../../../common/models/essence/essence\";\nimport { Resolution } from \"../../../common/models/visualization-manifest/visualization-manifest\";\nimport { MessageCard } from \"../message-card/message-card\";\nimport \"./manual-fallback.scss\";\n\nexport interface ManualFallbackProps {\n  clicker: Clicker;\n  essence: Essence;\n}\n\nexport class ManualFallback extends React.Component<ManualFallbackProps, {}> {\n\n  onResolutionClick(resolution: Resolution): void {\n    const { clicker } = this.props;\n    const { adjustment: { splits, series } } = resolution;\n\n    if (series != null) {\n      clicker.changeSeriesList(series);\n    }\n    if (splits != null) {\n      clicker.changeSplits(splits, VisStrategy.KeepAlways);\n    }\n  }\n\n  render() {\n    const { essence } = this.props;\n    const { visResolve } = essence;\n\n    if (!visResolve.isManual()) return null;\n\n    const resolutionItems = visResolve.resolutions.map((resolution, i) => {\n      return <li className=\"resolution-item\" key={i} onClick={this.onResolutionClick.bind(this, resolution)}>{resolution.description}</li>;\n    });\n\n    return <MessageCard title={visResolve.message}>\n      <ul className=\"manual-fallback\">\n        {resolutionItems}\n      </ul>\n    </MessageCard>;\n  }\n}\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Essence } from \"../../../common/models/essence/essence\";\nimport { Measure } from \"../../../common/models/measure/measure\";\nimport { allMeasures } from \"../../../common/models/measure/measures\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { AddTile } from \"../add-tile/add-tile\";\n\ninterface AddSeriesProps {\n  appendMeasureSeries: Unary<Measure, void>;\n  menuStage: Stage;\n  essence: Essence;\n}\n\nexport const AddSeries: React.FunctionComponent<AddSeriesProps> = props => {\n  const { appendMeasureSeries, menuStage, essence: { dataCube, series } } = props;\n  const tiles = allMeasures(dataCube.measures)\n    .filter(measure => !series.hasMeasure(measure))\n    .map(measure => {\n      return {\n        key: measure.name,\n        label: measure.title,\n        value: measure\n      };\n    });\n\n  return <AddTile<Measure>\n    containerStage={menuStage}\n    onSelect={appendMeasureSeries}\n    tiles={tiles} />;\n\n};\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { ClientMeasure } from \"../../../common/models/measure/measure\";\nimport {\n  customFormat,\n  DEFAULT_FORMAT,\n  EXACT_FORMAT,\n  exactFormat,\n  measureDefaultFormat,\n  PERCENT_FORMAT,\n  percentFormat,\n  SeriesFormat,\n  seriesFormatter,\n  SeriesFormatType\n} from \"../../../common/models/series/series-format\";\nimport { concatTruthy, Unary } from \"../../../common/utils/functional/functional\";\nimport { STRINGS } from \"../../config/constants\";\nimport { StringInputWithPresets } from \"../input-with-presets/string-input-with-presets\";\n\nconst PREVIEW_VALUE = 23667.25431;\n\ninterface FormatPickerProps {\n  measure: ClientMeasure;\n  format: SeriesFormat;\n  formatChange: Unary<SeriesFormat, void>;\n}\n\nfunction readFormat(format: string, measureFormat: string): SeriesFormat {\n  switch (format) {\n    case measureFormat:\n      return DEFAULT_FORMAT;\n    case exactFormat:\n      return EXACT_FORMAT;\n    case percentFormat:\n      return PERCENT_FORMAT;\n    default:\n      return customFormat(format);\n  }\n}\n\nfunction printFormat(format: SeriesFormat, measureFormat: string): string {\n  switch (format.type) {\n    case SeriesFormatType.DEFAULT:\n      return measureFormat;\n    case SeriesFormatType.EXACT:\n      return exactFormat;\n    case SeriesFormatType.PERCENT:\n      return percentFormat;\n    case SeriesFormatType.CUSTOM:\n      return format.value;\n  }\n}\n\nexport const FormatPicker: React.FunctionComponent<FormatPickerProps> = ({ format, measure, formatChange }) => {\n  const measureFormat = measure.format;\n\n  const formatPresets = concatTruthy(\n    { name: \"Default\", identity: measureFormat },\n    measureFormat !== exactFormat && { name: \"Exact\", identity: exactFormat },\n    { name: \"Percent\", identity: percentFormat }\n  );\n\n  function onFormatChange(format: string) {\n    formatChange(readFormat(format, measureFormat));\n  }\n\n  return <React.Fragment>\n    <StringInputWithPresets\n      presets={formatPresets}\n      title={STRINGS.format}\n      selected={printFormat(format, measureFormat)}\n      placeholder={`Custom format e.g. ${measureDefaultFormat}`}\n      onChange={onFormatChange} />\n    {format.type === SeriesFormatType.CUSTOM && <div className=\"format-hint\">\n      You can use custom numbro format to present measure values.\n      Please refer to the <a target=\"_blank\" className=\"documentation-link\" href=\"https://numbrojs.com/old-format.html\">numbro documentation</a>\n    </div>}\n    <div className=\"preview\">\n      <span className=\"value\">{PREVIEW_VALUE} → </span>\n      <span className=\"formatted\">{seriesFormatter(format, measure)(PREVIEW_VALUE)}</span>\n    </div>\n  </React.Fragment>;\n};\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { ArithmeticExpression, ArithmeticOperation } from \"../../../common/models/expression/concreteArithmeticOperation\";\nimport { ExpressionSeriesOperation } from \"../../../common/models/expression/expression\";\nimport { ClientMeasure, isApproximate } from \"../../../common/models/measure/measure\";\nimport { ClientMeasures, findMeasureByName } from \"../../../common/models/measure/measures\";\nimport { SeriesList } from \"../../../common/models/series-list/series-list\";\nimport { ExpressionConcreteSeries } from \"../../../common/models/series/expression-concrete-series\";\nimport { ExpressionSeries } from \"../../../common/models/series/expression-series\";\nimport { Series } from \"../../../common/models/series/series\";\nimport { SeriesFormat } from \"../../../common/models/series/series-format\";\nimport { Binary, values } from \"../../../common/utils/functional/functional\";\nimport { isTruthy } from \"../../../common/utils/general/general\";\nimport { Dropdown } from \"../dropdown/dropdown\";\nimport \"./arithmetic-series-menu.scss\";\nimport { FormatPicker } from \"./format-picker\";\n\ninterface ArithmeticOperationSeriesMenuProps {\n  measure: ClientMeasure;\n  measures: ClientMeasures;\n  seriesList: SeriesList;\n  series: ExpressionSeries;\n  initialSeries: Series;\n  onChange: Binary<ExpressionSeries, boolean, void>;\n}\n\ninterface Operation {\n  id: ArithmeticOperation;\n  label: string;\n}\n\nconst OPERATIONS: Operation[] = [{\n  id: ExpressionSeriesOperation.ADD, label: \"Add\"\n}, {\n  id: ExpressionSeriesOperation.SUBTRACT, label: \"Subtract\"\n}, {\n  id: ExpressionSeriesOperation.MULTIPLY, label: \"Multiply\"\n}, {\n  id: ExpressionSeriesOperation.DIVIDE, label: \"Divide\"\n}];\n\nconst renderOperation = (op: Operation): string => op.label;\n\nconst renderMeasure = (m: ClientMeasure): string => m.title;\nconst renderSelectedMeasure = (m: ClientMeasure): string => m ? m.title : \"Select measure\";\n\nfunction expressionSeriesTitle(series: ExpressionSeries, measure: ClientMeasure, measures: ClientMeasures): string {\n  const concreteSeries = new ExpressionConcreteSeries(series, measure, measures);\n  return concreteSeries.title();\n}\n\nexport const ArithmeticSeriesMenu: React.FunctionComponent<ArithmeticOperationSeriesMenuProps> = props => {\n  const { measure, measures, initialSeries, series, seriesList, onChange } = props;\n\n  function isSeriesValid({ expression }: ExpressionSeries): boolean {\n    return expression instanceof ArithmeticExpression && isTruthy(expression.reference);\n  }\n\n  function onSeriesChange(series: ExpressionSeries) {\n    onChange(series, isSeriesValid(series));\n  }\n\n  function onFormatChange(format: SeriesFormat) {\n    onSeriesChange(series.set(\"format\", format));\n  }\n\n  function onOperationSelect({ id }: Operation) {\n    onSeriesChange(series.setIn([\"expression\", \"operation\"], id));\n  }\n\n  function onOperandSelect({ name }: ClientMeasure) {\n    onSeriesChange(series.setIn([\"expression\", \"reference\"], name));\n  }\n\n  const otherSeries = seriesList.removeSeries(initialSeries);\n  const duplicate = otherSeries.getSeriesWithKey(series.key());\n  const expression = series.expression as ArithmeticExpression;\n  const operation = OPERATIONS.find(op => op.id === expression.operation);\n  const operand = findMeasureByName(measures, expression.reference);\n  const items = values(measures.byName).filter(m => m.name !== measure.name && !isApproximate(m));\n\n  return <React.Fragment>\n    <div className=\"operation-select__title\">Select operation</div>\n    <Dropdown<Operation>\n      className=\"operation-select\"\n      items={OPERATIONS}\n      renderItem={renderOperation}\n      equal={(a, b) => a.id === b.id}\n      selectedItem={operation}\n      onSelect={onOperationSelect}\n    />\n    <div className=\"operand-select__title\">Select measure</div>\n    <Dropdown<ClientMeasure>\n      className=\"operand-select\"\n      items={items}\n      renderItem={renderMeasure}\n      renderSelectedItem={renderSelectedMeasure}\n      equal={(a, b) => a.name === b.name}\n      selectedItem={operand}\n      onSelect={onOperandSelect}\n    />\n    {duplicate &&\n    <div className=\"arithmetic-operation-warning\">\n      \"{expressionSeriesTitle(duplicate as ExpressionSeries, measure, measures)}\" is already defined\n    </div>}\n    <FormatPicker\n      measure={measure}\n      format={series.format}\n      formatChange={onFormatChange}\n    />\n  </React.Fragment>;\n};\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Measure } from \"../../../common/models/measure/measure\";\nimport { MeasureSeries } from \"../../../common/models/series/measure-series\";\nimport { SeriesFormat } from \"../../../common/models/series/series-format\";\nimport { Binary } from \"../../../common/utils/functional/functional\";\nimport { FormatPicker } from \"./format-picker\";\n\ninterface MeasureSeriesMenuProps {\n  measure: Measure;\n  series: MeasureSeries;\n  onChange: Binary<MeasureSeries, boolean, void>;\n}\n\nexport const MeasureSeriesMenu: React.FunctionComponent<MeasureSeriesMenuProps> = ({ measure, series, onChange }) => {\n\n  function onFormatChange(format: SeriesFormat) {\n    onChange(series.set(\"format\", format), true);\n  }\n\n  return <React.Fragment>\n    <FormatPicker\n      measure={measure}\n      format={series.format}\n      formatChange={onFormatChange}\n    />\n  </React.Fragment>;\n};\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { ExpressionSeriesOperation } from \"../../../common/models/expression/expression\";\nimport { PercentExpression, PercentOperation } from \"../../../common/models/expression/percent\";\nimport { Measure } from \"../../../common/models/measure/measure\";\nimport { SeriesList } from \"../../../common/models/series-list/series-list\";\nimport { ExpressionSeries } from \"../../../common/models/series/expression-series\";\nimport { SeriesFormat } from \"../../../common/models/series/series-format\";\nimport { Binary } from \"../../../common/utils/functional/functional\";\nimport { Dropdown } from \"../dropdown/dropdown\";\nimport { FormatPicker } from \"./format-picker\";\nimport \"./percent-series-menu.scss\";\n\ninterface PercentSeriesMenuProps {\n  measure: Measure;\n  series: ExpressionSeries;\n  seriesList: SeriesList;\n  onChange: Binary<ExpressionSeries, boolean, void>;\n}\n\ninterface Operation {\n  id: PercentOperation;\n  label: string;\n}\n\nconst OPERATIONS: Operation[] = [{\n  id: ExpressionSeriesOperation.PERCENT_OF_PARENT, label: \"Percent of parent\"\n}, {\n  id: ExpressionSeriesOperation.PERCENT_OF_TOTAL, label: \"Percent of total\"\n}];\n\nfunction operationToExpression(operation: PercentOperation): PercentExpression {\n  return new PercentExpression({ operation });\n}\n\nconst renderOperation = (op: Operation): string => op.label;\n\nexport const PercentSeriesMenu: React.FunctionComponent<PercentSeriesMenuProps> = ({ series, seriesList, measure, onChange }) => {\n\n  const selectedOperations = seriesList\n    .getExpressionSeriesFor(measure.name)\n    .filter(s => !s.equals(series))\n    .filter(s => s.expression instanceof PercentExpression)\n    .map((s: ExpressionSeries) => s.expression.operation)\n    .toSet();\n\n  function isSeriesValid(series: ExpressionSeries): boolean {\n    return series.expression instanceof PercentExpression;\n  }\n\n  function onSeriesChange(series: ExpressionSeries) {\n    onChange(series, isSeriesValid(series));\n  }\n\n  function onFormatChange(format: SeriesFormat) {\n    onSeriesChange(series.set(\"format\", format));\n  }\n\n  function onOperationSelect({ id }: Operation) {\n    onSeriesChange(series.set(\"expression\", operationToExpression(id)));\n  }\n\n  return <React.Fragment>\n    <Dropdown<Operation>\n      className=\"percent-operation-picker\"\n      items={OPERATIONS.filter(({ id }) => !selectedOperations.has(id))}\n      renderItem={renderOperation}\n      renderSelectedItem={renderOperation}\n      equal={(a, b) => a.id === b.id}\n      selectedItem={series.expression && OPERATIONS.find(op => op.id === series.expression.operation)}\n      onSelect={onOperationSelect}\n    />\n    <FormatPicker\n      measure={measure}\n      format={series.format}\n      formatChange={onFormatChange}\n    />\n  </React.Fragment>;\n};\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Omit } from \"../../../common/utils/functional/functional\";\nimport { InputWithPresets, InputWithPresetsProps } from \"../input-with-presets/input-with-presets\";\n\ntype QuantilePickerProps = Omit<InputWithPresetsProps<number>, \"parseCustomValue\" | \"formatCustomValue\">;\n\nfunction parse(s: string): number {\n  const n = parseFloat(s);\n  return isNaN(n) ? 0 : n;\n}\n\nfunction format(n: number): string {\n  return n.toString();\n}\n\nexport const QuantilePicker: React.FunctionComponent<QuantilePickerProps> = props =>\n  <InputWithPresets<number> {...props} parseCustomValue={parse} formatCustomValue={format} />;\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Measure } from \"../../../common/models/measure/measure\";\nimport { SeriesList } from \"../../../common/models/series-list/series-list\";\nimport { QuantileSeries } from \"../../../common/models/series/quantile-series\";\nimport { Series } from \"../../../common/models/series/series\";\nimport { SeriesFormat } from \"../../../common/models/series/series-format\";\nimport { Binary } from \"../../../common/utils/functional/functional\";\nimport { Preset } from \"../input-with-presets/input-with-presets\";\nimport { FormatPicker } from \"./format-picker\";\nimport { QuantilePicker } from \"./quantile-picker\";\nimport \"./quantile-series-menu.scss\";\n\ninterface QuantileSeriesMenuProps {\n  measure: Measure;\n  initialSeries: Series;\n  series: QuantileSeries;\n  seriesList: SeriesList;\n  onChange: Binary<QuantileSeries, boolean, void>;\n}\n\nconst percentiles: Array<Preset<number>> = [\n  { identity: 50, name: \"50\" },\n  { identity: 75, name: \"75\" },\n  { identity: 90, name: \"90\" },\n  { identity: 95, name: \"95\" },\n  { identity: 99, name: \"99\" }\n];\n\nexport const QuantileSeriesMenu: React.FunctionComponent<QuantileSeriesMenuProps> = ({ seriesList, initialSeries, measure, series, onChange }) => {\n\n  const otherSeries = seriesList.removeSeries(initialSeries);\n\n  function validateSeries(series: QuantileSeries): string | null {\n    if (series.percentile <= 0 || series.percentile >= 100) {\n      return \"Percentile must be a number greater than 0 and lower than 100\";\n    }\n    if (otherSeries.hasSeriesWithKey(series.key())) {\n      return \"This percentile is already define for this measure\";\n    }\n    return null;\n  }\n\n  function isSeriesValid(series: QuantileSeries) {\n    return validateSeries(series) === null;\n  }\n\n  function onSeriesChange(series: QuantileSeries) {\n    onChange(series, isSeriesValid(series));\n  }\n\n  function onFormatChange(format: SeriesFormat) {\n    onSeriesChange(series.set(\"format\", format));\n  }\n\n  function onPercentileChange(percentile: number) {\n    onSeriesChange(series.set(\"percentile\", percentile));\n  }\n\n  const error = validateSeries(series);\n\n  return <React.Fragment>\n    <div className=\"percentile-picker\">\n      <QuantilePicker\n        title=\"Percentile\"\n        placeholder=\"Type percentile e.g. 55\"\n        selected={series.percentile}\n        presets={percentiles}\n        errorMessage={error}\n        onChange={onPercentileChange} />\n    </div>\n    <FormatPicker\n      measure={measure}\n      format={series.format}\n      formatChange={onFormatChange}\n    />\n  </React.Fragment>;\n};\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { ArithmeticExpression } from \"../../../common/models/expression/concreteArithmeticOperation\";\nimport { PercentExpression } from \"../../../common/models/expression/percent\";\nimport { Measure } from \"../../../common/models/measure/measure\";\nimport { Measures } from \"../../../common/models/measure/measures\";\nimport { SeriesList } from \"../../../common/models/series-list/series-list\";\nimport { ExpressionSeries } from \"../../../common/models/series/expression-series\";\nimport { MeasureSeries } from \"../../../common/models/series/measure-series\";\nimport { QuantileSeries } from \"../../../common/models/series/quantile-series\";\nimport { Series } from \"../../../common/models/series/series\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { Fn, isTruthy } from \"../../../common/utils/general/general\";\nimport { STRINGS } from \"../../config/constants\";\nimport { enterKey } from \"../../utils/dom/dom\";\nimport { BubbleMenu } from \"../bubble-menu/bubble-menu\";\nimport { Button } from \"../button/button\";\nimport { ArithmeticSeriesMenu } from \"./arithmetic-series-menu\";\nimport { MeasureSeriesMenu } from \"./measure-series-menu\";\nimport { PercentSeriesMenu } from \"./percent-series-menu\";\nimport { QuantileSeriesMenu } from \"./quantile-series-menu\";\nimport \"./series-menu.scss\";\n\ninterface SeriesMenuProps {\n  saveSeries: Unary<Series, void>;\n  measure: Measure;\n  measures: Measures;\n  seriesList: SeriesList;\n  containerStage: Stage;\n  onClose: Fn;\n  initialSeries: Series;\n  openOn: Element;\n}\n\ninterface SeriesMenuState {\n  series: Series;\n  isValid: boolean;\n}\n\nexport class SeriesMenu extends React.Component<SeriesMenuProps, SeriesMenuState> {\n\n  state: SeriesMenuState = { series: this.props.initialSeries, isValid: true };\n\n  componentDidMount() {\n    window.addEventListener(\"keydown\", this.globalKeyDownListener);\n  }\n\n  componentWillUnmount() {\n    window.removeEventListener(\"keydown\", this.globalKeyDownListener);\n  }\n\n  globalKeyDownListener = (e: KeyboardEvent) => enterKey(e) && this.onOkClick();\n\n  saveSeries = (series: Series, isValid: boolean) => this.setState({ series, isValid });\n\n  onCancelClick = () => this.props.onClose();\n\n  onOkClick = () => {\n    if (!this.validate()) return;\n    const { saveSeries, onClose } = this.props;\n    const { series } = this.state;\n    saveSeries(series);\n    onClose();\n  };\n\n  validate(): boolean {\n    const { isValid, series } = this.state;\n    const { initialSeries, seriesList } = this.props;\n    const isModified = !initialSeries.equals(series);\n    const otherSeries = seriesList.series.filter(s => !s.equals(initialSeries));\n    const isUnique = !isTruthy(otherSeries.find(s => s.key() === series.key()));\n    return isValid && isModified && isUnique;\n  }\n\n  render() {\n    const { measure, measures, initialSeries, seriesList, containerStage, onClose, openOn } = this.props;\n    const { series } = this.state;\n\n    return <BubbleMenu\n      className=\"series-menu\"\n      direction=\"down\"\n      containerStage={containerStage}\n      stage={Stage.fromSize(250, 240)}\n      openOn={openOn}\n      onClose={onClose}\n    >\n      {series instanceof MeasureSeries && <MeasureSeriesMenu\n        series={series}\n        measure={measure}\n        onChange={this.saveSeries}\n      />}\n      {series instanceof ExpressionSeries && series.expression instanceof PercentExpression && <PercentSeriesMenu\n        seriesList={seriesList}\n        series={series}\n        measure={measure}\n        onChange={this.saveSeries}\n      />}\n      {series instanceof ExpressionSeries && series.expression instanceof ArithmeticExpression && <ArithmeticSeriesMenu\n        seriesList={seriesList}\n        series={series}\n        initialSeries={initialSeries}\n        measure={measure}\n        measures={measures}\n        onChange={this.saveSeries}\n      />}\n      {series instanceof QuantileSeries && <QuantileSeriesMenu\n        seriesList={seriesList}\n        measure={measure}\n        onChange={this.saveSeries}\n        initialSeries={initialSeries}\n        series={series}\n      />}\n      <div className=\"button-bar\">\n        <Button className=\"ok\" type=\"primary\" disabled={!this.validate()} onClick={this.onOkClick} title={STRINGS.ok} />\n        <Button type=\"secondary\" onClick={this.onCancelClick} title={STRINGS.cancel} />\n      </div>\n    </BubbleMenu>;\n  }\n}\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Measure } from \"../../../common/models/measure/measure\";\nimport { Measures } from \"../../../common/models/measure/measures\";\nimport { SeriesList } from \"../../../common/models/series-list/series-list\";\nimport { Series } from \"../../../common/models/series/series\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { SeriesMenu } from \"../series-menu/series-menu\";\nimport { WithRef } from \"../with-ref/with-ref\";\n\ninterface PlaceholderSeriesTileProps {\n  measure: Measure;\n  measures: Measures;\n  seriesList: SeriesList;\n  series: Series;\n  style?: React.CSSProperties;\n  containerStage: Stage;\n  saveSeries: Unary<Series, void>;\n  closeItem: Fn;\n}\n\nexport const PlaceholderSeriesTile: React.FunctionComponent<PlaceholderSeriesTileProps> = props => {\n  const { series, measures, seriesList, containerStage, saveSeries, closeItem, style, measure } = props;\n  return <WithRef>\n    {({ ref: openOn, setRef }) => <div\n      className=\"tile measure\"\n      ref={setRef}\n      style={style}>\n      <div className=\"reading\">{measure.title}</div>\n      {openOn && <SeriesMenu\n        key=\"placeholder-series\"\n        measures={measures}\n        seriesList={seriesList}\n        openOn={openOn}\n        containerStage={containerStage}\n        onClose={closeItem}\n        initialSeries={series}\n        measure={measure}\n        saveSeries={saveSeries} />}\n    </div>}\n  </WithRef>;\n};\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Measures } from \"../../../common/models/measure/measures\";\nimport { SeriesList } from \"../../../common/models/series-list/series-list\";\nimport { ConcreteSeries } from \"../../../common/models/series/concrete-series\";\nimport { Series } from \"../../../common/models/series/series\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Binary, Ternary, Unary } from \"../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { SeriesMenu } from \"../series-menu/series-menu\";\nimport { SvgIcon } from \"../svg-icon/svg-icon\";\nimport { WithRef } from \"../with-ref/with-ref\";\n\ninterface SeriesTileProps {\n  item: ConcreteSeries;\n  open: boolean;\n  seriesList: SeriesList;\n  measures: Measures;\n  style?: React.CSSProperties;\n  removeSeries: Unary<Series, void>;\n  updateSeries: Binary<Series, Series, void>;\n  openSeriesMenu: Unary<Series, void>;\n  closeSeriesMenu: Fn;\n  dragStart: Ternary<string, Series, React.DragEvent<HTMLElement>, void>;\n  containerStage: Stage;\n}\n\nexport const SeriesTile: React.FunctionComponent<SeriesTileProps> = props => {\n  const { seriesList, measures, open, item, style, updateSeries, removeSeries, openSeriesMenu, closeSeriesMenu, dragStart, containerStage } = props;\n  const { definition, measure } = item;\n  const title = item.title();\n\n  const saveSeries = (newSeries: Series) => updateSeries(definition, newSeries);\n  const remove = (e: React.MouseEvent<HTMLElement>) => {\n    e.stopPropagation();\n    removeSeries(definition);\n  };\n\n  return <WithRef>\n    {({ ref: openOn, setRef }) => <React.Fragment>\n      <div\n        className=\"tile measure\"\n        draggable={true}\n        ref={setRef}\n        onClick={() => openSeriesMenu(definition)}\n        onDragStart={e => dragStart(measure.title, definition, e)}\n        style={style}\n        title={title}\n      >\n        <div className=\"reading\">{title}</div>\n        <div className=\"remove\" onClick={remove}>\n          <SvgIcon svg={require(\"../../icons/x.svg\")} />\n        </div>\n      </div>\n      {open && openOn && <SeriesMenu\n        key={definition.key()}\n        openOn={openOn}\n        seriesList={seriesList}\n        measures={measures}\n        containerStage={containerStage}\n        onClose={closeSeriesMenu}\n        initialSeries={definition}\n        measure={measure}\n        saveSeries={saveSeries} />}\n    </React.Fragment>}\n  </WithRef>;\n};\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { ReactElement } from \"react\";\nimport { Essence } from \"../../../common/models/essence/essence\";\nimport { findMeasureByName } from \"../../../common/models/measure/measures\";\nimport { Series } from \"../../../common/models/series/series\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { insert } from \"../../../common/utils/array/array\";\nimport { Binary, Ternary, Unary } from \"../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { transformStyle } from \"../../utils/dom/dom\";\nimport { SECTION_WIDTH } from \"../../utils/pill-tile/pill-tile\";\nimport { PartialSeries } from \"../../views/cube-view/partial-tiles-provider\";\nimport { TileOverflowContainer } from \"../tile-overflow-container/tile-overflow-container\";\nimport { PlaceholderSeriesTile } from \"./placeholder-series\";\nimport { SeriesTile } from \"./series-tile\";\n\ninterface SeriesTilesProps {\n  menuStage: Stage;\n  maxItems: number;\n  essence: Essence;\n  removeSeries: Unary<Series, void>;\n  updateSeries: Binary<Series, Series, void>;\n  openedSeriesMenu?: Series;\n  openSeriesMenu: Unary<Series, void>;\n  closeSeriesMenu: Fn;\n  dragStart: Ternary<string, Series, React.DragEvent<HTMLElement>, void>;\n  partialSeries?: PartialSeries;\n  removePlaceholderSeries: Fn;\n  savePlaceholderSeries: Unary<Series, void>;\n  overflowOpen: boolean;\n  closeOverflowMenu: Fn;\n  openOverflowMenu: Fn;\n}\n\nexport const SeriesTiles: React.FunctionComponent<SeriesTilesProps> = props => {\n  const {\n    openedSeriesMenu,\n    menuStage,\n    removeSeries,\n    dragStart,\n    closeSeriesMenu,\n    updateSeries,\n    removePlaceholderSeries,\n    savePlaceholderSeries,\n    openOverflowMenu,\n    closeOverflowMenu,\n    essence,\n    openSeriesMenu,\n    overflowOpen,\n    partialSeries,\n    maxItems\n  } = props;\n\n  const series = essence.getConcreteSeries().toArray();\n\n  const seriesTiles = series.map(item => <SeriesTile\n    seriesList={essence.series}\n    measures={essence.dataCube.measures}\n    key={item.definition.key()}\n    item={item}\n    open={item.definition.equals(openedSeriesMenu)}\n    closeSeriesMenu={closeSeriesMenu}\n    removeSeries={removeSeries}\n    dragStart={dragStart}\n    containerStage={menuStage}\n    openSeriesMenu={openSeriesMenu}\n    updateSeries={updateSeries} />);\n\n  function insertPlaceholder<T>(tiles: Array<ReactElement<T>>): Array<ReactElement<T>> {\n    if (!partialSeries) return tiles;\n    const { series, position } = partialSeries;\n    const measure = findMeasureByName(essence.dataCube.measures, series.reference);\n\n    const placeholderTile = <PlaceholderSeriesTile\n      key=\"placeholder-series-tile\"\n      measure={measure}\n      seriesList={essence.series}\n      measures={essence.dataCube.measures}\n      series={series}\n      containerStage={menuStage}\n      saveSeries={savePlaceholderSeries}\n      closeItem={removePlaceholderSeries} />;\n\n    return insert(tiles, position.getIndex(), placeholderTile);\n  }\n\n  const tilesWithPlaceholder = insertPlaceholder(seriesTiles);\n\n  const visibleItems = tilesWithPlaceholder\n    .slice(0, maxItems)\n    .map((element, idx) => React.cloneElement(element, { style: transformStyle(idx * SECTION_WIDTH, 0) }));\n  const overflowItems = tilesWithPlaceholder.slice(maxItems);\n\n  if (overflowItems.length <= 0) return <React.Fragment>{visibleItems}</React.Fragment>;\n\n  const anyOverflowItemOpen = series.slice(maxItems).some(({ definition }) => definition.equals(openedSeriesMenu));\n  const isDummySeriesInOverflow = overflowItems.some(element => element.type === PlaceholderSeriesTile);\n  const overflowOpened = overflowOpen || anyOverflowItemOpen || isDummySeriesInOverflow;\n\n  const seriesItemOverflow = <TileOverflowContainer\n    key=\"overflow-menu\"\n    items={overflowItems}\n    open={overflowOpened}\n    openOverflowMenu={openOverflowMenu}\n    x={visibleItems.length * SECTION_WIDTH}\n    closeOverflowMenu={closeOverflowMenu}\n    className=\"measure\" />;\n\n  return <React.Fragment>\n    {[...visibleItems, seriesItemOverflow]}\n  </React.Fragment>;\n};\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { DragPosition } from \"../../../common/models/drag-position/drag-position\";\nimport { Measure } from \"../../../common/models/measure/measure\";\nimport { MeasureSeries } from \"../../../common/models/series/measure-series\";\nimport { QuantileSeries } from \"../../../common/models/series/quantile-series\";\nimport { fromMeasure, Series } from \"../../../common/models/series/series\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Binary } from \"../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { CORE_ITEM_GAP, CORE_ITEM_WIDTH, STRINGS } from \"../../config/constants\";\nimport { getXFromEvent, setDragData, setDragGhost } from \"../../utils/dom/dom\";\nimport { DragManager } from \"../../utils/drag-manager/drag-manager\";\nimport { getMaxItems } from \"../../utils/pill-tile/pill-tile\";\nimport { CubeContext, CubeContextValue } from \"../../views/cube-view/cube-context\";\nimport { PartialSeries } from \"../../views/cube-view/partial-tiles-provider\";\nimport { DragIndicator } from \"../drag-indicator/drag-indicator\";\nimport { AddSeries } from \"./add-series\";\nimport { SeriesTiles } from \"./series-tiles\";\n\ninterface SeriesTilesRowProps {\n  menuStage: Stage;\n  partialSeries: PartialSeries | null;\n  addPartialSeries: Binary<Series, DragPosition, void>;\n  removePartialSeries: Fn;\n}\n\ninterface SeriesTilesRowState {\n  dragPosition?: DragPosition;\n  openedSeries?: Series;\n  overflowOpen?: boolean;\n}\n\nexport class SeriesTilesRow extends React.Component<SeriesTilesRowProps, SeriesTilesRowState> {\n  static contextType = CubeContext;\n  context: CubeContextValue;\n\n  state: SeriesTilesRowState = {};\n  private items = React.createRef<HTMLDivElement>();\n\n  private maxItems(): number {\n    const { essence: { series } } = this.context;\n    const { menuStage } = this.props;\n    return menuStage && getMaxItems(menuStage.width, series.count());\n  }\n\n  openSeriesMenu = (series: Series) => this.setState({ openedSeries: series });\n\n  closeSeriesMenu = () => this.setState({ openedSeries: null });\n\n  openOverflowMenu = () => this.setState({ overflowOpen: true });\n\n  closeOverflowMenu = () => this.setState({ overflowOpen: false });\n\n  updateSeries = (oldSeries: Series, series: Series) => {\n    const { essence, clicker } = this.context;\n    clicker.changeSeriesList(essence.series.replaceSeries(oldSeries, series));\n  };\n\n  savePlaceholderSeries = (series: Series) => {\n    const { removePartialSeries } = this.props;\n    const { clicker } = this.context;\n    clicker.addSeries(series);\n    removePartialSeries();\n  };\n\n  removeSeries = (series: Series) => {\n    const { clicker } = this.context;\n    clicker.removeSeries(series);\n    this.closeOverflowMenu();\n  };\n\n  canDrop(): boolean {\n    const { essence: { series: seriesList } } = this.context;\n    const measure = DragManager.draggingMeasure();\n    if (measure) return !seriesList.hasMeasure(measure);\n    return DragManager.isDraggingSeries();\n  }\n\n  dragStart = (label: string, series: Series, e: React.DragEvent<HTMLElement>) => {\n    const dataTransfer = e.dataTransfer;\n    dataTransfer.effectAllowed = \"all\";\n    setDragData(dataTransfer, \"text/plain\", label);\n\n    DragManager.setDragSeries(series);\n    setDragGhost(dataTransfer, label);\n\n    this.closeOverflowMenu();\n  };\n\n  calculateDragPosition(e: React.DragEvent<HTMLElement>): DragPosition {\n    const { essence } = this.context;\n    const numItems = essence.series.count();\n    const rect = this.items.current.getBoundingClientRect();\n    const x = getXFromEvent(e);\n    const offset = x - rect.left;\n    const position = DragPosition.calculateFromOffset(offset, numItems, CORE_ITEM_WIDTH, CORE_ITEM_GAP);\n    if (position.replace === this.maxItems()) {\n      return DragPosition.insertAt(position.replace);\n    }\n    return position;\n  }\n\n  dragEnter = (e: React.DragEvent<HTMLElement>) => {\n    if (!this.canDrop()) return;\n    e.preventDefault();\n    this.setState({\n      dragPosition: this.calculateDragPosition(e)\n    });\n  };\n\n  dragOver = (e: React.DragEvent<HTMLElement>) => {\n    if (!this.canDrop()) return;\n    e.preventDefault();\n    const dragPosition = this.calculateDragPosition(e);\n    if (dragPosition.equals(this.state.dragPosition)) return;\n    this.setState({ dragPosition });\n  };\n\n  dragLeave = () => {\n    if (!this.canDrop()) return;\n    this.setState({\n      dragPosition: null\n    });\n  };\n\n  drop = (e: React.DragEvent<HTMLElement>) => {\n    if (!this.canDrop()) return;\n    e.preventDefault();\n    this.setState({ dragPosition: null });\n\n    if (DragManager.isDraggingSeries()) {\n      this.rearrangeSeries(DragManager.draggingSeries(), this.calculateDragPosition(e));\n    } else {\n      this.dropNewSeries(fromMeasure(DragManager.draggingMeasure()), this.calculateDragPosition(e));\n    }\n  };\n\n  private dropNewSeries(newSeries: Series, dragPosition: DragPosition) {\n    const { addPartialSeries } = this.props;\n    const { clicker, essence: { series } } = this.context;\n    const isDuplicateQuantile = newSeries instanceof QuantileSeries && series.hasSeries(newSeries);\n    if (isDuplicateQuantile) {\n      if (dragPosition.isReplace()) {\n        clicker.removeSeries(series.series.get(dragPosition.replace));\n        addPartialSeries(newSeries, dragPosition);\n      } else {\n        addPartialSeries(newSeries, dragPosition);\n      }\n    } else {\n      this.rearrangeSeries(newSeries, dragPosition);\n    }\n  }\n\n  private rearrangeSeries(series: Series, dragPosition: DragPosition) {\n    const { clicker, essence } = this.context;\n\n    if (dragPosition.isReplace()) {\n      clicker.changeSeriesList(essence.series.replaceByIndex(dragPosition.replace, series));\n    } else {\n      clicker.changeSeriesList(essence.series.insertByIndex(dragPosition.insert, series));\n    }\n  }\n\n  appendMeasureSeries = (measure: Measure) => {\n    const { addPartialSeries } = this.props;\n    const { clicker, essence } = this.context;\n    const series = fromMeasure(measure);\n    const isMeasureSeries = series instanceof MeasureSeries;\n    const isUniqueQuantile = series instanceof QuantileSeries && !this.context.essence.series.hasSeries(series);\n    if (isMeasureSeries || isUniqueQuantile) {\n      clicker.addSeries(series);\n    } else {\n      addPartialSeries(series, DragPosition.insertAt(essence.series.count()));\n    }\n  };\n\n  render() {\n    const { dragPosition, openedSeries, overflowOpen } = this.state;\n    const { essence } = this.context;\n    const { menuStage, removePartialSeries, partialSeries } = this.props;\n    return <div className=\"tile-row series-tile-row\" onDragEnter={this.dragEnter}>\n      <div className=\"title\">{STRINGS.series}</div>\n      <div className=\"items\" ref={this.items}>\n        <SeriesTiles\n          menuStage={menuStage}\n          partialSeries={partialSeries}\n          maxItems={this.maxItems()}\n          essence={essence}\n          removeSeries={this.removeSeries}\n          updateSeries={this.updateSeries}\n          openSeriesMenu={this.openSeriesMenu}\n          closeSeriesMenu={this.closeSeriesMenu}\n          dragStart={this.dragStart}\n          removePlaceholderSeries={removePartialSeries}\n          savePlaceholderSeries={this.savePlaceholderSeries}\n          overflowOpen={overflowOpen}\n          closeOverflowMenu={this.closeOverflowMenu}\n          openOverflowMenu={this.openOverflowMenu}\n          openedSeriesMenu={openedSeries} />\n      </div>\n      <AddSeries menuStage={menuStage} essence={essence} appendMeasureSeries={this.appendMeasureSeries} />\n      <DragIndicator dragOver={this.dragOver} dragLeave={this.dragLeave} drop={this.drop} dragPosition={dragPosition} />\n    </div>;\n  }\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Visualization } from \"../../common/models/visualization-manifest/visualization-manifest\";\nimport { LineChartSettingsComponent } from \"./line-chart/line-chart-settings\";\nimport { ScatterplotSettingsComponent } from \"./scatterplot/scatterplot-settings\";\nimport { TableSettingsComponent } from \"./table/table-settings\";\n\ninterface SettingsComponents {\n  \"table\": typeof TableSettingsComponent;\n  \"bar-chart\": null;\n  \"line-chart\": typeof LineChartSettingsComponent;\n  \"heatmap\": null;\n  \"grid\": null;\n  \"totals\": null;\n  \"scatterplot\": typeof ScatterplotSettingsComponent;\n}\n\nconst Components: SettingsComponents = {\n  \"bar-chart\": null,\n  \"line-chart\": LineChartSettingsComponent,\n  \"heatmap\": null,\n  \"grid\": null,\n  \"totals\": null,\n  \"table\": TableSettingsComponent,\n  \"scatterplot\": ScatterplotSettingsComponent\n};\n\nexport function settingsComponent<T extends Visualization>(visualization: T): SettingsComponents[T] {\n  return Components[visualization];\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { VisualizationSettingsComponent } from \"../../../common/models/visualization-settings/visualization-settings\";\nimport { LineChartSettings } from \"../../../common/visualization-manifests/line-chart/settings\";\nimport { Checkbox } from \"../../components/checkbox/checkbox\";\n\nexport const LineChartSettingsComponent: VisualizationSettingsComponent<LineChartSettings> = ({ settings, onChange }) => {\n  const toggleGroupSeries = () => onChange(settings.update(\"groupSeries\", groupSeries => !groupSeries));\n  return <div className=\"settings-row\">\n    <Checkbox\n      selected={settings.groupSeries}\n      label=\"Group series\"\n      onClick={toggleGroupSeries} />\n  </div>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { VisualizationSettingsComponent } from \"../../../common/models/visualization-settings/visualization-settings\";\nimport { TableSettings } from \"../../../common/visualization-manifests/table/settings\";\nimport { Checkbox } from \"../../components/checkbox/checkbox\";\n\nexport const TableSettingsComponent: VisualizationSettingsComponent<TableSettings> = ({ settings, onChange }) => {\n  const toggleCollapseRows = () => onChange(settings.update(\"collapseRows\", collapse => !collapse));\n  return <div className=\"settings-row\">\n    <Checkbox\n      selected={settings.collapseRows}\n      label=\"Collapse rows\"\n      onClick={toggleCollapseRows} />\n  </div>;\n};\n","/*\n * Copyright 2017-2022 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { VisualizationSettingsComponent } from \"../../../common/models/visualization-settings/visualization-settings\";\nimport { ScatterplotSettings } from \"../../../common/visualization-manifests/scatterplot/settings\";\nimport { Checkbox } from \"../../components/checkbox/checkbox\";\nexport const ScatterplotSettingsComponent: VisualizationSettingsComponent<ScatterplotSettings> = props => {\n  const { settings, onChange } = props;\n  const toggleSummary = () => onChange(settings.update(\"showSummary\", showSummary => !showSummary));\n  return <div className=\"settings-row\">\n    <Checkbox\n      selected={settings.showSummary}\n      label=\"Show heatmap summary\"\n      onClick={toggleSummary} />\n  </div>;\n};\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { VisualizationManifest } from \"../../../common/models/visualization-manifest/visualization-manifest\";\nimport { VisualizationSettings } from \"../../../common/models/visualization-settings/visualization-settings\";\nimport { Binary, Unary } from \"../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { ImmutableRecord } from \"../../../common/utils/immutable-utils/immutable-utils\";\nimport { MANIFESTS } from \"../../../common/visualization-manifests\";\nimport { LineChartSettings } from \"../../../common/visualization-manifests/line-chart/settings\";\nimport { ScatterplotSettings } from \"../../../common/visualization-manifests/scatterplot/settings\";\nimport { TableSettings } from \"../../../common/visualization-manifests/table/settings\";\nimport { STRINGS } from \"../../config/constants\";\nimport { settingsComponent } from \"../../visualization-settings/settings-component\";\nimport { Button } from \"../button/button\";\nimport { VisSelectorItem } from \"./vis-selector-item\";\nimport \"./vis-selector-menu.scss\";\n\nexport interface VisSelectorMenuProps {\n  onSelect: Binary<VisualizationManifest, VisualizationSettings, void>;\n  initialVisualization: VisualizationManifest;\n  initialSettings: VisualizationSettings;\n  onClose: Fn;\n}\n\ninterface VisSelectorMenuState {\n  visualization: VisualizationManifest;\n  visualizationSettings: VisualizationSettings;\n}\n\nexport class VisSelectorMenu extends React.Component<VisSelectorMenuProps, VisSelectorMenuState> {\n\n  state: VisSelectorMenuState = {\n    visualization: this.props.initialVisualization,\n    visualizationSettings: this.props.initialSettings\n  };\n\n  save = () => {\n    const { onSelect, onClose } = this.props;\n    const { visualization, visualizationSettings } = this.state;\n    onSelect(visualization, visualizationSettings);\n    onClose();\n  };\n\n  close = () => this.props.onClose();\n\n  changeVisualization = (visualization: VisualizationManifest) => this.setState({ visualization, visualizationSettings: visualization.visualizationSettings.defaults });\n  changeSettings = (visualizationSettings: VisualizationSettings) => this.setState({ visualizationSettings });\n\n  renderSettings() {\n    const component = this.settingsComponent();\n    if (!component) return null;\n    return <div className=\"vis-settings\">\n      <div className=\"vis-settings-title\">Settings</div>\n      {component}\n    </div>;\n  }\n\n  settingsComponent(): JSX.Element | null {\n    const { visualization, visualizationSettings } = this.state;\n    /*\n      TODO:\n      Right now visualization and settings do not share type parameter.\n      We need to:\n        * move them together into union type indexed by visualization.name\n        * create getters for manifest in essence\n        * use switch to unpack both fields at once\n        * create mapped type acting like Visualization -> VisualizationSettings<Visualization>\n     */\n    switch (visualization.name) {\n      case \"table\":\n        const TableSettingsComponent = settingsComponent(visualization.name);\n        return <TableSettingsComponent onChange={this.changeSettings as Unary<ImmutableRecord<TableSettings>, void>}\n                                       settings={visualizationSettings as ImmutableRecord<TableSettings>} />;\n      case \"grid\":\n        return null;\n      case \"heatmap\":\n        return null;\n      case \"totals\":\n        return null;\n      case \"bar-chart\":\n        return null;\n      case \"line-chart\":\n        const LineChartSettingsComponent = settingsComponent(visualization.name);\n        return <LineChartSettingsComponent onChange={this.changeSettings as Unary<ImmutableRecord<LineChartSettings>, void>}\n                                           settings={visualizationSettings as ImmutableRecord<LineChartSettings>}/>;\n      case \"scatterplot\":\n        const ScatterplotSettingsComponent = settingsComponent(visualization.name);\n        return <ScatterplotSettingsComponent onChange={this.changeSettings as Unary<ImmutableRecord<ScatterplotSettings>, void>}\n                                             settings={visualizationSettings as ImmutableRecord<ScatterplotSettings>} />;\n    }\n  }\n\n  render() {\n    const { visualization: selected } = this.state;\n\n    return <div className=\"vis-selector-menu\">\n      <div className=\"vis-items\">\n        {MANIFESTS.map(visualization => <VisSelectorItem\n          key={visualization.name}\n          visualization={visualization}\n          selected={visualization.name === selected.name}\n          onClick={this.changeVisualization} />)}\n      </div>\n      {this.renderSettings()}\n      <div className=\"ok-cancel-bar\">\n        <Button type=\"primary\" title={STRINGS.ok} onClick={this.save} />\n        <Button type=\"secondary\" title={STRINGS.cancel} onClick={this.close} />\n      </div>\n    </div>;\n  }\n}\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Clicker } from \"../../../common/models/clicker/clicker\";\nimport { Essence } from \"../../../common/models/essence/essence\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { VisualizationManifest } from \"../../../common/models/visualization-manifest/visualization-manifest\";\nimport { VisualizationSettings } from \"../../../common/models/visualization-settings/visualization-settings\";\nimport { classNames } from \"../../utils/dom/dom\";\nimport { BubbleMenu } from \"../bubble-menu/bubble-menu\";\nimport { VisSelectorItem } from \"./vis-selector-item\";\nimport { VisSelectorMenu } from \"./vis-selector-menu\";\nimport \"./vis-selector.scss\";\n\nexport interface VisSelectorProps {\n  clicker: Clicker;\n  essence: Essence;\n}\n\nexport interface VisSelectorState {\n  openMenu: boolean;\n}\n\nconst visSelectorMenuStage = Stage.fromSize(268, 176);\n\nexport class VisSelector extends React.Component<VisSelectorProps, VisSelectorState> {\n\n  private selector = React.createRef<HTMLDivElement>();\n\n  state: VisSelectorState = { openMenu: false };\n\n  openMenu = (e: React.MouseEvent<HTMLElement>) => {\n    const { openMenu } = this.state;\n    const target = e.currentTarget;\n    if (openMenu && this.selector.current === target) {\n      this.closeMenu();\n      return;\n    }\n    this.setState({\n      openMenu: true\n    });\n  };\n\n  closeMenu = () => this.setState({ openMenu: false });\n\n  changeVisualization = (vis: VisualizationManifest, settings: VisualizationSettings) => this.props.clicker.changeVisualization(vis, settings);\n\n  renderMenu() {\n    const { openMenu } = this.state;\n\n    if (!openMenu) return null;\n    const { essence } = this.props;\n    return <BubbleMenu\n      className=\"vis-selector-menu-container\"\n      direction=\"down\"\n      stage={visSelectorMenuStage}\n      openOn={this.selector.current}\n      onClose={this.closeMenu}\n    >\n      <VisSelectorMenu\n        initialVisualization={essence.visualization}\n        initialSettings={essence.visualizationSettings}\n        onClose={this.closeMenu}\n        onSelect={this.changeVisualization} />\n    </BubbleMenu>;\n  }\n\n  render() {\n    const { essence: { visualization } } = this.props;\n    const { openMenu } = this.state;\n\n    return <React.Fragment>\n      <div\n        ref={this.selector}\n        className={classNames(\"vis-selector\", { active: openMenu })}\n        onClick={this.openMenu}>\n        <VisSelectorItem visualization={visualization} selected={true} />\n      </div>\n      {this.renderMenu()}\n    </React.Fragment>;\n  }\n}\n","/*\n * Copyright 2017-2021 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Dataset } from \"plywood\";\nimport React from \"react\";\nimport {\n  DatasetRequest,\n  DatasetRequestStatus,\n  error,\n  isError,\n  isLoaded,\n  loaded,\n  loading\n} from \"../../../common/models/dataset-request/dataset-request\";\nimport { Essence } from \"../../../common/models/essence/essence\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Timekeeper } from \"../../../common/models/timekeeper/timekeeper\";\nimport { debounceWithPromise, Unary } from \"../../../common/utils/functional/functional\";\nimport { Loader } from \"../../components/loader/loader\";\nimport { QueryError } from \"../../components/query-error/query-error\";\nimport { reportError } from \"../../utils/error-reporter/error-reporter\";\nimport { VisualizationQuery } from \"../../views/cube-view/api-context\";\nimport { DownloadableDataset, DownloadableDatasetContext } from \"../../views/cube-view/downloadable-dataset-context\";\n\ninterface DataProviderProps {\n  refreshRequestTimestamp: number;\n  essence: Essence;\n  timekeeper: Timekeeper;\n  stage: Stage;\n  query: VisualizationQuery;\n  children: Unary<Dataset, React.ReactNode>;\n}\n\ninterface DataProviderState {\n  dataset: DatasetRequest;\n}\n\nexport class DataProvider extends React.Component<DataProviderProps, DataProviderState> {\n  static contextType = DownloadableDatasetContext;\n  context: DownloadableDataset;\n\n  state: DataProviderState = { dataset: loading };\n\n  private lastQueryEssence: Essence = null;\n\n  componentDidMount() {\n    const { essence } = this.props;\n    this.loadData(essence);\n  }\n\n  componentWillUnmount() {\n    this.lastQueryEssence = null;\n    this.debouncedCallExecutor.cancel();\n  }\n\n  UNSAFE_componentWillReceiveProps(nextProps: DataProviderProps) {\n    if (this.shouldFetchData(nextProps) && this.visualisationNotResized(nextProps)) {\n      const { essence } = nextProps;\n      const hadDataLoaded = isLoaded(this.state.dataset);\n      const essenceChanged = !essence.equals(this.props.essence);\n      this.loadData(essence, hadDataLoaded && essenceChanged);\n    }\n  }\n\n  private loadData(essence: Essence, showSpinner = true) {\n    if (showSpinner) this.handleDatasetLoad(loading);\n    this.fetchData(essence)\n      .then(loadedDataset => {\n        // TODO: encode it better\n        // null is here when we get out of order request, so we just ignore it\n        if (!loadedDataset) return;\n        if (isError(loadedDataset)) {\n          this.handleDatasetLoad(loadedDataset);\n        }\n        if (isLoaded(loadedDataset)) {\n          this.handleDatasetLoad(loadedDataset);\n        }\n      });\n  }\n\n  private fetchData(essence: Essence): Promise<DatasetRequest | null> {\n    this.lastQueryEssence = essence;\n    return this.debouncedCallExecutor(essence);\n  }\n\n  private callExecutor = (essence: Essence): Promise<DatasetRequest | null> =>\n    this.props.query(essence)\n      .then((dataset: Dataset) => {\n          // signal out of order requests with null\n          if (!this.wasUsedForLastQuery(essence)) return null;\n          return loaded(dataset);\n        },\n        err => {\n          // signal out of order requests with null\n          if (!this.wasUsedForLastQuery(essence)) return null;\n          reportError(err);\n          return error(err);\n        });\n\n  private wasUsedForLastQuery(essence: Essence) {\n    return essence.equals(this.lastQueryEssence);\n  }\n\n  private debouncedCallExecutor = debounceWithPromise(this.callExecutor, 500);\n\n  private handleDatasetLoad(dataset: DatasetRequest) {\n    this.setState({ dataset });\n    const { setDataset } = this.context;\n    setDataset(isLoaded(dataset) ? dataset.dataset : null);\n  }\n\n  protected shouldFetchData(nextProps: DataProviderProps): boolean {\n    return this.differentVisualizationDefinition(nextProps);\n  }\n\n  private differentVisualizationDefinition(nextProps: DataProviderProps) {\n    const { essence, timekeeper } = this.props;\n    const nextEssence = nextProps.essence;\n    const nextTimekeeper = nextProps.timekeeper;\n    return nextEssence.differentDataCube(essence) ||\n      nextEssence.differentEffectiveFilter(essence, timekeeper, nextTimekeeper) ||\n      nextEssence.differentTimeShift(essence) ||\n      nextEssence.differentSplits(essence) ||\n      nextEssence.differentSeries(essence) ||\n      nextEssence.differentSettings(essence) ||\n      this.differentBucketingTimezone(nextEssence) ||\n      this.differentLastRefreshRequestTimestamp(nextProps);\n  }\n\n  private differentBucketingTimezone(newEssence: Essence): boolean {\n    const { essence } = this.props;\n    return !essence.timezone.equals(newEssence.timezone) && newEssence.splits.hasSplitOn(essence.getTimeDimension());\n  }\n\n  private differentLastRefreshRequestTimestamp({ refreshRequestTimestamp }: DataProviderProps): boolean {\n    return refreshRequestTimestamp !== this.props.refreshRequestTimestamp;\n  }\n\n  private visualisationNotResized(nextProps: DataProviderProps): boolean {\n    return this.props.stage.equals(nextProps.stage);\n  }\n\n  render() {\n    const { children } = this.props;\n    const { dataset } = this.state;\n    switch (dataset.status) {\n      case DatasetRequestStatus.LOADING:\n        return <Loader/>;\n      case DatasetRequestStatus.ERROR:\n        return <QueryError error={dataset.error}/>;\n      case DatasetRequestStatus.LOADED:\n        return children(dataset.dataset);\n    }\n  }\n}\n","/*\n * Copyright 2017-2021 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { ChartProps } from \"../../../../common/models/chart-props/chart-props\";\nimport { Clicker } from \"../../../../common/models/clicker/clicker\";\nimport { ClientCustomization } from \"../../../../common/models/customization/customization\";\nimport { Dimension } from \"../../../../common/models/dimension/dimension\";\nimport { DragPosition } from \"../../../../common/models/drag-position/drag-position\";\nimport { Essence } from \"../../../../common/models/essence/essence\";\nimport { Series } from \"../../../../common/models/series/series\";\nimport { Stage } from \"../../../../common/models/stage/stage\";\nimport { Timekeeper } from \"../../../../common/models/timekeeper/timekeeper\";\nimport { Binary, Omit, Unary } from \"../../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../../common/utils/general/general\";\nimport { DropIndicator } from \"../../../components/drop-indicator/drop-indicator\";\nimport { FilterTilesRow } from \"../../../components/filter-tile/filter-tiles-row\";\nimport { ManualFallback } from \"../../../components/manual-fallback/manual-fallback\";\nimport { SeriesTilesRow } from \"../../../components/series-tile/series-tiles-row\";\nimport {\n  DefaultSplitTilesRow,\n  SplitTilesRowBaseProps\n} from \"../../../components/split-tile/split-tiles-row\";\nimport { VisSelector } from \"../../../components/vis-selector/vis-selector\";\nimport VisualizationControlsLayout from \"../../../components/visualization-controls-layout/visualization-controls-layout\";\nimport { classNames } from \"../../../utils/dom/dom\";\nimport { DataProvider } from \"../../../visualizations/data-provider/data-provider\";\nimport { HighlightController } from \"../../../visualizations/highlight-controller/highlight-controller\";\nimport { ApiContext } from \"../api-context\";\nimport { PartialFilter, PartialSeries } from \"../partial-tiles-provider\";\n\nexport interface VisualizationControlsBaseProps {\n  essence: Essence;\n  clicker: Clicker;\n  stage: Stage;\n  timekeeper: Timekeeper;\n  customization: ClientCustomization;\n  addSeries: Binary<Series, DragPosition, void>;\n  addFilter: Binary<Dimension, DragPosition, void>;\n  partialSeries: PartialSeries | null;\n  partialFilter: PartialFilter | null;\n  removeTile: Fn;\n}\n\ninterface VisualizationControlsProps extends VisualizationControlsBaseProps {\n  splitTilesRow: React.ComponentType<SplitTilesRowBaseProps>;\n}\n\nexport const DefaultVisualizationControls: React.FunctionComponent<VisualizationControlsBaseProps> = props => {\n  return <VisualizationControls {...props} splitTilesRow={DefaultSplitTilesRow}/>;\n};\n\nexport const VisualizationControls: React.FunctionComponent<VisualizationControlsProps> = props => {\n  const {\n    splitTilesRow: SplitTilesRow,\n    addSeries,\n    addFilter,\n    clicker,\n    essence,\n    customization,\n    timekeeper,\n    stage,\n    partialSeries,\n    partialFilter,\n    removeTile\n  } = props;\n  return <VisualizationControlsLayout\n    tiles={\n      <>\n        <FilterTilesRow\n          locale={customization.locale}\n          timekeeper={timekeeper}\n          menuStage={stage}\n          partialFilter={partialFilter}\n          removePartialFilter={removeTile}\n          addPartialFilter={addFilter}\n        />\n        <SplitTilesRow\n          clicker={clicker}\n          essence={essence}\n          menuStage={stage}\n        />\n        <SeriesTilesRow\n          removePartialSeries={removeTile}\n          partialSeries={partialSeries}\n          menuStage={stage}\n          addPartialSeries={addSeries}/>\n      </>\n    }\n    selector={\n      <VisSelector clicker={clicker} essence={essence}/>}/>;\n};\n\ninterface ChartPanelProps {\n  essence: Essence;\n  clicker: Clicker;\n  stage: Stage;\n  chartComponent: React.ComponentType<ChartProps>;\n  timekeeper: Timekeeper;\n  lastRefreshRequestTimestamp: number;\n  dragEnter: Unary<React.DragEvent<HTMLElement>, void>;\n  dragOver: Unary<React.DragEvent<HTMLElement>, void>;\n  isDraggedOver: boolean;\n  dragLeave: Fn;\n  drop: Unary<React.DragEvent<HTMLElement>, void>;\n}\n\nexport const ChartPanel: React.FunctionComponent<ChartPanelProps> = props => {\n  const {\n    chartComponent,\n    essence,\n    clicker,\n    timekeeper,\n    lastRefreshRequestTimestamp,\n    stage,\n    isDraggedOver,\n    dragOver,\n    dragEnter,\n    dragLeave,\n    drop\n  } = props;\n  return <div\n    className=\"center-main\"\n    onDragEnter={dragEnter}\n  >\n    <div className=\"visualization\">\n      <ChartWrapper\n        chartComponent={chartComponent}\n        essence={essence}\n        clicker={clicker}\n        timekeeper={timekeeper}\n        lastRefreshRequestTimestamp={lastRefreshRequestTimestamp}\n        stage={stage}/>\n    </div>\n    {isDraggedOver && <React.Fragment>\n      <DropIndicator/>\n      <div\n        className=\"drag-mask\"\n        onDragOver={dragOver}\n        onDragLeave={dragLeave}\n        onDragExit={dragLeave}\n        onDrop={drop}\n      />\n    </React.Fragment>\n    }\n  </div>;\n};\n\ntype ChartWrapperProps = Pick<ChartPanelProps,\n  \"timekeeper\" |\n  \"essence\" |\n  \"clicker\" |\n  \"stage\" |\n  \"lastRefreshRequestTimestamp\" |\n  \"chartComponent\">;\n\nfunction ChartWrapper(props: ChartWrapperProps) {\n  const {\n    chartComponent: ChartComponent,\n    essence,\n    clicker,\n    timekeeper,\n    stage,\n    lastRefreshRequestTimestamp\n  } = props;\n  if (essence.visResolve.isManual()) {\n    return <ManualFallback clicker={clicker} essence={essence}/>;\n  }\n\n  return <HighlightController essence={essence} clicker={clicker}>\n    {highlightProps =>\n      <ApiContext.Consumer>\n        {({ visualizationQuery }) =>\n          <DataProvider\n            refreshRequestTimestamp={lastRefreshRequestTimestamp}\n            query={visualizationQuery}\n            essence={essence}\n            timekeeper={timekeeper}\n            stage={stage}>\n            {data => <div className={classNames(\"visualization-root\", essence.visualization.name)}>\n              <ChartComponent\n                data={data}\n                clicker={clicker}\n                essence={essence}\n                timekeeper={timekeeper}\n                stage={stage}\n                {...highlightProps} />\n            </div>}\n          </DataProvider>}\n      </ApiContext.Consumer>\n    }\n  </HighlightController>;\n}\n\ntype VisualizationPanelProps = ChartPanelProps & VisualizationControlsBaseProps;\nexport type VisualizationProps = Omit<VisualizationPanelProps, \"chartComponent\" | \"queryFactory\">;\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\n\ninterface WithRefProps {\n  children: Unary<{ ref?: Element, setRef: Unary<Element, void> }, JSX.Element>;\n}\n\ninterface WithRefState {\n  ref?: Element;\n}\n\nexport class WithRef extends React.Component<WithRefProps, WithRefState> {\n  state: WithRefState = {};\n\n  setRef = (ref: Element) => this.setState({ ref });\n\n  render() {\n    const setRef = this.setRef;\n    const { ref } = this.state;\n    return this.props.children({ ref, setRef });\n  }\n}\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { identity, Omit } from \"../../../common/utils/functional/functional\";\nimport { InputWithPresets, InputWithPresetsProps } from \"./input-with-presets\";\n\ntype StringInputWithPresetsProps = Omit<InputWithPresetsProps<string>, \"parseCustomValue\" | \"formatCustomValue\">;\n\nexport const StringInputWithPresets: React.FunctionComponent<StringInputWithPresetsProps> = props =>\n  <InputWithPresets<string> {...props} parseCustomValue={identity} formatCustomValue={identity} />;\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Dimension, isContinuous } from \"../../../common/models/dimension/dimension\";\nimport { ContinuousDimensionKind, formatGranularity, getGranularities, granularityToString, validateGranularity } from \"../../../common/models/granularity/granularity\";\nimport { Bucket } from \"../../../common/models/split/split\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { STRINGS } from \"../../config/constants\";\nimport { StringInputWithPresets } from \"../input-with-presets/string-input-with-presets\";\n\nexport interface GranularityPickerProps {\n  dimension: Dimension;\n  granularity: string;\n  granularityChange: Unary<string, void>;\n}\n\nexport const GranularityPicker: React.FunctionComponent<GranularityPickerProps> = ({ dimension, granularity, granularityChange }) => {\n  if (!isContinuous(dimension)) return null;\n\n  const granularities = dimension.granularities || getGranularities(dimension.kind as ContinuousDimensionKind, dimension.bucketedBy);\n  const presets = granularities.map((g: Bucket) => {\n    return {\n      name: formatGranularity(g),\n      identity: granularityToString(g)\n    };\n  });\n\n  const placeholder = dimension.kind === \"time\" ? STRINGS.floorableDurationsExamples : \"Bucket size\";\n\n  return <StringInputWithPresets\n    title={STRINGS.granularity}\n    selected={granularity}\n    errorMessage={validateGranularity(dimension.kind, granularity)}\n    onChange={granularityChange}\n    placeholder={placeholder}\n    presets={presets} />;\n};\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { STRINGS } from \"../../config/constants\";\nimport { Dropdown } from \"../dropdown/dropdown\";\n\nfunction formatLimit(limit: number): string {\n  return limit === null ? \"None\" : String(limit);\n}\n\n// TODO: Review again when fixing time split menu in #756\nfunction calculateLimits(limits: number[], includeNone: boolean) {\n  if (!includeNone) return limits;\n  return [...limits, null];\n}\n\nexport interface LimitDropdownProps {\n  selectedLimit: number;\n  limits: number[];\n  includeNone: boolean;\n  onLimitSelect: Unary<number, void>;\n}\n\nexport const LimitDropdown: React.FunctionComponent<LimitDropdownProps> = ({ onLimitSelect, limits, selectedLimit, includeNone }) => {\n  return <Dropdown<number | string>\n    label={STRINGS.limit}\n    items={calculateLimits(limits, includeNone)}\n    selectedItem={selectedLimit}\n    renderItem={formatLimit}\n    onSelect={onLimitSelect}\n  />;\n};\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { SortOn } from \"../../../common/models/sort-on/sort-on\";\nimport { Sort, SortDirection } from \"../../../common/models/sort/sort\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { STRINGS } from \"../../config/constants\";\nimport { Dropdown } from \"../dropdown/dropdown\";\nimport { SvgIcon } from \"../svg-icon/svg-icon\";\n\nexport interface SortDropdownProps {\n  direction: SortDirection;\n  selected: SortOn;\n  options: SortOn[];\n  onChange: Unary<Sort, void>;\n}\n\nexport const SortDropdown: React.FunctionComponent<SortDropdownProps> = ({ direction, options, selected, onChange }) => {\n\n  function toggleDirection() {\n    const newDirection = direction === SortDirection.descending ? SortDirection.ascending : SortDirection.descending;\n    onChange(selected.toSort(newDirection));\n  }\n\n  function selectSort(sortOn: SortOn) {\n    onChange(sortOn.toSort(direction));\n  }\n\n  return <div className=\"sort-direction\">\n    <Dropdown<SortOn>\n      label={STRINGS.sortBy}\n      items={options}\n      selectedItem={selected}\n      equal={SortOn.equals}\n      renderItem={SortOn.getTitle}\n      keyItem={SortOn.getKey}\n      onSelect={selectSort}\n    />\n    <div className={\"direction \" + direction} onClick={toggleDirection}>\n      <SvgIcon svg={require(\"../../icons/sort-arrow.svg\")} />\n    </div>\n  </div>;\n};\n","/*\n * Copyright 2017-2021 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Dimension } from \"../../../common/models/dimension/dimension\";\nimport { coerceGranularity, isGranularityValid } from \"../../../common/models/granularity/granularity\";\nimport { Sort } from \"../../../common/models/sort/sort\";\nimport { Split } from \"../../../common/models/split/split\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { STRINGS } from \"../../config/constants\";\nimport { enterKey } from \"../../utils/dom/dom\";\nimport { BubbleMenu } from \"../bubble-menu/bubble-menu\";\nimport { Button } from \"../button/button\";\n\ninterface SplitAssembly {\n  dimension: Dimension;\n  split: Split;\n  granularity?: string;\n  limit?: number;\n  sort?: Sort;\n}\n\nexport function validateSplit(splitAssembly: SplitAssembly): boolean {\n  const { granularity, split, dimension: { kind } } = splitAssembly;\n  if (!isGranularityValid(kind, granularity)) {\n    return false;\n  }\n  const newSplit = createSplit(splitAssembly);\n  return !split.equals(newSplit);\n}\n\nexport function createSplit({\n                              split: { type, reference },\n                              limit,\n                              granularity,\n                              sort,\n                              dimension: { kind }\n                            }: SplitAssembly): Split {\n  const bucket = coerceGranularity(granularity, kind);\n  return new Split({ type, reference, limit, sort, bucket });\n}\n\ninterface SplitMenuBaseProps {\n  openOn: Element;\n  containerStage: Stage;\n  onClose: Fn;\n  onSave: Fn;\n  dimension: Dimension;\n  isValid: boolean;\n}\n\nexport class SplitMenuBase extends React.Component<SplitMenuBaseProps> {\n\n  componentDidMount() {\n    window.addEventListener(\"keydown\", this.globalKeyDownListener);\n  }\n\n  componentWillUnmount() {\n    window.removeEventListener(\"keydown\", this.globalKeyDownListener);\n  }\n\n  globalKeyDownListener = (e: KeyboardEvent) => enterKey(e) && this.onOkClick();\n\n  onCancelClick = () => this.props.onClose();\n\n  onOkClick = () => {\n    const { isValid, onSave, onClose } = this.props;\n    if (!isValid) return;\n    onSave();\n    onClose();\n  };\n\n  render() {\n    const { containerStage, openOn, dimension, onClose, children, isValid } = this.props;\n    if (!dimension) return null;\n\n    return <BubbleMenu\n      className=\"split-menu\"\n      direction=\"down\"\n      containerStage={containerStage}\n      stage={Stage.fromSize(250, 240)}\n      openOn={openOn}\n      onClose={onClose}\n    >\n      {children}\n      <div className=\"button-bar\">\n        <Button className=\"ok\" type=\"primary\" disabled={!isValid} onClick={this.onOkClick} title={STRINGS.ok}/>\n        <Button type=\"secondary\" onClick={this.onCancelClick} title={STRINGS.cancel}/>\n      </div>\n    </BubbleMenu>;\n  }\n}\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Dimension } from \"../../../common/models/dimension/dimension\";\nimport { allDimensions } from \"../../../common/models/dimension/dimensions\";\nimport { Essence } from \"../../../common/models/essence/essence\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { AddTile } from \"../add-tile/add-tile\";\n\ninterface AddSplitProps {\n  appendSplit: Unary<Dimension, void>;\n  menuStage: Stage;\n  essence: Essence;\n}\n\nexport const AddSplit: React.FunctionComponent<AddSplitProps> = props => {\n  const { appendSplit, menuStage, essence: { dataCube, splits } } = props;\n  const tiles = allDimensions(dataCube.dimensions)\n    .filter(d => splits.findSplitForDimension(d) === undefined)\n    .map(dimension => {\n      return {\n        key: dimension.name,\n        label: dimension.title,\n        value: dimension\n      };\n    });\n\n  return <AddTile<Dimension>\n    containerStage={menuStage}\n    onSelect={appendSplit}\n    tiles={tiles} />;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { findDimensionByName } from \"../../../common/models/dimension/dimensions\";\nimport { Essence } from \"../../../common/models/essence/essence\";\nimport { Split } from \"../../../common/models/split/split\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Binary, Ternary, Unary } from \"../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { transformStyle } from \"../../utils/dom/dom\";\nimport { SECTION_WIDTH } from \"../../utils/pill-tile/pill-tile\";\nimport { TileOverflowContainer } from \"../tile-overflow-container/tile-overflow-container\";\nimport { SplitTileBaseProps } from \"./split-tile\";\n\ninterface SplitTilesProps {\n  essence: Essence;\n  openedSplit: Split;\n  removeSplit: Unary<Split, void>;\n  updateSplit: Binary<Split, Split, void>;\n  openMenu: Unary<Split, void>;\n  closeMenu: Fn;\n  dragStart: Ternary<string, Split, React.DragEvent<HTMLElement>, void>;\n  menuStage: Stage;\n  maxItems: number;\n  overflowOpen: boolean;\n  closeOverflowMenu: Fn;\n  openOverflowMenu: Fn;\n  splitTileComponent: React.ComponentType<SplitTileBaseProps>;\n}\n\nexport const SplitTiles: React.FunctionComponent<SplitTilesProps> = props => {\n  const {\n    splitTileComponent: SplitTile,\n    overflowOpen,\n    closeOverflowMenu,\n    openOverflowMenu,\n    essence,\n    maxItems,\n    removeSplit,\n    updateSplit,\n    openedSplit,\n    openMenu,\n    closeMenu,\n    dragStart,\n    menuStage\n  } = props;\n\n  const splits = essence.splits.splits.toArray();\n\n  const splitTiles = splits.map(split => {\n    const dimension = findDimensionByName(essence.dataCube.dimensions, split.reference);\n    return <SplitTile\n      key={split.toKey()}\n      split={split}\n      dimension={dimension}\n      removeSplit={removeSplit}\n      updateSplit={updateSplit}\n      open={split.equals(openedSplit)}\n      openMenu={openMenu}\n      closeMenu={closeMenu}\n      dragStart={dragStart}\n      containerStage={menuStage}\n      essence={essence} />;\n  });\n\n  const visibleSplits = splitTiles\n    .slice(0, maxItems)\n    .map((el, idx) => React.cloneElement(el, { style: transformStyle(idx * SECTION_WIDTH, 0) }));\n\n  const overflowSplits = splitTiles.slice(maxItems);\n\n  if (overflowSplits.length <= 0) {\n    return <React.Fragment>{visibleSplits}</React.Fragment>;\n  }\n\n  const anyOverflowTileOpen = splits.slice(maxItems).some(split => split.equals(openedSplit));\n  const overflowOpened = overflowOpen || anyOverflowTileOpen;\n\n  const splitOverflow = <TileOverflowContainer\n    className=\"dimension\"\n    key=\"overflow-menu\"\n    items={overflowSplits}\n    open={overflowOpened}\n    openOverflowMenu={openOverflowMenu}\n    closeOverflowMenu={closeOverflowMenu}\n    x={visibleSplits.length * SECTION_WIDTH} />;\n\n  return <React.Fragment>\n    {[...visibleSplits, splitOverflow]}\n  </React.Fragment>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Clicker } from \"../../../common/models/clicker/clicker\";\nimport { Dimension } from \"../../../common/models/dimension/dimension\";\nimport { findDimensionByName } from \"../../../common/models/dimension/dimensions\";\nimport { DragPosition } from \"../../../common/models/drag-position/drag-position\";\nimport { Essence, VisStrategy } from \"../../../common/models/essence/essence\";\nimport { Split } from \"../../../common/models/split/split\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { CORE_ITEM_GAP, CORE_ITEM_WIDTH, STRINGS } from \"../../config/constants\";\nimport { getXFromEvent, setDragData, setDragGhost } from \"../../utils/dom/dom\";\nimport { DraggedElementType, DragManager } from \"../../utils/drag-manager/drag-manager\";\nimport { getMaxItems } from \"../../utils/pill-tile/pill-tile\";\nimport { DragIndicator } from \"../drag-indicator/drag-indicator\";\nimport { AddSplit } from \"./add-split\";\nimport { DefaultSplitTile, SplitTileBaseProps } from \"./split-tile\";\nimport { SplitTiles } from \"./split-tiles\";\n\nexport interface SplitTilesRowBaseProps {\n  clicker: Clicker;\n  essence: Essence;\n  menuStage: Stage;\n}\n\ninterface SplitTilesRowProps extends SplitTilesRowBaseProps {\n  splitTileComponent: React.ComponentType<SplitTileBaseProps>;\n}\n\ninterface SplitTilesRowState {\n  dragPosition?: DragPosition;\n  openedSplit?: Split;\n  overflowOpen?: boolean;\n}\n\nexport const DefaultSplitTilesRow: React.FunctionComponent<SplitTilesRowBaseProps> = props =>\n  <SplitTilesRow {...props} splitTileComponent={DefaultSplitTile} />;\n\nexport class SplitTilesRow extends React.Component<SplitTilesRowProps, SplitTilesRowState> {\n  private items = React.createRef<HTMLDivElement>();\n\n  state: SplitTilesRowState = {};\n\n  private maxItems(): number {\n    const { menuStage, essence: { splits: { splits } } } = this.props;\n    return menuStage && getMaxItems(menuStage.width, splits.count());\n  }\n\n  openMenu = (split: Split) => this.setState({ openedSplit: split });\n\n  closeMenu = () => this.setState({ openedSplit: null });\n\n  openOverflowMenu = () => this.setState({ overflowOpen: true });\n\n  closeOverflowMenu = () => this.setState({ overflowOpen: false });\n\n  updateSplit = (oldSplit: Split, split: Split) => {\n    const { essence, clicker } = this.props;\n    clicker.changeSplits(essence.splits.replace(oldSplit, split), VisStrategy.UnfairGame);\n  };\n\n  removeSplit = (split: Split) => {\n    const { clicker } = this.props;\n    clicker.removeSplit(split, VisStrategy.FairGame);\n    this.closeOverflowMenu();\n  };\n\n  canDrop(): boolean {\n    const { essence: { splits, dataCube } } = this.props;\n    switch (DragManager.dragging.type) {\n      case DraggedElementType.DIMENSION:\n        return !splits.hasSplitOn(DragManager.draggingDimension());\n      case DraggedElementType.FILTER:\n        const dimension = findDimensionByName(dataCube.dimensions, DragManager.draggingFilter().reference);\n        return !splits.hasSplitOn(dimension);\n      case DraggedElementType.SPLIT:\n        return true;\n      case DraggedElementType.MEASURE:\n        return false;\n      case DraggedElementType.SERIES:\n        return false;\n      case DraggedElementType.NONE:\n        return false;\n    }\n  }\n\n  dragStart = (label: string, split: Split, e: React.DragEvent<HTMLElement>) => {\n    const dataTransfer = e.dataTransfer;\n    dataTransfer.effectAllowed = \"all\";\n    setDragData(dataTransfer, \"text/plain\", label);\n\n    DragManager.setDragSplit(split);\n    setDragGhost(dataTransfer, label);\n\n    this.closeOverflowMenu();\n  };\n\n  calculateDragPosition(e: React.DragEvent<HTMLElement>): DragPosition {\n    const { essence } = this.props;\n    const numItems = essence.splits.length();\n    const rect = this.items.current.getBoundingClientRect();\n    const x = getXFromEvent(e);\n    const offset = x - rect.left;\n    const position = DragPosition.calculateFromOffset(offset, numItems, CORE_ITEM_WIDTH, CORE_ITEM_GAP);\n    if (position.replace === this.maxItems()) {\n      return new DragPosition({ insert: position.replace });\n    }\n    return position;\n  }\n\n  dragEnter = (e: React.DragEvent<HTMLElement>) => {\n    if (!this.canDrop()) return;\n    e.preventDefault();\n    this.setState({\n      dragPosition: this.calculateDragPosition(e)\n    });\n  };\n\n  dragOver = (e: React.DragEvent<HTMLElement>) => {\n    if (!this.canDrop()) return;\n    e.preventDefault();\n    const dragPosition = this.calculateDragPosition(e);\n    if (dragPosition.equals(this.state.dragPosition)) return;\n    this.setState({ dragPosition });\n  };\n\n  dragLeave = () => {\n    if (!this.canDrop()) return;\n    this.setState({\n      dragPosition: null\n    });\n  };\n\n  draggingSplit(): Split {\n    const { essence: { dataCube } } = this.props;\n\n    switch (DragManager.dragging.type) {\n      case DraggedElementType.DIMENSION:\n        return Split.fromDimension(DragManager.draggingDimension());\n      case DraggedElementType.FILTER:\n        const dimension = findDimensionByName(dataCube.dimensions, DragManager.draggingFilter().reference);\n        return Split.fromDimension(dimension);\n      case DraggedElementType.SPLIT:\n        return DragManager.draggingSplit();\n    }\n    throw new Error(`Expected Dimension, Filter or Split, got ${DragManager.dragging.type}`);\n  }\n\n  drop = (e: React.DragEvent<HTMLElement>) => {\n    if (!this.canDrop()) return;\n    e.preventDefault();\n    this.setState({ dragPosition: null });\n\n    const split = this.draggingSplit();\n    if (!split) return;\n\n    const position = this.calculateDragPosition(e);\n\n    if (position.isReplace()) {\n      if (position.replace === this.maxItems()) {\n        this.insertSplit(split, position.replace);\n      } else {\n        this.replaceSplit(split, position.replace);\n      }\n    } else {\n      this.insertSplit(split, position.insert);\n    }\n  };\n\n  appendSplit = (dimension: Dimension) => {\n    this.props.clicker.addSplit(Split.fromDimension(dimension), VisStrategy.FairGame);\n  };\n\n  insertSplit = (split: Split, index: number) => {\n    const { clicker, essence: { splits } } = this.props;\n    clicker.changeSplits(splits.insertByIndex(index, split), VisStrategy.FairGame);\n  };\n\n  replaceSplit = (split: Split, index: number) => {\n    const { clicker, essence: { splits } } = this.props;\n    clicker.changeSplits(splits.replaceByIndex(index, split), VisStrategy.FairGame);\n  };\n\n  render() {\n    const { essence, menuStage, splitTileComponent } = this.props;\n    const { dragPosition, overflowOpen, openedSplit } = this.state;\n    return <div className=\"tile-row split-tile-row\" onDragEnter={this.dragEnter}>\n      <div className=\"title\">{STRINGS.split}</div>\n      <div className=\"items\" ref={this.items}>\n        <SplitTiles\n          essence={essence}\n          splitTileComponent={splitTileComponent}\n          openedSplit={openedSplit}\n          removeSplit={this.removeSplit}\n          updateSplit={this.updateSplit}\n          openMenu={this.openMenu}\n          closeMenu={this.closeMenu}\n          dragStart={this.dragStart}\n          menuStage={menuStage}\n          maxItems={this.maxItems()}\n          overflowOpen={overflowOpen}\n          closeOverflowMenu={this.closeOverflowMenu}\n          openOverflowMenu={this.openOverflowMenu} />\n      </div>\n      <DragIndicator dragOver={this.dragOver} dragLeave={this.dragLeave} drop={this.drop} dragPosition={dragPosition} />\n      <AddSplit appendSplit={this.appendSplit} menuStage={menuStage} essence={essence} />\n    </div>;\n  }\n}\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { CORE_ITEM_GAP } from \"../../config/constants\";\nimport { classNames, transformStyle } from \"../../utils/dom/dom\";\nimport { BubbleMenu } from \"../bubble-menu/bubble-menu\";\nimport { WithRef } from \"../with-ref/with-ref\";\n\ninterface TileOverflowContainerMenuProps {\n  items: JSX.Element[];\n  openOn: Element;\n  closeOverflowMenu: Fn;\n}\n\nconst SEGMENT_HEIGHT = 29 + CORE_ITEM_GAP;\n\nconst TileOverflowContainerMenu: React.FunctionComponent<TileOverflowContainerMenuProps> = props => {\n  const { items, openOn, closeOverflowMenu } = props;\n\n  const positionedItems = items.map((item, idx) =>\n    React.cloneElement(item, { style: transformStyle(0, CORE_ITEM_GAP + idx * SEGMENT_HEIGHT) }));\n\n  return <BubbleMenu\n    className=\"overflow-menu\"\n    direction=\"down\"\n    stage={Stage.fromSize(208, CORE_ITEM_GAP + (items.length * SEGMENT_HEIGHT))}\n    fixedSize={true}\n    openOn={openOn}\n    onClose={closeOverflowMenu}\n  >\n    {positionedItems}\n  </BubbleMenu>;\n};\n\ninterface TileOverflowContainerProps {\n  className: string;\n  x: number;\n  items: JSX.Element[];\n  open: boolean;\n  openOverflowMenu: Fn;\n  closeOverflowMenu: Fn;\n}\n\nexport const TileOverflowContainer: React.FunctionComponent<TileOverflowContainerProps> = props => {\n  const { x, items, open, openOverflowMenu, className, closeOverflowMenu } = props;\n\n  const style = transformStyle(x, 0);\n  return <WithRef>\n    {({ ref: openOn, setRef }) => <React.Fragment>\n      <div\n        className={classNames(\"overflow\", className)}\n        style={style}\n        ref={setRef}\n        onClick={openOverflowMenu}>\n        <div className=\"count\">{\"+\" + items.length}</div>\n      </div>\n      {open && openOn && <TileOverflowContainerMenu\n        openOn={openOn}\n        items={items}\n        closeOverflowMenu={closeOverflowMenu} />}\n    </React.Fragment>}\n  </WithRef>;\n};\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Dimension, isContinuous } from \"../../../common/models/dimension/dimension\";\nimport { Essence } from \"../../../common/models/essence/essence\";\nimport { granularityToString } from \"../../../common/models/granularity/granularity\";\nimport { DimensionSortOn, SortOn } from \"../../../common/models/sort-on/sort-on\";\nimport { Sort } from \"../../../common/models/sort/sort\";\nimport { Split } from \"../../../common/models/split/split\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Binary } from \"../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { GranularityPicker } from \"./granularity-picker\";\nimport { LimitDropdown } from \"./limit-dropdown\";\nimport { SortDropdown } from \"./sort-dropdown\";\nimport { createSplit, SplitMenuBase, validateSplit } from \"./split-menu-base\";\nimport \"./split-menu.scss\";\n\nexport interface SplitMenuProps {\n  essence: Essence;\n  saveSplit: Binary<Split, Split, void>;\n  openOn: Element;\n  containerStage: Stage;\n  onClose: Fn;\n  dimension: Dimension;\n  split: Split;\n}\n\nexport interface SplitMenuState {\n  granularity?: string;\n  sort?: Sort;\n  limit?: number;\n}\n\nexport class SplitMenu extends React.Component<SplitMenuProps, SplitMenuState> {\n\n  state: SplitMenuState = {};\n\n  UNSAFE_componentWillMount() {\n    const { split } = this.props;\n    const { bucket, sort, limit } = split;\n\n    this.setState({\n      sort,\n      limit,\n      granularity: bucket && granularityToString(bucket)\n    });\n  }\n\n  saveGranularity = (granularity: string) => this.setState({ granularity });\n\n  saveSort = (sort: Sort) => this.setState({ sort });\n\n  saveLimit = (limit: number) => this.setState({ limit });\n\n  saveSplit = () => {\n    const { split, saveSplit } = this.props;\n    saveSplit(split, this.createSplit());\n  };\n\n  private createSplit(): Split {\n    const { split, dimension } = this.props;\n    const { limit, sort, granularity } = this.state;\n    return createSplit({ split, dimension, limit, sort, granularity });\n  }\n\n  validate() {\n    const { dimension, split } = this.props;\n    const { limit, sort, granularity } = this.state;\n    return validateSplit({ split, dimension, limit, sort, granularity });\n  }\n\n  render() {\n    const { essence, containerStage, openOn, dimension, onClose } = this.props;\n    const { granularity, sort, limit } = this.state;\n\n    const seriesSortOns = essence.seriesSortOns(true).toArray();\n    const options = [new DimensionSortOn(dimension), ...seriesSortOns];\n    const selected = SortOn.fromSort(sort, essence);\n\n    return <SplitMenuBase\n      openOn={openOn}\n      containerStage={containerStage}\n      onClose={onClose}\n      onSave={this.saveSplit}\n      dimension={dimension}\n      isValid={this.validate()}>\n      <GranularityPicker\n        dimension={dimension}\n        granularityChange={this.saveGranularity}\n        granularity={granularity}\n      />\n      <SortDropdown\n        direction={sort.direction}\n        selected={selected}\n        options={options}\n        onChange={this.saveSort}\n      />\n      <LimitDropdown\n        onLimitSelect={this.saveLimit}\n        selectedLimit={limit}\n        includeNone={isContinuous(dimension)}\n        limits={dimension.limits}/>\n    </SplitMenuBase>;\n  }\n}\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Dimension } from \"../../../common/models/dimension/dimension\";\nimport { Essence } from \"../../../common/models/essence/essence\";\nimport { Split } from \"../../../common/models/split/split\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Binary, Ternary, Unary } from \"../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { SplitMenu, SplitMenuProps } from \"../split-menu/split-menu\";\nimport { SvgIcon } from \"../svg-icon/svg-icon\";\nimport { WithRef } from \"../with-ref/with-ref\";\n\nexport interface SplitTileBaseProps {\n  essence: Essence;\n  split: Split;\n  dimension: Dimension;\n  open: boolean;\n  style?: React.CSSProperties;\n  removeSplit: Unary<Split, void>;\n  updateSplit: Binary<Split, Split, void>;\n  openMenu: Unary<Split, void>;\n  closeMenu: Fn;\n  dragStart: Ternary<string, Split, React.DragEvent<HTMLElement>, void>;\n  containerStage: Stage;\n}\n\ninterface SplitTileProps extends SplitTileBaseProps {\n  splitMenuComponent: React.ComponentType<SplitMenuProps>;\n}\n\nexport const DefaultSplitTile: React.FunctionComponent<SplitTileBaseProps> = props => {\n  return <SplitTile {...props} splitMenuComponent={SplitMenu} />;\n};\n\nexport const SplitTile: React.FunctionComponent<SplitTileProps> = props => {\n  const { splitMenuComponent: SplitMenu, essence, open, split, dimension, style, removeSplit, updateSplit, openMenu, closeMenu, dragStart, containerStage } = props;\n\n  const title = split.getTitle(dimension);\n\n  const remove = (e: React.MouseEvent<HTMLElement>) => {\n    e.stopPropagation();\n    removeSplit(split);\n  };\n\n  return <WithRef>\n    {({ ref: openOn, setRef }) => <React.Fragment>\n      <div\n        className=\"tile dimension\"\n        key={split.toKey()}\n        ref={setRef}\n        draggable={true}\n        onClick={() => openMenu(split)}\n        onDragStart={e => dragStart(dimension.title, split, e)}\n        style={style}\n        title={title}\n      >\n        <div className=\"reading\">{title}</div>\n        <div className=\"remove\"\n             onClick={remove}>\n          <SvgIcon svg={require(\"../../icons/x.svg\")} />\n        </div>\n      </div>\n      {open && openOn && <SplitMenu\n        saveSplit={updateSplit}\n        essence={essence}\n        openOn={openOn}\n        containerStage={containerStage}\n        onClose={closeMenu}\n        dimension={dimension}\n        split={split} />}\n    </React.Fragment>}\n  </WithRef>;\n};\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { DragPosition } from \"../../../common/models/drag-position/drag-position\";\nimport { CORE_ITEM_GAP, CORE_ITEM_WIDTH } from \"../../config/constants\";\nimport { SvgIcon } from \"../svg-icon/svg-icon\";\nimport \"./fancy-drag-indicator.scss\";\n\nexport interface FancyDragIndicatorProps {\n  dragPosition: DragPosition;\n}\n\nexport interface FancyDragIndicatorState {\n}\n\nexport class FancyDragIndicator extends React.Component<FancyDragIndicatorProps, FancyDragIndicatorState> {\n\n  render() {\n    const { dragPosition } = this.props;\n    if (!dragPosition) return null;\n\n    const sectionWidth = CORE_ITEM_WIDTH + CORE_ITEM_GAP;\n\n    let ghostArrowLeft: number;\n    let dragGhostElement: JSX.Element = null;\n    if (dragPosition.isInsert()) {\n      ghostArrowLeft = dragPosition.insert * sectionWidth - CORE_ITEM_GAP / 2;\n    } else {\n      ghostArrowLeft = dragPosition.replace * sectionWidth + CORE_ITEM_WIDTH / 2;\n      const left = dragPosition.replace * sectionWidth;\n      dragGhostElement = <div className=\"drag-ghost-element\" style={{ left }} />;\n    }\n\n    return <div className=\"fancy-drag-indicator\">\n      {dragGhostElement}\n      <SvgIcon className=\"drag-ghost-arrow\" svg={require(\"../../icons/drag-arrow.svg\")} style={{ left: ghostArrowLeft }} />\n    </div>;\n  }\n}\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { DragPosition } from \"../../../common/models/drag-position/drag-position\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { FancyDragIndicator } from \"./fancy-drag-indicator\";\n\ninterface DragIndicatorProps {\n  drop: Unary<React.DragEvent<HTMLElement>, void>;\n  dragLeave: Fn;\n  dragOver: Unary<React.DragEvent<HTMLElement>, void>;\n  dragPosition?: DragPosition;\n}\n\nexport const DragIndicator: React.FunctionComponent<DragIndicatorProps> = props => {\n  const { dragPosition, dragOver, drop, dragLeave } = props;\n  if (!dragPosition) return null;\n  return <React.Fragment>\n    <FancyDragIndicator dragPosition={dragPosition} />\n    <div className=\"drag-mask\"\n         onDragOver={dragOver}\n         onDragLeave={dragLeave}\n         onDragExit={dragLeave}\n         onDrop={drop} />\n  </React.Fragment>;\n};\n","/*\n * Copyright 2017-2018 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport \"./message-card.scss\";\n\ninterface MessageCardProps {\n  title: string;\n}\n\nexport const MessageCard: React.FunctionComponent<MessageCardProps> = props => {\n  const { title, children } = props;\n  return <div className=\"message-card\">\n    <div className=\"message-card-title\">{title}</div>\n    {children}\n  </div>;\n};\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Stage } from \"../../../common/models/stage/stage\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { BubbleMenu } from \"../bubble-menu/bubble-menu\";\nimport { ClearableInput } from \"../clearable-input/clearable-input\";\nimport { HighlightString } from \"../highlight-string/highlight-string\";\nimport { SvgIcon } from \"../svg-icon/svg-icon\";\nimport \"./add-tile.scss\";\n\nexport interface Tile<T> {\n  key: string;\n  label: string;\n  value: T;\n}\n\ninterface AddTileProps<T> {\n  tiles: Array<Tile<T>>;\n  onSelect: Unary<T, void>;\n  containerStage: Stage;\n}\n\ninterface AddTileState {\n  openMenu: boolean;\n  query: string;\n}\n\nexport class AddTile<T> extends React.Component<AddTileProps<T>, AddTileState> {\n\n  state: AddTileState = { openMenu: false, query: \"\" };\n\n  private menuOpenOn: HTMLElement = null;\n\n  mountAdd = (addButton: HTMLElement) => {\n    this.menuOpenOn = addButton;\n  };\n\n  closeMenu = () => this.setState({ openMenu: false });\n\n  openMenu = () => this.setState({ openMenu: true });\n\n  setQuery = (query: string) => this.setState({ query });\n\n  resetQuery = () => this.setQuery(\"\");\n\n  selectTile = (value: T) => {\n    this.props.onSelect(value);\n    this.resetQuery();\n    this.closeMenu();\n  };\n\n  renderRows(rows: Array<Tile<T>>) {\n    const { query } = this.state;\n    return rows.map(({ value, key, label }) => <div\n      className=\"tile-row\"\n      key={key}\n      onClick={() => this.selectTile(value)}>\n      <HighlightString className=\"label\" text={label} highlight={query} />\n    </div>);\n  }\n\n  renderTable() {\n    const { tiles } = this.props;\n    const { query } = this.state;\n    if (query.length === 0) return this.renderRows(tiles);\n    const filteredRows = tiles.filter(({ label }) =>\n      label.toLowerCase().includes(query.toLowerCase()));\n    if (filteredRows.length > 0) return this.renderRows(filteredRows);\n    return <div className=\"tile-row no-results\">\n      No results for {query}\n    </div>;\n  }\n\n  renderMenu() {\n    const { containerStage } = this.props;\n    const { openMenu, query } = this.state;\n    if (!openMenu) return null;\n\n    return <BubbleMenu\n      className=\"add-tile-menu\"\n      direction=\"down\"\n      stage={Stage.fromSize(250, 410)}\n      containerStage={containerStage}\n      openOn={this.menuOpenOn}\n      onClose={this.closeMenu}>\n      <div className=\"search-box\">\n        <ClearableInput\n          placeholder=\"Search\"\n          focusOnMount={true}\n          value={query}\n          onChange={this.setQuery} />\n      </div>\n      <div className=\"tile-rows\">\n        {this.renderTable()}\n      </div>\n    </BubbleMenu>;\n  }\n\n  render() {\n    return <div className=\"add-tile\">\n      <div className=\"add-button\" ref={this.mountAdd} onClick={this.openMenu}>\n        <SvgIcon svg={require(\"../../icons/preview-subsplit.svg\")} />\n      </div>\n      {this.renderMenu()}\n    </div>;\n  }\n}\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Fn } from \"../../../common/utils/general/general\";\nimport { classNames } from \"../../utils/dom/dom\";\nimport \"./button-group.scss\";\n\nexport interface GroupMember {\n  title: string;\n  onClick: Fn;\n  key: string | number;\n  className?: string;\n  isSelected?: boolean;\n}\n\nexport interface ButtonGroupProps {\n  groupMembers: GroupMember[];\n  title?: string;\n  className?: string;\n}\n\nexport interface ButtonGroupState {\n}\n\nexport class ButtonGroup extends React.Component<ButtonGroupProps, ButtonGroupState> {\n\n  renderMembers() {\n    const { groupMembers } = this.props;\n    return groupMembers.map(button => {\n      return <li\n        className={classNames(\"group-member\", button.className, { selected: button.isSelected })}\n        key={button.key}\n        onClick={button.onClick}\n      >\n        {button.title}\n      </li>;\n    });\n  }\n\n  render() {\n    const { title, className } = this.props;\n\n    return <div className={classNames(\"button-group\", className)}>\n      {title ? <div className=\"button-group-title\">{title}</div> : null}\n      <ul className=\"group-container\">{this.renderMembers()}</ul>\n    </div>;\n  }\n}\n","/*\n * Copyright 2015-2016 Imply Data, Inc.\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { List } from \"immutable\";\nimport { FilterClause } from \"../../../common/models/filter-clause/filter-clause\";\n\nexport class Highlight {\n  constructor(public readonly clauses: List<FilterClause>, public readonly key: string | null) {\n  }\n}\n","/*\n * Copyright 2017-2021 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { List } from \"immutable\";\nimport React from \"react\";\nimport { ReactNode } from \"react\";\nimport { Clicker } from \"../../../common/models/clicker/clicker\";\nimport { Essence } from \"../../../common/models/essence/essence\";\nimport { FilterClause } from \"../../../common/models/filter-clause/filter-clause\";\nimport { Binary, Nullary, Unary } from \"../../../common/utils/functional/functional\";\nimport { Highlight } from \"./highlight\";\n\ninterface HighlightProps {\n  dropHighlight: Nullary<void>;\n  acceptHighlight: Nullary<void>;\n  highlight: Highlight | null;\n  saveHighlight: Binary<List<FilterClause>, string | null, void>;\n}\n\ninterface HighlightControllerProps {\n  essence: Essence;\n  clicker: Clicker;\n  children: Unary<HighlightProps, ReactNode>;\n}\n\ninterface HighlightControllerState {\n  highlight: Highlight | null;\n}\n\nexport function hasHighlightOn(highlight: Highlight | null, key: string): boolean {\n  if (!highlight) return false;\n  return highlight.key === key;\n}\n\nexport class HighlightController extends React.Component<HighlightControllerProps, HighlightControllerState> {\n  state: HighlightControllerState = { highlight: null };\n\n  private dropHighlight = () => this.setState({ highlight: null });\n\n  private acceptHighlight = () => {\n    const { highlight } = this.state;\n    if (highlight === null) return;\n    const { essence, clicker } = this.props;\n    clicker.changeFilter(essence.filter.mergeClauses(highlight.clauses));\n    this.setState({ highlight: null });\n  };\n\n  private saveHighlight = (clauses: List<FilterClause>, key: string | null = null) => {\n    const highlight = new Highlight(clauses, key);\n    this.setState({ highlight });\n  };\n\n  render() {\n    const { children } = this.props;\n    const { highlight } = this.state;\n    const highlightProps = {\n      dropHighlight: this.dropHighlight,\n      acceptHighlight: this.acceptHighlight,\n      saveHighlight: this.saveHighlight,\n      highlight\n    };\n    return children(highlightProps);\n  }\n}\n","/*\n * Copyright 2017-2019 Allegro.pl\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from \"react\";\nimport { Unary } from \"../../../common/utils/functional/functional\";\nimport { classNames } from \"../../utils/dom/dom\";\nimport { ButtonGroup, GroupMember } from \"../button-group/button-group\";\nimport \"./input-with-presets.scss\";\n\nexport interface Preset<T> {\n  name: string;\n  identity: T;\n}\n\nexport interface InputWithPresetsProps<T> {\n  presets: Array<Preset<T>>;\n  selected?: T;\n  onChange: Unary<T, void>;\n  errorMessage?: string;\n  placeholder?: string;\n  title?: string;\n  parseCustomValue: Unary<string, T>;\n  formatCustomValue: Unary<T, string>;\n}\n\ninterface InputWithPresetsState {\n  customPicked: boolean;\n  customValue: string;\n}\n\nexport class InputWithPresets<T> extends React.Component<InputWithPresetsProps<T>, InputWithPresetsState> {\n\n  initialState(): InputWithPresetsState {\n    const { selected, presets, formatCustomValue } = this.props;\n    const isPresetPicked = presets.some(({ identity }) => identity === selected);\n    const customPicked = selected !== undefined && !isPresetPicked;\n    const customValue = customPicked ? formatCustomValue(selected) : \"\";\n    return { customPicked, customValue };\n  }\n\n  state = this.initialState();\n\n  customValueUpdate = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const { onChange, parseCustomValue } = this.props;\n    const customValue = e.currentTarget.value;\n    onChange(parseCustomValue(customValue));\n    this.setState({ customValue });\n  };\n\n  pickCustom = () => {\n    const { onChange, parseCustomValue } = this.props;\n    this.setState({ customPicked: true });\n    onChange(parseCustomValue(this.state.customValue));\n  };\n\n  pickPreset = (value: T) => {\n    const { onChange } = this.props;\n    this.setState({ customPicked: false });\n    onChange(value);\n  };\n\n  render() {\n    const { errorMessage, selected, presets, placeholder, title, parseCustomValue } = this.props;\n    const { customPicked, customValue } = this.state;\n\n    const presetButtons = presets.map(({ name, identity }) => ({\n      key: String(identity),\n      title: name,\n      isSelected: !customPicked && identity === selected,\n      onClick: () => this.pickPreset(identity)\n    }));\n\n    const customSelected = customPicked && selected === parseCustomValue(customValue);\n\n    const customButton: GroupMember = {\n      key: \"custom\",\n      title: \"…\",\n      onClick: this.pickCustom,\n      isSelected: customSelected\n    };\n\n    const members = [...presetButtons, customButton];\n\n    const renderErrorMessage = customSelected && errorMessage && customValue.length > 0;\n\n    return <React.Fragment>\n      <ButtonGroup title={title} groupMembers={members} />\n      {customSelected && <input type=\"text\"\n                                className={classNames(\"custom-input\", { invalid: errorMessage })}\n                                placeholder={placeholder}\n                                value={customValue}\n                                onChange={this.customValueUpdate} />}\n      {renderErrorMessage && <span className=\"error-message\">{errorMessage}</span>}\n    </React.Fragment>;\n  }\n}\n"],"sourceRoot":""}